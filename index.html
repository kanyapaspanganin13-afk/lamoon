<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="apple-touch-icon" href="https://i.ibb.co/kVrdspsT/Barber-note-pro.jpg">
    <title>Barber Note Pro v.12.1 (Updated)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1e3a8a; --accent: #16a34a; --danger: #dc2626; --warning: #f59e0b; --main-bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --input-bg: #f8fafc; --indigo: #818cf8; --border: #e2e8f0; }
        body.theme-dark { --main-bg: #0f172a; --card: #1e293b; --text: #f8fafc; --input-bg: #334155; --border: #475569; }
        body.theme-pastel { --main-bg: #faf5ff; --card: #ffffff; --text: #4c1d95; --input-bg: #f5f3ff; --border: #e9d5ff; }
        body { margin: 0; font-family: 'Kanit'; background: var(--main-bg); color: var(--text); padding-bottom: 90px; transition: 0.3s; font-weight: 300; }
        header { padding: 15px; background: var(--card); display: flex; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); position: sticky; top:0; z-index:100; }
        header h1 { flex: 1; text-align: center; font-size: 18px; margin: 0; font-weight: 500; }
        .page { display: none; padding: 15px; animation: fadeIn 0.2s; } .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--card); border-radius: 20px; padding: 16px; margin-bottom: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; box-sizing: border-box; }
        input, select { width: 100%; height: 45px; padding: 8px 10px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05); font-size: 16px; box-sizing: border-box; background: var(--input-bg); color: var(--text); outline: none; font-family: 'Kanit'; }
        #dateInp { background: #e0f2fe !important; border: 1px solid #bae6fd !important; -webkit-appearance: none;}
        .time-input { background: #f0f9ff !important; border: 1px solid #bae6fd !important; text-align: center; font-weight: 600; }
        .btn-pay { border: 2px solid transparent; background: var(--input-bg); color: var(--text); padding: 8px 5px; border-radius: 12px; font-weight: 500; cursor: pointer; transition: 0.2s; font-size: 18px; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .active-cash { border: 3px solid #16a34a !important; color: #14532d !important; background: #dcfce7 !important; }
        .active-transfer { border: 3px solid #0284c7 !important; color: #0c4a6e !important; background: #e0f2fe !important; }
        .status-bar { width: 100%; padding: 15px; border-radius: 15px; text-align: center; font-weight: 600; font-size: 16px; margin: 10px 0; box-sizing: border-box; }
        .status-red { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; } 
        .status-green { background: #dcfce7; color: #16a34a; border: 1px solid #bbf7d0; }
        .status-blue { background: #e0f2fe; color: #0284c7; } 
        .status-indigo { background: #e0e7ff; color: #4338ca; border: 1px solid #c7d2fe; }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏´‡∏ô‡πâ‡∏≤ 3 ‡πÅ‡∏ö‡∏ö Card ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (Updated) */
        .acc-main-card { background: var(--card); padding: 18px; border-radius: 25px; border-left: 6px solid #f59e0b; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 15px; }
        .btn-toggle-history { width: 100%; background: #f1f5f9; border: 1px solid #e2e8f0; padding: 10px; border-radius: 12px; font-size: 13px; color: var(--primary); cursor: pointer; margin: 10px 0; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .history-wrapper { display: none; background: rgba(0,0,0,0.02); border-radius: 15px; padding: 10px; margin-bottom: 15px; }
        .history-list { max-height: 200px; overflow-y: auto; font-size: 12px; }
        .acc-light { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }

        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); display: flex; border-top: 1px solid rgba(0,0,0,0.1); height: 75px; align-items: center; justify-content: space-around; z-index: 9999; }
        .nav-item { flex: 1; text-align: center; color: #94a3b8; font-size: 13px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; }
        .nav-item.active { color: var(--primary); font-weight: 500; }
        .btn-save { background: var(--primary); color: white; width: 100%; padding: 16px; border-radius: 16px; font-size: 18px; font-weight: 600; border: none; margin-top: 10px; cursor: pointer; }
        .btn-close-day { position: fixed; bottom: 85px; right: 20px; width: 60px; height: 60px; border-radius: 30px; background: #818cf8; color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 99; font-size: 24px; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-content { background: var(--card); width: 100%; border-radius: 25px; padding: 22px; max-height: 85vh; overflow-y: auto; }
        .color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid #ddd; display: inline-block; margin: 5px; }
        .history-row { padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.03); font-size: 14px; }
        .badge { background: rgba(0,0,0,0.05); padding: 4px 10px; border-radius: 8px; font-size: 12px; margin: 2px; display: inline-block; color: var(--primary); }
    </style>
</head>
<body id="mainBody">
<header><div style="width:40px"></div><h1 id="shopNameDisp">Barber Note</h1><div onclick="openSettings()" style="cursor:pointer"><i class="fas fa-cog"></i></div></header>

<div id="p1" class="page active">
  <div id="p1" class="page active">
 <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; padding: 5px;">
    
    <div style="position: relative; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 12px; padding: 12px 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <span style="font-size: 18px;">üìÖ</span>
        <input type="date" id="dateInp" onchange="updateDateDisplay(this.value)" style="position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer;">
        <span id="dateDisplay" style="font-size: 10px; font-weight: 700; color: #475569;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
    </div>

    <div onclick="handleInsurance()" style="background: #fffbeb; border: 1.5px solid #fde68a; border-radius: 12px; padding: 12px 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <span style="font-size: 18px;">üõ°Ô∏è</span>
        <span style="font-size: 10px; font-weight: 800; color: #b45309;">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</span>
    </div>

    <div onclick="handleHoliday()" style="background: #fff1f2; border: 1.5px solid #fecdd3; border-radius: 12px; padding: 12px 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <span style="font-size: 18px;">üèñÔ∏è</span>
        <span style="font-size: 10px; font-weight: 800; color: #be185d;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span>
    </div>
</div>

    <div class="card" style="border-left: 5px solid #0ea5e9; padding: 10px 15px;">
        <div class="grid-2">
            <div><label style="font-size:12px">‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="tel" id="tStart" placeholder="0900" class="time-input" maxlength="4"></div>
            <div><label style="font-size:12px">‡πÄ‡∏™‡∏£‡πá‡∏à</label><input type="tel" id="tEnd" placeholder="0930" class="time-input" maxlength="4"></div>
        </div>
    </div>

    <div class="card" style="border-left: 5px solid #10b981;"><div class="grid-2" style="margin-bottom:10px"><select id="mainSvc"><option value="">‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option><option value="‡πÄ‡∏î‡πá‡∏Å">‡πÄ‡∏î‡πá‡∏Å</option></select><select id="hairStyle"><option value="">‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option><option>‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á</option><option>‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô</option><option>‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î</option><option>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á</option></option><option>‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£</option><option>‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option><option>‡πÅ‡∏Å‡πâ‡∏ó‡∏£‡∏á‡∏ú‡∏°<option>‡πÇ‡∏Å‡∏ô‡∏ú‡∏°</option></select></div>
    <div class="grid-2"><select id="extra1"><option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô 1</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option><option>‡∏î‡∏±‡∏î‡∏ú‡∏°</option></option></select><select id="extra2"><option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô 2</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option><option>‡∏î‡∏±‡∏î‡∏ú‡∏°</option>‡∏°</option></select></div></div>
    <div class="card" style="border-left: 5px solid #f59e0b;"><input type="number" id="priceInp" placeholder="0" inputmode="numeric" style="font-size:40px; font-weight:600; color:#b45309; text-align:center; height:80px;"><div class="grid-2" style="margin-top:15px"><button id="btnCash" class="btn-pay" onclick="selectPay('Cash')"><i class="fas fa-money-bill-wave"></i> ‡∏™‡∏î</button><button id="btnTrans" class="btn-pay" onclick="selectPay('Trans')"><i class="fas fa-mobile-alt"></i> ‡πÇ‡∏≠‡∏ô</button></div></div>
    <button class="btn-save" id="mainSaveBtn" onclick="handleSave()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</div>

<div id="p2" class="page">
    <div class="grid-2"><div class="card" style="text-align: center;"><label>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label><div id="dTotal" style="font-size:28px; font-weight:600">0</div><div id="dCounts" style="font-size:18px; font-weight:600; color:var(--primary); margin-top:5px;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: 0 ‡∏Ñ‡∏ô</div></div>
    <div class="card"><div style="font-size:16px; font-weight:600; margin-bottom:6px;">üì± ‡πÇ‡∏≠‡∏ô: <b id="dTrans">0</b></div><div style="font-size:16px; font-weight:600; margin-bottom:6px;">ü§µ ‡∏ä‡πà‡∏≤‡∏á: <b id="dBarber">0</b></div><div style="font-size:16px; font-weight:600;">üè† ‡∏£‡πâ‡∏≤‡∏ô: <b id="dShop">0</b></div></div></div>
    <div id="settleBar" class="status-bar status-blue">‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ</div>
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;"><label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label><i class="fab fa-line" style="color:#06C755; font-size:24px; cursor:pointer;" onclick="shareLine()"></i></div>
        <div id="dServiceStats" style="margin-bottom:15px;"></div><div id="dailyList"></div>
    </div>
    <button class="btn-close-day" onclick="closeDay()"><i class="fas fa-check-circle"></i></button>
</div>

<div id="p3" class="page">
    <div class="acc-main-card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; font-size:15px; color:#b45309;">üßæ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</h3>
            <div id="accLight" class="acc-light" style="background:gray;"></div>
        </div>

        <div style="font-size:11px; color:#64748b; margin:12px 0; line-height:1.6; background:rgba(0,0,0,0.03); padding:10px; border-radius:12px;">
            <div style="display:flex; justify-content:space-between;">
                <span id="accOldText">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°:</span>
                <b id="accOldVal">‡∏ø0</b>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <span id="accTodayText">‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</span>
                <b id="accTodayVal">‡∏ø0</b>
            </div>
        </div>

        <div style="text-align:center; margin:15px 0;">
            <div style="font-size:38px; font-weight:800; color:#1e3a8a;">
                <small style="font-size:18px; font-weight:400; opacity:0.5;">‡∏ø</small><span id="accNet">0</span>
            </div>
        </div>
        
        <div id="accStatus" class="status-bar" style="margin:10px 0; text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

        <button class="btn-toggle-history" onclick="toggleAccHistory()">
            <i class="fas fa-history"></i> <span id="toggleText">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô</span>
        </button>

        <div id="accHistoryWrapper" class="history-wrapper">
            <div id="accHistory" class="history-list"></div>
        </div>

        <hr style="opacity:0.05; margin:15px 0;">

        <label style="font-size:12px; color:#64748b;">‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</label>
        <input type="date" id="accDate" style="height:40px; margin-bottom:10px;">
        <input type="text" id="accNote" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå" style="height:40px; margin-bottom:10px;">
        <button class="btn-save" onclick="clearAccount()" style="margin:0; padding:15px; background:var(--accent);">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</button>
    </div>

    <div class="card" style="border-top: 4px solid var(--primary);"><label>‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</label><input type="date" id="histDate" onchange="loadHistDaily()"><div id="histDailyArea"></div></div>
    <div class="card" style="border-top: 4px solid var(--warning);"><label>‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input type="month" id="histMonth" onchange="loadHistMonth()"><div id="histMonthArea"></div></div>
</div> 
<div id="historyPanel" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:10000; align-items:flex-end;">
    <div style="background:var(--card); width:100%; border-radius:25px 25px 0 0; padding:20px; max-height:85vh; overflow-y:auto; animation: slideUp 0.3s ease-out; box-shadow: 0 -10px 25px rgba(0,0,0,0.2);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:2px solid rgba(0,0,0,0.05); padding-bottom:15px;">
            <h3 style="margin:0; font-size:18px;"><i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô</h3>
            <button onclick="closeHistoryFull()" style="background:#f1f5f9; border:none; padding:10px 20px; border-radius:12px; font-weight:bold; color:var(--danger);">‡∏õ‡∏¥‡∏î</button></div>
        <div id="accHistoryFull"></div>
    </div>
</div>

    <style>
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
/* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ô Card ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô */
.btn-toggle-history { width: 100%; padding: 12px; border-radius: 12px; border: 1px dashed var(--primary); background: #f0f7ff; color: var(--primary); cursor: pointer; font-family: 'Kanit'; }
</style>

    <div id="modalSet" class="modal"><div class="modal-content"><h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3><label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label><input id="setShop">
<div class="grid-2" style="margin-top:10px"><div><label>% ‡πÅ‡∏ö‡πà‡∏á</label><input type="number" id="setPerc"></div><div><label>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</label><input type="number" id="setGuar"></div></div>
<div class="grid-2" style="margin-top:15px"><div><label>üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á</label><select id="setSound"><option value="on">‡πÄ‡∏õ‡∏¥‡∏î</option><option value="off">‡∏õ‡∏¥‡∏î</option></select></div><div><label>üéöÔ∏è ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î</label><select id="setVoice"><option value="female">üë© ‡∏´‡∏ç‡∏¥‡∏á</option><option value="male">üë® ‡∏ä‡∏≤‡∏¢</option></select></div></div>
<label style="margin-top:15px">‡∏ò‡∏µ‡∏°</label><select id="setTheme" onchange="changeTheme(this.value)"><option value="light">Light</option><option value="dark">Dark</option><option value="pastel">Pastel</option></select>
<div style="margin-top:10px"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (7 ‡∏™‡∏µ)</label><br>
    <div class="color-dot" style="background:#fdf2f8" onclick="setBg('#fdf2f8')"></div><div class="color-dot" style="background:#f0fdf4" onclick="setBg('#f0fdf4')"></div><div class="color-dot" style="background:#f0f9ff" onclick="setBg('#f0f9ff')"></div><div class="color-dot" style="background:#fffbeb" onclick="setBg('#fffbeb')"></div><div class="color-dot" style="background:#faf5ff" onclick="setBg('#faf5ff')"></div><div class="color-dot" style="background:#f1f5f9" onclick="setBg('#f1f5f9')"></div><div class="color-dot" style="background:#ffffff; border:1px solid #ccc" onclick="setBg('#ffffff')"></div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;"><button class="btn-save" onclick="saveSettings()" style="margin:0">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button onclick="closeSettings()" style="border-radius:10px; border: 1px solid var(--border)">‡∏õ‡∏¥‡∏î</button></div>
<button onclick="clearAllData()" style="width:100%; background:none; border:none; color:red; margin-top:20px; font-size:12px; opacity:0.5">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></div></div>

<nav class="nav"><div class="nav-item active" id="n1" onclick="go(1)"><i class="fas fa-edit"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div><div class="nav-item" id="n2" onclick="go(2)"><i class="fas fa-calendar-check"></i>‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div><div class="nav-item" id="n3" onclick="go(3)"><i class="fas fa-history"></i>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div></nav>

<script>
    let payMethod="", 
        conf=JSON.parse(localStorage.getItem("barber_conf"))||{shop:"Barber Shop",perc:50,guar:0,theme:"light",bg:"#f1f5f9",sound:"on",voice:"female"}, 
        db=JSON.parse(localStorage.getItem("barber_db"))||[], 
        archives=JSON.parse(localStorage.getItem("barber_arc"))||[],
        account=JSON.parse(localStorage.getItem("barber_account"))||{balance:0, logs:[]};

   const $ = (id) => document.getElementById(id);window.onload = () => { const dateInp = $("dateInp"); dateInp.valueAsDate = new Date(); applySettings(); updateDateDisplay(dateInp.value); 
}; 
    function speak(t){ if(conf.sound==="off")return; window.speechSynthesis.cancel(); const m=new SpeechSynthesisUtterance(t); m.lang='th-TH'; m.pitch=conf.voice==="male"?0.6:1.1; window.speechSynthesis.speak(m); }
    
    document.querySelectorAll('.time-input').forEach(i=>i.addEventListener('input',e=>{ 
        let v=e.target.value.replace(/\D/g,''); 
        if(v.length>=4) e.target.value=v.substring(0,2)+":"+v.substring(2,4); 
    }));

    function go(n){ 
        document.querySelectorAll('.page, .nav-item').forEach(el=>el.classList.remove('active')); 
        $("p"+n).classList.add('active'); 
        $("n"+n).classList.add('active'); 
        if(n===2) renderDay(); 
        if(n===3) { loadAccountStatus(); loadAccountHistory(); }
    }

    function selectPay(m){ payMethod=m; $("btnCash").className=m==='Cash'?'btn-pay active-cash':'btn-pay'; $("btnTrans").className=m==='Trans'?'btn-pay active-transfer':'btn-pay'; }
// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥
    function handleSave(){
        const p=$("priceInp").value; 
        if(!p||!payMethod){ speak("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô"); return; }
        let svcs=[($("mainSvc").value||"‡∏ï‡∏±‡∏î‡∏ú‡∏°"),$("extra1").value,$("extra2").value].filter(s=>s);
        
        db.push({
            id:Date.now(),
            date:$("dateInp").value,
            time:`${$("tStart").value}-${$("tEnd").value}`,
            mainSvc:$("mainSvc").value||"‡∏ï‡∏±‡∏î‡∏ú‡∏°",
            svcs,
            hair:$("hairStyle").value,
            price:Number(p),
            pay:payMethod
        });
        
        localStorage.setItem("barber_db",JSON.stringify(db)); 
        speak("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "+p+" ‡∏ö‡∏≤‡∏ó ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        $("mainSaveBtn").innerText="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì"; 
        $("mainSaveBtn").style.background="var(--accent)";
        
        setTimeout(()=>{ 
            $("mainSaveBtn").innerText="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; 
            $("mainSaveBtn").style.background="var(--primary)"; 
            $("priceInp").value=""; 
            if($("tEnd").value){ $("tStart").value=$("tEnd").value; $("tEnd").value=""; } 
            $("extra1").value=$("extra2").value=""; 
            selectPay(""); 
        }, 600);
    }

    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
    function handleInsurance() {
        const d = $("dateInp").value;
        if (!d) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); return; }

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ db ‡∏ï‡∏≤‡∏° handleSave)
        if (db.some(item => item.date === d)) { 
            alert("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö"); 
            return; 
        }

        const currentInsurance = (window.settings && window.settings.guarantee) ? window.settings.guarantee : 300;

        if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏¢‡∏≠‡∏î "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ" ‡∏ø${currentInsurance}\n(‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 0 ‡∏Ñ‡∏ô - ‡∏£‡πâ‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á)`)) {
            const item = {
                date: d,
                total: Number(currentInsurance),
                cash: 0,
                barber: Number(currentInsurance),
                shop: -Number(currentInsurance),
                count: 0,
                details: [{
                    time: "00:00",
                    svcs: ["üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ"],
                    price: Number(currentInsurance),
                    hair: "‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô",
                    pay: "Trans",
                    barber: Number(currentInsurance)
                }],
                stats: { "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ": 1 },
                settle: -Number(currentInsurance),
                isInsurance: true
            };
            saveSpecialEntry(item);
        }
    }

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
    function handleHoliday() {
        const d = $("dateInp").value;
        if (!d) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
        if (confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î'?\n(‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥)")) {
            const item = {
                date: d,
                total: 0, cash: 0, barber: 0, shop: 0, count: 0,
                details: [],
                stats: { "üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î": 1 },
                settle: 0,
                isHoliday: true 
            };
            saveSpecialEntry(item);
        }
    }

    // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á
    function saveSpecialEntry(item) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏ñ‡πâ‡∏≤‡πÅ‡∏≠‡∏õ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å archives ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡πâ‡∏ô)
        if (typeof archives === 'undefined') archives = [];
        
        archives = archives.filter(a => a.date !== item.date);
        archives.push(item);
        localStorage.setItem("barber_archives", JSON.stringify(archives));
        
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        showPage('p2'); 
        if (typeof loadHistDaily === 'function') loadHistDaily(); 
    }
    
    function renderDay(){
¬† ¬† ¬† ¬† const d=$("dateInp").value, today=db.filter(r=>r.date===d);¬†
¬† ¬† ¬† ¬† let tot=0,trans=0,cash=0,stats={},listHtml="";
¬† ¬† ¬† ¬† today.sort((a,b)=>a.time.localeCompare(b.time)).forEach(r=>{
¬† ¬† ¬† ¬† ¬† ¬† tot+=r.price;¬†
¬† ¬† ¬† ¬† ¬† ¬† r.pay==='Trans' ? trans+=r.price : cash+=r.price;¬†
¬† ¬† ¬† ¬† ¬† ¬† const isCutting = r.svcs.includes("‡∏ï‡∏±‡∏î‡∏ú‡∏°") || r.svcs.includes("‡πÄ‡∏î‡πá‡∏Å") || (r.hair && r.hair.trim() !== "");
¬† ¬† ¬† ¬† ¬† ¬† if (isCutting) stats["‡∏ï‡∏±‡∏î‡∏ú‡∏°"] = (stats["‡∏ï‡∏±‡∏î‡∏ú‡∏°"] || 0) + 1;
¬† ¬† ¬† ¬† ¬† ¬† r.svcs.forEach(s => { if (s === "‡πÄ‡∏î‡πá‡∏Å") stats["‡πÄ‡∏î‡πá‡∏Å"] = (stats["‡πÄ‡∏î‡πá‡∏Å"] || 0) + 1; else if (s !== "‡∏ï‡∏±‡∏î‡∏ú‡∏°") stats[s] = (stats[s] || 0) + 1; });
¬† ¬† ¬† ¬† ¬† ¬† listHtml += `<div class="history-row"><div style="display:flex; justify-content:space-between"><span>${r.time} | ${r.svcs.join('+')}</span><b>‡∏ø${r.price}</b></div><div style="display:flex; justify-content:space-between; opacity:0.7"><span>${r.hair||''}</span><span>${r.pay==='Cash'?'üíµ ‡∏™‡∏î':'üì± ‡πÇ‡∏≠‡∏ô'} <i class="fas fa-trash" style="margin-left:10px; color:var(--danger)" onclick="delRec(${r.id})"></i></span></div></div>`;
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† const bEarn=Math.max(tot*(conf.perc/100),conf.guar), sEarn=tot-bEarn, settle=cash-bEarn;
¬† ¬† ¬† ¬† $("dTotal").innerText=tot.toLocaleString(); $("dTrans").innerText=trans.toLocaleString(); $("dBarber").innerHTML=`${Math.floor(bEarn).toLocaleString()} <small>(‡∏™‡∏î: ${cash})</small>`; $("dShop").innerText=Math.floor(sEarn).toLocaleString(); $("dCounts").innerText=`‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${today.length} ‡∏Ñ‡∏ô`; $("dailyList").innerHTML=listHtml||"<center style='opacity:0.3; padding:20px'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</center>";
¬† ¬† ¬† ¬† let sH=""; if(stats["‡∏ï‡∏±‡∏î‡∏ú‡∏°"]) sH += `<span class="badge" style="background:#4338ca; color:white;">‡∏ï‡∏±‡∏î‡∏ú‡∏°: ${stats["‡∏ï‡∏±‡∏î‡∏ú‡∏°"]}</span>`;
¬† ¬† ¬† ¬† for(let s in stats) { if(s !== "‡∏ï‡∏±‡∏î‡∏ú‡∏°") sH += `<span class="badge">${s}: ${stats[s]}</span>`; }
¬† ¬† ¬† ¬† $("dServiceStats").innerHTML=sH;
¬† ¬† ¬† ¬† const b=$("settleBar");¬†
¬† ¬† ¬† ¬† if(tot===0){ b.innerText="üü¶ ‡∏£‡πâ‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô"; b.className="status-bar status-blue"; }¬†
¬† ¬† ¬† ¬† else if(settle>0){ b.innerText=`üü• ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${Math.floor(settle).toLocaleString()}`; b.className="status-bar status-red"; }¬†
¬† ¬† ¬† ¬† else if(settle<0){ b.innerText=`üü¶ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ‡∏ø${Math.floor(Math.abs(settle)).toLocaleString()}`; b.className="status-bar status-indigo"; }¬†
¬† ¬† ¬† ¬† else { b.innerText="‚úÖ ‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ"; b.className="status-bar status-green"; }
¬† ¬† }
    function calcTodaySettle(){
        const d = $("dateInp").value;
        const today = db.filter(r=>r.date===d);
        if(!today.length) return 0;
        const tot = today.reduce((a,b)=>a+b.price,0);
        const cash = today.filter(r=>r.pay==='Cash').reduce((a,b)=>a+b.price,0);
        const bEarn = Math.max(tot*(conf.perc/100), conf.guar);
        return cash - bEarn;
    }

function toggleAccHistory() {
    const panel = $("historyPanel");
    const box = $("accHistoryFull");
    panel.style.display = "flex";

    if(!account.logs.length){
        box.innerHTML = "<center style='opacity:.4; padding:50px;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô</center>";
        return;
    }
    box.innerHTML = account.logs.map(l => `
        <div style="padding:15px; border-bottom:1px solid rgba(0,0,0,0.05); margin-bottom:12px; background:var(--input-bg); border-radius:15px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <b style="font-size:15px;">üìÖ ${l.date}</b>
                <b style="font-size:18px; color:var(--accent);">‡∏ø${Math.abs(l.amount).toLocaleString()}</b>
            </div>
            <div style="font-size:12px; color:#64748b; margin-top:8px; line-height:1.4;">
                <i class="far fa-comment-dots"></i> ${l.note || "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°"}
            </div>
        </div>
    `).join("");
}

function closeHistoryFull() {
    $("historyPanel").style.display = "none";
}

    function loadAccountStatus() {
        const todaySettle = calcTodaySettle();
        const oldBal = account.balance || 0;
        const net = oldBal + todaySettle;
        const dStr = $("dateInp").value;
        const dObj = new Date(dStr);
        const dateThai = `${dObj.getDate()}/${dObj.getMonth()+1}/${(dObj.getFullYear()+543).toString().slice(-2)}`;

        $("accOldVal").innerText = `‡∏ø${oldBal.toLocaleString()}`;
        $("accTodayVal").innerText = `‡∏ø${todaySettle.toLocaleString()}`;
        $("accNet").innerText = Math.abs(net).toLocaleString();

        let txt="‚úÖ ‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ", cls="status-green", light="#16a34a";
        if(net>0){ txt=`üö© ‡∏™‡∏£‡∏∏‡∏õ ${dateThai}: ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${Math.abs(net).toLocaleString()}`; cls="status-red"; light="#dc2626"; }
        else if(net<0){ txt=`üö© ‡∏™‡∏£‡∏∏‡∏õ ${dateThai}: ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ‡∏ø${Math.abs(net).toLocaleString()}`; cls="status-indigo"; light="#1e3a8a"; }

        $("accStatus").innerText = txt;
        $("accStatus").className = "status-bar "+cls;
        $("accLight").style.background = light;
    }

    function clearAccount(){
        const d = $("accDate").value; if(!d) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå");
        const net = (account.balance || 0) + calcTodaySettle();
        account.logs.unshift({ date: d, amount: net, note: $("accNote").value || "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°" });
        account.balance = 0 - calcTodaySettle();
        localStorage.setItem("barber_account",JSON.stringify(account));
        speak("‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); $("accNote").value = ""; loadAccountHistory(); loadAccountStatus();
    }

    function loadAccountHistory(){
        const box = $("accHistory");
        if(!account.logs.length){ box.innerHTML = "<center style='opacity:.4; padding:20px;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</center>"; return; }
        box.innerHTML = account.logs.slice(0,10).map(l=>`<div class="history-row" style="padding:8px 0; border-bottom:1px dashed #ddd;"><b>${l.date}</b> | ‡∏ø${Math.abs(l.amount).toLocaleString()}<div style="font-size:10px; opacity:.6">${l.note}</div></div>`).join("");
    }

    function delRec(id) { if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) { db = db.filter(r => r.id !== id); localStorage.setItem("barber_db", JSON.stringify(db)); speak("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); renderDay(); } }

    function closeDay() {
        const d = $("dateInp").value;
        const today = db.filter(r => r.date === d);
        if(!today.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        if(confirm("‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥?")) {
            const tot = today.reduce((a,b) => a+b.price, 0);
            const cash = today.filter(r=>r.pay==='Cash').reduce((a,b)=>a+b.price, 0);
            const bEarn = Math.max(tot * (conf.perc/100), conf.guar);
            let dailyStats = {};
            today.forEach(r => { 
                r.svcs.forEach(s => { dailyStats[s] = (dailyStats[s] || 0) + 1; if(s === "‡πÄ‡∏î‡πá‡∏Å") dailyStats["‡∏ï‡∏±‡∏î‡∏ú‡∏°"] = (dailyStats["‡∏ï‡∏±‡∏î‡∏ú‡∏°"] || 0) + 1; }); 
                if(r.hair) { dailyStats["‡∏ï‡∏±‡∏î‡∏ú‡∏°"] = (dailyStats["‡∏ï‡∏±‡∏î‡∏ú‡∏°"] || 0) + 1; dailyStats["‡∏ó‡∏£‡∏á:" + r.hair] = (dailyStats["‡∏ó‡∏£‡∏á:" + r.hair] || 0) + 1; }
            }); 
            archives = archives.filter(a => a.date !== d);
            archives.push({date: d, total: tot, cash: cash, barber: bEarn, shop: tot-bEarn, settle: cash-bEarn, count: today.length, details: today, stats: dailyStats});
            account.balance = (account.balance || 0) + (cash - bEarn);
            localStorage.setItem("barber_account", JSON.stringify(account));
            localStorage.setItem("barber_arc", JSON.stringify(archives));
            db = db.filter(r => r.date !== d);
            localStorage.setItem("barber_db", JSON.stringify(db));
            speak("‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); go(3);
        }
    }

    function loadHistDaily() {
        const d = $("histDate").value; const found = archives.find(a => a.date === d); area = $("histDailyArea"); if(!found) { area.innerHTML = "<center style='color:#ccc; padding:20px;'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</center>"; return; }
        let rows = found.details.map(r => `<div class="history-row" style="font-size:13px;"><div style="display:flex; justify-content:space-between"><b>${r.time} | ${r.svcs.join('+')}</b> <b>‡∏ø${r.price}</b></div><div style="font-size:13px; font-weight:600; color:var(--text);">${r.hair || ''} <span style="font-weight:300; opacity:0.6">(${r.pay==='Cash'?'‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î':'‡πÇ‡∏≠‡∏ô'})</span></div></div>`).join('');
        let statBadges = ""; if (found.stats) { for(let s in found.stats) { statBadges += `<span class="badge" style="background:#eee; color:#333; margin-right:4px;">${s}: ${found.stats[s]}</span>`; } }
        const settle = found.settle || 0;
        const settleText = settle > 0 ? `‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô: ‡∏ø${Math.floor(settle).toLocaleString()}` : settle < 0 ? `‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á: ‡∏ø${Math.floor(Math.abs(settle)).toLocaleString()}` : "‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ";
        const settleClass = settle > 0 ? "status-red" : settle < 0 ? "status-indigo" : "status-green";
        area.innerHTML = `<div style="background:var(--input-bg); padding:15px; border-radius:15px;"><div class="status-bar ${settleClass}" style="padding:8px; font-size:13px; margin-bottom:10px;">${settleText}</div><div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:15px; font-size:13px;"><div>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <b>${found.total.toLocaleString()}</b></div><div>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î: <b>${found.cash.toLocaleString()}</b></div><div>‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ: <b>${Math.floor(found.barber).toLocaleString()}</b></div><div>‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ: <b>${Math.floor(found.shop).toLocaleString()}</b></div></div><div style="margin-bottom:15px; display:flex; flex-wrap:wrap; gap:4px;">${statBadges}</div><div style="border-top:1px dashed #ccc; padding-top:10px;">${rows}</div></div>`;
    }
function updateDateDisplay(val) {
    if(!val) return;
    const d = new Date(val);
    const months = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
    document.getElementById('dateDisplay').innerText = d.getDate() + " " + months[d.getMonth()];
}
    function loadHistMonth() {
    const m = $("histMonth").value; 
    const area = $("histMonthArea"); 
    if(!m) return;
    
    const filtered = archives.filter(a => a.date.startsWith(m));
    if(!filtered.length) { 
        area.innerHTML = "<center style='color:#ccc; padding:20px;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</center>"; 
        return; 
    }

    let monthTotal = 0;   // ‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    let monthBarber = 0;  // ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ä‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏°
    let monthShop = 0;    // ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏£‡∏ß‡∏°
    let monthCount = 0;   // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    let monthStats = {};

    filtered.forEach(a => { 
        monthTotal += a.total; 
        monthBarber += a.barber; 
        monthShop += (a.total - a.barber); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡∏ä‡πà‡∏≤‡∏á
        monthCount += a.count; 
        if(a.stats) { 
            for(let s in a.stats) monthStats[s] = (monthStats[s] || 0) + a.stats[s]; 
        } 
    });

    let sB = "", hB = "";
    for(let s in monthStats) { 
        if(s.startsWith("‡∏ó‡∏£‡∏á:")) hB += `<span class="badge" style="background:#10b981; color:white;">${s.replace("‡∏ó‡∏£‡∏á:","")}: ${monthStats[s]}</span>`; 
        else sB += `<span class="badge" style="background:var(--indigo); color:white;">${s}: ${monthStats[s]}</span>`; 
    }

    area.innerHTML = `
    <div style="padding:15px; background:var(--input-bg); border-radius:20px; border:1px solid var(--border);">
        <div style="text-align:center; margin-bottom:15px; padding:10px; background:#fff; border-radius:15px; box-shadow:inset 0 0 10px rgba(0,0,0,0.02);">
            <div style="font-size:12px; color:#64748b;">‚úÇÔ∏è ‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
            <div style="font-size:28px; font-weight:700; color:var(--primary);">‡∏ø${monthTotal.toLocaleString()}</div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
            <div style="background:#dcfce7; padding:12px; border-radius:15px; text-align:center;">
                <div style="font-size:11px; color:#166534;">ü§µ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ä‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏°</div>
                <div style="font-size:18px; font-weight:700; color:#15803d;">‡∏ø${Math.floor(monthBarber).toLocaleString()}</div>
            </div>
            <div style="background:#e0f2fe; padding:12px; border-radius:15px; text-align:center;">
                <div style="font-size:11px; color:#0369a1;">üè† ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏£‡∏ß‡∏°</div>
                <div style="font-size:18px; font-weight:700; color:#075985;">‡∏ø${Math.floor(monthShop).toLocaleString()}</div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:13px; margin-bottom:15px; padding:0 5px;">
            <div style="color:#64748b;">üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b style="color:var(--text);">${monthCount} ‡∏Ñ‡∏ô</b></div>
            <div style="color:#64748b;">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: <b style="color:var(--text);">${filtered.length} ‡∏ß‡∏±‡∏ô</b></div>
        </div>

        <div style="border-top:1px dashed #cbd5e1; padding-top:10px;">
            <label style="font-size:11px; opacity:0.6; font-weight:bold;">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</label>
            <div style="margin:5px 0 10px 0;">${sB || '-'}</div>
            <label style="font-size:11px; opacity:0.6; font-weight:bold;">üíá ‡∏ó‡∏£‡∏á‡∏ú‡∏°:</label>
            <div style="margin-top:5px;">${hB || '-'}</div>
        </div>
    </div>`;
}
   function shareLine() {
        const d = $("dateInp").value, today = db.filter(r => r.date === d); if (!today.length) return;
        let tot = 0, trans = 0, cash = 0, counts = {"‡πÄ‡∏î‡πá‡∏Å":0, "‡∏™‡∏£‡∏∞‡∏ú‡∏°":0, "‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î":0, "‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°":0};
        let msg = `üíà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô: ${conf.shop}\nüìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${d}\n-------------------------\nüìù ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏ß‡∏° ${today.length} ):\n`;
        today.forEach((r, i) => { tot += r.price; r.pay === 'Trans' ? trans += r.price : cash += r.price;
            let name = r.hair || r.svcs[0]; if (r.mainSvc === "‡πÄ‡∏î‡πá‡∏Å") name += "(‡πÄ‡∏î‡πá‡∏Å)";
            msg += `${i + 1}. [${r.time}] ${name} = ${r.price} ${r.pay === 'Cash' ? 'üíµ' : 'üì±'}\n`;
            r.svcs.forEach(s => {
                if (s.includes("‡πÄ‡∏î‡πá‡∏Å")) counts["‡πÄ‡∏î‡πá‡∏Å"]++; else if (s.includes("‡∏™‡∏£‡∏∞")) counts["‡∏™‡∏£‡∏∞‡∏ú‡∏°"]++; else if (s.includes("‡πÇ‡∏Å‡∏ô") || s.includes("‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤")) counts["‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î"]++; else if (s.includes("‡∏¢‡πâ‡∏≠‡∏°") || s.includes("‡∏î‡∏±‡∏î")) counts["‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°"]++;
            });
        });
        const bE = Math.max(tot * (conf.perc / 100), conf.guar), settle = Math.floor(cash - bE);
        msg += `-------------------------\nüìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô:\n`;
        const icons = {"‡πÄ‡∏î‡πá‡∏Å":"üßí", "‡∏™‡∏£‡∏∞‡∏ú‡∏°":"üßº", "‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î":"ü™í", "‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°":"üé®"}; for (let k in counts) { if(counts[k] > 0) msg += `${icons[k]} ${k}: ${counts[k]} \n`; }
        msg += `-------------------------\nüí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${tot} ‡∏ö‡∏≤‡∏ó\nüì± ‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô: ${trans} ‡∏ö‡∏≤‡∏ó\nü§µ ‡∏ä‡πà‡∏≤‡∏á: ${Math.floor(bE)} ‡∏ö‡∏≤‡∏ó\nüè† ‡∏£‡πâ‡∏≤‡∏ô: ${Math.floor(tot - bE)} ‡∏ö‡∏≤‡∏ó\n-------------------------\n`;
        if (settle === 0) msg += `‚úÖ ‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ`; else msg += `‚ö†Ô∏è ${settle > 0 ? '‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ' : '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á '}${Math.abs(settle)} ‡∏ö‡∏≤‡∏ó`;
        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(msg)}`);
    }

    function openSettings(){ $("modalSet").style.display="flex"; $("setShop").value=conf.shop; $("setPerc").value=conf.perc; $("setGuar").value=conf.guar; $("setTheme").value=conf.theme; $("setSound").value=conf.sound; $("setVoice").value=conf.voice; }
    function closeSettings(){ $("modalSet").style.display="none"; }
    function setBg(c){ conf.bg=c; applySettings(); }
    function changeTheme(v){ conf.theme=v; applySettings(); }
    function saveSettings(){ conf.shop=$("setShop").value; conf.perc=Number($("setPerc").value); conf.guar=Number($("setGuar").value); conf.theme=$("setTheme").value; conf.sound=$("setSound").value; conf.voice=$("setVoice").value; localStorage.setItem("barber_conf",JSON.stringify(conf)); applySettings(); closeSettings(); speak("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß"); }
    function applySettings(){ $("shopNameDisp").innerText=conf.shop; $("mainBody").className="theme-"+conf.theme; $("mainBody").style.backgroundColor=conf.bg; }
    function clearAllData(){ if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")){ localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
