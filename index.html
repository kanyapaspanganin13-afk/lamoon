 <!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="apple-touch-icon" href="https://i.ibb.co/kVrdspsT/Barber-note-pro.jpg">
    <title>Barber Note Pro v.11</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
    :root { 
        --primary: #6366f1; --accent: #0ea5e9; --danger: #ef4444; --success: #22c55e; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --border: #e2e8f0;
    }
    * { box-sizing: border-box; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; overflow-x: hidden; }
    .container { padding: 15px 15px 100px 15px !important; max-width: 500px; margin: auto; position: relative; z-index: 1; }
nav {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: #1a237e !important; /* ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏õ‡πä‡∏∞‡πÜ */
    display: flex; justify-content: space-around; padding: 12px 0;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.4); /* ‡πÉ‡∏™‡πà‡πÄ‡∏á‡∏≤‡πÉ‡∏´‡πâ‡∏ö‡∏≤‡∏£‡πå‡∏•‡∏≠‡∏¢‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
    z-index: 9999; border-top: 1px solid rgba(255,255,255,0.1);
}
.nav-item { text-align: center; color: rgba(255,255,255,0.5); flex: 1; transition: 0.2s; }
.nav-item.active { color: #ffffff !important; opacity: 1; } /* ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡∏Ç‡∏≤‡∏ß‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏à‡πâ‡∏≤ */
.nav-item i { font-size: 22px; display: block; margin-bottom: 2px; }
.nav-item span { font-size: 11px; font-weight: 700; }
    body.navy { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --accent: #38bdf8; }
     body.dark { --bg: #121212; --card: #1a1a1a; --text: #fbbf24; --accent: #fbbf24; }
     body { background-color: var(--bg); color: var(--text); transition: all 0.3s ease; }
    .icon-card, input, select { background: var(--card); color: var(--text); border: 1px solid rgba(255,255,255,0.1); }
    .grid-3 {display: grid !important; grid-template-columns: repeat(3, 1fr) !important; gap: 6px; margin-bottom: 8px;}
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
    .icon-card { position: relative; border-radius: 15px; padding: 10px 2px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: none !important; background: #fff; height: 75px !important; font-size: 14px !important; }
    input, select { width: 100%; height: 75px !important; border-radius: 20px !important; font-size: 20px !important; font-weight: 700; text-align: center; border: none !important; outline: none !important; background: #f1f5f9; appearance: none; -webkit-appearance: none; box-shadow: 0 4px 10px rgba(0,0,0,0.03); color: #1e293b; }
    .btn { border: none; padding: 12px; border-radius: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 700; transition: 0.2s; }
    .btn-pay { background: #e2e8f0; color: #64748b; border:2px solid transparent; height: 70px; font-size: 18px;}
    .btn-pay.active-cash { background: #dcfce7; color: #15803d; border-color: #22c55e; }
    .btn-pay.active-trans { background: #e0f2fe; color: #0369a1; border-color: #0ea5e9; }
   
    .page { display: none; } 
    .page.active { display: block; }
    .modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.85); display: none; z-index: 100000; align-items: center; justify-content: center; }
    .modal-content { background: #fff; width: 90%; max-width: 400px; border-radius: 25px; padding: 25px; max-height: 85vh; overflow-y: auto; }
    .status-bar { padding: 12px; border-radius: 12px; text-align: center; font-weight: 800; font-size: 14px; margin-bottom: 10px; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
    .acc-main-card { background: white; padding: 20px; border-radius: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #fffbeb; }
    .btn-save { background: var(--success); color: white; border: none; width: 100%; padding: 15px; border-radius: 15px; font-weight: 700; font-size: 16px; cursor: pointer; }
    #accHistory { font-size: 12px; max-height: 150px; overflow-y: auto; }
</style>
</head>
<body>
<div class="container">
<div id="p1" class="page active" style="padding: 15px; background: #f8fafc;">
    <h2 id="shopNameDisp" style="text-align:center; color:#1e293b; font-weight:900; margin: 10px 0 20px 0; letter-spacing: 1px; text-transform: uppercase;">BARBER SHOP</h2>
    
    <div class="grid-3" style="gap: 12px; margin-bottom: 20px;">
        <div class="icon-card" style="background:#fff; border:none; box-shadow:0 8px 15px rgba(0,0,0,0.05); border-radius:20px; height:90px; display:flex; flex-direction:column; align-items:center; justify-content:center;" onclick="handleInsurance()">
            <div style="background:linear-gradient(135deg, #fbbf24, #f59e0b); width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:8px; color:#fff; font-size:18px;">
                <i class="fas fa-shield-alt"></i>
            </div>
            <span style="color:#1e293b; font-weight:800; font-size:11px;">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</span>
        </div>
        <div class="icon-card" style="background:#fff; border:none; box-shadow:0 8px 15px rgba(0,0,0,0.05); border-radius:20px; height:90px; display:flex; flex-direction:column; align-items:center; justify-content:center;" onclick="handleHoliday()">
            <div style="background:linear-gradient(135deg, #f87171, #ef4444); width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:8px; color:#fff; font-size:18px;">
                <i class="fas fa-umbrella-beach"></i>
            </div>
            <span style="color:#1e293b; font-weight:800; font-size:11px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span>
        </div>

        <div class="icon-card" style="background:#fff; border:none; box-shadow:0 8px 15px rgba(0,0,0,0.05); border-radius:20px; height:90px; display:flex; flex-direction:column; align-items:center; justify-content:center;" onclick="openSettings()">
            <div style="background:linear-gradient(135deg, #94a3b8, #475569); width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:8px; color:#fff; font-size:18px;">
                <i class="fas fa-cog"></i>
            </div>
            <span style="color:#1e293b; font-weight:800; font-size:11px;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
        </div>
    </div>
    <div class="grid-3" style="gap:10px; margin-bottom:15px;">
       <div style="background:#fff; border-radius:18px; border:none; height:75px; position:relative; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
    <span id="dateDisplay" style="font-weight:800; color:#475569; font-size:18px;">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
    <input type="date" id="dateInp" 
           onchange="updateDateDisplay(this.value)" 
           style="position:absolute; opacity:0; width:100%; height:100%; cursor:pointer; z-index:2;">
</div>
        <input type="time" id="tStart" style="height:60px; border-radius:22px; border:none; text-align:center; font-weight:700; background:#fff; color:#1e293b; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
        <input type="time" id="tEnd" style="height:60px; border-radius:22px; border:none; text-align:center; font-weight:700; background:#fff; color:#1e293b; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
    </div>

    <div style="display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 8px; margin-bottom: 15px;">
        <select id="hairStyle" style="height: 70px; border-radius:18px; border:none; font-weight:800; padding:0 10px; background:#fff; color:#1e293b; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
            <option value="">‚úÇÔ∏è ‡∏ó‡∏£‡∏á‡∏ú‡∏°</option>
            <option value="‡πÄ‡∏î‡πá‡∏Å">‡∏ï‡∏±‡∏î‡∏ú‡∏°‡πÄ‡∏î‡πá‡∏Å</option>
            <option>‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á</option><option>‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô</option><option>‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î</option><option>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á</option><option>‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£</option><option>‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            <option>‡πÅ‡∏Å‡πâ‡∏ú‡∏°</option><option>‡πÇ‡∏Å‡∏ô‡∏ú‡∏°</option>
        </select>
        <select id="extra1" style="height: 70px; border-radius:14px; border:none; font-weight:700; background:#fff; color:#64748b; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
            <option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£1</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option>
        </select>
        <select id="extra2" style="height: 70px; border-radius:14px; border:none; font-weight:700; background:#fff; color:#64748b; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
            <option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£2</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option>
        </select>
    </div>
<div style="display: grid; grid-template-columns: 1.4fr 1fr; gap: 8px; margin: 10px 0;">
    <div style="position: relative; background: #ffffff; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05);">
        <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 24px; color: #6366f1; font-weight: 900;">‡∏ø</span>
        <input type="number" id="priceInp" placeholder="0" inputmode="numeric" 
            style="width: 100%; height: 85px !important; background: transparent !important; font-size: 45px !important; font-weight: 900 !important; color: #1e293b !important; padding-left: 40px !important; border: none !important;">
    </div>

    <input type="number" id="tipInp" placeholder="‡∏ó‡∏¥‡∏õ" inputmode="numeric" 
        style="width: 100%; height: 85px !important; background: #ccfbf1 !important; border-radius: 20px !important; font-size: 32px !important; font-weight: 900 !important; color: #0f766e !important; border: none !important;">
</div>

<input type="hidden" id="payType" value="Cash">

<div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:20px;">
    <button id="btnCash" onclick="selectPay('Cash')" style="height:75px; border-radius:22px; border:none; background:linear-gradient(135deg, #10b981, #059669); color:#fff; font-weight:900; font-size:22px; box-shadow:0 8px 20px rgba(16,185,129,0.3); display:flex; align-items:center; justify-content:center; gap:10px;">
        <i class="fas fa-money-bill-wave"></i> ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
    </button>
    <button id="btnTrans" onclick="selectPay('Trans')" style="height:75px; border-radius:22px; border:none; background:linear-gradient(135deg, #6366f1, #4338ca); color:#fff; font-weight:900; font-size:22px; box-shadow:0 8px 20px rgba(99,102,241,0.3); display:flex; align-items:center; justify-content:center; gap:10px;">
        <i class="fas fa-qrcode"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢
    </button>
</div>

<button class="btn-main" onclick="handleSave(event)" style="width:100%; height:90px; border-radius:28px; background:linear-gradient(135deg, #4338ca, #3730a3); color:#fff; border:none; box-shadow:0 15px 35px rgba(67,56,202,0.4); display:flex; align-items:center; justify-content:center; gap:15px;">
    <i class="fas fa-save" style="font-size: 38px;"></i>
    <span style="font-size: 32px; font-weight: 900; letter-spacing:1px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
</button>  
</div>
<div id="p2" class="page" style="max-width:480px; margin:0 auto; padding: 15px; padding-bottom: 100px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
        <div style="background: white; padding:18px 15px; border-radius:20px; text-align:center; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;">
            <small style="font-weight:800; color:#64748b; text-transform: uppercase;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
            <div id="dTotal" style="font-size:36px; font-weight:900; color:#4338ca; margin: 5px 0;">0</div>
            <div id="dCounts" style="font-size:13px; font-weight:700; color:#1e293b; background:#e0e7ff; display:inline-block; padding:2px 10px; border-radius:10px;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 0 ‡∏Ñ‡∏ô</div>
        </div>

        <div style="background:white; padding:15px; border-radius:20px; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; display:flex; flex-direction:column; justify-content:center; gap:8px;">
            <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:700;"><span style="color:#0ea5e9;">üì± ‡πÇ‡∏≠‡∏ô:</span> <b id="dTrans">0</b></div>
            <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:700;"><span style="color:#f59e0b;">üíµ ‡∏™‡∏î:</span> <b id="dCash">0</b></div>
            <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:700;"><span style="color:#6366f1;">ü§µ ‡∏ä‡πà‡∏≤‡∏á:</span> <b id="dBarber">0</b></div>
            <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:800;"><span style="color:#64748b;">üè† ‡∏£‡πâ‡∏≤‡∏ô:</span> <b id="dShop">0</b></div>
        </div>
    </div>
    <div id="settleBarContainer" style="margin-bottom:18px;"><div id="settleBar"></div> </div>
    <div id="dServiceStats"></div>
    <hr style="border:0; border-top:1px solid #e2e8f0; margin-top:15px;">
    <div id="dailyList"></div>
</div>
<div id="p3" class="page" 
<div id="modalSet" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); z-index:9999; align-items:center; justify-content:center;">  
    <div style="background:#fff; width:92%; max-width:400px; border-radius:35px; box-shadow:0 20px 60px rgba(0,0,0,0.15); overflow:hidden; padding:10px 25px 30px;">
        <div style="width:40px; height:5px; background:#f1f5f9; border-radius:10px; margin:5px auto 20px;"></div>
        <h3 style="margin:0 0 20px; font-size:20px; color:#1a237e; font-weight:800; text-align:center;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
        </div>
</div>
 <div class="card" style="background:#fff; border-radius:25px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.08); margin-bottom:15px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><b style="font-size:16px; color:#92400e;"><i class="fas fa-wallet"></i> ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</b><div id="accLight" style="background:#22c55e; width:10px; height:10px; border-radius:50%; box-shadow:0 0 8px #22c55e;"></div></div>
        <div style="display:flex; gap:12px; margin-bottom:25px;">
            <div style="flex:1; background:#fff; border-radius:22px; padding:18px 10px; text-align:center; border:1px solid #f1f5f9;"><small style="font-size:11px; color:#64748b; font-weight:700;">‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°</small><b style="font-size:22px; color:#1e293b; font-weight:900; display:block;" id="accOldVal">‡∏ø0</b></div>
            <div style="flex:1; background:#fff; border-radius:22px; padding:18px 10px; text-align:center; border:1px solid #f1f5f9;"><small style="font-size:11px; color:#64748b; font-weight:700;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small><b style="font-size:22px; color:#1e293b; font-weight:900; display:block;" id="accTodayVal">‡∏ø0</b></div>
        </div>
        <div style="text-align:center; margin-bottom:20px;"><div style="font-size:48px; font-weight:900; color:#1a237e; letter-spacing:-1px;">‡∏ø<span id="accNet">0</span></div><div id="accStatus" style="margin-top:5px; font-size:14px; font-weight:800; color:#64748b;">‡∏£‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div></div>
        <div style="margin-bottom:15px;">
            <div style="display:flex; align-items:center; background:#f1f5f9; border-radius:15px; padding:0 15px; margin-bottom:8px; height:50px;"><i class="fas fa-calendar-alt" style="color:#6366f1;"></i><input type="date" id="accDate" style="flex:1; border:none; background:none; font-size:16px; font-weight:600; padding-left:10px; outline:none;"></div>
            <div style="display:flex; align-items:center; background:#f1f5f9; border-radius:15px; padding:0 15px; height:50px;"><i class="fas fa-pen-nib" style="color:#94a3b8;"></i><input type="text" id="accNote" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥..." style="flex:1; border:none; background:none; font-size:15px; padding-left:10px; outline:none;"></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button onclick="clearAccount()" style="background:linear-gradient(135deg,#10b981,#059669); color:#fff; border:none; border-radius:18px; padding:15px 5px; font-size:14px; font-weight:800;"><i class="fas fa-check-double"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô</button>
            <button onclick="openHistoryModal()" style="background:#fff; color:#3b82f6; border:2px solid #3b82f6; border-radius:18px; padding:15px 5px; font-size:14px; font-weight:800;"><i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</button>
        </div>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div onclick="$('histDate').showPicker()" style="background:linear-gradient(135deg,#f59e0b,#d97706); border-radius:25px; padding:20px 10px; text-align:center; color:#fff; position:relative;">
            <i class="fas fa-search-dollar" style="font-size:28px; margin-bottom:5px; display:block;"></i><b style="font-size:14px;">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</b><input type="date" id="histDate" onchange="loadHistDaily()" style="position:absolute; inset:0; opacity:0; cursor:pointer;">
        </div>
        <div onclick="$('histMonth').showPicker()" style="background:linear-gradient(135deg,#6366f1,#4338ca); border-radius:25px; padding:20px 10px; text-align:center; color:#fff; position:relative;">
            <i class="fas fa-calendar-check" style="font-size:28px; margin-bottom:5px; display:block;"></i><b style="font-size:14px;">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</b><input type="month" id="histMonth" onchange="loadHistMonth()" style="position:absolute; inset:0; opacity:0; cursor:pointer;">
        </div>
    </div>
    <div id="histResult" style="margin-top:15px; background:#fff; border-radius:20px; padding:15px; box-shadow:0 8px 20px rgba(0,0,0,0.05); display:none;"></div>
</div>

<div id="historyModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center; padding:20px;">
    <div style="background:#fff; width:100%; max-width:400px; border-radius:30px; padding:25px; max-height:80vh; overflow-y:auto; position:relative;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><b style="font-size:20px; color:#1e293b;">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</b><i class="fas fa-times" onclick="$('historyModal').style.display='none'" style="cursor:pointer; font-size:22px; color:#94a3b8;"></i></div>
        <div id="barber_acc_logs_list"></div>
    </div>
</div>
<div id="modalSet" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); z-index:9999; align-items:flex-end; justify-content:center;">
    <div style="background:#fff; width:92%; max-width:400px; border-radius:35px; margin-bottom:110px; box-shadow:0 20px 60px rgba(0,0,0,0.15); overflow:hidden; padding:10px 25px 30px;">
        <div style="width:40px; height:5px; background:#f1f5f9; border-radius:10px; margin:5px auto 20px;"></div>
        <h3 style="margin:0 0 20px; font-size:20px; color:#1a237e; font-weight:800; text-align:center;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
        <label style="display:block; font-size:11px; font-weight:800; color:#94a3b8; margin-bottom:8px;">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label>
        <input type="text" id="setShop" style="width:100%; height:55px; border-radius:18px; border:none; background:#f8fafc; text-align:center; font-size:16px; font-weight:700; outline:none; margin-bottom:12px;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
            <input type="number" id="setPerc" placeholder="% ‡∏ä‡πà‡∏≤‡∏á" style="height:55px; border-radius:18px; border:none; background:#f8fafc; text-align:center; font-weight:700; outline:none;">
            <input type="number" id="setGuar" placeholder="‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô" style="height:55px; border-radius:18px; border:none; background:#f8fafc; text-align:center; font-weight:700; outline:none;">
        </div>
        <select id="setTheme" style="width:100%; height:55px; border-radius:18px; border:none; background:#f8fafc; padding:0 15px; font-weight:700; outline:none; margin-bottom:12px;">
            <option value="light">üå§ ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á</option><option value="navy">üåå ‡πÇ‡∏´‡∏°‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô</option><option value="dark">üåë ‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏≥-‡∏ó‡∏≠‡∏á</option>
        </select>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:18px;">
            <select id="setSound" style="height:55px; border-radius:18px; border:none; background:#f8fafc; text-align:center; font-weight:700; outline:none;"><option value="on">üîä ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</option><option value="off">üîá ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</option></select>
            <select id="setVoice" style="height:55px; border-radius:18px; border:none; background:#f8fafc; text-align:center; font-weight:700; outline:none;"><option value="female">üë∏ ‡∏´‡∏ç‡∏¥‡∏á</option><option value="male">ü§µ ‡∏ä‡∏≤‡∏¢</option></select>
        </div>
        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px;">
            <button onclick="saveSettings()" style="background:#1e3a8a; color:#fff; height:65px; border-radius:22px; border:none; font-weight:800; font-size:18px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button onclick="$('modalSet').style.display='none'" style="background:#fff5f5; color:#e11d48; height:65px; border-radius:22px; border:none; font-size:32px; display:flex; align-items:center; justify-content:center;">‚èª</button>
        </div>
        <button onclick="clearAllData()" style="width:100%; margin-top:20px; background:none; border:none; color:#fca5a5; font-size:14px; font-weight:700; text-decoration:underline;">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
</div>
<nav>
    <div onclick="go(1)" class="nav-item active"><i class="fas fa-edit"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span></div>
    <div onclick="go(2)" class="nav-item"><i class="fas fa-history"></i><span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span></div>
    <div onclick="go(3)" class="nav-item"><i class="fas fa-wallet"></i><span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span></div>
</nav>
<script>
/* ======================================================
   STATE
====================================================== */
const KEY = {
  DB: "barber_db",
  ARCH: "barber_archives",
  CONF: "barber_conf",
  ACC: "barber_account"
};

let db = JSON.parse(localStorage.getItem(KEY.DB) || "[]");
let archives = JSON.parse(localStorage.getItem(KEY.ARCH) || "[]");
let conf = JSON.parse(localStorage.getItem(KEY.CONF) || '{"perc":50,"guar":0}');
let account = JSON.parse(localStorage.getItem(KEY.ACC) || '{"balance":0,"logs":[]}');
let payMethod = ""; // FIX: ‡∏Å‡∏±‡∏ô ReferenceError

/* ======================================================
   UTILS
====================================================== */
const $ = id => document.getElementById(id);
const saveDB = () => localStorage.setItem(KEY.DB, JSON.stringify(db));
const saveArch = () => localStorage.setItem(KEY.ARCH, JSON.stringify(archives));
const saveConf = () => localStorage.setItem(KEY.CONF, JSON.stringify(conf));
const saveAcc = () => localStorage.setItem(KEY.ACC, JSON.stringify(account));
const d10 = d => (d||"").slice(0,10);

/* ======================================================
   RENDER DAY (‡∏´‡∏ô‡πâ‡∏≤ 2)
====================================================== */
function renderDay() {
  const dInp = $("dateInp").value, 
        allRec = db.filter(r => d10(r.date) === dInp), 
        today = allRec.filter(r => r.type !== 'HOLIDAY'), 
        isHoliday = allRec.some(r => r.type === 'HOLIDAY');
  
  let tot = 0, trans = 0, cash = 0, tips = 0, listHtml = "";
  let stats = {}; // <--- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏±‡∏ö‡∏´‡∏±‡∏ß

  today.slice().sort((a,b) => a.time.localeCompare(b.time)).forEach((r, i) => {
    const p = +r.price||0, t = +r.tip||0; 
    tot += p; tips += t;
    (r.pay === 'Trans') ? trans += (p + t) : cash += p;

    // --- üìä ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (‡∏ô‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å) ---
    const job = r.hair || "‡∏ï‡∏±‡∏î‡∏ú‡∏°";
    stats[job] = (stats[job] || 0) + 1;
    if (r.svcs) r.svcs.forEach(s => { if(s) stats[s] = (stats[s] || 0) + 1; });

    const jobDesc = r.hair ? (r.svcs?.length ? `${r.hair}+${r.svcs.join('+')}` : r.hair) : (r.svcs?.length ? r.svcs.join('+') : "‡∏ï‡∏±‡∏î‡∏ú‡∏°");
    listHtml += `
    <div class="history-row" style="padding:15px; border-bottom:1px solid #f1f5f9; background:#fff;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <span style="font-weight:800; font-size:14px; color:#1e293b;">${i+1}. [${r.time}] | ${jobDesc}</span>
                ${t ? `<small style="color:#be185d; display:block; font-weight:bold;">‡∏ó‡∏¥‡∏õ: ‡∏ø${t}</small>` : ''}
            </div>
            <div style="text-align:right;">
                <b style="font-size:16px;">‡∏ø${p}${t ? ` <span style="color:#be185d;">(+${t})</span>` : ''}</b><br>
                <small style="font-weight:bold; color:#64748b;">${r.pay==='Trans'?'üì± ‡πÇ‡∏≠‡∏ô':'üíµ ‡∏™‡∏î'} <i class="fas fa-trash-alt" onclick="delRec(${r.id})" style="color:#ef4444; margin-left:5px; cursor:pointer;"></i></small>
            </div>
        </div>
    </div>`;
  });
  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡∏ä‡πà‡∏≤‡∏á/‡∏£‡πâ‡∏≤‡∏ô
  const bEarn = isHoliday ? 0 : Math.max(tot * (conf.perc / 100), conf.guar) + tips;
  const sEarn = isHoliday ? 0 : tot - (bEarn - tips);
  const settle = cash - bEarn;

  // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
  $("dTotal").innerText = tot.toLocaleString();
  $("dBarber").innerText = Math.floor(bEarn).toLocaleString();
  $("dShop").innerText = Math.floor(sEarn).toLocaleString();
  $("dCounts").innerText = `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${today.length} ‡∏Ñ‡∏ô`;

  // 2. ‡∏û‡πà‡∏ô‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏ô‡∏±‡∏ö‡∏ï‡∏±‡∏î/‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô/‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î) ‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡πÄ‡∏•‡∏¢
  let sH = `<div style="display:flex; flex-wrap:wrap; gap:6px; justify-content:center; margin:10px 0;">`;
  for (let s in stats) {
    const isHair = s.includes("‡∏ó‡∏£‡∏á") || s.includes("‡∏ï‡∏±‡∏î‡∏ú‡∏°") || s.includes("‡πÄ‡∏î‡πá‡∏Å");
    sH += `<span style="background:${isHair ? '#10b981' : '#6366f1'}; color:#fff; padding:3px 10px; border-radius:8px; font-size:11px; font-weight:800;">${s}: ${stats[s]}</span>`;
  }
  const statsDiv = $("dServiceStats") || document.querySelector(".stats-area");
  if (statsDiv) statsDiv.innerHTML = sH + `</div>`;

  // 3. ‡πÅ‡∏ñ‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô + ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏¥‡∏ô
  let txt = "‚úÖ ‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ", bg = "#dcfce7", clr = "#166534";
  if (tot === 0 && !isHoliday) { txt = "üõ°Ô∏è ‡∏£‡πâ‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô"; bg = "#7c3aed"; clr = "#fff"; }
  else if (settle < 0) { txt = `üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ‡∏ø${Math.abs(Math.floor(settle)).toLocaleString()}`; bg = "#2563eb"; clr = "#fff"; }
  else if (settle > 0) { txt = `ü§µ ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${Math.abs(Math.floor(settle)).toLocaleString()}`; bg = "#fee2e2"; clr = "#991b1b"; }

  const settleArea = $("settleBarContainer");
  if (settleArea) {
    settleArea.innerHTML = `
      <div style="display:flex; gap:10px; width:100%; margin-top:5px;">
        <div style="flex:1; height:50px; background:${bg}; color:${clr}; display:flex; align-items:center; justify-content:center; border-radius:15px; font-weight:900; font-size:14px; box-shadow:0 4px 10px ${bg}66;">${txt}</div>
        <button onclick="saveAndGo('${dInp}',${tot},${sEarn},${bEarn})" style="width:60px; height:50px; background:linear-gradient(135deg,#f97316,#ea580c); border:none; border-radius:15px; color:#fff; font-size:24px; cursor:pointer; box-shadow:0 4px 10px rgba(234,88,12,0.3);">‚úàÔ∏è</button>
      </div>`;
  }

  $("dailyList").innerHTML = listHtml || "<center style='padding:40px; opacity:0.3;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</center>";
}
/* ======================================================
   SAVE & CLOSE DAY
====================================================== */
function saveAndGo() {
    const d = $("date")?.value || $("histDate")?.value;
    const today = db.filter(r => r.date === d);
    if (!today.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏õ‡∏¥‡∏î");

    const total = today.reduce((s, r) => s + Number(r.price || 0), 0);
    // ü§µ ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ (‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á + ‡∏ó‡∏¥‡∏õ)
    const barberEarn = today.reduce((s, r) => s + (Number(r.price) * 0.5), 0); 
    // üì± ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô (‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
    const transInShop = today.filter(r => r.pay === "Transfer").reduce((s, r) => s + Number(r.price || 0), 0);
    // ‚úÖ ‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå (Settle): ‡πÄ‡∏≠‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏ñ‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà ‡∏´‡∏±‡∏Å‡∏•‡∏ö‡∏Å‡∏±‡∏ö ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ
    const settle = transInShop - barberEarn;
    // ‡∏ñ‡πâ‡∏≤ settle ‡πÄ‡∏õ‡πá‡∏ô + ‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á | ‡∏ñ‡πâ‡∏≤ settle ‡πÄ‡∏õ‡πá‡∏ô - ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏ß‡∏±‡∏Å‡∏™‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô
    account.balance = (Number(account.balance) || 0) + settle;
    
    archives.unshift({ date: d, total, barber: barberEarn, settle, count: today.length, stats: countStats(today), details: today });
    saveAcc(); saveArch(); 
    
    alert(settle >= 0 ? `‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ‡∏ø${settle}` : `‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${Math.abs(settle)}`);
    go(3); // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
}
 
/* ======================================================
   ACCOUNT (‡∏´‡∏ô‡πâ‡∏≤ 3)
====================================================== */
function loadAccountStatus() {
    const dInp = $("accDate").value; if (!dInp) return;
    const day = archives.find(a => (a.date || "").slice(0, 10) === dInp);
    const todaySettle = (day && !day.cleared) ? Number(day.settle || 0) : 0;
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå
    const oldBal = Number(account.balance || 0);
    const net = oldBal + todaySettle;

    $("accOldVal").innerText = "‡∏ø" + oldBal.toLocaleString();
    $("accTodayVal").innerText = "‡∏ø" + todaySettle.toLocaleString();
    $("accNet").innerText = Math.abs(net).toLocaleString();
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÑ‡∏ü‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    const color = todaySettle > 0 ? "#ef4444" : (todaySettle < 0 ? "#3b82f6" : "#22c55e");
    $("accLight").style.background = color;
    $("accLight").style.boxShadow = `0 0 8px ${color}`;
}
function clearAccount() {
    const amt = Number(account.balance || 0); if (!amt) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á");
    account.logs.unshift({ date: new Date().toISOString().slice(0,10), amount: -amt, note: "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô" });
    account.balance = 0; saveAcc(); loadAccountStatus();
}
function openHistoryModal() {
    $("historyModal").style.display = "flex";
    $("barber_acc_logs_list").innerHTML = account.logs.length ? account.logs.map(l => `<div style="padding:8px;border-bottom:1px solid #eee">üìÖ ${l.date} | ‡∏ø${Math.abs(l.amount)}<br><small>${l.note||""}</small></div>`).join("") : "<center style='opacity:.4'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</center>";
}
const clearAccountOnly = () => confirm("‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?") && (localStorage.removeItem(KEY.ACC), location.reload());
 function resetAccountOnly() {
    if (!confirm("‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ")) return;
    account = { balance: 0, logs: [] };
    saveAccount();
    location.reload();
}
/* ======================================================
   REPORT
====================================================== */
function loadHistDaily() {
    const d = $("histDate").value, f = archives.find(a => a.date === d), res = $("histResult");
    if (!f) return res.innerHTML = "<center style='padding:20px; color:#ef4444;'>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</center>";

    // 1. ‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏á‡∏ú‡∏° / ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)
    let sB = "", hB = "";
    if (f.stats) {
        for (let s in f.stats) {
            const style = `display:inline-block; padding:2px 8px; border-radius:8px; font-size:11px; margin:2px; font-weight:800; color:#fff; background:`;
            if (s.includes("‡∏ó‡∏£‡∏á") || s.includes("‡∏ï‡∏±‡∏î‡∏ú‡∏°") || s.includes("‡πÄ‡∏î‡πá‡∏Å")) hB += `<span style="${style}#10b981;">${s}: ${f.stats[s]}</span>`;
            else sB += `<span style="${style}#6366f1;">${s}: ${f.stats[s]}</span>`;
        }
    }
    // 2. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏î‡∏∂‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á ‡πÑ‡∏°‡πà Default)
    const detailsH = (f.details || []).map((r, i) => `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #f1f5f9; min-width:350px;">
            <span style="flex:1; font-size:11px; color:#64748b;">${i+1}. [${r.time}]</span>
            <span style="flex:3; font-weight:700; font-size:13px; color:#1e293b;">${r.hair || ''}${r.svcs?.length ? (r.hair ? '+' : '') + r.svcs.join('+') : ''}</span>
            <span style="flex:1; text-align:right; font-weight:800; color:#1e3a8a;">‡∏ø${(+r.price).toLocaleString()}</span>
            <span style="width:30px; text-align:right;">${r.pay==='Trans'?'üì±':'üíµ'}</span>
        </div>`).join('');
    // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏¥‡∏î‡∏ß‡∏±‡∏ô
    const settle = f.settle || 0;
    let txt = "‚úÖ ‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ", bg = "#dcfce7", clr = "#166534";
    if (f.total === 0) { txt = "üõ°Ô∏è ‡∏£‡πâ‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô"; bg = "#7c3aed"; clr = "#fff"; }
    else if (settle < 0) { txt = `üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ‡∏ø${Math.abs(Math.floor(settle))}`; bg = "#2563eb"; clr = "#fff"; }
    else if (settle > 0) { txt = `ü§µ ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${Math.abs(Math.floor(settle))}`; bg = "#fee2e2"; clr = "#991b1b"; }

    res.style.display = "block";
    res.innerHTML = `
    <div style="background:#fff; border-radius:25px; padding:20px; box-shadow:0 15px 40px rgba(0,0,0,0.15); max-width:500px; margin:auto; position:relative;">
        <i class="fas fa-times" onclick="$('histResult').style.display='none'" style="position:absolute; top:20px; right:20px; color:#94a3b8; cursor:pointer;"></i>
        <b style="font-size:18px; color:#1e3a8a;">üóìÔ∏è ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d}</b><br>
        <div style="background:${bg}; color:${clr}; padding:10px; border-radius:12px; font-weight:900; margin:15px 0; text-align:center;">${txt}</div>
        <div style="background:#f8fafc; border-radius:15px; padding:12px; margin-bottom:15px; text-align:left;">
            <small style="font-weight:900; color:#64748b;">üíá ‡∏ó‡∏£‡∏á‡∏ú‡∏°:</small><br>${hB || '-'}<br>
            <small style="font-weight:900; color:#64748b;">‚ú® ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°:</small><br>${sB || '-'}
        </div>
        <div style="max-height:200px; overflow-y:auto; border-top:2px solid #f8fafc;">${detailsH}</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px; border-top:1px dashed #cbd5e1; padding-top:15px;">
            <div><small>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</small><br><b>‡∏ø${f.total.toLocaleString()}</b></div>
            <div style="text-align:right;"><small>‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</small><br><b style="color:#2563eb;">‡∏ø${Math.floor(f.barber).toLocaleString()}</b></div>
        </div>
        <button onclick="$('histResult').style.display='none'" style="width:100%; margin-top:20px; padding:12px; border:none; border-radius:15px; background:#1e3a8a; color:#fff; font-weight:900;">‡∏õ‡∏¥‡∏î</button>
    </div>`;
}
 function loadHistMonth() {
    const m = $("histMonth").value, area = $("histMonthArea") || $("histResult"), filtered = archives.filter(a => a.date.startsWith(m));
    if (!m || !filtered.length) return area.innerHTML = "<center style='padding:20px; color:#ccc;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</center>";

    let tTot = 0, tBar = 0, tShop = 0, tCust = 0, mStats = {};
    filtered.forEach(a => {
        tTot += a.total; tBar += a.barber; tCust += (a.count || 0);
        tShop += (a.total - (a.barber - (a.tips || 0)));
        if (a.stats) for (let s in a.stats) mStats[s] = (mStats[s] || 0) + a.stats[s];
    });

    let sB = "", hB = "";
    for (let s in mStats) {
        const style = `display:inline-block; color:white; padding:2px 8px; border-radius:8px; font-size:11px; margin:2px; font-weight:800; background:`;
        if (s.includes("‡∏ó‡∏£‡∏á") || s.includes("‡∏ï‡∏±‡∏î‡∏ú‡∏°") || s.includes("‡πÄ‡∏î‡πá‡∏Å")) hB += `<span style="${style}#10b981;">${s}: ${mStats[s]}</span>`;
        else sB += `<span style="${style}#4f46e5;">${s}: ${mStats[s]}</span>`;
    }

    area.style.display = "block";
    area.innerHTML = `
    <div style="padding:15px; background:#f8fafc; border-radius:20px; border:1px solid #e2e8f0;">
        <div style="text-align:center; padding:15px; background:#fff; border-radius:18px; margin-bottom:15px;">
            <small style="color:#64748b; font-weight:bold;">‚úÇÔ∏è ‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (${m})</small>
            <div style="font-size:32px; font-weight:900; color:#1e3a8a;">‡∏ø${tTot.toLocaleString()}</div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
            <div style="background:#dcfce7; padding:12px; border-radius:15px; text-align:center;">
                <small style="color:#166534;">ü§µ ‡∏ä‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏°</small><br><b style="font-size:18px; color:#15803d;">‡∏ø${Math.floor(tBar).toLocaleString()}</b>
            </div>
            <div style="background:#e0f2fe; padding:12px; border-radius:15px; text-align:center;">
                <small style="color:#0369a1;">üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏£‡∏ß‡∏°</small><br><b style="font-size:18px; color:#075985;">‡∏ø${Math.floor(tShop).toLocaleString()}</b>
            </div>
        </div>
        <div style="border-top:1px dashed #cbd5e1; padding-top:12px;">
            <small style="font-weight:900; color:#64748b;">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥:</small>
            <div style="margin:5px 0;">${hB}${sB}</div>
        </div>
        <button onclick="this.parentElement.parentElement.style.display='none'" style="width:100%; margin-top:15px; padding:12px; border:none; border-radius:15px; background:#1e3a8a; color:#fff; font-weight:900;">‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
    </div>`;
}
    /* ======================================================
   TIME UTILS
====================================================== */
function addMinutes(t, mins = 0) {
    if (typeof t !== "string" || !t.includes(":")) return "";
    const [h, m] = t.split(":").map(Number);
    if (isNaN(h) || isNaN(m)) return "";
    const tot = (h * 60 + m + mins + 1440) % 1440;
    return `${String(Math.floor(tot / 60)).padStart(2, "0")}:${String(tot % 60).padStart(2, "0")}`;
}

const getSelectedSvcs = () => 
    [...document.querySelectorAll('input[name="svc"]:checked')].map(el => el.value);

/* ======================================================
   SAVE SERVICE
====================================================== */
function handleSave()function handleSave() {
    try {
        const d = d10($("dateInp")?.value);
        if (!d) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô!");

        const s = $("tStart")?.value || new Date().toTimeString().slice(0,5);
        const pVal = Number($("priceInp")?.value), p = isFinite(pVal) ? pVal : 0;

        const record = {
            id: Date.now(),
            date: d,
            time: s,
            endTime: (typeof addMinutes === "function") ? addMinutes(s, 30) : s,
            hair: $("hairStyle")?.value || "",
            svcs: [$("extra1")?.value, $("extra2")?.value].filter(v => v),
            price: p,
            pay: payMethod || "Cash", 
            type: "SERVICE"
        };

        db.unshift(record);
        saveDB(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ UTILS ‡∏Ç‡∏≠‡∏á‡∏°‡∏∂‡∏á
        
        if (typeof renderDay === "function") renderDay(d);
        if ($("priceInp")) $("priceInp").value = "";
        
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ñ‡πâ‡∏≤‡πÅ‡∏Å‡πà!");
    } catch (e) {
        console.error(e);
        alert("üö® ‡∏û‡∏±‡∏á‡∏ó‡∏µ‡πà: " + e.message);
    }
}
*/======================================================
   GUARANTEE / INSURANCE
====================================================== */

 function handleInsurance() {
  const d = $("dateInp").value, g = +conf.guar || 0;
  if (!d || g <= 0) return alert(!d ? "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô" : "‚ö†Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô");
  if (archives.some(a => a.date === d)) return alert("‚ùå ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
  if (db.some(r => r.date === d && r.type === "GUARANTEE_CLAIM")) return alert("üõ°Ô∏è ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");

  if (confirm("üõ°Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ?")) {
    db.push({
      id: Date.now(), date: d, time: "00:00",
      svcs: ["üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô"], price: 0, pay: "N/A", type: "GUARANTEE_CLAIM"
    });
    saveDB(); renderDay();
    speak(`‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô ${g} ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
  }
}

  function shareLine() {
    const dInp = $("dateInp").value, today = db.filter(r => r.date === dInp); if (!today.length) return;
    const dp = dInp.split('-'), fDate = `${dp[2]}/${dp[1]}/${dp[0]}`;
    let tot=0, cash=0, trans=0, tips=0, stats={};
    let clientList = today.sort((a,b)=>a.time.localeCompare(b.time)).map((r,i)=>{
        const p = Number(r.price)||0, t = Number(r.tip)||0; tot+=p; tips+=t;
        r.pay==='Trans' ? trans+=p : cash+=p;
        if(r.hair&&r.hair.includes("‡πÄ‡∏î‡πá‡∏Å")) stats["‡πÄ‡∏î‡πá‡∏Å"]=(stats["‡πÄ‡∏î‡πá‡∏Å"]||0)+1;
        (r.svcs||[]).forEach(s=>{ if(s) stats[s]=(stats[s]||0)+1; });
        const tShow = r.endTime ? `${r.time}-${r.endTime}` : r.time;
        return `${i+1}. [${tShow}] ${(r.svcs||[]).join('+')} = ${p}${t?` (+‡∏ó‡∏¥‡∏õ ${t})`:''} ${r.pay==='Trans'?'üì±':'üíµ'}`;
    }).join('\n');
    const allowed = ["‡πÄ‡∏î‡πá‡∏Å","‡∏™‡∏£‡∏∞‡∏ú‡∏°","‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î","‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°","‡∏¢‡πâ‡∏≠‡∏°‡∏™‡∏µ"], icons = {"‡πÄ‡∏î‡πá‡∏Å":"üßí","‡∏™‡∏£‡∏∞":"üßº","‡πÇ‡∏Å‡∏ô":"ü™í","‡∏¢‡πâ‡∏≠‡∏°":"üé®"};
    let statText = Object.entries(stats).filter(([k])=>allowed.some(a=>k.includes(a))).map(([k,v])=>`${icons[Object.keys(icons).find(i=>k.includes(i))]||'üîπ'} ${k}: ${v}`).join('\n');
    let bEarn = Math.max(tot*(conf.perc/100), conf.guar) + tips; // ‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ = ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ö‡πà‡∏á + ‡∏ó‡∏¥‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    let settle = cash - bEarn, settleMsg = settle > 0 ? `‚ö†Ô∏è ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ${Math.floor(Math.abs(settle))}` : `üü¶ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ${Math.floor(Math.abs(settle))}`;
    let msg = `üíà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô: Barber Shop\nüìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${fDate}\n-------------------------\nüìù ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (${today.length} ‡∏Ñ‡∏ô):\n${clientList}\n-------------------------\nüìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô:\n${statText}\n-------------------------\nüí∞ ‡∏¢‡∏≠‡∏î: ${tot} | üßß ‡∏ó‡∏¥‡∏õ: ${tips}\nüì± ‡πÇ‡∏≠‡∏ô: ${trans} | üíµ ‡∏™‡∏î: ${cash}\nü§µ ‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ: ${Math.floor(bEarn)}\nüè† ‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ${Math.floor(tot-(bEarn-tips))}\n-------------------------\n${settleMsg}`;
    window.open(`https://line.me/R/msg/text/?${encodeURIComponent(msg)}`);
}
/* ======================================================
   HOLIDAY
====================================================== */
function handleHoliday() {
  const d = $("dateInp")?.value;
  if (!d) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");
  if (db.some(r => r.date === d && r.type === "HOLIDAY")) return alert("üèñÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");

  if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d} ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î?`)) {
    db.push({
      id: Date.now(), date: d, time: "00:00", 
      svcs: ["üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"], price: 0, pay: "N/A", type: "HOLIDAY" 
    });
    saveDB(); renderDay();
    speak("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  }
}
/* ======================================================
   SETTINGS
====================================================== */

function openSettings() {
    const m = $("modalSet"); 
    if(!m) return;

    // ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÉ‡∏ä‡πâ setProperty ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
    m.style.setProperty("display", "flex", "important"); 
    
    // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏û‡∏ß‡∏Å‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏∂‡∏á "‡∏î‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß" ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏û‡∏±‡∏á
    const set = (id,v)=>$(id)&&( $(id).value=v );
    set("setShop",conf.shop||"");
    set("setTheme",conf.theme||"light");
    set("setVoice",conf.voice||"female");
    set("setSound",conf.sound||"on");
    set("setPerc",conf.perc||50);
    set("setGuar",conf.guar||0);
}
function saveSettings(){try{conf = {...conf,shop: $("setShop").value,perc: +$("setPerc").value || 0,guar: +$("setGuar").value || 0,theme: $("setTheme").value,voice: $("setVoice").value,sound: $("setSound").value};saveConf();applyTheme(conf.theme);$("shopNameDisp") && ($("shopNameDisp").innerText = conf.shop);alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");closeAndGoHome();renderDay();}catch(e){alert("‚ùå error: " + e.message);}}
function closeAndGoHome(){$("modalSet") && ($("modalSet").style.display="none");typeof go==="function" ? go(1) : location.reload();}
/* ======================================================
   PAYMENT
====================================================== */
function selectPay(m) {
  // 1. ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global ‡πÅ‡∏•‡∏∞‡∏•‡∏á input hidden ‡∏Ç‡∏≠‡∏á‡∏°‡∏∂‡∏á
  payMethod = (m === 'Trans') ? 'Transfer' : 'Cash'; 
  if($("payType")) $("payType").value = payMethod;

  // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ UI (‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡πÄ‡∏î‡πà‡∏ô ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏à‡∏≤‡∏á)
  const isC = m === 'Cash';
  if ($("btnCash")) $("btnCash").style.transform = isC ? "scale(1.05)" : "scale(1)";
  if ($("btnCash")) $("btnCash").style.opacity = isC ? "1" : "0.5";
  
  if ($("btnTrans")) $("btnTrans").style.transform = isC ? "scale(1)" : "scale(1.05)";
  if ($("btnTrans")) $("btnTrans").style.opacity = isC ? "0.5" : "1";

  console.log("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡πà‡∏≤‡∏¢:", payMethod);
}
/* ======================================================
   CLOSE DAY (manual fallback)
====================================================== */
function closeDay(){const d = $("dateInp")?.value;if(!d) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");if(archives.some(a=>a.date===d))return alert("‚ùå ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");const total  = +$("dTotal").innerText.replace(/,/g,"")||0;const barber = +$("dBarber").innerText.replace(/,/g,"")||0;const shop   = +$("dShop").innerText.replace(/,/g,"")||0;saveAndGo(d,total,shop,barber);}
/* ======================================================
   RECORD
====================================================== */
function delRec(id){if(!confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;db = db.filter(r=>r.id!==id);saveDB();renderDay();}
function editTime(id){const r = db.find(x=>x.id===id); if(!r) return;const s = prompt("‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° (HH:MM)", r.time); if(!s) return;const e = prompt("‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (HH:MM)", r.endTime||"");r.time = s;r.endTime = e || addMinutes(s,30); saveDB();renderDay();}

/* ======================================================
   UI / SYSTEM
====================================================== */
function closeHistoryModal(){ $("historyModal")&&( $("historyModal").style.display="none" ); }
function clearAllData(){if(confirm("üí£ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")){localStorage.clear();location.reload();}}
function updateDateDisplay(v) {if (!v) return;const d = new Date(v);const display = $("dateDisplay");if (display) {display.innerText = "üìÖ " + d.toLocaleDateString("th-TH", {day: "numeric",month: "short",year: "2-digit"});}if (typeof renderDay === "function") {renderDay();}}
function go(n){document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));document.querySelectorAll(".nav-item").forEach(b=>b.classList.remove("active"));$("p"+n)?.classList.add("active");document.querySelectorAll("nav .nav-item")[n-1]?.classList.add("active");if(n===2) renderDay();if(n===3) loadAccountStatus();}
function applyTheme() {const t = (typeof conf !== 'undefined' && conf.theme) ? conf.theme : 'navy';document.body.className = 'theme-' + t;console.log("Theme applied:", t);}
window.onload = () => {if(typeof applyTheme === 'function') applyTheme(); if(typeof renderDay === 'function') renderDay(); };
/* ======================================================
   INIT
====================================================== */
window.addEventListener("DOMContentLoaded",()=>{const t = new Date().toISOString().slice(0,10);$("dateInp")&&( $("dateInp").value=t );updateDateDisplay(t);});
window.onclick = e => { if(e.target === $("historyModal")) closeHistoryModal(); };

 </script>
</body>
</html>
