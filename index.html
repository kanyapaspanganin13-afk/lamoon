<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BarberNote">
    <link rel="apple-touch-icon" href="https://i.ibb.co/kVrdspsT/Barber-note-pro.jpg">
    <title>Barber Note Pro V.13 </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./service-worker.js")
                    .then(reg => console.log("‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!"))
                    .catch(err => console.error("‚ùå SW error:", err));
            });
        }
    </script>
</head>
<style>
    /* 1. ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å */
    :root { 
        --primary: #6366f1; --accent: #0ea5e9; --danger: #ef4444; --success: #22c55e; 
        --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --border: #e2e8f0;
    }
    /* 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ò‡∏µ‡∏° (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£) */
    body.navy { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --accent: #38bdf8; }
    body.dark { --bg: #121212; --card: #1a1a1a; --text: #fbbf24; --accent: #fbbf24; }

    /* 3. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
    * { box-sizing: border-box; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
    body { 
        margin: 0; background: var(--bg); color: var(--text); 
        padding-bottom: 90px; overflow-x: hidden; transition: all 0.3s ease; 
    }
   /* 4. ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏¢‡πå‡πÄ‡∏≠‡∏≤‡∏ï‡πå (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á) */
.container { 
    padding: 15px; 
    max-width: 500px; 
    margin: auto; 
    position: relative; 
    z-index: 1; 
}
/* 4. ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏¢‡πå‡πÄ‡∏≠‡∏≤‡∏ï‡πå (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢) */
.page { 
    display: none; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô */
    background: var(--card);
    opacity: 0.95; 
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 25px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid var(--border);
    min-height: 75vh;    
}

/* ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏•‡∏≤‡∏™ active ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á */
.page.active { 
    display: block !important; 
    animation: slideUp 0.4s ease-out;
}
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 8px; }
/* 5. ‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏≤‡∏£‡πå (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ò‡∏µ‡∏°) */
nav {
    position: fixed; bottom: 0; left: 0; right: 0;
    /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å #ffffff !important ‡πÄ‡∏õ‡πá‡∏ô var(--card) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏ò‡∏µ‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
    background: var(--card) !important; 
    display: flex; justify-content: space-around; 
    height: 75px; align-items: center;
    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ò‡∏µ‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏°‡∏∑‡∏î */
    box-shadow: 0 -5px 20px rgba(0,0,0,0.15); 
    z-index: 99999; 
    /* ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏ò‡∏µ‡∏° */
    border-top: 1px solid var(--border); 
    padding-bottom: env(safe-area-inset-bottom);
    transition: background 0.3s ease; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡∏à‡∏∞‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏î‡∏π‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•‡∏Ñ‡∏£‡∏±‡∏ö */
}
.nav-item { 
    flex: 1; text-align: center; 
    /* ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏ò‡∏µ‡∏° ‡πÅ‡∏ï‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏à‡∏≤‡∏á‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
    color: var(--text);
    opacity: 0.6; 
    cursor: pointer; transition: 0.2s; 
    display: flex; flex-direction: column; align-items: center;
}
.nav-item.active { 
    /* ‡∏™‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏µ Accent ‡∏Ç‡∏≠‡∏á‡∏ò‡∏µ‡∏°‡∏ô‡∏±‡πâ‡∏ô‡πÜ (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á) */
    color: var(--accent) !important; 
    opacity: 1; 
}
.nav-item i { font-size: 22px; display: block; margin-bottom: 2px; }
.nav-item span { font-size: 11px; font-weight: 700; }
    /* 6. ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï */
    .icon-card, input, select { background: var(--card); color: var(--text); }
    .icon-card { 
        border-radius: 15px; padding: 10px 2px; display: flex; flex-direction: column; 
        align-items: center; justify-content: center; gap: 4px; cursor: pointer; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); height: 75px; font-size: 14px; transition: 0.2s;
    }
    .icon-card:active { transform: scale(0.95); }
    input, select { 
        width: 100%; height: 75px; border-radius: 20px; font-size: 20px; font-weight: 700; 
        text-align: center; border: none; outline: none; box-shadow: 0 4px 10px rgba(0,0,0,0.03); 
        appearance: none; -webkit-appearance: none;
    }
        
      /* 7. ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (‡∏Ç‡∏ô‡∏≤‡∏î‡∏ô‡∏¥‡πà‡∏á‡∏™‡∏ô‡∏¥‡∏ó) */

/* ‡∏™‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏° */
#btnCash { background: linear-gradient(135deg, #10b981, #059669); color: white; }
#btnTrans { background: linear-gradient(135deg, #6366f1, #4338ca); color: white; }
#btnMix   { background: linear-gradient(135deg, #81d4fa, #01579b); color: white; }

.btn-pay { 
    height: 75px; 
    font-size: 18px; 
    width: 100%; 
    border-radius: 18px;
    border: 3px solid transparent;
    transition: background 0.2s, opacity 0.2s, filter 0.2s; /* ‡∏•‡∏ö transform ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å transition */
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transform: none !important; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏±‡∏ö */
}
/* ‡∏•‡πá‡∏≠‡∏Ñ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢ */
.btn-pay i {
    transform: none !important;
    display: inline-block;
    margin-bottom: 4px;
}
/* üü¢ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏≤ (‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°) */
.btn-pay.active-cash, 
.btn-pay.active-trans, 
.btn-pay.active-mix { 
    opacity: 1 !important;
    filter: grayscale(0) !important;
    border-color: #ffffff !important; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transform: none !important; /* ‡∏•‡πá‡∏≠‡∏Ñ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏∏‡πà‡∏° */
}

/* ‚ö™ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ */
.btn-pay.is-inactive { 
    background: #e2e8f0 !important; 
    color: #94a3b8 !important; 
    filter: grayscale(1); 
    opacity: 0.5;
    transform: none !important; /* ‡∏•‡πá‡∏≠‡∏Ñ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏∏‡πà‡∏° */
}
    /* 8. ‡πÇ‡∏°‡∏î‡∏≠‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô */
    .modal { 
        position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); 
        display: none; z-index: 1000000; align-items: center; justify-content: center; 
    }
    .modal-content { 
        background: var(--card); color: var(--text); width: 90%; max-width: 400px; 
        border-radius: 25px; padding: 25px; max-height: 85vh; overflow-y: auto; 
    }
    .status-bar { padding: 12px; border-radius: 12px; text-align: center; font-weight: 800; font-size: 14px; margin-bottom: 10px; }
    .acc-main-card { background: var(--card); padding: 20px; border-radius: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 15px; }
    #accHistory { font-size: 12px; max-height: 150px; overflow-y: auto; }
    @keyframes slideUp {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
        </style>
    </head>
<body>
            <div class="container">
            <div id="p1" class="page active" style="padding: 15px; background: #f8fafc;">
                <h2 id="shopNameDisp" style="text-align:center; color:#1e293b; font-weight:900; margin: 10px 0 20px 0; letter-spacing: 1px; text-transform: uppercase;">BARBER SHOP</h2>
                
                <div class="grid-3" style="gap: 12px; margin-bottom: 20px;">
                    <div class="icon-card" style="background:#fff; border:none; box-shadow:0 8px 15px rgba(0,0,0,0.05); border-radius:20px; height:90px; display:flex; flex-direction:column; align-items:center; justify-content:center;" onclick="handleInsurance()">
                        <div style="background:linear-gradient(135deg, #fbbf24, #f59e0b); width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:8px; color:#fff; font-size:18px;">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <span style="color:#1e293b; font-weight:800; font-size:14px;">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</span>
                    </div>
                    
                    <div class="icon-card" style="background:#fff; border:none; box-shadow:0 8px 15px rgba(0,0,0,0.05); border-radius:20px; height:90px; display:flex; flex-direction:column; align-items:center; justify-content:center;" onclick="handleHoliday()">
                        <div style="background:linear-gradient(135deg, #f87171, #ef4444); width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:8px; color:#fff; font-size:18px;">
                            <i class="fas fa-umbrella-beach"></i>
                        </div>
                        <span style="color:#1e293b; font-weight:800; font-size:14px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span>
                    </div>
            
                    <div class="icon-card" style="background:#fff; border:none; box-shadow:0 8px 15px rgba(0,0,0,0.05); border-radius:20px; height:90px; display:flex; flex-direction:column; align-items:center; justify-content:center;" onclick="openSettings()">
                        <div style="background:linear-gradient(135deg, #94a3b8, #475569); width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:8px; color:#fff; font-size:18px;">
                            <i class="fas fa-cog"></i>
                        </div>
                        <span style="color:#1e293b; font-weight:800; font-size:14px;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
                    </div>
                </div>
            
               <div class="grid-3" style="gap:10px; margin-bottom:15px;">
                    <div style="background:#fff; border-radius:18px; border:none; height:75px; position:relative; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
                        <span id="dateDisplay" style="font-weight:800; color:#475569; font-size:18px;">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
                       <input type="date" id="dateInp" onchange="document.getElementById('dateDisplay').innerText = this.value; if(window.updateDateDisplay) updateDateDisplay(this.value); renderDay();" style="position:absolute; opacity:0; width:100%; height:100%; cursor:pointer; z-index:2;">
                    </div>
                    <input type="time" id="tStart" style="height:75px; border-radius:22px; border:none; text-align:center; font-weight:700; background:#fff; color:#1e293b; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
                    <input type="time" id="tEnd" style="height:75px; border-radius:22px; border:none; text-align:center; font-weight:700; background:#fff; color:#1e293b; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
                </div>
            <div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <select id="hairStyle" style="height:70px; border-radius:14px; border:none; font-weight:700; background:#fff; color:#1e293b; box-shadow:0 4px 10px rgba(0,0,0,0.03); padding:0 10px;">
                    <option value="">‚úÇÔ∏è ‡∏ó‡∏£‡∏á‡∏ú‡∏°</option>
                    <option>‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô</option><option>‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î</option><option>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á</option><option>‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á</option>
                    <option>‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£</option><option>‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option><option>‡πÅ‡∏Å‡πâ‡∏ú‡∏°</option><option>‡πÇ‡∏Å‡∏ô‡∏ú‡∏°</option>
                </select>
                <select id="extra1" style="height:70px; border-radius:14px; border:none; font-weight:700; background:#fff; color:#64748b; box-shadow:0 4px 10px rgba(0,0,0,0.03); padding:0 8px;">
                    <option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£1</option>
                    <option value="‡πÄ‡∏î‡πá‡∏Å"> ‡πÄ‡∏î‡πá‡∏Å</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option>
                </select>
                <select id="extra2" style="height:70px; border-radius:14px; border:none; font-weight:700; background:#fff; color:#64748b; box-shadow:0 4px 10px rgba(0,0,0,0.03); padding:0 8px;">
                    <option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£2</option>
                    <option value="‡πÄ‡∏î‡πá‡∏Å"> ‡πÄ‡∏î‡πá‡∏Å</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option>
                </select>
            </div>
            
            <div style="display: grid; grid-template-columns: 1.4fr 1fr; gap: 8px; margin: 10px 0;">
                <div style="position: relative; background: #ffffff; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05);">
                    <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 24px; color: #6366f1; font-weight: 900;">‡∏ø</span>
                    <input type="number" id="priceInp" placeholder="0" inputmode="numeric" 
                        style="width: 100%; height: 85px !important; background: transparent !important; font-size: 45px !important; font-weight: 900 !important; color: #1e293b !important; padding-left: 40px !important; border: none !important;">
                </div>
            
                <input type="number" id="tipInp" placeholder="‡∏ó‡∏¥‡∏õ" inputmode="numeric" 
                    style="width: 100%; height: 85px !important; background: #e1f5fe !important; border-radius: 20px !important; font-size: 32px !important; font-weight: 900 !important; color: #fff !important; border: none !important;">
            </div>
            
           <div class="grid-3" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; margin-bottom:15px;">
    <button id="btnCash" onclick="setPaymentType('Cash')" style="height:70px; border-radius:18px; border:none; background:linear-gradient(135deg, #10b981, #059669); color:#fff; font-weight:700; font-size:18px; box-shadow:0 4px 10px rgba(16,185,129,0.2);">
        <i class="fas fa-money-bill-wave"></i><br>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
    </button>
    <button id="btnTrans" onclick="setPaymentType('Trans')" style="height:70px; border-radius:18px; border:none; background:linear-gradient(135deg, #6366f1, #4338ca); color:#fff; font-weight:700; font-size:18px; box-shadow:0 4px 10px rgba(99,102,241,0.2);">
        <i class="fas fa-qrcode"></i><br>‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢
    </button>
    <button id="btnMix" onclick="setPaymentType('Mix')" style="height:70px; border-radius:18px; border:none; background:linear-gradient(135deg, #81d4fa, #01579b); color:#fff; font-weight:700; font-size:18px; box-shadow:0 4px 10px rgba(245,158,11,0.2);">
        <i class="fas fa-wallet"></i><br>‡∏à‡πà‡∏≤‡∏¢‡∏ú‡∏™‡∏°
    </button>
</div>

<div id="mixPanel" style="display:none; background:#f8fafc; padding:15px; border-radius:20px; border:2px dashed #cbd5e1; margin-bottom:20px;">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div>
            <label style="font-size:18px; color:#64748b;">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î:</label>
            <input type="number" id="mixCash" style="width:100%; height:45px; border-radius:12px; border:1px solid #ddd; text-align:center; font-size:30px;" placeholder="0">
        </div>
        <div>
            <label style="font-size:18px; color:#64748b;">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô:</label>
            <input type="number" id="mixTrans" style="width:100%; height:45px; border-radius:12px; border:1px solid #ddd; text-align:center; font-size:30px;" placeholder="0">
        </div>
    </div>
</div>

<button class="btn-main" onclick="handleSave(event)" style="width:100%; height:90px; border-radius:28px; background:linear-gradient(135deg, #4338ca, #3730a3); color:#fff; border:none; box-shadow:0 15px 35px rgba(67,56,202,0.4); display:flex; align-items:center; justify-content:center; gap:15px;">
    <i class="fas fa-save" style="font-size: 38px;"></i>
    <span style="font-size: 32px; font-weight: 900; letter-spacing:1px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
</button>
</div>
            <div id="p2" class="page" style="max-width:480px; margin:0 auto; padding: 15px; padding-bottom: 100px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                    <div style="background: #3b50ce; padding:18px 15px; border-radius:20px; text-align:center; box-shadow:0 10px 15px -3px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);">
                        <small style="font-weight:800; color:#cbd5e1; text-transform: uppercase; letter-spacing: 0.5px;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
                        <div id="dTotal" style="font-size:36px; font-weight:900; color:#cbd5e1; margin: 5px 0;">0</div>
                        <div id="dCounts" style="font-size:16px; font-weight:700; color:#cbd5e1; background:rgba(255,255,255,0.15); display:inline-block; padding:2px 10px; border-radius:10px;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 0 ‡∏Ñ‡∏ô</div>
                    </div>
            
                   <div style="background:#3b50ce; padding:15px; border-radius:20px; box-shadow:0 10px 15px -3px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); display:flex; flex-direction:column; justify-content:center; gap:8px;">
                
                <div style="display:flex; justify-content:space-between; align-items:center; font-size:15px; font-weight:700;">
                    <span style="color:#cbd5e1; display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-mobile-alt" style="width:18px; color:#60a5fa;"></i> ‡πÇ‡∏≠‡∏ô:
                    </span> 
                    <b id="dTrans" style="color:#ffffff;">0</b>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; font-size:15px; font-weight:700;">
                    <span style="color:#cbd5e1; display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-money-bill-wave" style="width:18px; color:#4ade80;"></i> ‡∏™‡∏î:
                    </span> 
                    <b id="dCash" style="color:#ffffff;">0</b>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; font-size:15px; font-weight:700;">
                    <span style="color:#cbd5e1; display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-cut" style="width:18px; color:#fbbf24;"></i> ‡∏ä‡πà‡∏≤‡∏á:
                    </span> 
                    <b id="dBarber" style="color:#ffffff;">0</b>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; font-size:15px; font-weight:800; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 8px; margin-top: 2px;">
                    <span style="color:#cbd5e1; display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-store" style="width:18px; color:#f472b6;"></i> ‡∏£‡πâ‡∏≤‡∏ô:
                    </span> 
                    <b id="dShop" style="color:#ffffff;">0</b>
                </div>
            </div>
            </div>
                <div id="settleBarContainer" style="margin-bottom:18px;"><div id="settleBar"></div> </div>
                <div id="dServiceStats"></div>
                <hr style="border:0; border-top:1px solid #e2e8f0; margin-top:15px;">
                <div id="dailyList"></div>
            </div>
            
               <div id="p3" class="page" style="max-width:480px; margin:0 auto; padding: 12px; padding-bottom: 100px; background: #f8fafc;">
    
    <div class="card" style="background:#fff; border-radius:25px; padding:20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border:1px solid #fff; margin-bottom: 15px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <b style="font-size:22px; color:#92400e;"><i class="fas fa-wallet"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</b>
            <div id="accLight" style="background:#22c55e; width:10px; height:10px; border-radius:50%; box-shadow:0 0 8px #22c55e;"></div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div style="background:#fff; border-radius:18px; padding:12px; text-align:center; border: 1px solid #f1f5f9; box-shadow: 0 4px 12px rgba(0,0,0,0.03);">
                <small style="font-size:12px; color:#64748b; font-weight:700;">‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°</small>
                <b style="font-size:18px; color:#1e293b; display:block;" id="accOldVal">‡∏ø0</b>
            </div>
            <div style="background:#fff; border-radius:18px; padding:12px; text-align:center; border: 1px solid #f1f5f9; box-shadow: 0 4px 12px rgba(0,0,0,0.03);">
                <small id="accDateLabel" style="font-size:12px; color:#64748b; font-weight:700;">00/00/0000</small>
                <b style="font-size:18px; color:#1e293b; display:block;" id="accTodayVal">‡∏ø0</b>
            </div>
        </div>

        <div style="background:#fff; border-radius:22px; padding:20px; text-align:center; margin-bottom:15px; border: 1px solid #f1f5f9;">
            <div id="statusBadge" style="display:inline-block; padding:4px 12px; border-radius:10px; font-size:12px; font-weight:700; margin-bottom:8px;">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...
            </div>
            <div style="font-size:32px; font-weight:900; color:#1e293b;" id="accTotalVal">‡∏ø0</div>
        </div>

        <div style="margin-bottom:15px;">
            <div style="display:flex; align-items:center; background:#f1f5f9; border-radius:15px; padding:0 15px; margin-bottom:8px; height:50px;">
                <i class="fas fa-calendar-alt" style="color:#6366f1;"></i>
                <input type="date" id="accDate" style="flex:1; border:none; background:none; font-size:16px; font-weight:600; padding-left:10px; outline:none;">
            </div>
            <div style="display:flex; align-items:center; background:#f1f5f9; border-radius:15px; padding:0 15px; height:50px;">
                <i class="fas fa-pen-nib" style="color:#94a3b8;"></i>
                <input type="text" id="accNote" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..." style="flex:1; border:none; background:none; font-size:15px; padding-left:10px; outline:none;">
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button onclick="clearAccount()" style="background:linear-gradient(135deg, #f59e0b, #d97706); color:#fff; border:none; border-radius:18px; padding:15px 5px; font-size:14px; font-weight:800; cursor:pointer;">
                <i class="fas fa-check-double"></i> ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô
            </button>
            <button onclick="openHistoryModal()" style="background:#fff; color:#3b82f6; border:2px solid #3b82f6; border-radius:18px; padding:15px 5px; font-size:14px; font-weight:800; cursor:pointer;">
                <i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô
            </button>
        </div>  
       <div onclick="$('histMonth').showPicker()" 
     style="background:linear-gradient(135deg, #0b1e59, #190da8);border-radius:25px;padding:12px 10px;text-align:center;color:#fff;position:relative;box-shadow:0 8px 15px rgba(99,102,241,0.2);cursor:pointer;margin-top: 15px; margin-bottom: 12px;">
           <i class="fas fa-calendar-check" style="font-size:24px; margin-bottom:5px; display:block;"></i><b style="font-size:16px;">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</b>
            <input type="month" id="histMonth" onchange="loadHistMonth()" style="position:absolute; inset:0; opacity:0; cursor:pointer;">
</div>

    <div onclick="confirmShareLine()" style="background: linear-gradient(135deg, #25d366, #075e54); border-radius: 25px; padding: 15px; text-align: center; color: #fff; cursor: pointer; box-shadow: 0 8px 15px rgba(37,211,102,0.2); display: flex; align-items: center; justify-content: center; gap: 10px;">       
        <i class="fab fa-line" style="font-size: 24px;"></i>
        <b style="font-size: 16px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</b>
        </div>
     </div> 
  </div>                   
    <div id="modalSet" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(15px); -webkit-backdrop-filter:blur(15px); z-index:9999; display:flex; align-items:center; justify-content:center; padding:15px;">
    
    <div style="background:#ffffff; width:95%; max-width:420px; border-radius:35px; display:flex; flex-direction:column; overflow:hidden; animation: slideUp 0.3s ease-out; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
        
        <div style="padding:25px 20px 15px; text-align:center;">
            <h3 style="margin:0; font-size:24px; color:#1e3a8a; font-weight:900;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
        </div>

        <div style="padding:10px 25px 35px;">
            <input type="text" id="setShop" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô" style="width:100%; height:55px; border-radius:18px; border:1px solid #e2e8f0; background:#f1f5f9; text-align:center; font-size:18px; font-weight:700; color:#1e3a8a; margin-bottom:12px; outline:none;">

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px;">
                <input type="number" id="setPerc" placeholder="% ‡∏ä‡πà‡∏≤‡∏á" style="width:100%; height:55px; border-radius:18px; border:1px solid #e2e8f0; background:#f1f5f9; text-align:center; font-size:18px; font-weight:700; outline:none;">
                <input type="number" id="setGuar" placeholder="‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô" style="width:100%; height:55px; border-radius:18px; border:1px solid #e2e8f0; background:#f1f5f9; text-align:center; font-size:18px; font-weight:700; outline:none;">
            </div>

            <div style="margin-bottom:12px;">
                <select id="setTheme" style="width:100%; height:55px; border-radius:18px; border:1px solid #e2e8f0; background:#f1f5f9; text-align:center; font-size:16px; font-weight:700; color:#475569; outline:none;">
                    <option value="light">üå§ ‡∏ò‡∏µ‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á</option>
                    <option value="navy">üåå ‡∏ò‡∏µ‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô</option>
                    <option value="dark">üåë ‡∏ò‡∏µ‡∏°‡∏î‡∏≥-‡∏ó‡∏≠‡∏á</option>
                </select>
            </div>
<div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:20px;">
    <div style="position: relative; display: flex; align-items: center;">
        <select id="setSound" style="width:100%; height:55px; border-radius:18px; border:1px solid #cbd5e1; background:#f1f5f9; text-align:center; font-size:15px; font-weight:700; outline:none; appearance:none; -webkit-appearance:none; padding-left: 40px;">
            <option value="on">‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</option>
            <option value="off">‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</option>
        </select>
        <i class="fas fa-volume-up" style="position: absolute; left: 15px; color: #475569; pointer-events: none;"></i>
    </div>

    <div style="position: relative; display: flex; align-items: center;">
        <select id="setVoice" style="width:100%; height:55px; border-radius:18px; border:1px solid #cbd5e1; background:#f1f5f9; text-align:center; font-size:15px; font-weight:700; outline:none; appearance:none; -webkit-appearance:none; padding-left: 40px;">
            <option value="female">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏´‡∏ç‡∏¥‡∏á</option>
            <option value="male">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ä‡∏≤‡∏¢</option>
        </select>
        <i class="fas fa-user-friends" style="position: absolute; left: 15px; color: #475569; pointer-events: none;"></i>
    </div>
</div>

<div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-bottom:25px;">
    <button onclick="exportBackup()" style="height:50px; background:#ffffff; border:1px solid #cbd5e1; border-radius:12px; font-size:13px; font-weight:800; color:#1e293b; display:flex; align-items:center; justify-content:center; gap:6px; cursor:pointer;">
        <i class="fas fa-file-download" style="font-size:14px;"></i> 
        <span>‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
    </button>
    
    <input type="file" id="fileInput" style="display:none;" onchange="importBackup(this)">

<button onclick="document.getElementById('fileInput').click()" style="height:50px; background:#ffffff; border:1px solid #cbd5e1; border-radius:12px; font-size:13px; font-weight:800; color:#1e293b; display:flex; align-items:center; justify-content:center; gap:6px; cursor:pointer;">
    <i class="fas fa-file-upload" style="font-size:14px;"></i> 
    <span>‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤</span>
</button>
    
    <button onclick="clearData()" style="height:50px; background:#fff1f2; border:1px solid #fecaca; border-radius:12px; font-size:13px; font-weight:800; color:#e11d48; display:flex; align-items:center; justify-content:center; gap:6px; cursor:pointer;">
        <i class="fas fa-trash-alt" style="font-size:14px;"></i> 
        <span>‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
    </button>
</div>

            <div style="display:grid; grid-template-columns: 2fr 1.2fr; gap:12px;">
                <button onclick="saveSettings()" style="background:#1e3a8a; color:#fff; height:65px; border-radius:22px; border:none; font-weight:800; font-size:20px; box-shadow: 0 10px 25px rgba(30,58,138,0.3);">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button onclick="$('modalSet').style.display='none'" style="background:#f1f5f9; color:#64748b; height:65px; border-radius:22px; border:none; font-weight:800; font-size:18px;">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</button>
            </div>
        </div>
    </div>
</div>
    <div id="reportModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="reportTitle" style="margin:0; color:#1a237e;">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
            <button onclick="closeReportModal()" style="background:#fee2e2; color:#dc2626; border:none; width:35px; height:35px; border-radius:50%; font-size:18px; cursor:pointer;">‚úï</button>
        </div>
        <div id="reportContent" style="max-height:400px; overflow-y:auto;"></div>
    </div>
</div>
<div id="historyModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; color:#1a237e;">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô</h3>
            <button onclick="closeHistoryModal()" style="background:#fee2e2; color:#dc2626; border:none; width:35px; height:35px; border-radius:50%; font-size:18px; cursor:pointer;">‚úï</button>
        </div>
        <div id="accHistory" style="max-height:400px; overflow-y:auto;"></div>
    </div>
</div>
<div id="linePreview" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center; padding:20px;">
    <div style="background:#fff; width:100%; max-width:450px; padding:20px; border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
        <h3 style="margin:0 0 15px 0; color:#1e293b; font-size:18px; display:flex; align-items:center; gap:8px;">üìù ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
        <textarea id="msgEdit" style="width:100%; height:300px; padding:12px; border:1px solid #cbd5e1; border-radius:10px; font-family:sans-serif; font-size:14px; line-height:1.5; outline:none; resize:none;"></textarea>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="document.getElementById('linePreview').style.display='none'" style="flex:1; padding:12px; background:#f1f5f9; color:#475569; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button onclick="sendToLineFinal()" style="flex:1; padding:12px; background:#22c55e; color:#fff; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ LINE ‚úÖ</button>
        </div>
    </div>
</div>
    <nav>
    <div onclick="go(1)" class="nav-item active"><i class="fas fa-edit"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span></div>
    <div onclick="go(2)" class="nav-item"><i class="fas fa-history"></i><span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span></div>
    <div onclick="go(3)" class="nav-item"><i class="fas fa-wallet"></i><span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span></div>
</nav>
 <script>
            const $ = (id) => document.getElementById(id);
            let db = JSON.parse(localStorage.getItem("barber_db")) || [];
            let archives = JSON.parse(localStorage.getItem("barber_archives")) || [];
            let account = JSON.parse(localStorage.getItem("barber_account")) || { balance: 0, logs: [] };
            let conf = JSON.parse(localStorage.getItem("barber_conf")) || { shop: "Barber Shop", perc: 50, guar: 0 };
            let payMethod = "";
            function save() {
                localStorage.setItem("barber_db", JSON.stringify(db));
                localStorage.setItem("barber_archives", JSON.stringify(archives));
                localStorage.setItem("barber_account", JSON.stringify(account));
                localStorage.setItem("barber_conf", JSON.stringify(conf));
            }
            window.onload = () => {
                const today = new Date().toISOString().split('T')[0];
            
                if ($("dateInp")) $("dateInp").value = today;
                if ($("accDate")) $("accDate").value = today;
                if ($("histDate")) $("histDate").value = today;
                if (conf.shop) $("shopNameDisp").innerText = conf.shop;
                if (conf.theme) applyTheme(conf.theme);
            
                renderDay();
                loadAccountStatus();
            };
            
                function addMinutes(time, mins) {
                if (!time) return "";
                const [h, m] = time.split(":").map(Number);
                const d = new Date();
                d.setHours(h, m + mins, 0, 0);
                return d.toTimeString().slice(0, 5);
            }
            function openReportModal(title, htmlContent) {
                const modal = $("reportModal");
                const modalTitle = $("reportTitle");     
                const modalContent = $("reportContent"); 
                const modalInner = modalContent.parentElement; 
            
                if (!modal || !modalTitle || !modalContent) {
                    console.error("‚ùå ‡∏´‡∏≤ ID Modal ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÄ‡∏ä‡πá‡∏Ñ HTML ‡∏î‡πà‡∏ß‡∏ô!");
                    return;
                }
                modalTitle.innerText = title;
                modalContent.innerHTML = htmlContent;
                modalInner.style.width = "95%";            
                modalInner.style.maxWidth = "650px";       
                modalInner.style.maxHeight = "85vh";       
                modalInner.style.overflowY = "auto";       
                modalInner.style.borderRadius = "24px";    
                modalInner.style.padding = "20px";
                modalInner.style.margin = "auto";
                modal.style.display = "flex";
                modal.style.alignItems = "center";
                modal.style.justifyContent = "center";
            }
            function closeReportModal() {
                $("reportModal").style.display = "none";
            }
              function openHistoryModal() { 
                $("historyModal").style.display = "flex"; 
                if (typeof renderHistoryList === "function") {
                    renderHistoryList(); 
                } else { 
                    console.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderHistoryList ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
                }
            }
            function closeHistoryModal() { 
                $("historyModal").style.display = "none"; 
            }

function confirmDeleteDaily(dateStr) {
    const isConfirm = confirm(`‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n\n‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ)`);
    
    if (isConfirm) {
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏Å
        archives = archives.filter(r => r.date !== dateStr);
        saveData(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
        
        alert(`‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        closeReportModal(); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
        if (typeof renderHistory === "function") renderHistory(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
    }
}
   function handleSave(event) {
    const p = parseInt($("priceInp").value), t = parseInt($("tipInp").value) || 0;
    
    if (!p || !payMethod) {
        return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô!");
    }

    const start = $("tStart").value || new Date().toTimeString().slice(0, 5);
    let cashAmt = 0, transAmt = 0;

    if (payMethod === 'Mix') {
        cashAmt = parseInt($("mixCash").value) || 0;
        transAmt = parseInt($("mixTrans").value) || 0;
        if (cashAmt + transAmt !== p + t) {
            if (!confirm(`‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ö‡∏¥‡∏• (‡∏£‡∏ß‡∏° ${cashAmt + transAmt} / ‡∏ö‡∏¥‡∏• ${p + t})\n‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
        }
    } else {
        payMethod === 'Cash' ? cashAmt = p + t : transAmt = p + t;
    }

    const rec = {
        id: Date.now(), 
        date: $("dateInp").value, 
        time: start, 
        endTime: $("tEnd").value || (typeof addMinutes === 'function' ? addMinutes(start, 30) : start),
        svcs: [$("hairStyle")?.value, $("extra1")?.value, $("extra2")?.value].filter(Boolean),
        price: p, tip: t, pay: payMethod, payCash: cashAmt, payTrans: transAmt, type: "SERVICE"
    };

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    db.push(rec); 
    saveDB(); 
    renderDay(); 
    if (typeof loadAccountStatus === 'function') loadAccountStatus();

    // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    const btnSave = event.currentTarget || document.querySelector(".btn-main");
    if (btnSave) {
        const oldContent = btnSave.innerHTML;
        const oldBg = btnSave.style.background;

        btnSave.style.setProperty("background", "linear-gradient(135deg, #10b981, #059669)", "important");
        btnSave.innerHTML = `<i class="fas fa-check-circle" style="font-size:38px;"></i> <span style="font-size:32px; font-weight:900;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`;

        setTimeout(() => {
            btnSave.style.background = oldBg;
            btnSave.innerHTML = oldContent;
        }, 1200);
    }

    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°
    ["priceInp", "tipInp", "mixCash", "mixTrans"].forEach(id => { if($(id)) $(id).value = ""; });
    payMethod = ""; 
    ["btnCash", "btnTrans", "btnMix"].forEach(id => { if($(id)) $(id).className = "icon-card"; });
    if($("mixPanel")) $("mixPanel").style.display = 'none';
}
            function handleInsurance() {
                const d = $("dateInp").value || new Date().toISOString().split('T')[0], g = parseInt(conf.guar) || 0;
                const speak = (t) => { const m = new SpeechSynthesisUtterance(t); m.lang = 'th-TH'; window.speechSynthesis.speak(m); };
                if (g <= 0) return (speak("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô"), alert("‚ö†Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÉ‡∏ô '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö' ‡∏Å‡πà‡∏≠‡∏ô"));
                if (db.find(r => r.date === d && r.type === "GUARANTEE_CLAIM")) return (speak("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß"), alert("üõ°Ô∏è ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß"));
                if (confirm(`üõ°Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ'?`)) {
                    db.push({ id: Date.now(), date: d, time: "00:00", svcs: ["üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô"], price: 0, pay: "N/A", type: "GUARANTEE_CLAIM" });
                    saveDB(); speak(`‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô ${g} ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`); alert("‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); renderDay();
                }
            }
            function handleHoliday(){
                const d=$("dateInp").value;
                if(!d) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");
                if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d} ‡πÄ‡∏õ‡πá‡∏ô "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"?`)){
                    db.push({id: Date.now(),date: d, time: "00:00",svcs: ["üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"],price: 0, pay: "N/A",type: "HOLIDAY",off: true  });
                    saveDB();
                    const m = new SpeechSynthesisUtterance("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                    m.lang = 'th-TH';
                    window.speechSynthesis.speak(m); 
                    alert("üèñÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                    renderDay();
                }
            }
                function openSettings() {
                if ($("setShop"))  $("setShop").value  = conf.shop  || "";
                if ($("setTheme")) $("setTheme").value = conf.theme || "light";
                if ($("setVoice")) $("setVoice").value = conf.voice || "female";
                if ($("setSound")) $("setSound").value = conf.sound || "on"; 
                if ($("setPerc"))  $("setPerc").value  = conf.perc  || 50;
                if ($("setGuar"))  $("setGuar").value  = conf.guar  || 0;
                $("modalSet").style.display = "flex";
            }
            function applyTheme(t) {
                document.body.className = t;
                const oldStyle = document.getElementById("navyStyle");
                if (oldStyle) oldStyle.remove();
                const s = document.documentElement.style;
            
                // --- ‚òÄÔ∏è ‡∏ò‡∏µ‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á (Default) ---
                s.setProperty('--card', '#ffffff');
                s.setProperty('--text', '#1a237e');
                s.setProperty('--modal-bg', '#f3f4f6'); // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏µ‡∏™‡∏ß‡πà‡∏≤‡∏á
                document.body.style.background = '#f3f4f6';
            
                if (t === 'dark') {
                    // --- üåë ‡∏ò‡∏µ‡∏°‡∏°‡∏∑‡∏î-‡∏ó‡∏≠‡∏á ---
                    s.setProperty('--card', '#262626');
                    s.setProperty('--text', '#fbbf24');
                    s.setProperty('--modal-bg', '#171717'); // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏µ‡∏î‡∏≥
                    document.body.style.background = '#171717';
                } 
                else if (t === 'navy') {
                    // --- üåå ‡∏ò‡∏µ‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô ---
                    s.setProperty('--card', '#ffffff');
                    s.setProperty('--text', '#1a237e');
                    s.setProperty('--modal-bg', '#1a237e'); // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
                    document.body.style.background = '#1a237e';
            
                    const st = document.createElement("style");
                    st.id = "navyStyle";
                    st.innerHTML = `
                        body.navy { background: #1a237e !important; color: #ffffff !important; }
                        .navy .card b, .navy .card span { color: #1e293b !important; }
                        .navy #dTotal, .navy #accNet { color: #1a237e !important; }
                        .nav-item { color: #ffffff !important; opacity: 0.7; }
                        .nav-item.active { color: #facc15 !important; opacity: 1; font-weight: bold; }
                    `;
                    document.head.appendChild(st);
                }
            }
            
    function saveSettings() {
    const shopName = $("setShop").value;
    const shopPerc = $("setPerc").value;
    const shopGuar = $("setGuar").value;
    const shopTheme = $("setTheme").value;
    // --- 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Select) ---
    const shopVoice = $("setVoice") ? $("setVoice").value : "default.mp3"; 

    conf.shop = shopName;
    conf.perc = parseFloat(shopPerc) || 0;
    conf.guar = parseFloat(shopGuar) || 0;
    conf.theme = shopTheme;
    
    // --- 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Å‡∏•‡∏≤‡∏á (conf) ---
    conf.voice = shopVoice; 

    localStorage.setItem('shopName', shopName);
    localStorage.setItem('shopPerc', shopPerc);
    localStorage.setItem('shopGuar', shopGuar);
    localStorage.setItem('shopTheme', shopTheme);
    // --- 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏á‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (LocalStorage) ---
    localStorage.setItem('shopVoice', shopVoice); 

    if($("shopNameDisp")) {
        $("shopNameDisp").innerText = shopName.toUpperCase();
    }
    if (typeof applyTheme === "function") {
        applyTheme(shopTheme); 
    }
    // --- 4. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏£‡∏¥‡∏°) ---
    if (typeof playSuccessSound === "function") {
        playSuccessSound(shopVoice); 
    }

    if (typeof calculateMoney === "function") {
        calculateMoney(); 
    }
    if (typeof renderDay === "function") {
        renderDay(); 
    }
    $("modalSet").style.display = 'none';
    alert("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
}
             function closeAndGoHome(){const m=document.getElementById("modalSet");if(m)m.style.display='none';if(typeof go==='function')go(1);else location.reload()}
             function speak(txt) {if ('speechSynthesis' in window) {const msg = new SpeechSynthesisUtterance(txt); msg.lang = 'th-TH'; window.speechSynthesis.speak(msg);}}       
             function clearAllData(){if(confirm("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")){localStorage.clear();location.reload()}}
             function updateDateDisplay(v){if(!v)return;const d=new Date(v);const el=$("dateDisplay");if(el)el.innerText=d.toLocaleDateString('th-TH',{day:'numeric',month:'short',year:'2-digit'});if(typeof renderDay==="function")renderDay()}window.addEventListener('DOMContentLoaded',()=>{const i=$("dateInp"),t=new Date().toISOString().split('T')[0];if(i){i.value=t;updateDateDisplay(t)}});
function setPaymentType(m) {
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (typeof payMethod !== 'undefined' && payMethod === m) {
        payMethod = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤

        // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ò‡∏µ‡∏°‡πÄ‡∏î‡∏¥‡∏° (‡∏•‡∏ö class ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
        ['btnCash', 'btnTrans', 'btnMix'].forEach(id => {
            const el = $(id);
            if (el) el.className = 'btn btn-pay'; 
        });

        if ($("mixPanel")) $("mixPanel").style.display = 'none';
        return;
    }
    // 2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
    payMethod = m;

    const btns = {
        'Cash': { id: 'btnCash', active: 'active-cash' },
        'Trans': { id: 'btnTrans', active: 'active-trans' },
        'Mix': { id: 'btnMix', active: 'active-mix' }
    };

    Object.keys(btns).forEach(key => {
        const target = $(btns[key].id);
        if (target) {
            if (m === key) {
                // ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡πÉ‡∏™‡πà‡∏™‡∏µ‡∏™‡∏î‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô
                target.className = `btn btn-pay ${btns[key].active}`;
            } else {
                // ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏ó‡∏≤
                target.className = `btn btn-pay is-inactive`;
            }
        }
    });
    // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á mixPanel (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà)
    const mixPanel = $("mixPanel");
    if (mixPanel) {
        if (m === 'Mix') {
            mixPanel.style.display = 'block';
            const total = (parseFloat($("priceInp").value) || 0) + (parseFloat($("tipInp").value) || 0);
            $("mixCash").value = ""; 
            $("mixTrans").value = total; 
        } else {
            mixPanel.style.display = 'none';
        }
    }
}
function updateMixValues() {
    const price = parseFloat($("priceInp").value) || 0;
    const tip = parseFloat($("tipInp").value) || 0;
    const total = price + tip;
    const cash = parseFloat($("mixCash").value) || 0;
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
    const trans = total - cash;
    $("mixTrans").value = trans > 0 ? trans : 0;
}
// ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
if ($("mixCash")) {
    $("mixCash").addEventListener("input", updateMixValues);
}
// ‡πÅ‡∏•‡∏∞‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ó‡∏¥‡∏õ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
if ($("priceInp")) $("priceInp").addEventListener("input", updateMixValues);
if ($("tipInp")) $("tipInp").addEventListener("input", updateMixValues);
   
function addRecord() {
    const dInp = $("dateInp").value;
    const timeInp = $("timeInp").value;
    const price = parseFloat($("priceInp").value) || 0;
    const tip = parseFloat($("tipInp").value) || 0;
    const total = price + tip; // ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö 
    // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ payMethod ‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô setPaymentType ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ// (‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å Input ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ payType)
    const currentPay = payMethod; 
    if (price === 0 && currentPay !== 'Holiday' && currentPay !== 'Guarantee') {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
        return;
    }
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ---
    let finalCash = 0;
    let finalTrans = 0;
    if (currentPay === 'Mix') {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏à‡πà‡∏≤‡∏¢‡∏ú‡∏™‡∏°: ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á Mix
        finalCash = parseFloat($("mixCash").value) || 0;
        finalTrans = parseFloat($("mixTrans").value) || 0;
    } else if (currentPay === 'Cash' || currentPay === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î: ‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
        finalCash = total;
        finalTrans = 0;
    } else if (currentPay === 'Trans' || currentPay === '‡πÇ‡∏≠‡∏ô') {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÇ‡∏≠‡∏ô: ‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏≠‡∏ô
        finalCash = 0;
        finalTrans = total;
    }
    const newRec = {
        id: Date.now(),
        date: dInp,
        time: timeInp,
        price: price,
        tip: tip,
        pay: currentPay, 
        svcs: selectedServices,
        // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏¢‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏î‡∏∂‡∏á‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
        payCash: finalCash,
        payTrans: finalTrans
    };

    db.push(newRec);
    localStorage.setItem("barber_db", JSON.stringify(db));
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");
    
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    if (typeof resetForm === 'function') resetForm();
    renderDay(); 
}  
 // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
function resetForm() {
    $("priceInp").value = "";
    $("tipInp").value = "";
    $("mixCash").value = "";
    $("mixTrans").value = "";
    $("mixPanel").style.display = "none";
    selectedServices = []; // ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
    // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏û‡∏ß‡∏Å checkbox ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏Å‡πá‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡∏ö
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î mixPanel ‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
function togglePayType() {
    const payType = $("payTypeInp").value;
    const panel = $("mixPanel");
    
    if (payType === 'Mix') {
        panel.style.display = "block";
        // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏≠‡∏ô = ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const total = (parseFloat($("priceInp").value) || 0) + (parseFloat($("tipInp").value) || 0);
        $("mixCash").value = "";
        $("mixTrans").value = total;
    } else {
        panel.style.display = "none";
    }
}
// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î" ‡πÉ‡∏´‡πâ "‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô" ‡∏•‡∏î‡∏•‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
$("mixCash").addEventListener("input", function() {
    const total = (parseFloat($("priceInp").value) || 0) + (parseFloat($("tipInp").value) || 0);
    const cash = parseFloat(this.value) || 0;
    const remain = total - cash;
    $("mixTrans").value = remain > 0 ? remain : 0;
});    
   function renderDay(selectedDate) {
    let dInp = selectedDate || ($("dateInp") ? $("dateInp").value : new Date().toISOString().split('T')[0]);
    if ($("dateInp")) $("dateInp").value = dInp;
    let allRec = db.filter(r => r.date === dInp);
    
    if (allRec.length === 0 && typeof archives !== 'undefined') {
        const archivedDay = archives.find(a => a.date === dInp);
        if (archivedDay && archivedDay.details) {
            allRec = archivedDay.details;
        }
    }
    const isHoliday = allRec.some(r => r.type && r.type.toUpperCase() === 'HOLIDAY');
    const stats = {};
    const extraSvcs = ["‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î", "‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤", "‡∏™‡∏£‡∏∞‡∏ú‡∏°"];
    let tot = 0, trans = 0, cash = 0, tips = 0;
    let listHtml = "";
    let realCustomerCount = 0;
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
    allRec
    .slice()
    .sort((a,b) => a.time.localeCompare(b.time))
    .forEach((r, i) => {
        const p = parseFloat(r.price) || 0; 
        const t = parseFloat(r.tip) || 0;
        const rType = r.type ? String(r.type).toUpperCase().trim() : '';
        const currentSvcs = Array.isArray(r.svcs) ? r.svcs : [];
 // ‚úÖ 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å DB)
        tot += p;
        tips += t;
        if (r.pay === 'Mix') {
            // ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            const pCash = parseFloat(r.payCash) || 0;
            const pTrans = parseFloat(r.payTrans) || 0; 
            trans += pTrans;
            // cash ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡∏´‡∏±‡∏Å‡∏ó‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
            // ‡∏ñ‡πâ‡∏≤ r.payCash ‡∏£‡∏ß‡∏°‡∏ó‡∏¥‡∏õ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ pCash - t
            cash += (pCash - t); 
        } else if (r.pay === 'Trans' || r.pay === '‡πÇ‡∏≠‡∏ô') {
            // ‡∏ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ + ‡∏ó‡∏¥‡∏õ ‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô trans
            trans += (p + t);
        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Cash): ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ cash ‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô (‡∏ó‡∏¥‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏ß‡∏Å)
            cash += p;
        }
      // üö® 2. ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
    if (rType === 'HOLIDAY' || rType === 'GUARANTEE' || p === 0) {
        // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö (‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/‡∏Å‡∏≤‡∏£‡∏±‡∏ô‡∏ï‡∏µ/‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡πá‡∏ô 0)
    } else {
    // üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ô‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 1 ‡∏Ñ‡∏ô‡πÄ‡∏™‡∏°‡∏≠‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ï‡∏±‡∏î‡∏ú‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°)
    if (currentSvcs.length > 0) {
        realCustomerCount++; 
    }
    // ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏ï‡∏±‡∏î‡∏ú‡∏°‡∏ö‡πâ‡∏≤‡∏á)
    const cleanExtras = extraSvcs.map(s => s.trim().toLowerCase());
    const hasRealHaircut = currentSvcs.some(s => {
        if (!s) return false;
        const cleanS = s.trim().toLowerCase();
        return !cleanExtras.includes(cleanS);
    });
    if (hasRealHaircut) {
        stats["‡∏ï‡∏±‡∏î‡∏ú‡∏°"] = (stats["‡∏ï‡∏±‡∏î‡∏ú‡∏°"] || 0) + 1;
    }
    // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
    currentSvcs.forEach(s => {
        if (s) stats[s] = (stats[s] || 0) + 1;
    });
}
        // ‚úÖ 3. ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á HTML (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô Mix)
        const timeShow = r.endTime ? `${r.time}-${r.endTime}` : r.time;
        
        let payIcon = r.pay === 'Trans' ? 'üì±' : 'üíµ';
        let mixText = "";
        if (r.pay === 'Mix') {
            payIcon = 'üåì'; // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡πà‡∏≤‡∏¢‡∏ú‡∏™‡∏°
            mixText = `<br><small style="color:#64748b; font-size:10px; font-weight:normal;">(‡∏™‡∏î:${r.payCash}/‡πÇ‡∏≠‡∏ô:${r.payTrans})</small>`;
        } 
        listHtml += `
        <div class="history-row" style="padding:15px; border-bottom:1px solid #f1f5f9; background:#fff;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="width:28px; height:28px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:800; color:#64748b; flex-shrink:0;">
                        ${i+1}
                    </div>
                    <div style="display:flex; flex-direction:column;">
                        <div style="font-weight:800; font-size:14px; color:#1e293b; margin-bottom:2px;">
                            <span style="color:#64748b; font-weight:500;">[${timeShow}]</span> ${currentSvcs.join(' + ')}
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            ${t ? `<small style="color:#be185d; font-weight:700; font-size:11px;">üîπ ‡∏ó‡∏¥‡∏õ: ‡∏ø${t}</small>` : '<small style="color:#94a3b8; font-size:11px;">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏¥‡∏õ)</small>'}
                        </div>
                    </div>
                </div>
                <div style="text-align:right;">
                    <b style="font-size:16px; display:block; color:#1e293b; line-height:1.2;">
                        <span style="font-size:14px;">${payIcon}</span> ‡∏ø${p}${t ? ` <span style="color:#be185d;">(+${t})</span>` : ''}
                        ${mixText}
                    </b>
                    <span style="font-size:11px; font-weight:700; color:#ef4444; cursor:pointer;" onclick="delRec(${r.id})">‡∏•‡∏ö</span>
                </div>
            </div>
        </div>`;
    });

    const bEarn = isHoliday ? 0 : Math.max(tot * (conf.perc / 100), conf.guar) + tips;
    const sEarn = isHoliday ? 0 : tot - (bEarn - tips);
    const settle = isHoliday ? 0 : cash - bEarn;

    if ($("dTotal")) $("dTotal").innerText = tot.toLocaleString();
    if ($("dTrans")) $("dTrans").innerText = trans.toLocaleString();
    if ($("dCash")) $("dCash").innerText = cash.toLocaleString();
    if ($("dBarber")) $("dBarber").innerText = Math.floor(bEarn).toLocaleString();
    if ($("dShop")) $("dShop").innerText = Math.floor(sEarn).toLocaleString();

    if ($("dCounts")) {
        if (isHoliday) {
            $("dCounts").innerText = "üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î";
        } else if (realCustomerCount === 0 && allRec.length > 0) {
            $("dCounts").innerText = "üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ";
        } else if (allRec.length === 0 && allRec.length > 0) {
            $("dCounts").innerText = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        } else {
            $("dCounts").innerText = `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${realCustomerCount} ‡∏Ñ‡∏ô`;
        }
    }

    let sH = `<div style="display:flex; flex-wrap:wrap; gap:5px; justify-content:center; margin-bottom:10px;">`;
    const priority = ["‡∏ï‡∏±‡∏î‡∏ú‡∏°", "‡πÄ‡∏î‡πá‡∏Å"];
    priority.forEach(k => { if (stats[k]) sH += `<span style="background:#4338ca;color:#fff;padding:5px 12px;border-radius:8px;font-size:11px;font-weight:800;">${k}: ${stats[k]}</span>`; });
    for (let s in stats) { if (!priority.includes(s)) sH += `<span style="background:#64748b;color:#fff;padding:5px 12px;border-radius:8px;font-size:11px;font-weight:800;">${s}: ${stats[s]}</span>`; }
    if ($("dServiceStats")) $("dServiceStats").innerHTML = sH + `</div>`;

    let txt = "", statusColor = "", icon = "";
    if (isHoliday) {
        txt = "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"; statusColor = "#1e40af"; icon = "üèñÔ∏è";
    } else if (allRec.length === 0) {
        txt = "‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."; statusColor = "#64748b"; icon = "üìù";
    } else if (tot === 0) {
        txt = "‡∏£‡πâ‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô"; statusColor = "#0369a1"; icon = "üõ°Ô∏è";
    } else if (settle > 0) {
        txt = `‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${Math.floor(settle).toLocaleString()}`; statusColor = "#b91c1c"; icon = "üë®‚Äçüé®";
    } else if (settle < 0) {
        txt = `‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ‡∏ø${Math.floor(Math.abs(settle)).toLocaleString()}`; statusColor = "#4338ca"; icon = "üè†";
    } else {
        txt = "‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ"; statusColor = "#15803d"; icon = "‚úÖ";
    }

    const actionBox = $("settleBarContainer");
    if (actionBox) {
        actionBox.style.display = "flex";
        actionBox.style.gap = "10px";
        actionBox.innerHTML = `
            <div id="settleBar" style="flex:8; height:55px; background:#f1f5f9; display:flex; align-items:center; justify-content:center; border-radius:18px; font-weight:800; font-size:14px; color:${statusColor}; border:1px solid #e2e8f0;">
                <span style="margin-right:8px; font-size:18px;">${icon}</span> ${txt}
            </div>
            <button onclick="saveAndGo('${dInp}', ${tot})" style="flex:2.2; height:55px; background:#ff6f00; color:#fff; border-radius:18px; border:none; font-size:22px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                <i class="fas fa-paper-plane"></i>
            </button>`;
    }
const dList = $("dailyList");
if (dList) {
    const dateParts = dInp.split('-'); 
    let displayDateBE = dInp;

    if (dateParts.length === 3) {
        const d = dateParts[2];
        const m = dateParts[1];
        const yBE = parseInt(dateParts[0]) + 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
        displayDateBE = `${d}/${m}/${yBE}`;
    }

    dList.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; background: #ffffff; padding: 8px 12px; border-radius: 12px; border-bottom: 2px solid #f1f5f9; margin-bottom: 10px;">
            
            <div style="display: flex; align-items: center; gap: 10px;">
                <b style="font-size: 16px; color: #1e293b;">üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</b>
              
            <div style="position: relative; background: #f1f5f9; padding: 5px 12px; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; align-items: center; cursor: pointer; width: 180px;"> 
                <span style="font-size: 14px; font-weight: 700; color: #6366f1; width: 100%; text-align: center;">${displayDateBE}</span>
                
            <input type="date" id="reportDateSelector" value="${dInp}" 
                   onchange="renderDay(this.value)" 
                   style="position: absolute; opacity: 0; left: 0; top: 0; width: 100%; height: 100%; cursor: pointer;">
        </div>
    </div>

            <i class="fab fa-line" style="color: #22c55e; font-size: 32px; cursor: pointer;" onclick="shareLine()"></i>
        </div>

        <div style="padding: 0 5px;">
            ${isHoliday ? `<center style='padding:30px; color:#64748b;'>üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (${displayDateBE})</center>` : (listHtml || "<center style='padding:30px; color:#94a3b8;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</center>")}
        </div>
    `;
}
}               
        function clearDailyData() {
                const confirmDelete = confirm("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ)");
                if (confirmDelete) {
                    localStorage.removeItem("barber_db"); 
                    alert("‚úÖ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                    location.reload();
                }
            }
    function saveAndGo(date, total) {
    const allToday = db.filter(r => r.date === date);
    const todayData = allToday.filter(r => r.type === 'SERVICE' || r.type === 'GUARANTEE');
    const isHoliday = allToday.some(r => r.type === 'HOLIDAY');
    let cash = 0, trans = 0, tips = 0, count = 0, stats = {};
    const extraSvcs = ["‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î", "‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤", "‡∏™‡∏£‡∏∞‡∏ú‡∏°"];

    todayData.forEach(r => {
        const p = Number(r.price) || 0, t = Number(r.tip) || 0;
        tips += t;
        r.pay === "Cash" ? cash += p : trans += (p + t);
        const svcs = Array.isArray(r.svcs) ? r.svcs : [r.svcs];
        
        if (r.type !== 'GUARANTEE') {
            const isRealCut = svcs.some(s => s && !extraSvcs.includes(s));
            if (isRealCut) count++;
            svcs.forEach(s => { 
                if(s) stats[s] = (stats[s] || 0) + 1; 
            });
        }
    });

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
    const bEarn = isHoliday ? 0 : Math.max(total * (conf.perc / 100), conf.guar) + tips;
    const settle = isHoliday ? 0 : cash - bEarn;
    const idx = archives.findIndex(a => a.date === date);

    const data = {
        date,
        total: Number(total),
        cash,
        trans,
        tips,
        barber: Math.floor(bEarn),
        shop: isHoliday ? 0 : total - (bEarn - tips),
        settle,
        count,
        stats,
        details: allToday, 
        off: isHoliday,     
        type: isHoliday ? "HOLIDAY" : "WORK"
    };    
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏° (Balance) ---
    if (idx > -1) {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏¥‡∏°: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á settle ‡πÑ‡∏õ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á balance
        account.balance = (Number(account.balance) || 0) + (settle - (archives[idx].settle || 0));
        archives[idx] = data;
    } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà: ‡∏ö‡∏ß‡∏Å settle ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡πÜ
        account.balance = (Number(account.balance) || 0) + settle;
        archives.push(data);
    }
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô db ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î
    db = db.filter(r => r.date !== date);
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Memory/Storage
    save(); 
    // --- ‚úÖ ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ---
    if (typeof loadAccountStatus === "function") {
        loadAccountStatus();
    }
    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
    go(3); // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
}
    function toggleAccHistory() {const w = $("accHistoryWrapper"); w.style.display = w.style.display === "none" ? "block" : "none";$("accHistory").innerHTML = account.logs.map(l => `<div style="padding:5px; border-bottom:1px solid #eee;">${l.date}: ‡∏ø${l.amount} (${l.note})</div>`).join('') || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥";}    
    function loadAccountHistory() {let h = account.logs.map(l => `<div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;"><div><b style="font-size:14px; color:#1e293b;">${l.date}</b><br><small style="color:#64748b;">${l.note}</small></div><b style="color:${l.amount >= 0 ? '#16a34a' : '#dc2626'};">${l.amount >= 0 ? '+' : ''}‡∏ø${Math.abs(l.amount).toLocaleString()}</b></div> `).join('');if($("accHistory")) {$("accHistory").innerHTML = h || '<center style="padding:40px; color:#94a3b8;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</center>';}}     
  
    function loadAccountStatus() {
    const now = new Date();
    const dateLabel = now.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
    if ($("accDateLabel")) $("accDateLabel").innerText = dateLabel;

    // 1. ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°
    const oldBalance = Number(account.balance) || 0;
    if ($("accOldVal")) $("accOldVal").innerText = `‡∏ø${oldBalance.toLocaleString()}`;

    // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    const today = now.toISOString().split('T')[0];
    const todayEntries = db.filter(r => r.date === today && (r.type === 'SERVICE' || r.type === 'GUARANTEE'));
    
    let tCash = 0, tTotal = 0, tTips = 0;
    todayEntries.forEach(r => {
        tTotal += (Number(r.price) || 0);
        tTips += (Number(r.tip) || 0);
        if (r.pay === "Cash") tCash += (Number(r.price) || 0) + (Number(r.tip) || 0);
    });

    let settleToday = 0;
    // --- ‡∏ï‡∏£‡∏£‡∏Å‡∏∞: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0 / ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Å‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡∏ô VS ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô ---
    if (todayEntries.length > 0) {
        const commissionEarn = tTotal * (conf.perc / 100);
        const baseEarn = (commissionEarn >= conf.guar) ? commissionEarn : Number(conf.guar);
        const bEarn = baseEarn + tTips;
        settleToday = tCash - bEarn;
    } else {
        settleToday = 0; 
    }

    if ($("accTodayVal")) $("accTodayVal").innerText = `‡∏ø${settleToday.toLocaleString()}`;

    // 3. ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
    const net = oldBalance + settleToday;
    if ($("accTotalVal")) $("accTotalVal").innerText = `‡∏ø${net.toLocaleString()}`;

    // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Badge ‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    updateStatusUI(net);
}

// ‡πÅ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô UI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡πâ‡∏î
function updateStatusUI(net) {
    const badge = $("statusBadge");
    const light = $("accLight");
    let color = net > 0 ? "#dc2626" : (net < 0 ? "#1e3a8a" : "#16a34a");
    let txt = net > 0 ? "üë®‚Äçüé® ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô" : (net < 0 ? "üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á" : "‚öñÔ∏è ‡∏¢‡∏≠‡∏î‡∏•‡∏á‡∏ï‡∏±‡∏ß");

    if (badge) {
        badge.innerText = txt;
        badge.style.background = net > 0 ? "#fef2f2" : (net < 0 ? "#eff6ff" : "#f0fdf4");
        badge.style.color = color;
    }
    if (light) {
        light.style.background = color;
        light.style.boxShadow = `0 0 12px ${color}`;
    }
}     function clearAccount() {
                const d = $("accDate").value || new Date().toISOString().split('T')[0];
                const net = Number(account.balance) || 0;
                if (net === 0) {
                    alert("üíé ‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå");
                    return;
                }
                const confirmMsg = net > 0 
                    ? `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏≤‡∏á "‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" ‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${net.toLocaleString()} ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`
                    : `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≤‡∏ô "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô" ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≤‡∏á ‡∏ø${Math.abs(net).toLocaleString()} ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`;
                if (!confirm(confirmMsg)) return;
                if (!account.logs) account.logs = [];
                account.logs.unshift({
                    date: d,
                    amount: net,
                    note: $("accNote")?.value || "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á"
                });
                account.balance = 0;
                save(); 
                alert("‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                if ($("accNote")) $("accNote").value = "";
                loadAccountHistory(); 
                loadAccountStatus();  
            }
            function renderHistoryList() {
                // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (!account.logs || account.logs.length === 0) {
                    $("accHistory").innerHTML = '<center style="padding:50px; color:#94a3b8; font-size:15px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡∏£‡∏±‡∏ö</center>';
                    return;
                }
                let h = "";
                for (let i = account.logs.length - 1; i >= 0; i--) {
                    let l = account.logs[i];
                    h += `
                        <div style="padding:20px 15px; border-bottom:1px solid #e2e8f0; background:#ffffff; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-radius:15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                            <div style="flex: 1;">
                                <b style="font-size:17px; color:#0f172a; display:block; margin-bottom:5px;">üìÖ ${l.date}</b>
                                <span style="color:#475569; font-size:15px; font-weight:500;">üìå ${l.note || '‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á'}</span>
                            </div>
                            <div style="text-align:right; min-width:120px;">
                                <b style="color:${l.amount >= 0 ? '#16a34a' : '#dc2626'}; font-size:20px; display:block; margin-bottom:10px;">
                                    ‡∏ø${Math.abs(l.amount).toLocaleString()}
                                </b>
                                
                                <button onclick="editAccountLog(${i})" style="background:#fef3c7; color:#92400e; border:1px solid #fcd34d; border-radius:10px; padding:10px 20px; font-size:14px; font-weight:800; cursor:pointer; width:100%;">
                                    <i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                $("accHistory").innerHTML = h;
            }
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô
            function editAccountLog(index) {
                let l = account.logs[index];
                const newNote = prompt("üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:", l.note);
                const newAmount = prompt("üí∞ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:", Math.abs(l.amount));
                if (newNote !== null && newAmount !== null) {
                    const isNegative = l.amount < 0;
                    const val = parseFloat(newAmount.replace(/,/g, '')) || 0;
                    account.logs[index].note = newNote;
                    account.logs[index].amount = isNegative ? -val : val;
                    if (typeof save === "function") {
                        save();
                    }
                    alert("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                    renderHistoryList();
                    if (typeof loadAccountStatus === "function") {
                        loadAccountStatus();
                    }
                }
            }
    function loadHistDaily() {
    const d = $("histDate").value;
    if (!d) return;
    const f = archives.find(a => a.date === d);
    if (!f) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ");
    let cashTotal = f.cash || 0;
    let transTotal = f.trans || 0;
    let totalRevenue = cashTotal + transTotal;
    let customerCount = f.count || (f.details ? f.details.length : 0);
    const barberEarn = Math.floor(f.barber || 0);
    const shopEarn = Math.floor(f.shop || 0);
    const svcCounts = {};
    (f.details || []).forEach(r => {
        const services = Array.isArray(r.svcs) ? r.svcs : [r.svcs];
        services.forEach(s => {
            if(s) svcCounts[s] = (svcCounts[s] || 0) + 1;
        });
    });

    const svcHTML = Object.entries(svcCounts).map(([name, count]) => `
        <div style="background:rgba(203, 213, 225, 0.1); padding:6px 12px; border-radius:10px; font-size:12px; color:#cbd5e1; font-weight:600; display:inline-block; margin:3px; border:1px solid rgba(255, 255, 255, 0.1);">
            ${name} <span style="opacity:0.7; margin-left:4px;">x${count}</span>
        </div>
    `).join("");

    let settleHTML = "";
    if (cashTotal > barberEarn) {
        const toShop = cashTotal - barberEarn;
        settleHTML = `<div style="background:rgba(251,146,60,0.1); padding:16px; border-radius:16px; margin-bottom:20px; text-align:center; border:1px solid rgba(251,146,60,0.3);">
            <div style="font-size:16px; color:#fdba74; font-weight:600; margin-bottom:4px;">üë®‚Äçüé® ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô</div>
            <div style="font-size:24px; color:#fb923c; font-weight:800;">‡∏ø${toShop.toLocaleString()}</div>
        </div>`;
    } else if (barberEarn > cashTotal) {
        const toBarber = barberEarn - cashTotal;
        settleHTML = `<div style="background:rgba(56,189,248,0.1); padding:16px; border-radius:16px; margin-bottom:20px; text-align:center; border:1px solid rgba(56,189,248,0.3);">
            <div style="font-size:16px; color:#7dd3fc; font-weight:600; margin-bottom:4px;">üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á</div>
            <div style="font-size:24px; color:#38bdf8; font-weight:800;">‡∏ø${toBarber.toLocaleString()}</div>
        </div>`;
    }
    const rows = (f.details || [])
        .slice()
        .sort((a, b) => (a.time || "").localeCompare(b.time || ""))
        .map((r, index) => {
            const p = Number(r.price) || 0;
            const t = Number(r.tip) || 0;
            const fullTime = (r.time && r.endTime) ? `${r.time}-${r.endTime}` : (r.time || "--:--");
            let payText = "";
            if (r.pay === 'Mix') {
                payText = `üåì ‡∏ú‡∏™‡∏° (‡∏™‡∏î:${(r.payCash||0)}/‡πÇ‡∏≠‡∏ô:${(r.payTrans||0)})`;
            } else {
                payText = r.pay === 'Trans' ? 'üì± ‡πÇ‡∏≠‡∏ô' : 'üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î';
            }
            return `
            <div style="padding:14px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:16px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="width:28px; height:28px; background:rgba(255,255,255,0.08); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:700; color:#94a3b8;">${index + 1}</div>
                    <div>
                        <div style="font-weight:700; font-size:14px; color:#f8fafc;">${Array.isArray(r.svcs) ? r.svcs.join(' + ') : r.svcs}</div>
                        <div style="font-size:13px; color:#94a3b8; font-weight:500; margin-top:2px;">‚è± ${fullTime} ‚Ä¢ ${payText}</div>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:16px; font-weight:800; color:#f8fafc;">‡∏ø${p.toLocaleString()}</div>
                    ${t > 0 ? `<div style="font-size:12px; font-weight:600; color:#f472b6;">+ Tip ‡∏ø${t.toLocaleString()}</div>` : ''}
                </div>
            </div>`;
        }).join("");

    openReportModal(`‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ${d}`, `
        <div style="font-family:'Inter', system-ui, sans-serif; background:#0f172a; margin:-16px; padding:24px; color:#f1f5f9; min-height:100vh;">
            <div style="text-align:center; padding:20px 0 30px 0;">
                <div style="font-size:16px; color:#94a3b8; font-weight:600; text-transform:uppercase; letter-spacing:1px;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</div>
                <div style="font-size:48px; font-weight:900; color:#ffffff; margin-top:5px;">‡∏ø${totalRevenue.toLocaleString()}</div>
            </div>

            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-bottom:24px;">
                <div style="background:#14532d; padding:14px 8px; border-radius:18px; text-align:center; color:#ffffff;">
                    <div style="font-size:13px; opacity:0.8; font-weight:600; margin-bottom:4px;">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</div>
                    <div style="font-size:16px; font-weight:800;">‡∏ø${cashTotal.toLocaleString()}</div>
                </div>
                <div style="background:#1e3a8a; padding:14px 8px; border-radius:18px; text-align:center; color:#ffffff;">
                    <div style="font-size:13px; opacity:0.8; font-weight:600; margin-bottom:4px;">üì± ‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô</div>
                    <div style="font-size:16px; font-weight:800;">‡∏ø${transTotal.toLocaleString()}</div>
                </div>
                <div style="background:#78350f; padding:14px 8px; border-radius:18px; text-align:center; color:#ffffff;">
                    <div style="font-size:13px; opacity:0.8; font-weight:600; margin-bottom:4px;">üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                    <div style="font-size:16px; font-weight:800;">${customerCount}</div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
                <div style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); padding:16px; border-radius:20px; text-align:center;">
                    <div style="font-size:14px; color:#94a3b8; font-weight:600; margin-bottom:4px;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ä‡πà‡∏≤‡∏á</div>
                    <div style="font-size:20px; font-weight:800; color:#f8fafc;">‡∏ø${barberEarn.toLocaleString()}</div>
                </div>
                <div style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); padding:16px; border-radius:20px; text-align:center;">
                    <div style="font-size:14px; color:#94a3b8; font-weight:600; margin-bottom:4px;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡πâ‡∏≤‡∏ô</div>
                    <div style="font-size:20px; font-weight:800; color:#f8fafc;">‡∏ø${shopEarn.toLocaleString()}</div>
                </div>
            </div>

            ${settleHTML}

            <div style="margin-bottom:30px;">
                <div style="font-size:14px; color:#94a3b8; font-weight:700; text-transform:uppercase; margin-bottom:12px; text-align:center;">‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</div>
                <div style="text-align:center;">${svcHTML}</div>
            </div>

            <div style="font-weight:800; font-size:16px; color:#f8fafc; margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                <div style="width:4px; height:18px; background:#cbd5e1; border-radius:2px;"></div>
                ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô
            </div>
            <div style="max-height:400px; overflow-y:auto;">
                ${rows}
            </div>
            </div>
    `);
}
     function renderStats(obj, accentColor) {
    const entries = Object.entries(obj).sort((a, b) => b[1] - a[1]);
    if (!entries.length) return "<div style='color:rgba(255,255,255,0.2); padding:10px; font-size:13px;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>";
    
    return entries.map(([k, v]) => `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:16px; margin-bottom:8px;">
            <div style="font-weight:600; color:#f1f5f9; font-size:14px;">${k}</div>
            <div style="font-weight:800; color:${accentColor}; font-size:16px;">${v} <span style="font-size:11px; opacity:0.5; color:#fff;">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
        </div>`).join("");
}

function loadHistMonth() {
    const $ = (id) => document.getElementById(id);
    const m = $("histMonth").value;
    if (!m) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

    if (typeof archives === 'undefined') return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (archives)");

    const filtered = archives.filter(a => a.date && a.date.startsWith(m));
    if (!filtered.length) {
        return openReportModal("üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "<div style='text-align:center;padding:50px;color:#94a3b8;'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>");
    }

    let monthTotal = 0, monthBarber = 0, monthCount = 0;
    let hairStats = {}, serviceStats = {};
    let offDays = 0, workDays = 0;
    let weeklyData = {};

    const haircutList = ["‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô","‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î","‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á","‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á","‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£","‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡πÅ‡∏Å‡πâ‡∏ú‡∏°","‡πÇ‡∏Å‡∏ô‡∏ú‡∏°","‡πÄ‡∏î‡πá‡∏Å"];
    const dayNames = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", "‡∏û‡∏∏‡∏ò", "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ", "‡∏®‡∏∏‡∏Å‡∏£‡πå", "‡πÄ‡∏™‡∏≤‡∏£‡πå"];

    filtered.forEach(day => {
        const dObj = new Date(day.date);
        let wIdx = Math.ceil(dObj.getDate() / 7);
        if (wIdx > 4) wIdx = 4;
        const wKey = `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà ${wIdx}`;

        if (!weeklyData[wKey]) {
            weeklyData[wKey] = { 
                customers: 0, workDays: 0, offDays: 0, 
                zeroDays: 0, dailyCounts: [], 
                popularHair: {}, 
                popularService: {}, // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
                income: 0 // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
            };
        }

        if (day.off === true || day.type === "HOLIDAY") {
            offDays++;
            weeklyData[wKey].offDays++;
            return;
        }

        workDays++;
        weeklyData[wKey].workDays++;
        const dailyIncome = Number(day.total) || 0;
        monthTotal += dailyIncome;
        monthBarber += Number(day.barber) || 0;
        weeklyData[wKey].income += dailyIncome; // ‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå

        let dayCustomerCount = 0;
        if (day.details && Array.isArray(day.details)) {
            day.details.forEach(d => {
                if (d.type === "SERVICE") {
                    const svcs = Array.isArray(d.svcs) ? d.svcs : [d.svcs];
                    let isHaircut = false;
                    svcs.forEach(s => {
                        if (!s) return;
                        const cleanS = s.trim();
                        if (haircutList.includes(cleanS)) {
                            hairStats[cleanS] = (hairStats[cleanS] || 0) + 1;
                            weeklyData[wKey].popularHair[cleanS] = (weeklyData[wKey].popularHair[cleanS] || 0) + 1;
                            isHaircut = true;
                        } else {
                            serviceStats[cleanS] = (serviceStats[cleanS] || 0) + 1;
                            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏î‡πâ‡∏ß‡∏¢
                            weeklyData[wKey].popularService[cleanS] = (weeklyData[wKey].popularService[cleanS] || 0) + 1;
                        }
                    });
                    if (isHaircut) {
                        monthCount++;
                        dayCustomerCount++;
                        weeklyData[wKey].customers++;
                    }
                }
            });
        }

        if (dayCustomerCount === 0) weeklyData[wKey].zeroDays++;
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ income ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô dailyCounts ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏ô generateMonthlyReport
        weeklyData[wKey].dailyCounts.push({ dayName: dayNames[dObj.getDay()], count: dayCustomerCount, income: dailyIncome });
    });

    const avgCustomerPerDay = workDays > 0 ? (monthCount / workDays) : 0;
    generateMonthlyReport(m, monthTotal, monthBarber, monthCount, workDays, offDays, avgCustomerPerDay, weeklyData, hairStats, serviceStats);
}

function generateMonthlyReport(m, monthTotal, monthBarber, monthCount, workDays, offDays, avgCustomerPerDay, weeklyData, hairStats, serviceStats) {
    // --- 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Logic) ---
    const weekEntries = Object.entries(weeklyData);
    const dayStats = {};
    let dailyTimeline = []; // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ

    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏•‡∏á‡πÉ‡∏ô dailyTimeline ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ß‡∏±‡∏ô
    weekEntries.forEach(([wk, data]) => {
        if (data.dailyCounts) {
            data.dailyCounts.forEach(d => {
                dailyTimeline.push(d); // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏•‡∏á‡πÉ‡∏ô Timeline
                const dayName = d.dayName.split(' ')[0]; 
                if (!dayStats[dayName]) dayStats[dayName] = { total: 0, count: 0 };
                if (d.count > 0) {
                    dayStats[dayName].total += d.count;
                    dayStats[dayName].count += 1;
                }
            });
        }
    });

    // ‡∏´‡∏≤‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
    const topIncomeWeek = weekEntries.length > 0 
        ? weekEntries.reduce((prev, curr) => (curr[1].income > prev[1].income ? curr : prev))
        : null;

    // ‡∏´‡∏≤‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
    const topCustomerWeek = weekEntries.length > 0 
        ? weekEntries.reduce((prev, curr) => (curr[1].customers > prev[1].customers ? curr : prev))
        : null;

    const dayAverages = Object.entries(dayStats)
        .filter(([name, data]) => data.count > 0)
        .map(([name, data]) => ({ name, avg: data.total / data.count }));

    const busiestDay = dayAverages.sort((a, b) => b.avg - a.avg)[0];
    const quietestDay = dayAverages.sort((a, b) => a.avg - b.avg)[0];

    // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏≤‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏£‡∏¥‡∏á (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Error ‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ)
    const dates = dailyTimeline.map(d => d.date).filter(Boolean).sort();
    const startDate = dates.length > 0 ? dates[0] : "";
    const endDate = dates.length > 0 ? dates[dates.length - 1] : "";

    const fmt = (dStr) => {
        if(!dStr) return "";
        const p = dStr.split('-');
        return p.length === 3 ? `${p[2]}/${p[1]}` : dStr;
    };

    const periodLabel = (startDate && endDate) 
        ? `‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${fmt(startDate)} - ${fmt(endDate)}` 
        : "‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ";

    // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°
    const maxDailyCount = dailyTimeline.length > 0 ? Math.max(...dailyTimeline.map(d => d.count)) : 0;
    const behavior = (maxDailyCount > avgCustomerPerDay * 1.5)
        ? `${periodLabel} ‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡∏ß‡∏±‡∏ô`
        : `${periodLabel} ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ô`;
    
    const topHair = Object.entries(hairStats).sort((a,b) => b[1] - a[1])[0];
    const topService = Object.entries(serviceStats).sort((a,b) => b[1] - a[1])[0];

    // --- 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Array ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ Insights ---
    const insights = [
        `‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <b>${workDays} ‡∏ß‡∏±‡∏ô</b> (‡∏´‡∏¢‡∏∏‡∏î ${offDays} ‡∏ß‡∏±‡∏ô)`,
        `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${behavior}`,
        topIncomeWeek ? `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ <b>${topIncomeWeek[0]}</b>` : `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ`,
        topCustomerWeek ? `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ <b>${topCustomerWeek[0]}</b>` : `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤`,
        `‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡πÉ‡∏ô <b>‡∏ß‡∏±‡∏ô${busiestDay?.name || '-'}</b> ‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏ô <b>‡∏ß‡∏±‡∏ô${quietestDay?.name || '-'}</b>`,
        `‡∏ó‡∏£‡∏á‡∏ú‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°: <b>${topHair ? topHair[0] : '-'}</b> (‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°: ${topService ? topService[0] : '-'})`
    ];

    // --- 3. ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ---
    const weeklyHtml = weekEntries.map(([wk, data]) => {
        const avg = data.workDays > 0 ? (data.customers / data.workDays).toFixed(1) : 0;
        const weeklyTotalIncome = data.income || 0;
        const sortedDays = data.dailyCounts ? [...data.dailyCounts].sort((a,b) => b.count - a.count) : [];
        const bestDay = sortedDays.length > 0 && sortedDays[0].count > 0 ? `${sortedDays[0].dayName} (${sortedDays[0].count})` : "-";
        const worstDay = sortedDays.length > 0 ? `${sortedDays[sortedDays.length-1].dayName} (${sortedDays[sortedDays.length-1].count})` : "-";

        const unusedHair = Object.keys(hairStats).filter(h => !data.popularHair[h]);
        const unusedService = Object.keys(serviceStats).filter(s => !data.popularService[s]);

        const popHair = Object.entries(data.popularHair).sort((a,b) => b[1] - a[1]).slice(0, 2).map(([name, count]) => `
            <span style="background:rgba(190,242,100,0.1); color:#bef264; padding:2px 8px; border-radius:8px; font-size:11px; font-weight:600; border:1px solid rgba(190,242,100,0.2);">‚úÇÔ∏è ${name} (${count})</span>
        `).join("");

        const popService = Object.entries(data.popularService).sort((a,b) => b[1] - a[1]).slice(0, 2).map(([name, count]) => `
            <span style="background:rgba(56,189,248,0.1); color:#38bdf8; padding:2px 8px; border-radius:8px; font-size:11px; font-weight:600; border:1px solid rgba(56,189,248,0.2);">üß¥ ${name} (${count})</span>
        `).join("");

        return `
        <div style="background:#020617; border:1px solid rgba(255,255,255,0.08); padding:16px; border-radius:22px; margin-bottom:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div style="font-size:15px; font-weight:800; color:#f8fafc;">üìÖ ${wk}</div>
                <div style="font-size:10px; color:#94a3b8;">‡πÄ‡∏õ‡∏¥‡∏î ${data.workDays} | ‡∏´‡∏¢‡∏∏‡∏î ${data.offDays}</div>
            </div>

            <div style="background:linear-gradient(90deg, rgba(74,222,128,0.15), transparent); padding:8px 12px; border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:12px; color:#4ade80; font-weight:600;">üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</span>
                <span style="font-size:18px; font-weight:900; color:#ffffff;">‡∏ø${weeklyTotalIncome.toLocaleString()}</span>
            </div>

            <div style="display:flex; gap:8px; margin-bottom:10px;">
                <div style="flex:1; background:rgba(255,255,255,0.03); padding:6px 10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:11px; color:#94a3b8;">üë§ ‡∏£‡∏ß‡∏°</span>
                    <span style="font-size:13px; font-weight:700; color:#38bdf8;">${data.customers}</span>
                </div>
                <div style="flex:1; background:rgba(255,255,255,0.03); padding:6px 10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:11px; color:#94a3b8;">üìä ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</span>
                    <span style="font-size:13px; font-weight:700; color:#facc15;">${avg}</span>
                </div>
            </div>

            <div style="font-size:11px; color:#64748b; line-height:1.6; padding:0 4px 10px 4px; border-bottom:1px solid rgba(255,255,255,0.05); margin-bottom:10px;">
                <div>üìà ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: <span style="color:#f1f5f9; font-weight:600;">${bestDay}</span></div>
                <div>üìâ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: <span style="color:#f1f5f9; font-weight:600;">${worstDay}</span></div>
                
                <div style="margin-top:6px; color:#fb7185; border-top:1px dashed rgba(251,113,133,0.2); padding-top:4px;">
                    üö® <b>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</b> ${[...unusedHair, ...unusedService].length > 0 ? [...unusedHair, ...unusedService].join(", ") : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"}
                </div>
            </div>

            <div style="display:flex; flex-wrap:wrap; gap:6px;">
                ${popHair}
                ${popService}
            </div>
        </div>`;
    }).join("");

    // --- 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Modal ---
    openReportModal(
        `‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${m}`,
        `<div style="background:#0f172a; padding:24px; color:#f1f5f9; border-radius:20px; font-family: sans-serif; margin-bottom:50px;">
            <div style="text-align:center; padding:10px 0 20px 0;">
                <div style="font-size:16px; color:#94a3b8; font-weight:700; margin-bottom:5px;">‚úÇÔ∏è ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                <div style="font-size:48px; font-weight:900; color:#ffffff;">‡∏ø${monthTotal.toLocaleString()}</div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
                <div style="background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.1); padding:15px; border-radius:20px; text-align:center;">
                    <div style="font-size:11px; color:#94a3b8;">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ä‡πà‡∏≤‡∏á</div>
                    <div style="font-size:20px; font-weight:800; color:#f8fafc;">‡∏ø${Math.floor(monthBarber).toLocaleString()}</div>
                </div>
                <div style="background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.1); padding:15px; border-radius:20px; text-align:center;">
                    <div style="font-size:11px; color:#94a3b8;">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡πâ‡∏≤‡∏ô</div>
                    <div style="font-size:20px; font-weight:800; color:#f8fafc;">‡∏ø${Math.floor(monthTotal - monthBarber).toLocaleString()}</div>
                </div>
            </div>

            <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:8px; margin-bottom:25px;">
                <div style="background:rgba(56,189,248,0.15); padding:6px 14px; border-radius:12px; font-size:13px; font-weight:600; color:#38bdf8;">üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${monthCount} ‡∏Ñ‡∏ô</div>
                <div style="background:rgba(255,255,255,0.08); padding:6px 14px; border-radius:12px; font-size:13px; font-weight:600; color:#f8fafc;">üìÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô ${workDays} ‡∏ß‡∏±‡∏ô</div>
                <div style="background:rgba(244,63,94,0.15); padding:6px 14px; border-radius:12px; font-size:13px; font-weight:600; color:#fb7185;">üõë ‡∏´‡∏¢‡∏∏‡∏î ${offDays} ‡∏ß‡∏±‡∏ô</div>
                <div style="background:rgba(250,204,21,0.15); padding:6px 14px; border-radius:12px; font-size:13px; font-weight:600; color:#facc15;">üìä ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${avgCustomerPerDay.toFixed(2)}</div>
            </div>

            <div style="margin-bottom:25px;">
                <div style="font-size:14px; font-weight:800; color:#facc15; margin-bottom:12px;">üìÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
                ${weeklyHtml}
            </div>

            <div style="background:rgba(250,204,21,0.08); border:1px solid rgba(250,204,21,0.25); padding:18px; border-radius:20px; margin-bottom:30px;">
                <div style="font-size:14px; font-weight:800; color:#facc15; margin-bottom:10px;">üí° ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</div>
                ${insights.map(i => `<div style="font-size:13px; color:#f8fafc; margin-bottom:6px;">‚Ä¢ ${i}</div>`).join("")}
            </div>

            <div style="margin-bottom:25px;">
                <div style="font-size:15px; font-weight:800; color:#bef264; margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                    <div style="width:4px; height:16px; background:#bef264; border-radius:2px;"></div> ‡∏ó‡∏£‡∏á‡∏ú‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°
                </div>
                ${renderStats ? renderStats(hairStats, "#bef264") : ""}
            </div>

            <div style="padding-bottom:20px;">
                <div style="font-size:15px; font-weight:800; color:#38bdf8; margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                    <div style="width:4px; height:16px; background:#38bdf8; border-radius:2px;"></div> ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°
                </div>
                ${renderStats ? renderStats(serviceStats, "#38bdf8") : ""}
            </div>
        </div>`
    );
}
     function topN(obj, n = 5) {
              if (!obj || Object.keys(obj).length === 0) return [];
              return Object.entries(obj)
                .filter(([_, count]) => count > 0)
                .sort((a, b) => b[1] - a[1])
                .slice(0, n);
            }
              function confirmShareLine() {
              const m = $("histMonth").value;
              if (!m) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô");
            
              if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${m} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà LINE ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`)) {
                shareLineMonth();
              }
            }
            
// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (‡πÄ‡∏û‡∏¥‡πà‡∏° Logic ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)
function buildMonthlyComments(data) {
    const { weekly, monthHair, monthSvc, avgPerDay, workDays, monthKey } = data;
    const comments = [];

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (Calendar Logic) ---
    const [year, month] = monthKey.split('-').map(Number);
    const daysInMonth = new Date(year, month, 0).getDate(); 
    const offDaysCount = daysInMonth - workDays;
    
    // ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢)
    const dayNames = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå"];
    const workedWeekdays = new Set();
    Object.values(weekly).forEach(w => {
        w.days.forEach(dateStr => workedWeekdays.add(new Date(dateStr).getDay()));
    });
    const regularOffDays = dayNames.filter((name, index) => !workedWeekdays.has(index));

    // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡∏™‡∏∏‡∏†‡∏≤‡∏û)
    let holidayMsg = `‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏ß‡∏° ${offDaysCount} ‡∏ß‡∏±‡∏ô`;
    if (regularOffDays.length > 0 && offDaysCount > 0) {
        holidayMsg += ` (‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô${regularOffDays.join("/")})`;
    }
    comments.push(holidayMsg);

    // --- ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ---
    let maxDaily = 0;
    Object.values(weekly).forEach(w => {
        Object.values(w.daily).forEach(count => { if (count > maxDaily) maxDaily = count; });
    });
    const behavior = (maxDaily > avgPerDay * 1.5)
        ? '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©'
        : '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°';
    comments.push(`‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°: ${behavior}`);

    // --- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ---
    const dayTotals = {};
    Object.values(weekly).forEach(w => {
        Object.entries(w.daily).forEach(([day, count]) => { dayTotals[day] = (dayTotals[day] || 0) + count; });
    });
    const busiestDay = Object.entries(dayTotals).sort((a, b) => b[1] - a[1])[0];
    if (busiestDay) comments.push(`‡∏ß‡∏±‡∏ô‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°: "‡∏ß‡∏±‡∏ô${busiestDay[0]}" ‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î`);

    return comments;
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á LINE (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)
function shareLineMonth() {
    const m = $("histMonth").value;
    if (!m) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô");

    const records = archives.filter(r => r.date && r.date.startsWith(m));
    if (!records.length) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ");

    const shopName = $("setShop").value || "Barber Shop";
    let total = 0, barberEarn = 0, clientCount = 0;
    let weekly = {}, monthHair = {}, monthSvc = {};
    const workDaysCount = records.length;

    // Logic ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const weekOfMonth = d => Math.ceil((new Date(d).getDate()) / 7);
    const weekdayTH = d => ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå"][new Date(d).getDay()];

    records.forEach(r => {
        const w = weekOfMonth(r.date);
        const day = weekdayTH(r.date);
        total += Number(r.total) || 0;
        barberEarn += Number(r.barber) || 0;
        let dayCust = r.details ? r.details.length : 1;
        clientCount += dayCust;

        if (!weekly[w]) {
            weekly[w] = { customers: 0, days: new Set(), daily: {}, hair: {}, service: {} };
        }
        weekly[w].customers += dayCust;
        weekly[w].days.add(r.date);
        weekly[w].daily[day] = (weekly[w].daily[day] || 0) + dayCust;

        (r.details || []).forEach(d => {
            (d.svcs || []).forEach(s => {
                if(!s) return;
                const haircutList = ["‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô","‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î","‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á","‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á","‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£","‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡πÅ‡∏Å‡πâ‡∏ú‡∏°","‡πÇ‡∏Å‡∏ô‡∏ú‡∏°","‡πÄ‡∏î‡πá‡∏Å"];
                if(haircutList.includes(s.trim())) { monthHair[s] = (monthHair[s]||0)+1; } 
                else { monthSvc[s] = (monthSvc[s]||0)+1; }
            });
        });
    });

    const shopEarn = total - barberEarn;
    const avgPerDay = workDaysCount > 0 ? (clientCount / workDaysCount) : 0;
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ AI Comments ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á monthKey ‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
    const aiComments = buildMonthlyComments({ 
        weekly, monthHair, monthSvc, avgPerDay, workDays: workDaysCount, monthKey: m 
    });

    const msg = `
üíà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${shopName}
üìÖ ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${m}

üí∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ:
‚úÇÔ∏è ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ‡∏ø${total.toLocaleString()}
ü§µ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ä‡πà‡∏≤‡∏á: ‡∏ø${Math.floor(barberEarn).toLocaleString()}
üè† ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡πâ‡∏≤‡∏ô: ‡∏ø${Math.floor(shopEarn).toLocaleString()}

üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:
üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${clientCount} ‡∏Ñ‡∏ô
üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ${workDaysCount} ‡∏ß‡∏±‡∏ô
üò¥ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î: ${new Date(m.split('-')[0], m.split('-')[1], 0).getDate() - workDaysCount} ‡∏ß‡∏±‡∏ô
üìà ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${avgPerDay.toFixed(2)} ‡∏Ñ‡∏ô/‡∏ß‡∏±‡∏ô

üìù ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°:
${aiComments.map(c => `‚Ä¢ ${c}`).join("\n")}

üèÜ ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°:
${Object.entries(monthSvc).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k,v])=>`‚Ä¢ ${k} (${v} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`).join("\n") || "-"}

üí° ‡∏™‡∏£‡∏∏‡∏õ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô Barber
`.trim();

    const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(msg)}`;
    location.href = lineUrl;
}
function shareLine() {
    const dInp = $("dateInp").value, today = db.filter(r => r.date === dInp); 
    if (!today.length) return;

    const dp = dInp.split('-'), fDate = `${dp[2]}/${dp[1]}/${dp[0]}`;
    let tot=0, cash=0, trans=0, tips=0, stats={}, realCustomerCount=0;

    let clientList = today.sort((a,b)=>a.time.localeCompare(b.time)).map((r,i)=>{
        const p = Number(r.price)||0, t = Number(r.tip)||0; 
        const rType = r.type ? String(r.type).toUpperCase().trim() : '';
        
        tot += p; 
        tips += t;
        r.pay === 'Trans' ? trans += (p + t) : cash += p; // ‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡πÇ‡∏≠‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏¥‡∏õ‡∏ï‡∏≤‡∏°‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏£‡πâ‡∏≤‡∏ô

        // üö® ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πà‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô/‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/‡∏¢‡∏≠‡∏î0)
        if (rType !== 'GUARANTEE' && rType !== 'HOLIDAY' && p > 0) {
            realCustomerCount++;
            if(r.hair && r.hair.includes("‡πÄ‡∏î‡πá‡∏Å")) stats["‡πÄ‡∏î‡πá‡∏Å"] = (stats["‡πÄ‡∏î‡πá‡∏Å"]||0) + 1;
            (r.svcs||[]).forEach(s => { if(s) stats[s] = (stats[s]||0) + 1; });
        }

        const tShow = r.endTime ? `${r.time}-${r.endTime}` : r.time;
        const icon = rType === 'GUARANTEE' ? 'üõ°Ô∏è' : (rType === 'HOLIDAY' ? 'üèñÔ∏è' : '');
        return `${i+1}. [${tShow}] ${icon} ${(r.svcs||[]).join('+')} = ${p}${t?` (+‡∏ó‡∏¥‡∏õ ${t})`:''} ${r.pay==='Trans'?'üì±':'üíµ'}`;
    }).join('\n');

    const allowed = ["‡πÄ‡∏î‡πá‡∏Å","‡∏™‡∏£‡∏∞‡∏ú‡∏°","‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î","‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°","‡∏¢‡πâ‡∏≠‡∏°‡∏™‡∏µ"], icons = {"‡πÄ‡∏î‡πá‡∏Å":"üßí","‡∏™‡∏£‡∏∞":"üßº","‡πÇ‡∏Å‡∏ô":"ü™í","‡∏¢‡πâ‡∏≠‡∏°":"üé®"};
    let statText = Object.entries(stats).filter(([k])=>allowed.some(a=>k.includes(a))).map(([k,v])=>`${icons[Object.keys(icons).find(i=>k.includes(i))]||'üîπ'} ${k}: ${v}`).join('\n');
    
    let bEarn = Math.max(tot*(conf.perc/100), conf.guar) + tips;
    let settle = cash - bEarn, settleMsg = settle > 0 ? `‚ö†Ô∏è ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ${Math.floor(Math.abs(settle))}` : `üü¶ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ${Math.floor(Math.abs(settle))}`;

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    let msg = `üíà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô: Barber Shop\n`;
    msg += `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${fDate}\n`;
    msg += `-------------------------\n`;
    msg += `üìù ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (${realCustomerCount} ‡∏Ñ‡∏ô):\n${clientList}\n`; // ‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á
    msg += `-------------------------\n`;
    msg += `üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô:\n${statText || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°)'}\n`;
    msg += `-------------------------\n`;
    msg += `üí∞ ‡∏¢‡∏≠‡∏î: ${tot} | üßß ‡∏ó‡∏¥‡∏õ: ${tips}\n`;
    msg += `üì± ‡πÇ‡∏≠‡∏ô: ${trans} | üíµ ‡∏™‡∏î: ${cash}\n`;
    msg += `ü§µ ‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ: ${Math.floor(bEarn)}\n`;
    msg += `üè† ‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ${Math.floor(tot-(bEarn-tips))}\n`;
    msg += `-------------------------\n`;
    msg += `${settleMsg}`;

    // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î LINE ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á Preview ‡πÅ‡∏ó‡∏ô
    document.getElementById("msgEdit").value = msg;
    document.getElementById("linePreview").style.display = "flex";
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
function sendToLineFinal() {
    const finalMsg = document.getElementById("msgEdit").value;
    window.open(`https://line.me/R/msg/text/?${encodeURIComponent(finalMsg)}`);
    document.getElementById("linePreview").style.display = "none";
}
           function go(p) {
    // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Page
    document.querySelectorAll('.page').forEach(pg => {
        pg.classList.remove('active');
        pg.style.display = 'none'; 
    });

    const targetPage = document.getElementById('p' + p);
    if (targetPage) {
        targetPage.classList.add('active');
        targetPage.style.display = 'block';
    }

    // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π (Navbar) ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    document.querySelectorAll('.nav-item').forEach((btn, i) => {
        btn.classList.toggle('active', (i + 1) === p);
    });
    // 3. ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤
    if (p === 2) {
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        const targetDate = $("dateInp")?.value || new Date().toISOString().split('T')[0];
        if (typeof renderDay === 'function') renderDay(targetDate);
    }
    if (p === 3) { 
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞
        if ($("accDate") && $("dateInp")) $("accDate").value = $("dateInp").value;
        if (typeof loadAccountStatus === 'function') loadAccountStatus(); 
    }
    // 4. ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢)
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
                function saveDB() {localStorage.setItem("barber_db", JSON.stringify(db));localStorage.setItem("barber_conf", JSON.stringify(conf));}
                function delRec(id) { if (confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) { db = db.filter(r => r.id !== id); saveDB(); renderDay(); } }
                function editTime(id) {const rec = db.find(r => r.id === id);if (!rec) return;const newStart = prompt("‡πÅ‡∏Å‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° (HH:MM)", rec.time);if (!newStart) return;const newEnd = prompt("‡πÅ‡∏Å‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à (HH:MM)", rec.endTime || "");rec.time = newStart;rec.endTime = newEnd || addMinutes(newStart, 30);saveDB();renderDay();}
                
                window.onclick = function(e) {const modals = [{ id: "reportModal", close: closeReportModal },{ id: "historyModal", close: closeHistoryModal },{ id: "configModal", close: closeConfigModal } ]; 
                modals.forEach(m => {const modalEl = $(m.id);if (modalEl && e.target === modalEl && typeof m.close === "function") {m.close();}});};
               window.addEventListener('load', () => {
                const n = new Date(), 
                      t = n.getHours().toString().padStart(2, '0') + ':' + n.getMinutes().toString().padStart(2, '0'); 
                if(document.getElementById('tStart')) document.getElementById('tStart').value = t; 
                if(document.getElementById('tEnd')) document.getElementById('tEnd').value = t;
                const savedName = localStorage.getItem('shopName');
                const savedTheme = localStorage.getItem('shopTheme');
                if (savedName) {
                    document.getElementById('shopNameDisp').innerText = savedName.toUpperCase();
                    if(document.getElementById('setShop')) document.getElementById('setShop').value = savedName;
                }
                if (savedTheme) {
                    if(document.getElementById('setTheme')) document.getElementById('setTheme').value = savedTheme;
                    const body = document.body;
                    if (savedTheme === 'navy') {
                        body.style.background = '#1e3a8a';
                        body.style.color = '#ffffff';
                    } else if (savedTheme === 'dark') {
                        body.style.background = '#0f172a';
                        body.style.color = '#e2e8f0';
                    } else {
                        body.style.background = '#f8fafc';
                        body.style.color = '#1e293b';
                    }
                }
            });
                 // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
       function exportBackup() {
    try {
        const data = {
    
            db: JSON.parse(localStorage.getItem("barber_db") || localStorage.getItem("db") || "[]"),
            archives: JSON.parse(localStorage.getItem("barber_archives") || localStorage.getItem("archives") || "[]"),
            clearHistory: JSON.parse(localStorage.getItem("clear_history") || localStorage.getItem("account_history") || "[]"),
            dailySummary: JSON.parse(localStorage.getItem("daily_summary") || "[]"),
            
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            settings: JSON.parse(localStorage.getItem("barber_settings") || "{}"),
            exportDate: new Date().toISOString()
        };

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô localStorage ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß (‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ Key ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏Å‡πÜ)
        Object.keys(localStorage).forEach(key => {
            if (!data[key]) {
                try {
                    data[key] = JSON.parse(localStorage.getItem(key));
                } catch (e) {
                    data[key] = localStorage.getItem(key);
                }
            }
        });

        const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        
        a.href = url;
        a.download = `full-backup-barber-${new Date().toISOString().split('T')[0]}.json`;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        URL.revokeObjectURL(url);
        alert("‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
    } catch (error) {
        console.error("Backup error:", error);
        alert("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
    }
}
                    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
               function importBackup(input) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        const confirmImport = confirm("‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");
                        if(confirmImport) {
                            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡∏°‡∏µ barber_ ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ)
                            const dbStr = JSON.stringify(data.db || []);
                            const arcStr = JSON.stringify(data.archives || []);
                            localStorage.setItem("barber_db", dbStr);
                            localStorage.setItem("barber_archives", arcStr);
                            // ‡πÅ‡∏ñ‡∏°: ‡∏ñ‡πâ‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏Å‡πá‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
                            localStorage.setItem("db", dbStr);
                            localStorage.setItem("archives", arcStr);
                            alert("‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà");
                            location.reload();
                        }
                    } catch(err) {
                        alert("‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                    }
                    input.value = '';
                };
            
                if (input.files && input.files[0]) {
                    reader.readAsText(input.files[0]);
                }
            }
                    // 3. ‡∏ï‡∏±‡∏ß‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Service Worker (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏î‡πâ)
                    if ('serviceWorker' in navigator) {
                        window.addEventListener('load', () => {
                            navigator.serviceWorker.register('./service-worker.js')
                                .then(reg => console.log('Service Worker ‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'))
                                .catch(err => console.log('‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', err));
                        });
                    }
            
                function clearData() {
                const confirmDelete = confirm("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î");
                if (confirmDelete) {
                    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
                    localStorage.clear(); 
                    alert("‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                    location.reload(); // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô 0
                }
            }
        
 </script>
            </body>
            </html>
