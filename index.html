<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.ibb.co/27GqTXFn/Barber-Note.png">
    <title>Barber Note Pro v.2.2 Fixed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e3a8a; --accent: #16a34a; --danger: #dc2626; --warning: #f59e0b;
            --main-bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --input-bg: #f8fafc;
            --indigo: #818cf8; --border: #e2e8f0;
        }
        body.theme-dark { --main-bg: #0f172a; --card: #1e293b; --text: #f8fafc; --input-bg: #334155; --border: #475569; }
        body.theme-pastel { --main-bg: #faf5ff; --card: #ffffff; --text: #4c1d95; --input-bg: #f5f3ff; --border: #e9d5ff; }

        body { margin: 0; font-family: 'Kanit', sans-serif; background: var(--main-bg); color: var(--text); padding-bottom: 90px; transition: 0.3s; font-weight: 300; }
        header { padding: 15px; background: var(--card); display: flex; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); position: sticky; top:0; z-index:100; }
        header h1 { flex: 1; text-align: center; font-size: 18px; margin: 0; font-weight: 500; }
        
        .page { display: none; padding: 15px; animation: fadeIn 0.2s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card); border-radius: 20px; padding: 16px; margin-bottom: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        label { font-size: 18px; font-weight: 500; opacity: 0.9; margin-bottom: 4px; display: block; }

        input, select { 
            width: 100%; height: 45px; padding: 8px 12px; border-radius: 12px; border: 1px solid transparent; 
            font-size: 18px; box-sizing: border-box; background: var(--input-bg); color: var(--text); 
            outline: none; font-family: 'Kanit'; 
        }

        #dateInp { background: #e0f2fe !important; border: 1px solid #bae6fd !important; }
        .time-input { background: #f0f9ff !important; border: 1px solid #bae6fd !important; text-align: center; font-weight: 600; font-size: 18px; }

        .btn-pay { 
            border: 2px solid transparent; background: var(--input-bg); color: var(--text); padding: 8px 5px; 
            border-radius: 12px; font-weight: 500; cursor: pointer; transition: 0.2s; font-size: 18px; 
            display: flex; align-items: center; justify-content: center; gap: 4px; 
        }
        .btn-pay.active-cash { border: 3px solid #16a34a !important; color: #14532d !important; background: #dcfce7 !important; font-weight: 600; }
        .btn-pay.active-transfer { border: 3px solid #0284c7 !important; color: #0c4a6e !important; background: #e0f2fe !important; font-weight: 600; }
        
        .status-bar { width: 100%; padding: 15px; border-radius: 15px; text-align: center; font-weight: 600; font-size: 16px; margin: 10px 0; box-sizing: border-box; }
        .status-red { background: #fee2e2; color: #dc2626; }
        .status-green { background: #dcfce7; color: #16a34a; }
        .status-blue { background: #e0f2fe; color: #0284c7; }
        .status-indigo { background: #e0e7ff; color: #4338ca; }

        .nav { 
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); display: flex !important; 
            border-top: 1px solid rgba(0,0,0,0.1); padding-bottom: env(safe-area-inset-bottom); 
            z-index: 9999; height: 75px; align-items: center; justify-content: space-around; 
        }
        .nav-item { flex: 1; text-align: center; color: #94a3b8; font-size: 13px; cursor: pointer; display: flex !important; flex-direction: column; align-items: center; justify-content: center; gap: 4px; }
        .nav-item.active { color: var(--primary); font-weight: 500; }

        .btn-save { background: var(--primary); color: white; width: 100%; padding: 16px; border-radius: 16px; font-size: 18px; font-weight: 600; border: none; margin-top: 10px; cursor: pointer; }
        .btn-close-day { position: fixed; bottom: 85px; right: 20px; width: 60px; height: 60px; border-radius: 30px; background: #818cf8; color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 99; font-size: 24px; cursor: pointer; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-content { background: var(--card); width: 100%; border-radius: 25px; padding: 22px; max-height: 85vh; overflow-y: auto; }
        
        .badge { background: rgba(0,0,0,0.05); padding: 4px 10px; border-radius: 8px; font-size: 12px; margin: 2px; display: inline-block; color: var(--primary); font-weight: 500; }
        .history-row { padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.03); font-size: 14px; }
        .btn-clear-data { width: 100%; background: none; border: 1px solid var(--danger); color: var(--danger); padding: 10px; border-radius: 12px; margin-top: 20px; cursor: pointer; font-size: 14px; opacity: 0.6; }
    </style>
</head>
<body id="mainBody">

<header>
    <div style="width:40px"></div>
    <h1 id="shopNameDisp">Barber Note</h1>
    <div style="width:40px; text-align:right; cursor:pointer" onclick="openSettings()"><i class="fas fa-cog"></i></div>
</header>

<div id="p1" class="page active">
    <div class="card" style="border-left: 5px solid #0ea5e9;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom:15px;">
            <i class="fas fa-calendar-day" style="color:#0ea5e9"></i>
            <input type="date" id="dateInp" style="padding: 5px; font-size: 18px;">
        </div>
        <div class="grid-2">
            <div><label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="tel" id="tStart" placeholder="0900" class="time-input" maxlength="4"></div>
            <div><label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à</label><input type="tel" id="tEnd" placeholder="0930" class="time-input" maxlength="4"></div>
        </div>
    </div>

    <div class="card" style="border-left: 5px solid #10b981;">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
        <div class="grid-2" style="margin-bottom:10px">
            <select id="mainSvc"><option value="">‡∏ï‡∏±‡∏î‡∏ú‡∏°</option><option value="‡πÄ‡∏î‡πá‡∏Å">‡πÄ‡∏î‡πá‡∏Å</option></select>
            <select id="hairStyle"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏£‡∏á‡∏ú‡∏°</option><option>‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á</option><option>‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô</option><option>‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î</option><option>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á</option><option>‡∏ß‡∏¥‡∏ô‡πÄ‡∏ó‡∏à</option><option>‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£</option><option>‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option><option>‡πÅ‡∏Å‡πâ‡∏ó‡∏£‡∏á‡∏ú‡∏°</option></select>
        </div>
        <div class="grid-2">
            <select id="extra1"><option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô 1</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option><option>‡∏î‡∏±‡∏î‡∏ú‡∏°</option><option>‡πÇ‡∏Å‡∏ô‡∏ú‡∏°</option></select>
            <select id="extra2"><option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô 2</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option><option>‡∏î‡∏±‡∏î‡∏ú‡∏°</option><option>‡πÇ‡∏Å‡∏ô‡∏ú‡∏°</option></select>
        </div>
    </div>

    <div class="card" style="border-left: 5px solid #f59e0b;">
        <label>‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
        <input type="number" id="priceInp" placeholder="0" inputmode="numeric" style="font-size:40px; font-weight:600; color:#b45309; text-align:center; height:80px;">
        <div class="grid-2" style="margin-top:15px">
            <button id="btnCash" class="btn-pay" onclick="selectPay('Cash')"><i class="fas fa-money-bill-wave"></i> ‡∏™‡∏î</button>
            <button id="btnTrans" class="btn-pay" onclick="selectPay('Trans')"><i class="fas fa-mobile-alt"></i> ‡πÇ‡∏≠‡∏ô</button>
        </div>
    </div>
    <button class="btn-save" id="mainSaveBtn" onclick="handleSave()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</div>

<div id="p2" class="page">
    <div class="grid-2">
        <div class="card" style="text-align: center;">
            <label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label>
            <div id="dTotal" style="font-size:28px; font-weight:600">0</div>
            <div id="dCounts" style="font-size:18px; font-weight:600; color:var(--primary); margin-top:5px;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: 0 ‡∏Ñ‡∏ô</div>
        </div>
        <div class="card">
            <div style="font-size:16px; font-weight:600; margin-bottom:6px;">üì± ‡πÇ‡∏≠‡∏ô: <b id="dTrans" style="color:#0284c7">0</b></div>
            <div style="font-size:16px; font-weight:600; margin-bottom:6px;">ü§µ ‡∏ä‡πà‡∏≤‡∏á: <b id="dBarber" style="color:var(--primary)">0</b></div>
            <div style="font-size:16px; font-weight:600;">üè† ‡∏£‡πâ‡∏≤‡∏ô: <b id="dShop" style="color:var(--accent)">0</b></div>
        </div>
    </div>
    <div id="settleBar" class="status-bar status-blue">‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ</div>
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label>
            <i class="fab fa-line" style="color:#06C755; font-size:24px; cursor:pointer;" onclick="shareLine()"></i>
        </div>
        <div id="dServiceStats" style="margin-bottom:15px;"></div>
        <div id="dailyList"></div>
    </div>
    <button class="btn-close-day" onclick="closeDay()"><i class="fas fa-check-circle"></i></button>
</div>

<div id="p3" class="page">
    <div class="card" style="border-top:4px solid var(--primary);">
        <label>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</label>
        <input type="date" id="histDate" onchange="loadHistDaily()">
        <div id="histDailyArea" style="margin-top:12px; text-align:center; opacity:0.6;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
    </div>
    <div class="card" style="border-top:4px solid var(--warning);">
        <label>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
        <input type="month" id="histMonth" onchange="loadHistMonth()">
        <div id="histMonthArea" style="margin-top:12px; text-align:center; opacity:0.6;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>
    </div>
</div>

<div id="modalSet" class="modal">
    <div class="modal-content">
        <h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label><input id="setShop">
        <div class="grid-2" style="margin-top:10px">
            <div><label>% ‡πÅ‡∏ö‡πà‡∏á‡∏ä‡πà‡∏≤‡∏á</label><input type="number" id="setPerc"></div>
            <div><label>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</label><input type="number" id="setGuar"></div>
        </div>
        <div class="grid-2" style="margin-top:15px">
            <div><label>üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</label><select id="setSound"><option value="on">‡πÄ‡∏õ‡∏¥‡∏î</option><option value="off">‡∏õ‡∏¥‡∏î</option></select></div>
            <div><label>üéöÔ∏è ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î</label><select id="setVoice"><option value="female">‡∏´‡∏ç‡∏¥‡∏á</option><option value="male">‡∏ä‡∏≤‡∏¢</option></select></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
            <button class="btn-save" onclick="saveSettings()" style="width:100%; margin:0; padding:12px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button onclick="closeSettings()" style="width:100%; margin:0; border: 1px solid var(--border); border-radius: 10px;">‡∏õ‡∏¥‡∏î</button>
        </div>
        <button class="btn-clear-data" onclick="clearAllData()">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
</div>

<nav class="nav">
    <div class="nav-item active" id="n1" onclick="go(1)"><i class="fas fa-edit"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
    <div class="nav-item" id="n2" onclick="go(2)"><i class="fas fa-calendar-check"></i>‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
    <div class="nav-item" id="n3" onclick="go(3)"><i class="fas fa-history"></i>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>
</nav>

<script>
    let payMethod = "";
    let conf = JSON.parse(localStorage.getItem("barber_conf")) || {shop:"Barber Shop", perc:50, guar:0, theme:"light", sound:"on", voice:"female"};
    let db = JSON.parse(localStorage.getItem("barber_db")) || []; 
    let archives = JSON.parse(localStorage.getItem("barber_arc")) || []; 

    window.onload = () => { document.getElementById("dateInp").valueAsDate = new Date(); applySettings(); };

    function speak(text) {
        if (conf.sound === "off") return;
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'th-TH';
        msg.pitch = conf.voice === "male" ? 0.6 : 1.1;
        window.speechSynthesis.speak(msg);
    }

    document.querySelectorAll('.time-input').forEach(inp => {
        inp.addEventListener('input', (e) => {
            let v = e.target.value.replace(/\D/g, '');
            if(v.length >= 4) e.target.value = v.substring(0,2) + ":" + v.substring(2,4);
        });
    });

    function go(n) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('p'+n).classList.add('active');
        document.getElementById('n'+n).classList.add('active');
        if(n===2) renderDay();
    }

    function selectPay(m) {
        payMethod = m;
        document.getElementById("btnCash").className = m==='Cash'?'btn-pay active-cash':'btn-pay';
        document.getElementById("btnTrans").className = m==='Trans'?'btn-pay active-transfer':'btn-pay';
    }

    function handleSave() {
        const p = document.getElementById("priceInp").value;
        if(!p || !payMethod) return alert("‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô");
        let svcs = [document.getElementById("mainSvc").value || "‡∏ï‡∏±‡∏î‡∏ú‡∏°"];
        if(document.getElementById("extra1").value) svcs.push(document.getElementById("extra1").value);
        if(document.getElementById("extra2").value) svcs.push(document.getElementById("extra2").value);
        const rec = { id: Date.now(), date: document.getElementById("dateInp").value, time: `${document.getElementById("tStart").value}-${document.getElementById("tEnd").value}`, svcs: svcs, hair: document.getElementById("hairStyle").value, price: Number(p), pay: payMethod };
        db.push(rec); localStorage.setItem("barber_db", JSON.stringify(db));
        speak("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å " + p + " ‡∏ö‡∏≤‡∏ó");
        document.getElementById("priceInp").value = "";
        if(document.getElementById("tEnd").value) document.getElementById("tStart").value = document.getElementById("tEnd").value;
        document.getElementById("tEnd").value = "";
        selectPay(""); renderDay();
    }

    function renderDay() {
        const d = document.getElementById("dateInp").value, today = db.filter(r => r.date === d);
        let tot = 0, trans = 0, cash = 0, listHtml = "", stats = {};
        today.sort((a,b) => a.time.localeCompare(b.time)).forEach(r => {
            tot += r.price; r.pay==='Trans' ? trans += r.price : cash += r.price;
            r.svcs.forEach(s => stats[s] = (stats[s]||0)+1);
            listHtml += `<div class="history-row"><div style="display:flex; justify-content:space-between; font-weight:600; font-size:16px;"><span>${r.time} | ${r.svcs.join('+')}</span><span>‡∏ø${r.price}</span></div><div style="display:flex; justify-content:space-between; margin-top:3px;"><span>${r.hair ? '‡∏ó‡∏£‡∏á: '+r.hair : ''}</span><span style="opacity:0.7;">${r.pay==='Cash'?'üíµ':'üì±'} <i class="fas fa-trash" style="margin-left:10px; color:var(--danger)" onclick="delRec(${r.id})"></i></span></div></div>`;
        });
        const bEarn = Math.max(tot * (conf.perc/100), conf.guar), settle = cash - bEarn;
        document.getElementById("dTotal").innerText = tot.toLocaleString();
        document.getElementById("dTrans").innerText = trans.toLocaleString();
        document.getElementById("dBarber").innerText = Math.floor(bEarn).toLocaleString();
        document.getElementById("dShop").innerText = Math.floor(tot - bEarn).toLocaleString();
        document.getElementById("dCounts").innerText = `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${today.length} ‡∏Ñ‡∏ô`;
        document.getElementById("dailyList").innerHTML = listHtml || "<center style='padding:40px; opacity:0.3'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</center>";
        let statBadges = ""; for(let s in stats) statBadges += `<span class="badge">${s}: ${stats[s]}</span>`;
        document.getElementById("dServiceStats").innerHTML = statBadges;
        const bar = document.getElementById("settleBar");
        bar.innerText = settle > 0 ? `‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${Math.floor(settle).toLocaleString()}` : settle < 0 ? `‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ‡∏ø${Math.floor(Math.abs(settle)).toLocaleString()}` : "‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ";
        bar.className = `status-bar ${settle > 0 ? 'status-red' : settle < 0 ? 'status-indigo' : 'status-green'}`;
    }

    function delRec(id) { if(confirm("‡∏•‡∏ö?")) { db = db.filter(r => r.id !== id); localStorage.setItem("barber_db", JSON.stringify(db)); renderDay(); } }

    function closeDay() {
        const d = document.getElementById("dateInp").value, today = db.filter(r => r.date === d);
        if(!today.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        if(confirm("‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥?")) {
            const tot = today.reduce((a,b) => a+b.price, 0), cash = today.filter(r=>r.pay==='Cash').reduce((a,b)=>a+b.price, 0);
            const bEarn = Math.max(tot * (conf.perc/100), conf.guar);
            let ds = {}; today.forEach(r => r.svcs.forEach(s => ds[s] = (ds[s]||0)+1));
            archives = archives.filter(a => a.date !== d);
            archives.push({ date: d, total: tot, cash: cash, barber: bEarn, shop: tot-bEarn, settle: cash-bEarn, count: today.length, details: today, stats: ds });
            localStorage.setItem("barber_arc", JSON.stringify(archives));
            db = db.filter(r => r.date !== d); localStorage.setItem("barber_db", JSON.stringify(db));
            speak("‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); go(3);
        }
    }

    function loadHistDaily() {
        const d = document.getElementById("histDate").value, found = archives.find(a => a.date === d), area = document.getElementById("histDailyArea");
        if(!found) { area.innerHTML = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; return; }
        let rows = found.details.map(r => `<div class="history-row"><div style="display:flex; justify-content:space-between"><b>${r.time} | ${r.svcs.join('+')}</b><b>‡∏ø${r.price}</b></div></div>`).join('');
        area.innerHTML = `<div style="background:var(--input-bg); padding:15px; border-radius:15px; text-align:left;">
            <button onclick="closeHist('histDailyArea')" style="float:right; border:none; background:var(--danger); color:white; border-radius:5px; padding:2px 8px;">‡∏õ‡∏¥‡∏î</button>
            <div style="font-weight:600; color:var(--primary); margin-bottom:10px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${found.date}</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; font-size:13px; margin-bottom:10px;">
                <div>‡∏£‡∏ß‡∏°: ${found.total.toLocaleString()}</div><div>‡∏ä‡πà‡∏≤‡∏á: ${Math.floor(found.barber).toLocaleString()}</div>
            </div>
            <div style="max-height:200px; overflow-y:auto; border-top:1px dashed #ccc; padding-top:10px;">${rows}</div>
        </div>`;
        area.style.opacity = "1";
    }

    function loadHistMonth() {
        const m = document.getElementById("histMonth").value, area = document.getElementById("histMonthArea"), filtered = archives.filter(a => a.date.startsWith(m));
        if(!filtered.length) { area.innerHTML = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; return; }
        let tot=0, bTot=0, cTot=0; filtered.forEach(a => { tot+=a.total; bTot+=a.barber; cTot+=a.count; });
        area.innerHTML = `<div style="background:var(--input-bg); padding:15px; border-radius:15px; text-align:left;">
            <button onclick="closeHist('histMonthArea')" style="float:right; border:none; background:var(--danger); color:white; border-radius:5px; padding:2px 8px;">‡∏õ‡∏¥‡∏î</button>
            <div style="font-size:18px; font-weight:600; color:var(--primary); margin-bottom:10px;">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${m}</div>
            <div style="font-size:20px; font-weight:600;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ‡∏ø${tot.toLocaleString()}</div>
            <div style="font-size:14px; margin-top:5px;">‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°: ‡∏ø${Math.floor(bTot).toLocaleString()} | ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${cTot} ‡∏Ñ‡∏ô</div>
        </div>`;
        area.style.opacity = "1";
    }

    function closeHist(id) { document.getElementById(id).innerHTML = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; document.getElementById(id).style.opacity = "0.6"; }

    function shareLine() {
        const d = document.getElementById("dateInp").value, today = db.filter(r => r.date === d);
        if(!today.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        let tot=0, trans=0, cash=0, ds=d.split('-'), thaiDate=`${ds[2]}/${ds[1]}/${parseInt(ds[0])+543}`;
        let msg = `üíà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô: ${conf.shop}\nüìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${thaiDate}\n--------------------------\n`;
        today.sort((a,b)=>a.time.localeCompare(b.time)).forEach((r,i) => {
            tot+=r.price; r.pay==='Trans' ? trans+=r.price : cash+=r.price;
            msg+=`${i+1}. [${r.time}] ${r.svcs.join('+')} ${r.hair?'('+r.hair+')':''} = ${r.price}${r.pay==='Cash'?'üíµ':'üì±'}\n`;
        });
        const bEarn = Math.max(tot*(conf.perc/100), conf.guar), sEarn = tot-bEarn, settle = cash-bEarn;
        msg+=`--------------------------\nüí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${tot.toLocaleString()}‡∏ø\nüì± ‡πÇ‡∏≠‡∏ô: ${trans.toLocaleString()}‡∏ø\nü§µ ‡∏ä‡πà‡∏≤‡∏á: ${Math.floor(bEarn).toLocaleString()}‡∏ø\nüè† ‡∏£‡πâ‡∏≤‡∏ô: ${Math.floor(sEarn).toLocaleString()}‡∏ø\n--------------------------\n`;
        msg += settle > 0 ? `‚ö†Ô∏è ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô: ${Math.floor(settle).toLocaleString()}‡∏ø` : settle < 0 ? `‚ö†Ô∏è ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á: ${Math.floor(Math.abs(settle)).toLocaleString()}‡∏ø` : "‚úÖ ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏û‡∏≠‡∏î‡∏µ";
        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(msg)}`);
    }

    function openSettings() { document.getElementById("modalSet").style.display="flex"; document.getElementById("setShop").value=conf.shop; document.getElementById("setPerc").value=conf.perc; document.getElementById("setGuar").value=conf.guar; }
    function closeSettings() { document.getElementById("modalSet").style.display="none"; }
    function saveSettings() { 
        conf.shop = document.getElementById("setShop").value; conf.perc = Number(document.getElementById("setPerc").value); conf.guar = Number(document.getElementById("setGuar").value);
        conf.sound = document.getElementById("setSound").value; conf.voice = document.getElementById("setVoice").value;
        localStorage.setItem("barber_conf", JSON.stringify(conf)); applySettings(); closeSettings(); speak("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
    }
    function applySettings() { document.getElementById("shopNameDisp").innerText=conf.shop; document.getElementById("mainBody").className="theme-"+(conf.theme||'light'); }
    function clearAllData() { if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
