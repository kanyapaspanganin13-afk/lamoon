 <!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="apple-touch-icon" href="https://i.ibb.co/kVrdspsT/Barber-note-pro.jpg">
    <title>Barber Note Pro v.1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
    /* 1. Global & Variables */
    :root {
        --primary: #6366f1; --accent: #0ea5e9; --danger: #ef4444; 
        --success: #22c55e; --bg: #f8fafc; --card: #ffffff; 
        --text: #1e293b; --border: #e2e8f0; --input-bg: #f1f5f9;
    }
    /* 2. Themes Support (‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏µ Input/Card ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏£‡∏¥‡∏á) */
    body.navy { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --accent: #38bdf8; --input-bg: #334155; --border: rgba(255,255,255,0.1); }
    body.dark { --bg: #121212; --card: #1a1a1a; --text: #fbbf24; --accent: #fbbf24; --input-bg: #262626; --border: #333; }
    * { box-sizing: border-box; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; } 
    body { 
        margin: 0; background-color: var(--bg); color: var(--text); 
        padding-bottom: 90px; overflow-x: hidden; 
        transition: background-color .3s ease, color .3s ease; 
    }
    .container { padding: 15px 15px 100px 15px; max-width: 500px; margin: auto; position: relative; z-index: 1; }
    /* 3. Navigation (‡∏£‡∏ß‡∏°‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö) */
    nav {
        position: fixed; bottom: 0; left: 0; right: 0; height: 75px;
        background: #1a237e; display: flex; justify-content: space-around;
        align-items: center; z-index: 999999; box-shadow: 0 -10px 30px rgba(0,0,0,0.4);
    }
    .nav-item {
        flex: 1; display: flex; flex-direction: column; align-items: center; 
        justify-content: center; cursor: pointer; color: rgba(255,255,255,0.5);
        transition: color .2s ease, transform .2s ease;
    }
    .nav-item.active { color: var(--accent); opacity: 1; transform: translateY(-2px); }
    .nav-item i { font-size: 22px; margin-bottom: 2px; }
    .nav-item span { font-size: 11px; font-weight: 700; }
    /* 4. Layout & Grid (‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå) */
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 8px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
    .card { background: var(--card); border-radius: 25px; padding: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); border: 1px solid var(--border); margin-bottom: 15px; }
    .icon-card { 
        background: var(--card); color: var(--text); border: 1px solid var(--border);
        border-radius: 15px; padding: 10px 2px; display: flex; flex-direction: column; 
        align-items: center; justify-content: center; gap: 4px; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); height: 75px; font-size: 14px; cursor: pointer;
    }
    /* 5. Input & Buttons (‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∞‡πÉ‡∏à‡∏ä‡πà‡∏≤‡∏á) */
    input, select { 
        width: 100%; height: 70px; border-radius: 20px; font-size: 20px; 
        font-weight: 700; text-align: center; outline: none; 
        background: var(--input-bg); color: var(--text); border: 1px solid var(--border);
        box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 10px;
    }
    .btn { border: none; padding: 15px; border-radius: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 700; transition: 0.2s; font-size: 16px; }
    
    .btn-pay { background: var(--card); color: var(--text); border: 2px solid var(--border); height: 70px; font-size: 18px; }
    .btn-pay.active-cash { background: #dcfce7 !important; color: #15803d !important; border-color: #22c55e !important; }
    .btn-pay.active-trans { background: #e0f2fe !important; color: #0369a1 !important; border-color: #0ea5e9 !important; }
    
    .btn-save { background: var(--success); color: white; width: 100%; }
    .btn-green { background: var(--success); color: white; }
    .btn-outline { background: transparent; color: var(--accent); border: 2px solid var(--accent); }
    /* 6. Status & Modal */
    .page { display: none; }
    .page.active { display: block; }
    .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); display: none; z-index: 100000; align-items: center; justify-content: center; }
    .modal-content { background: var(--card); color: var(--text); width: 90%; max-width: 400px; border-radius: 25px; padding: 25px; max-height: 85vh; overflow-y: auto; }
    .status-bar { padding: 12px; border-radius: 12px; text-align: center; font-weight: 800; font-size: 14px; margin-bottom: 10px; }
    #accHistory { font-size: 13px; max-height: 200px; overflow-y: auto;margin-top: 15px;padding: 5px;border-top: 1px dashed var(--border);}
    #accHistory::-webkit-scrollbar { width: 5px; }
    #accHistory::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
</style>
</head>
<body>
<div class="container">
<div id="p1" class="page active">
    <h2 id="shopNameDisp" style="text-align:center; font-weight:900; margin: 10px 0 20px 0; letter-spacing: 1px; text-transform: uppercase;">BARBER SHOP</h2>
    
    <div class="grid-3" style="gap: 12px; margin-bottom: 20px;">
        <div class="icon-card" onclick="handleInsurance()">
            <div style="background:linear-gradient(135deg, #fbbf24, #f59e0b); width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:8px; color:#fff; font-size:18px;">
                <i class="fas fa-shield-alt"></i>
            </div>
            <span>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</span>
        </div>
        
        <div class="icon-card" onclick="handleHoliday()">
            <div style="background:linear-gradient(135deg, #f87171, #ef4444); width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:8px; color:#fff; font-size:18px;">
                <i class="fas fa-umbrella-beach"></i>
            </div>
            <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span>
        </div>

        <div class="icon-card" onclick="openSettings()">
            <div style="background:linear-gradient(135deg, #94a3b8, #475569); width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:8px; color:#fff; font-size:18px;">
                <i class="fas fa-cog"></i>
            </div>
            <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
        </div>
    </div>

    <div class="grid-3" style="gap:10px; margin-bottom:15px;">
        <div style="background:var(--card); border-radius:18px; border:1px solid var(--border); height:75px; position:relative; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
            <span id="dateDisplay" style="font-weight:800; color:var(--text); font-size:18px;">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
            <input type="date" id="dateInp" onchange="updateDateDisplay(this.value)" style="position:absolute; opacity:0; width:100%; height:100%; cursor:pointer; z-index:2;">
        </div>
        <input type="time" id="tStart">
        <input type="time" id="tEnd">
    </div>

    <div style="display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 8px; margin-bottom: 15px;">
        <select id="hairStyle">
            <option value="">‚úÇÔ∏è ‡∏ó‡∏£‡∏á‡∏ú‡∏°</option>
            <option value="‡πÄ‡∏î‡πá‡∏Å">‡∏ï‡∏±‡∏î‡∏ú‡∏°‡πÄ‡∏î‡πá‡∏Å</option>
            <option>‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á</option><option>‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô</option><option>‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î</option><option>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á</option><option>‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£</option><option>‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            <option>‡πÅ‡∏Å‡πâ‡∏ú‡∏°</option><option>‡πÇ‡∏Å‡∏ô‡∏ú‡∏°</option>
        </select>
        <select id="extra1"><option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£1</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option></select>
        <select id="extra2"><option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£2</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option></select>
    </div>

    <div style="display: grid; grid-template-columns: 1.4fr 1fr; gap: 8px; margin: 10px 0;">
        <div style="position: relative; background: var(--card); border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 8px 20px rgba(0,0,0,0.05);">
            <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 24px; color: var(--primary); font-weight: 900;">‡∏ø</span>
            <input type="number" id="priceInp" placeholder="0" inputmode="numeric" style="background: transparent !important; font-size: 45px !important; padding-left: 45px !important; border: none !important; margin-bottom:0;">
        </div>
        <input type="number" id="tipInp" placeholder="‡∏ó‡∏¥‡∏õ" inputmode="numeric" style="background: #ccfbf1 !important; color: #0f766e !important; height: 85px !important; margin-bottom:0;">
    </div>

    <div class="grid-2" style="margin-bottom:20px;">
        <button id="btnCash" class="btn btn-pay" onclick="selectPay('Cash')">
            <i class="fas fa-money-bill-wave" style="margin-right:8px;"></i> ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
        </button>
        <button id="btnTrans" class="btn btn-pay" onclick="selectPay('Trans')">
            <i class="fas fa-qrcode" style="margin-right:8px;"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢
        </button>
    </div>

    <button class="btn btn-save" onclick="handleSave(event)" style="height:90px; border-radius:28px;">
        <i class="fas fa-save" style="font-size: 38px; margin-right:15px;"></i>
        <span style="font-size: 32px; font-weight: 900; letter-spacing:1px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
    </button>  
</div>
<div id="p2" class="page">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
        <div class="card" style="text-align:center; padding:18px 15px;">
            <small style="font-weight:800; color:var(--text); opacity:0.6; text-transform: uppercase;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
            <div id="dTotal" style="font-size:36px; font-weight:900; color:var(--primary); margin: 5px 0;">0</div>
            <div id="dCounts" style="font-size:13px; font-weight:700; color:#fff; background:var(--accent); display:inline-block; padding:2px 10px; border-radius:10px;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 0 ‡∏Ñ‡∏ô</div>
        </div>
        <div class="card" style="display:flex; flex-direction:column; justify-content:center; gap:8px;">
            <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:700;"><span style="color:var(--accent);">üì± ‡πÇ‡∏≠‡∏ô:</span> <b id="dTrans">0</b></div>
            <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:700;"><span style="color:#f59e0b;">üíµ ‡∏™‡∏î:</span> <b id="dCash">0</b></div>
            <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:700;"><span style="color:var(--primary);">ü§µ ‡∏ä‡πà‡∏≤‡∏á:</span> <b id="dBarber">0</b></div>
            <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:800;"><span style="color:var(--text);">üè† ‡∏£‡πâ‡∏≤‡∏ô:</span> <b id="dShop">0</b></div>
        </div>
    </div>
    <div id="settleBarContainer" style="margin-bottom:18px;"><div id="settleBar"></div> </div>
    <div id="dServiceStats"></div>
    <hr style="border:0; border-top:1px solid var(--border); margin-top:15px;">
    <div id="dailyList"></div>
</div>
<div id="p3" class="page" style="max-width:480px; margin:0 auto; padding: 12px; padding-bottom: 100px;">
    
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <b style="font-size:16px; color:var(--primary);"><i class="fas fa-wallet"></i> ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</b>
            <div id="accLight" style="background:#22c55e; width:10px; height:10px; border-radius:50%; box-shadow:0 0 8px #22c55e;"></div>
        </div>

        <div class="grid-2" style="margin-bottom:25px;">
            <div style="background:var(--input-bg); border-radius:22px; padding:18px 10px; text-align:center; border: 1px solid var(--border);">
                <small style="font-size:11px; color:var(--text); opacity:0.6; font-weight:700; text-transform:uppercase;">‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°</small>
                <b style="font-size:22px; color:var(--text); font-weight:900; display:block;" id="accOldVal">‡∏ø0</b>
            </div>
            <div style="background:var(--input-bg); border-radius:22px; padding:18px 10px; text-align:center; border: 1px solid var(--border);">
                <small style="font-size:11px; color:var(--text); opacity:0.6; font-weight:700; text-transform:uppercase;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
                <b style="font-size:22px; color:var(--text); font-weight:900; display:block;" id="accTodayVal">‡∏ø0</b>
            </div>
        </div>

        <div style="text-align:center; margin-bottom:20px;">
            <div style="font-size:48px; font-weight:900; color:var(--primary); letter-spacing:-1px;">‡∏ø<span id="accNet">0</span></div>
            <div id="accStatus" style="font-size:12px; font-weight:700;"></div>
        </div>

        <div style="margin-bottom:15px;">
            <div style="display:flex; align-items:center; background:var(--input-bg); border-radius:15px; padding:0 15px; margin-bottom:8px; height:50px;">
                <i class="fas fa-calendar-alt" style="color:var(--primary);"></i>
                <input type="date" id="accDate" style="flex:1; border:none; background:none; font-size:16px; font-weight:600; padding-left:10px; color:var(--text);">
            </div>
            <div style="display:flex; align-items:center; background:var(--input-bg); border-radius:15px; padding:0 15px; height:50px;">
                <i class="fas fa-pen-nib" style="color:var(--text); opacity:0.5;"></i>
                <input type="text" id="accNote" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥..." style="flex:1; border:none; background:none; font-size:15px; padding-left:10px; color:var(--text);">
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap:10px;">
            <button class="btn btn-green" onclick="clearAccount()" style="padding:15px 5px; font-size:14px;">
                <i class="fas fa-check-double"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô
            </button>
            <button class="btn btn-outline" onclick="$('historyModal').style.display='flex'" style="padding:15px 5px; font-size:14px;">
                <i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            </button>
        </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:15px;">
        <div onclick="$('histDate').showPicker()" style="background:linear-gradient(135deg, #f59e0b, #d97706); border-radius:25px; padding:20px 10px; text-align:center; color:#fff; position:relative; box-shadow:0 8px 15px rgba(245,158,11,0.2);">
            <i class="fas fa-search-dollar" style="font-size:28px; margin-bottom:5px; display:block;"></i>
            <b style="font-size:14px;">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</b>
            <input type="date" id="histDate" onchange="loadHistDaily()" style="position:absolute; inset:0; opacity:0;">
        </div>
        <div onclick="$('histMonth').showPicker()" style="background:linear-gradient(135deg, #6366f1, #4338ca); border-radius:25px; padding:20px 10px; text-align:center; color:#fff; position:relative; box-shadow:0 8px 15px rgba(99,102,241,0.2);">
            <i class="fas fa-calendar-check" style="font-size:28px; margin-bottom:5px; display:block;"></i>
            <b style="font-size:14px;">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</b>
            <input type="month" id="histMonth" onchange="loadHistMonth()" style="position:absolute; inset:0; opacity:0;">
        </div>
    </div>

    <div id="histResult"></div> 
</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <b><i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</b>
            <i class="fas fa-times" onclick="$('historyModal').style.display='none'" style="cursor:pointer; padding:5px;"></i>
        </div>
        <div id="barber_acc_logs_list"></div> 
    </div>
</div>
<div id="modalSet" class="modal" style="align-items:flex-end;">
    <div class="modal-content" style="width:92%; border-radius:35px 35px 0 0; margin-bottom:0; padding-bottom: calc(100px + env(safe-area-inset-bottom));">
        
        <div style="text-align:center; padding-top:10px;">
            <div style="width:40px; height:5px; background:var(--border); border-radius:10px; margin:0 auto 20px;"></div>
        </div>

        <h3 style="margin:0 0 20px; font-size:20px; color:var(--primary); font-weight:800; text-align:center;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>

        <div style="margin-bottom:18px;">
            <label style="display:block; font-size:11px; font-weight:800; color:var(--text); opacity:0.6; margin-bottom:8px;">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label>
            <input type="text" id="setShop" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
        </div>

        <div class="grid-2">
            <div>
                <label style="display:block; font-size:11px; font-weight:800; opacity:0.6; margin-bottom:8px;">% ‡∏ä‡πà‡∏≤‡∏á</label>
                <input type="number" id="setPerc" placeholder="%">
            </div>
            <div>
                <label style="display:block; font-size:11px; font-weight:800; opacity:0.6; margin-bottom:8px;">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</label>
                <input type="number" id="setGuar" placeholder="‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô">
            </div>
        </div>

        <div style="margin-top:18px;">
            <label style="display:block; font-size:11px; font-weight:800; opacity:0.6; margin-bottom:8px;">‡∏ò‡∏µ‡∏°‡∏£‡∏∞‡∏ö‡∏ö</label>
            <select id="setTheme" onchange="applyTheme(this.value)">
                <option value="light">üå§ ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á</option>
                <option value="navy">üåå ‡πÇ‡∏´‡∏°‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô</option>
                <option value="dark">üåë ‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏≥-‡∏ó‡∏≠‡∏á</option>
            </select>
        </div>

        <div class="grid-2" style="margin-top:18px;">
            <select id="setSound">
                <option value="on">üîä ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</option>
                <option value="off">üîá ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</option>
            </select>
            <select id="setVoice">
                <option value="female">üë∏ ‡∏´‡∏ç‡∏¥‡∏á </option>
                <option value="male">ü§µ ‡∏ä‡∏≤‡∏¢ </option>
            </select>
        </div>

        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px; margin-top:25px;">
            <button class="btn btn-save" onclick="saveSettings()" style="height:65px; border-radius:22px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button onclick="$('modalSet').style.display='none'" style="background:#fff5f5; color:#e11d48; height:65px; border-radius:22px; border:none; font-size:32px; display:flex; align-items:center; justify-content:center; cursor:pointer;">‚èª</button>
        </div>

        <button onclick="clearAllData()" style="width:100%; margin-top:20px; background:none; border:none; color:var(--danger); font-size:14px; font-weight:700; text-decoration:underline; cursor:pointer; opacity:0.7;">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
</div>

<nav>
    <div id="nav1" onclick="go(1)" class="nav-item active"><i class="fas fa-edit"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span></div>
    <div id="nav2" onclick="go(2)" class="nav-item"><i class="fas fa-history"></i><span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span></div>
    <div id="nav3" onclick="go(3)" class="nav-item"><i class="fas fa-wallet"></i><span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span></div>
</nav>

<script>
// --- ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå (Refactored by Gemini) ---
const $ = (id) => document.getElementById(id);

// --- 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
let archives = JSON.parse(localStorage.getItem("barber_arc")) || [];
let db = JSON.parse(localStorage.getItem("barber_db")) || [];
let conf = JSON.parse(localStorage.getItem("barber_conf")) || { shop: "BARBER SHOP", perc: 50, guar: 0, theme: 'light', sound: 'on', voice: 'female' };
let accLogs = JSON.parse(localStorage.getItem("barber_acc_logs")) || []; 
let payMethod = "Cash";

// --- 2. ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏ã‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
function saveAll() {
    localStorage.setItem("barber_arc", JSON.stringify(archives));
    localStorage.setItem("barber_db", JSON.stringify(db));
    localStorage.setItem("barber_conf", JSON.stringify(conf));
    localStorage.setItem("barber_acc_logs", JSON.stringify(accLogs));
}

// --- 3. Initial Setup ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ ---
window.addEventListener("DOMContentLoaded", () => {
    const today = new Date().toISOString().split('T')[0];
    if ($("dateInp")) $("dateInp").value = today;
    if ($("accDate")) $("accDate").value = today;
    if ($("histDate")) $("histDate").value = today;
    
    applyTheme(conf.theme || 'light');
    applySettings();
    updateDateDisplay(today);
    selectPay("Cash");
    updateNetAccount();
    
    // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Time
    const now = new Date();
    const tStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
    if($("tStart")) $("tStart").value = tStr;
    if($("tEnd")) $("tEnd").value = addMinutes(tStr, 30);
});

// --- 4. Logic ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (P1) ---
function addMinutes(time, mins) {
    if (!time) return "";
    const [h, m] = time.split(":").map(Number);
    const d = new Date();
    d.setHours(h, m + mins, 0, 0);
    return d.toTimeString().slice(0, 5);
}

function handleSave(e) {
    if(e) e.preventDefault();
    const p = parseInt($("priceInp").value);
    const t = parseInt($("tipInp").value) || 0;
    if (!p) return alert("‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏ñ‡πâ‡∏≤‡πÅ‡∏Å‡πà!");

    const start = $("tStart").value || new Date().toTimeString().slice(0, 5);
    const rec = {
        id: Date.now(),
        date: $("dateInp").value,
        time: start,
        endTime: $("tEnd").value || addMinutes(start, 30),
        svcs: [$("hairStyle").value, $("extra1").value, $("extra2").value].filter(Boolean),
        hair: $("hairStyle").value,
        price: p,
        tip: t,
        pay: payMethod,
        type: "SERVICE"
    };

    db.push(rec);
    saveAll();
    speak(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${p} ‡∏ö‡∏≤‡∏ó`);
    
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
    ["priceInp", "tipInp"].forEach(id => $(id).value = "");
    renderDay();
}

function handleInsurance() {
    const d = $("dateInp").value;
    const g = parseInt(conf.guar) || 0;
    if (g <= 0) return alert("‚ö†Ô∏è ‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤' ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
    
    if (db.find(r => r.date === d && r.type === "GUARANTEE_CLAIM")) return alert("üõ°Ô∏è ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
    
    if (confirm(`üõ°Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ' ${g} ‡∏ö‡∏≤‡∏ó?`)) {
        db.push({ id: Date.now(), date: d, time: "00:00", svcs: ["üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô"], price: 0, pay: "N/A", type: "GUARANTEE_CLAIM" });
        saveAll();
        renderDay();
    }
}

function handleHoliday() {
    const d = $("dateInp").value;
    if(confirm(`üèñÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d} ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î?`)) {
        db.push({ id: Date.now(), date: d, time: "00:00", svcs: ["üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"], price: 0, pay: "N/A", type: "HOLIDAY" });
        saveAll();
        renderDay();
    }
}

// --- 5. Logic ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (P2) ---
function renderDay() {
    const dInp = $("dateInp").value;
    const allRec = db.filter(r => r.date === dInp);
    const today = allRec.filter(r => r.type !== 'HOLIDAY');
    const isHoliday = allRec.some(r => r.type === 'HOLIDAY');
    
    let tot = 0, trans = 0, cash = 0, tips = 0, listHtml = "";
    let stats = {};

    today.sort((a,b) => a.time.localeCompare(b.time)).forEach((r, i) => {
        const p = Number(r.price)||0, t = Number(r.tip)||0;
        tot += p; tips += t;
        (r.pay === 'Trans') ? trans += (p + t) : cash += p;
        
        (r.svcs || []).forEach(s => { if(s) stats[s] = (stats[s] || 0) + 1; });

        listHtml += `
            <div class="history-row" style="background:var(--card); border-bottom:1px solid var(--border); padding:15px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:800; color:var(--text);">${i+1}. [${r.time}] ${r.svcs.join('+')}</div>
                    ${t ? `<small style="color:var(--accent); font-weight:700;">‡∏ó‡∏¥‡∏õ: ‡∏ø${t}</small>` : ''}
                </div>
                <div style="text-align:right;">
                    <b style="color:var(--text);">‡∏ø${p}</b>
                    <div style="font-size:11px; opacity:0.6;">${r.pay==='Trans'?'üì± ‡πÇ‡∏≠‡∏ô':'üíµ ‡∏™‡∏î'} <i class="fas fa-trash-alt" style="color:red; margin-left:5px;" onclick="delRec(${r.id})"></i></div>
                </div>
            </div>`;
    });

    const bEarn = isHoliday ? 0 : Math.max(tot * (conf.perc / 100), conf.guar) + tips;
    const sEarn = isHoliday ? 0 : tot - (bEarn - tips);
    const settle = isHoliday ? 0 : cash - bEarn;

    $("dTotal").innerText = tot.toLocaleString();
    $("dTrans").innerText = trans.toLocaleString();
    $("dCash").innerText = cash.toLocaleString();
    $("dBarber").innerText = Math.floor(bEarn).toLocaleString();
    $("dShop").innerText = Math.floor(sEarn).toLocaleString();
    $("dCounts").innerText = isHoliday ? "üè™ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î" : `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${today.length} ‡∏Ñ‡∏ô`;

    // ‡πÅ‡∏™‡∏î‡∏á Badge ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    let sH = "";
    for (let s in stats) sH += `<span class="badge">${s}: ${stats[s]}</span>`;
    $("dServiceStats").innerHTML = sH;

    // ‡πÅ‡∏ñ‡∏ö Settle ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
    let txt = "‚úÖ ‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ", bg = "var(--border)";
    if (isHoliday) { txt = "üèñÔ∏è ‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"; }
    else if (settle > 0) { txt = `üü• ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${Math.floor(settle).toLocaleString()}`; bg = "#fee2e2"; }
    else if (settle < 0) { txt = `üü¶ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ‡∏ø${Math.floor(Math.abs(settle)).toLocaleString()}`; bg = "#e0e7ff"; }

    $("settleBar").innerText = txt;
    $("settleBar").style.background = bg;
    $("dailyList").innerHTML = listHtml || "<center style='padding:40px; opacity:0.3;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</center>";
    
    updateNetAccount();
}

function delRec(id) {
    if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) {
        db = db.filter(r => r.id !== id);
        saveAll();
        renderDay();
    }
}

// --- 6. Logic ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (P3) ---
function updateNetAccount() {
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Archives
    const totalSettle = archives.reduce((sum, day) => sum + (Number(day.settle) || 0), 0);
    
    // ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
    const dInp = $("dateInp").value;
    const dayRecs = db.filter(r => r.date === dInp);
    const isHoliday = dayRecs.some(r => r.type === 'HOLIDAY');
    const tot = dayRecs.reduce((a,b) => a + (Number(b.price)||0), 0);
    const cash = dayRecs.filter(r => r.pay === 'Cash').reduce((a,b) => a + (Number(b.price)||0), 0);
    const tips = dayRecs.reduce((a,b) => a + (Number(b.tip)||0), 0);
    const bEarn = isHoliday ? 0 : Math.max(tot * (conf.perc / 100), conf.guar) + tips;
    const todaySettle = isHoliday ? 0 : cash - bEarn;

    if($("accNet")) $("accNet").innerText = Math.floor(totalSettle + todaySettle).toLocaleString();
    if($("accOldVal")) $("accOldVal").innerText = "‡∏ø" + Math.floor(totalSettle).toLocaleString();
    if($("accTodayVal")) $("accTodayVal").innerText = "‡∏ø" + Math.floor(todaySettle).toLocaleString();
    
    const light = $("accLight");
    if(light) light.style.background = (totalSettle + todaySettle) === 0 ? "#22c55e" : "#ef4444";
}

function saveAndGo() {
    const d = $("dateInp").value;
    const dayRecs = db.filter(r => r.date === d);
    if(!dayRecs.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!");

    if(confirm("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏•‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥?")) {
        const tot = dayRecs.reduce((a,b) => a + (Number(b.price)||0), 0);
        const cash = dayRecs.filter(r => r.pay === 'Cash').reduce((a,b) => a + (Number(b.price)||0), 0);
        const tips = dayRecs.reduce((a,b) => a + (Number(b.tip)||0), 0);
        const bEarn = Math.max(tot * (conf.perc / 100), conf.guar) + tips;
        const settle = cash - bEarn;

        const arc = {
            date: d,
            total: tot,
            cash: cash,
            barber: bEarn,
            shop: tot - (bEarn - tips),
            settle: settle,
            count: dayRecs.length,
            details: dayRecs,
            stats: getDailyStats(dayRecs)
        };

        archives = archives.filter(a => a.date !== d);
        archives.push(arc);
        db = db.filter(r => r.date !== d);
        saveAll();
        alert("‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
        go(3);
        updateNetAccount();
    }
}

function getDailyStats(data) {
    let s = {};
    data.forEach(r => r.svcs.forEach(v => s[v] = (s[v] || 0) + 1));
    return s;
}

function clearAccount() {
    const total = archives.reduce((sum, day) => sum + (Number(day.settle) || 0), 0);
    if(total === 0) return alert("‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡∏£‡∏±‡∏ö");

    if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô ‡∏ø${Math.floor(total).toLocaleString()}?`)) {
        accLogs.push({
            date: $("accDate").value,
            amount: total,
            note: $("accNote").value || "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î‡∏õ‡∏Å‡∏ï‡∏¥"
        });
        archives = [];
        saveAll();
        $("accNote").value = "";
        alert("‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        updateNetAccount();
    }
}

// --- 7. ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ & ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ---
function loadHistDaily() {
    const d = $("histDate").value;
    const found = archives.find(a => a.date === d);
    const area = $("histResult");
    if(!found) return area.innerHTML = `<center style="padding:20px; opacity:0.5;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d}</center>`;

    area.innerHTML = `
        <div class="card" style="margin-top:10px;">
            <div style="display:flex; justify-content:space-between; font-weight:900; margin-bottom:10px;">
                <span>üìÖ ${found.date}</span>
                <span style="color:var(--primary);">‡∏ø${found.total.toLocaleString()}</span>
            </div>
            <div style="font-size:12px; display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                <div>üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î: ${found.cash}</div>
                <div>ü§µ ‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ: ${Math.floor(found.barber)}</div>
                <div>üè† ‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ${Math.floor(found.shop)}</div>
                <div style="color:var(--accent);">üö© ‡∏Ñ‡πâ‡∏≤‡∏á: ${Math.floor(found.settle)}</div>
            </div>
        </div>`;
}
function loadHistMonth() {
    const m = $("histMonth").value; // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å input ‡πÄ‡∏ä‡πà‡∏ô "2024-03"
    const area = $("histResult");
    
    if(!m) return;
    
    // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    const filtered = archives.filter(a => a.date.startsWith(m));
    
    if(!filtered.length) { 
        area.innerHTML = `
            <div style="text-align:center; padding:40px; background:var(--card); border-radius:25px; margin-top:15px; border:1px solid var(--border);">
                <i class="fas fa-folder-open" style="font-size:40px; opacity:0.2; margin-bottom:10px; display:block;"></i>
                <div style="color:var(--text); opacity:0.5; font-weight:600;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${m}</div>
            </div>`; 
        return; 
    }

    // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    let monthTotal = 0;   
    let monthBarber = 0;  
    let monthShop = 0;    
    let monthCount = 0;   
    let monthStats = {};

    filtered.forEach(a => { 
        monthTotal += (Number(a.total) || 0); 
        monthBarber += (Number(a.barber) || 0); 
        monthShop += (Number(a.shop) || 0); 
        monthCount += (Number(a.count) || 0); 
        
        // ‡∏£‡∏ß‡∏°‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
        if(a.stats) { 
            for(let s in a.stats) monthStats[s] = (monthStats[s] || 0) + a.stats[s]; 
        } 
    });

    // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
    let statBadges = "";
    for(let s in monthStats) { 
        statBadges += `<span class="badge" style="background:var(--primary); color:#fff; border:none;">${s}: ${monthStats[s]}</span>`; 
    }

    area.innerHTML = `
    <div class="card" style="margin-top:15px; border:1px solid var(--border); animation: slideUp 0.3s ease-out;">
        <div style="text-align:center; margin-bottom:20px;">
            <small style="font-size:11px; color:var(--text); opacity:0.6; font-weight:800; text-transform:uppercase;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${m}</small>
            <div style="font-size:36px; font-weight:900; color:var(--primary); margin:5px 0;">‡∏ø${monthTotal.toLocaleString()}</div>
        </div>

        <div class="grid-2" style="margin-bottom:20px;">
            <div style="background:var(--input-bg); padding:15px; border-radius:20px; text-align:center;">
                <div style="font-size:11px; opacity:0.7; font-weight:700;">ü§µ ‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</div>
                <div style="font-size:18px; font-weight:800; color:#10b981;">‡∏ø${Math.floor(monthBarber).toLocaleString()}</div>
            </div>
            <div style="background:var(--input-bg); padding:15px; border-radius:20px; text-align:center;">
                <div style="font-size:11px; opacity:0.7; font-weight:700;">üè† ‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</div>
                <div style="font-size:18px; font-weight:800; color:var(--primary);">‡∏ø${Math.floor(monthShop).toLocaleString()}</div>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:15px; padding:10px; border-bottom:1px dashed var(--border);">
            <span>üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b>${monthCount} ‡∏Ñ‡∏ô</b></span>
            <span>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: <b>${filtered.length} ‡∏ß‡∏±‡∏ô</b></span>
        </div>

        <div style="margin-top:10px;">
            <div style="font-size:11px; font-weight:800; opacity:0.5; margin-bottom:10px;">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</div>
            <div style="display:flex; flex-wrap:wrap; gap:5px;">
                ${statBadges || '<span style="opacity:0.3;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span>'}
            </div>
        </div>
    </div>`;
}
function shareLine() {
    const dInp = $("dateInp").value, 
          today = db.filter(r => r.date === dInp); 
    
    if (!today.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÅ‡∏ä‡∏£‡πå‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏ñ‡πâ‡∏≤‡πÅ‡∏Å‡πà");

    const dp = dInp.split('-'), 
          fDate = `${dp[2]}/${dp[1]}/${parseInt(dp[0])+543}`; // ‡πÉ‡∏™‡πà‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢
    
    let tot=0, cash=0, trans=0, tips=0, stats={};

    // 1. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤)
    let clientList = today.sort((a,b)=>a.time.localeCompare(b.time)).map((r,i)=>{
        const p = Number(r.price)||0, t = Number(r.tip)||0; 
        tot+=p; tips+=t;
        r.pay==='Trans' ? trans+=p : cash+=p;
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏£‡∏á‡∏ú‡∏°‡πÄ‡∏î‡πá‡∏Å
        if(r.hair && r.hair.includes("‡πÄ‡∏î‡πá‡∏Å")) stats["‡πÄ‡∏î‡πá‡∏Å"] = (stats["‡πÄ‡∏î‡πá‡∏Å"]||0) + 1;
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°
        (r.svcs||[]).forEach(s=>{ if(s) stats[s] = (stats[s]||0) + 1; });

        const tShow = r.endTime ? `${r.time}-${r.endTime}` : r.time;
        return `${i+1}. [${tShow}] ${(r.svcs||[]).join('+')} = ${p.toLocaleString()}${t ? ` (+‡∏ó‡∏¥‡∏õ ${t})` : ''} ${r.pay==='Trans'?'üì±':'üíµ'}`;
    }).join('\n');

    // 2. ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö Filter (‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡∏î‡∏°‡∏∂‡∏á)
    const allowed = ["‡πÄ‡∏î‡πá‡∏Å","‡∏™‡∏£‡∏∞‡∏ú‡∏°","‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î","‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°","‡∏¢‡πâ‡∏≠‡∏°‡∏™‡∏µ"];
    const icons = {"‡πÄ‡∏î‡πá‡∏Å":"üßí","‡∏™‡∏£‡∏∞":"üßº","‡πÇ‡∏Å‡∏ô":"ü™í","‡∏¢‡πâ‡∏≠‡∏°":"üé®"};

    let statText = Object.entries(stats)
        .filter(([k]) => allowed.some(a => k.includes(a))) // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ
        .map(([k,v]) => {
            const icon = icons[Object.keys(icons).find(i => k.includes(i))] || 'üîπ';
            return `${icon} ${k}: ${v}`;
        }).join('\n');

    // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
    let bEarn = Math.max(tot * (conf.perc/100), conf.guar) + tips;
    let sEarn = tot - (bEarn - tips);
    let settle = cash - bEarn;
    let settleMsg = settle > 0 ? `‚ö†Ô∏è ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ${Math.floor(Math.abs(settle)).toLocaleString()}` : `üü¶ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ${Math.floor(Math.abs(settle)).toLocaleString()}`;

    // 4. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    let msg = `üíà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô: ${conf.shop}\n` +
              `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${fDate}\n` +
              `-------------------------\n` +
              `üìù ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (${today.length} ‡∏Ñ‡∏ô):\n${clientList}\n` +
              `-------------------------\n` +
              `üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô:\n${statText || 'üîπ ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}\n` +
              `-------------------------\n` +
              `üí∞ ‡∏¢‡∏≠‡∏î: ${tot.toLocaleString()} | üßß ‡∏ó‡∏¥‡∏õ: ${tips.toLocaleString()}\n` +
              `üì± ‡πÇ‡∏≠‡∏ô: ${trans.toLocaleString()} | üíµ ‡∏™‡∏î: ${cash.toLocaleString()}\n` +
              `ü§µ ‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ: ${Math.floor(bEarn).toLocaleString()}\n` +
              `üè† ‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ${Math.floor(sEarn).toLocaleString()}\n` +
              `-------------------------\n` +
              `${settleMsg}\n` +
              `-------------------------`;

    window.open(`https://line.me/R/msg/text/?${encodeURIComponent(msg)}`);
}
// --- 8. UI & Navigation ---
function go(p) {
    document.querySelectorAll('.page').forEach(pg => pg.style.display = 'none');
    $(`p${p}`).style.display = 'block';
    document.querySelectorAll('.nav-item').forEach((item, i) => {
        item.classList.toggle('active', (i+1) === p);
    });
    if(p === 2) renderDay();
    if(p === 3) updateNetAccount();
}

function selectPay(m) {
    payMethod = m;
    $("btnCash").classList.toggle('active-cash', m === 'Cash');
    $("btnTrans").classList.toggle('active-trans', m === 'Trans');
}

function applyTheme(t) {
    document.body.className = t;
    conf.theme = t;
    saveAll();
}

function openSettings() {
    $("modalSet").style.display = "flex";
    $("setShop").value = conf.shop;
    $("setPerc").value = conf.perc;
    $("setGuar").value = conf.guar;
    $("setTheme").value = conf.theme;
}

function saveSettings() {
    conf.shop = $("setShop").value;
    conf.perc = $("setPerc").value;
    conf.guar = $("setGuar").value;
    conf.theme = $("setTheme").value;
    saveAll();
    location.reload();
}

function applySettings() {
    if($("shopNameDisp")) $("shopNameDisp").innerText = conf.shop;
}

function speak(t) {
    if(conf.sound === 'off') return;
    const m = new SpeechSynthesisUtterance(t);
    m.lang = 'th-TH';
    window.speechSynthesis.speak(m);
}

function updateDateDisplay(val) {
    if(!val) return;
    const d = new Date(val);
    const months = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
    if($("dateDisplay")) $("dateDisplay").innerText = d.getDate() + " " + months[d.getMonth()];
    renderDay();
}

function clearAllData() {
    if(confirm("üí£ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏≤‡∏ß‡∏£?")) {
        localStorage.clear();
        location.reload();
    }
}
</body>
</html>
