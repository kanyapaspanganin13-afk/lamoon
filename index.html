 <!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="apple-touch-icon" href="https://i.ibb.co/kVrdspsT/Barber-note-pro.jpg">
    <title>Barber Note Pro v.3</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
    :root { 
        --primary: #6366f1; --accent: #0ea5e9; --danger: #ef4444; --success: #22c55e; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --border: #e2e8f0;
    }
    * { box-sizing: border-box; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; overflow-x: hidden; }
    .container { padding: 15px 15px 100px 15px !important; max-width: 500px; margin: auto; position: relative; z-index: 1; }
    .nav-bar {
        position: fixed !important; bottom: 0 !important; left: 0 !important; right: 0 !important;
        height: 75px !important; background: white !important; display: flex !important; 
        justify-content: space-around !important; align-items: center !important; 
        z-index: 99999 !important; 
        border-top: 1px solid #eee;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }
    .nav-item {
        flex: 1 !important; display: flex !important; flex-direction: column !important;
        align-items: center !important; justify-content: center !important; cursor: pointer !important;
        pointer-events: auto !important;
    }
    .nav-item.active { color: #6366f1; }
    .nav-item i { font-size: 24px; }
    .nav-item span { font-size: 13px; font-weight: 500; }
    body.deep-navy { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --border: #334155; }
    body.deep-navy .icon-card, body.deep-navy input, body.deep-navy select { background: #1e293b; color: white; border-color: #334155; }
    body.barber-dark { --bg: #121212; --card: #1a1a1a; --text: #e0e0e0; --primary: #fbbf24; --border: #333; }
    body.barber-dark .icon-card, body.barber-dark input, body.barber-dark select { background: #1a1a1a; color: #fbbf24; border-color: #333; }   
    
    .grid-3 {display: grid !important; grid-template-columns: repeat(3, 1fr) !important; gap: 6px; margin-bottom: 8px;}
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
    .icon-card { position: relative; border-radius: 15px; padding: 15px 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1.5px solid transparent; background: #fff; }
    input, select { width: 100%; height: 68px !important; border-radius: 14px !important; font-size: 18px !important; font-weight: 600; text-align: center; border: 1.5px solid var(--border); background: #f1f5f9; }
   
    .btn { border: none; padding: 12px; border-radius: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 700; transition: 0.2s; }
    .btn-pay { background: #e2e8f0; color: #64748b; border:2px solid transparent; height: 70px; font-size: 18px;}
    .btn-pay.active-cash { background: #dcfce7; color: #15803d; border-color: #22c55e; }
    .btn-pay.active-trans { background: #e0f2fe; color: #0369a1; border-color: #0ea5e9; }
   
    .page { display: none; } 
    .page.active { display: block; }
    .modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.85); display: none; z-index: 100000; align-items: center; justify-content: center; }
    .modal-content { background: #fff; width: 90%; max-width: 400px; border-radius: 25px; padding: 25px; max-height: 85vh; overflow-y: auto; }
    .status-bar { padding: 12px; border-radius: 12px; text-align: center; font-weight: 800; font-size: 14px; margin-bottom: 10px; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
    .acc-main-card { background: white; padding: 20px; border-radius: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #fffbeb; }
    .btn-save { background: var(--success); color: white; border: none; width: 100%; padding: 15px; border-radius: 15px; font-weight: 700; font-size: 16px; cursor: pointer; }
    #accHistory { font-size: 12px; max-height: 150px; overflow-y: auto; }
      
    .price-row{display:grid;grid-template-columns:1.6fr 1fr;gap:10px;margin:10px 0 5px 0;align-items:center;}
    #priceInp, #tipInp, .price-box, .tip-input{height:90px!important;font-size:40px!important;font-weight:800!important;margin:0!important;text-align:center;border-radius:18px!important;}
    #priceInp, .price-box{border:2.5px solid var(--primary)!important;background:#fff;color:var(--text);}
    #tipInp, .tip-input{background:#fff1f2!important;border:2.5px solid #fecdd3!important;color:#be185d!important;}
   .btn-main{width:100%;height:85px;font-size:32px;border-radius:20px;background:var(--primary);color:#fff;margin-top:5px!important;border:none;display:flex;align-items:center;justify-content:center;gap:15px;font-weight:900;}
</style>
</head>
<body>
<div class="container">
    <div id="p1" class="page active">
        <h2 id="shopNameDisp" style="text-align:center; color:var(--primary); margin: 10px 0;">Barber Shop</h2>
        
        <div class="grid-3">
            <div class="icon-card" style="background: #fffbeb; border-color: #fde68a;" onclick="handleInsurance()"><span>ğŸ›¡ï¸</span><span style="color: #b45309;">à¸›à¸£à¸°à¸à¸±à¸™à¸£à¸²à¸¢à¹„à¸”à¹‰</span></div>
            <div class="icon-card" style="background: #fff1f2; border-color: #fecdd3;" onclick="handleHoliday()"><span>ğŸ–ï¸</span><span style="color: #be185d;">à¸šà¸±à¸™à¸—à¸¶à¸à¸§à¸±à¸™à¸«à¸¢à¸¸à¸”</span></div>
            <div class="icon-card" style="background: #f1f5f9; border-color: #cbd5e1;" onclick="openSettings()"><span>âš™ï¸</span><span style="color: #475569;">à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸£à¸°à¸šà¸š</span></div>
        </div>

        <div class="grid-3">
            <div class="icon-card" style="background: #f1f5f9; border-color: #cbd5e1; padding: 1px; height: 70px; position: relative;">
                <span id="dateDisplay" style="font-size: 18px; font-weight: 700;">à¹€à¸¥à¸·à¸­à¸à¸§à¸±à¸™à¸—à¸µà¹ˆ</span>
                <input type="date" id="dateInp" onchange="document.getElementById('dateDisplay').innerText = this.value; if(window.updateDateDisplay) updateDateDisplay(this.value)" style="position: absolute; top: 0; left: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2;">
            </div>
            <input type="time" id="tStart" placeholder="à¹€à¸£à¸´à¹ˆà¸¡" style="text-align:center; height: 50px;">
            <input type="time" id="tEnd" placeholder="à¹€à¸ªà¸£à¹‡à¸ˆ" style="text-align:center; height: 50px;">
        </div>

        <div style="display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 8px; margin-bottom: 12px;">
            <select id="hairStyle" style="height: 70px;">
                <option value="">ğŸ’‡ à¹€à¸¥à¸·à¸­à¸à¸—à¸£à¸‡à¸œà¸¡</option>
                <option value="à¹€à¸”à¹‡à¸">ğŸ‘¶ à¸•à¸±à¸”à¸œà¸¡à¹€à¸”à¹‡à¸</option>
                <option>à¸£à¸­à¸‡à¸—à¸£à¸‡</option><option>à¹à¸Ÿà¸Šà¸±à¹ˆà¸™</option><option>à¸ªà¸à¸´à¸™à¹€à¸Ÿà¸”</option><option>à¹€à¸›à¸´à¸”à¸‚à¹‰à¸²à¸‡</option><option>à¸•à¸³à¸£à¸§à¸ˆ/à¸—à¸«à¸²à¸£</option><option>à¸—à¸£à¸‡à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™</option>
                <option>à¹à¸à¹‰à¸œà¸¡</option><option>à¹‚à¸à¸™à¸œà¸¡</option>
            </select>
            <select id="extra1" style="height: 50px;"><option value="">à¸šà¸£à¸´à¸à¸²à¸£ 1</option><option>à¹‚à¸à¸™à¸«à¸™à¸§à¸”</option><option>à¸à¸±à¸™à¸«à¸™à¹‰à¸²</option><option>à¸ªà¸£à¸°à¸œà¸¡</option><option>à¸¢à¹‰à¸­à¸¡à¸œà¸¡</option></select>
            <select id="extra2" style="height: 50px;"><option value="">à¸šà¸£à¸´à¸à¸²à¸£ 2</option><option>à¹‚à¸à¸™à¸«à¸™à¸§à¸”</option><option>à¸à¸±à¸™à¸«à¸™à¹‰à¸²</option><option>à¸ªà¸£à¸°à¸œà¸¡</option><option>à¸¢à¹‰à¸­à¸¡à¸œà¸¡</option></select>
        </div>

        <div class="price-row"><input type="number" id="priceInp" class="price-box" placeholder="0" inputmode="numeric"><input type="number" id="tipInp" class="tip-input" placeholder="+à¸—à¸´à¸›" inputmode="numeric"></div>
        <div class="grid-2">
            <button id="btnCash" class="btn btn-pay" onclick="selectPay('Cash')">ğŸ’µ à¹€à¸‡à¸´à¸™à¸ªà¸”</button>
            <button id="btnTrans" class="btn btn-pay" onclick="selectPay('Trans')">ğŸ“± à¹‚à¸­à¸™</button>
        </div>
       <button class="btn-main" onclick="handleSave(event)" style="display:flex; align-items:center; justify-content:center; gap:12px; width:100%; height:85px; border-radius:20px; background:var(--primary); color:#fff; border:none; margin-top:5px!important;">
    <i class="fas fa-save" style="font-size: 35px;"></i>
    <span style="font-size: 24px; font-weight: 900;">à¸šà¸±à¸™à¸—à¸¶à¸</span>
</button>
    </div> <div id="p2" class="page" style="padding: 15px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
            <div style="background: white; padding:18px 15px; border-radius:20px; text-align:center; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;">
                <small style="font-weight:800; color:#64748b; text-transform: uppercase;">à¸¢à¸­à¸”à¸£à¸§à¸¡à¸§à¸±à¸™à¸™à¸µà¹‰</small>
                <div id="dTotal" style="font-size:36px; font-weight:900; color:#4338ca; margin: 5px 0;">0</div>
                <div id="dCounts" style="font-size:13px; font-weight:700; color:#1e293b; background:#e0e7ff; display:inline-block; padding:2px 10px; border-radius:10px;">à¸¥à¸¹à¸à¸„à¹‰à¸² 0 à¸„à¸™</div>
            </div>

            <div style="background:white; padding:15px; border-radius:20px; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; display:flex; flex-direction:column; justify-content:center; gap:8px;">
                <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:700;"><span style="color:#0ea5e9;">ğŸ“± à¹‚à¸­à¸™:</span> <b id="dTrans">0</b></div>
                <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:700;"><span style="color:#f59e0b;">ğŸ’µ à¸ªà¸”:</span> <b id="dCash">0</b></div>
                <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:700;"><span style="color:#6366f1;">ğŸ¤µ à¸Šà¹ˆà¸²à¸‡:</span> <b id="dBarber">0</b></div>
                <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:800;"><span style="color:#64748b;">ğŸ  à¸£à¹‰à¸²à¸™:</span> <b id="dShop">0</b></div>
            </div>
        </div>
        <div id="settleBarContainer" style="margin-bottom:18px;">
        <div id="settleBar"></div> </div>
        <div id="dServiceStats"></div>
        <hr style="border:0; border-top:1px solid #e2e8f0; margin-top:15px;">
        <div id="dailyList"></div>
    </div> 
<div id="p3" class="page" style="padding: 10px; background: #f0f2f5;">
    <div class="card" style="background:#fff; border-radius:25px; padding:15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <b style="font-size:16px; color:#b45309;"><i class="fas fa-wallet"></i> à¸šà¸±à¸à¸Šà¸µà¸ªà¸¸à¸—à¸˜à¸´</b>
            <div id="accLight" style="background:#22c55e; width:10px; height:10px; border-radius:50%;"></div>
        </div>

        <div style="display:flex; gap:8px; margin-bottom:15px;">
            <div style="flex:1; border:2px solid #f6ad55; border-radius:15px; padding:8px; text-align:center;">
                <small style="font-size:10px; color:#b45309;">à¸„à¹‰à¸²à¸‡à¹€à¸”à¸´à¸¡</small><br>
                <b style="font-size:18px;" id="accOldVal">à¸¿0</b>
            </div>
            <div style="flex:1; border:2px solid #63b3ed; border-radius:15px; padding:8px; text-align:center;">
                <small style="font-size:10px; color:#2b6cb0;">à¸§à¸±à¸™à¸™à¸µà¹‰</small><br>
                <b style="font-size:18px;" id="accTodayVal">à¸¿0</b>
            </div>
        </div>

        <div style="text-align:center; margin-bottom:15px;">
            <div style="font-size:36px; font-weight:900; color:var(--primary);">à¸¿<span id="accNet">0</span></div>
            <div style="height:1px; border-top:1px dashed #eee; width:80%; margin:10px auto;"></div>
        </div>

        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <div style="border:1px solid #ddd; border-radius:12px; width:40px; display:flex; align-items:center; justify-content:center; background:#f8fafc;"><i class="fas fa-calendar-alt" style="font-size:14px;"></i></div>
            <input type="text" id="accNote" placeholder="à¸šà¸±à¸™à¸—à¸¶à¸..." style="flex:1; border:1px solid #ddd; border-radius:12px; padding:8px; font-size:13px;">
        </div>

        <button onclick="clearAccount()" style="width:100%; background:#52b788; color:#fff; border:none; border-radius:12px; padding:12px; font-weight:700; margin-bottom:8px;">à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œà¹€à¸‡à¸´à¸™</button>
        <button onclick="openHistoryModal()" style="width:100%; background:none; color:#3b82f6; border:1px solid #3b82f6; border-radius:12px; padding:6px; font-size:11px;">à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œ</button>
    </div>

    <div style="margin-top:15px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        
        <div onclick="$('histDate').showPicker()" style="background:#fff; border-radius:20px; padding:12px; border:1px solid #e2e8f0; text-align:center; box-shadow: 0 4px 10px rgba(0,0,0,0.02);">
            <i class="fas fa-search-dollar" style="color:#10b981; font-size:22px;"></i>
            <b style="display:block; font-size:12px; margin:5px 0;">à¸„à¹‰à¸™à¸«à¸²à¸£à¸²à¸¢à¸§à¸±à¸™</b>
            <input type="date" id="histDate" onchange="loadHistDaily()" style="opacity:0; position:absolute; width:0; height:0;">
        </div>

        <div onclick="$('histMonth').showPicker()" style="background:#fff; border-radius:20px; padding:12px; border:1px solid #e2e8f0; text-align:center; box-shadow: 0 4px 10px rgba(0,0,0,0.02);">
            <i class="fas fa-calendar-check" style="color:#4f46e5; font-size:22px;"></i>
            <b style="display:block; font-size:12px; margin:5px 0;">à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™</b>
            <input type="month" id="histMonth" onchange="loadHistMonth()" style="opacity:0; position:absolute; width:0; height:0;">
        </div>

    </div>
</div>
Â  Â  <div id="reportModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(5px);">
Â  Â  Â  Â  <div style="background:#fff; margin:10% auto; padding:25px; width:90%; border-radius:30px; max-height:80vh; overflow-y:auto;">
Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f1f5f9; padding-bottom:15px; margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="reportTitle" style="margin:0; font-size:18px;">ğŸ“Š à¸£à¸²à¸¢à¸‡à¸²à¸™</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="closeReportModal()" style="border:none; background:none; font-size:24px;">&times;</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="reportContent"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="historyModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(5px);">
Â  Â  Â  Â  <div style="background:#fff; margin:15% auto; padding:20px; width:85%; border-radius:25px; max-height:70vh; overflow-y:auto;">
Â  Â  Â  Â  Â  Â  <h3 style="margin-top:0;">ğŸ“œ à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œ</h3>
Â  Â  Â  Â  Â  Â  <div id="accHistoryList"></div>
Â  Â  Â  Â  Â  Â  <button onclick="closeHistoryModal()" style="width:100%; margin-top:15px; padding:10px; border-radius:15px; border:none; background:#eee;">à¸›à¸´à¸”</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
<div id="modalSet" class="modal" style="display:none;position:fixed;z-index:9999;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(5px);">
    <div class="modal-content" style="background:#fff;margin:8% auto;padding:20px;width:88%;border-radius:25px;position:relative;">
        <button onclick="closeSettings()" style="position:absolute;top:12px;right:12px;border:none;background:#f1f5f9;width:32px;height:32px;border-radius:50%;">&times;</button>
        <h3 style="margin:0 0 15px;text-align:center;font-size:16px;">âš™ï¸ à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸£à¸°à¸šà¸š</h3>
        
        <label style="font-size:11px;font-weight:600;">à¸Šà¸·à¹ˆà¸­à¸£à¹‰à¸²à¸™</label>
        <input id="setShop" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;margin-bottom:12px;">

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
            <div><label style="font-size:11px;">% à¸Šà¹ˆà¸²à¸‡</label><input type="number" id="setPerc" style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;"></div>
            <div><label style="font-size:11px;">à¸›à¸£à¸°à¸à¸±à¸™</label><input type="number" id="setGuar" style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;"></div>
            
            <div>
                <label style="font-size:11px;">à¸˜à¸µà¸¡</label>
                <select id="setTheme" style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;">
                    <option value="neon-light">ğŸŒ¤ Light</option>
                    <option value="deep-navy">ğŸŒŒ Navy</option>
                    <option value="barber-dark">ğŸŒ‘ Dark</option>
                </select>
            </div>
            <div>
                <label style="font-size:11px;">à¸£à¸°à¸šà¸šà¹€à¸ªà¸µà¸¢à¸‡</label>
                <select id="setSound" style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;">
                    <option value="on">ğŸ”Š à¹€à¸›à¸´à¸”</option>
                    <option value="off">ğŸ”‡ à¸›à¸´à¸”</option>
                </select>
            </div>
            <div style="grid-column: span 2;">
                <label style="font-size:11px;">à¹€à¸ªà¸µà¸¢à¸‡à¸à¸¹à¸”</label>
                <select id="setVoice" style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;">
                    <option value="female">ğŸ‘© à¸œà¸¹à¹‰à¸«à¸à¸´à¸‡</option>
                    <option value="male">ğŸ‘¨ à¸œà¸¹à¹‰à¸Šà¸²à¸¢</option>
                </select>
            </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <button onclick="saveSettings()" style="background:var(--primary);color:#fff;padding:12px;border-radius:15px;border:none;font-weight:800;">à¸šà¸±à¸™à¸—à¸¶à¸</button>
            <button onclick="closeSettings()" style="background:#eee;padding:12px;border-radius:15px;border:none;">à¸›à¸´à¸”</button>
        </div>
        <button onclick="clearAllData()" style="width:100%;background:none;color:#ef4444;border:none;margin-top:10px;font-size:10px;">âš ï¸ à¸¥à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥</button>
    </div>
</div>
<nav class="nav-bar">
    <div class="nav-item active" id="n1" onclick="go(1)"><i class="fas fa-edit"></i><span>à¸šà¸±à¸™à¸—à¸¶à¸</span></div>
    <div class="nav-item" id="n2" onclick="go(2)"><i class="fas fa-file-invoice"></i><span>à¸£à¸²à¸¢à¸‡à¸²à¸™</span></div>
    <div class="nav-item" id="n3" onclick="go(3)"><i class="fas fa-wallet"></i><span>à¸šà¸±à¸à¸Šà¸µ</span></div>
</nav>
<script>
    // --- 1. à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹à¸¥à¸°à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ ---
    let db = JSON.parse(localStorage.getItem("barber_db")) || [];
    let archives = JSON.parse(localStorage.getItem("barber_arc")) || [];
    let account = JSON.parse(localStorage.getItem("barber_account")) || { balance: 0, logs: [] };
    let conf = JSON.parse(localStorage.getItem("barber_conf")) || { shop: "Barber Shop", perc: 50, guar: 0, theme: "light", sound: "on", voice: "female" };
    let payMethod = "";
    const $ = (id) => document.getElementById(id);

    window.onload = () => {
        const today = new Date().toISOString().split('T')[0];
        if($("dateInp")) $("dateInp").value = today;
        if($("accDate")) $("accDate").value = today;
        applyTheme(conf.theme);
        updateDateDisplay(today);
    };

    const saveDB = () => localStorage.setItem("barber_db", JSON.stringify(db));
    const saveAcc = () => localStorage.setItem("barber_account", JSON.stringify(account));
    
    function speak(t) { 
        if(conf.sound==='off') return;
        window.speechSynthesis.cancel();
        const m = new SpeechSynthesisUtterance(t);
        m.lang='th-TH'; m.pitch = (conf.voice==='male') ? 0.7 : 1.2;
        window.speechSynthesis.speak(m);
    }

    // --- 2. à¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸«à¸™à¹‰à¸² ---
    function go(n) {
        document.querySelectorAll('.page, .nav-item').forEach(el => el.classList.remove('active'));
        if($('p'+n)) $('p'+n).classList.add('active');
        if($('n'+n)) $('n'+n).classList.add('active');
        if(n===2) renderDay();
        if(n===3) loadAccountStatus();
    }

    // --- 3. à¸«à¸™à¹‰à¸²à¸šà¸±à¸™à¸—à¸¶à¸à¸‡à¸²à¸™ (à¸«à¸™à¹‰à¸²à¸ªà¹‰à¸¡/à¸­à¸´à¸ªà¹‰à¸¡) ---
    function handleSave() {
        const p = parseInt($("priceInp").value);
        if (!p || !payMethod) return (speak("à¹ƒà¸ªà¹ˆà¸£à¸²à¸„à¸²à¸”à¹‰à¸§à¸¢à¸„à¹ˆà¸°"), alert("à¹ƒà¸ªà¹ˆà¸£à¸²à¸„à¸²à¹à¸¥à¸°à¹€à¸¥à¸·à¸­à¸à¸§à¸´à¸˜à¸µà¸ˆà¹ˆà¸²à¸¢à¸à¹ˆà¸­à¸™!"));
        const start = $("tStart").value || new Date().toTimeString().slice(0, 5);
        db.push({ 
            id: Date.now(), date: $("dateInp").value, time: start, 
            endTime: $("tEnd").value || addMinutes(start, 30), 
            svcs: [$("hairStyle").value, $("extra1").value, $("extra2").value].filter(Boolean), 
            hair: $("hairStyle").value, price: p, tip: parseInt($("tipInp").value)||0, pay: payMethod 
        });
        saveDB(); renderDay();
        ["priceInp", "tipInp", "tStart", "tEnd"].forEach(id => $(id).value = "");
        speak("à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ " + p + " à¸šà¸²à¸—");
    }

   function renderDay() {
    const dInp = $("dateInp").value, today = db.filter(r => r.date === dInp), stats = {};
    let tot = 0, trans = 0, cash = 0, tips = 0, listHtml = "";
    today.slice().sort((a,b) => a.time.localeCompare(b.time)).forEach((r, i) => {
        const p = Number(r.price)||0, t = Number(r.tip)||0; tot += p; tips += t;
        (r.pay === 'Trans') ? trans += (p + t) : cash += p;
        const c = new Set(["à¸•à¸±à¸”à¸œà¸¡"]); if (r.hair && r.hair.includes("à¹€à¸”à¹‡à¸")) c.add("à¹€à¸”à¹‡à¸");
        (r.svcs || []).forEach(s => { if (s && !["à¹€à¸”à¹‡à¸","à¸£à¸­à¸‡à¸—à¸£à¸‡","à¹à¸Ÿà¸Šà¸±à¹ˆà¸™","à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™","à¸•à¸±à¸”à¸œà¸¡"].some(x => s.includes(x))) c.add(s); });
        c.forEach(k => stats[k] = (stats[k] || 0) + 1);
        const timeShow = r.endTime ? `${r.time}-${r.endTime}` : r.time;
    listHtml += `<div class="history-row" style="padding:15px; border-bottom:1px solid #f1f5f9; background:#fff;"><div style="display:flex; justify-content:space-between; align-items:center;"><div style="display:flex; flex-direction:column;"><span style="font-weight:800; font-size:14px; color:#1e293b;">${i+1}. [${timeShow}] | ${(r.svcs||[]).join('+')}</span>${t?`<small style="color:#be185d; font-weight:700; font-size:11px;">ğŸ”¹ à¸—à¸´à¸›: à¸¿${t}</small>`:''}</div><div style="text-align:right;"><b style="font-size:16px; display:block;">à¸¿${p}${t?` <span style="color:#be185d;">(+${t})</span>`:''}</b><span style="font-size:12px; font-weight:700;">${r.pay==='Trans'?'ğŸ“± à¹‚à¸­à¸™':'ğŸ’µ à¸ªà¸”'} <i class="fas fa-trash-alt" style="color:#ef4444; cursor:pointer; margin-left:8px;" onclick="delRec(${r.id})"></i></span></div></div></div>`;
    });
    const bEarn = Math.max(tot * (conf.perc / 100), conf.guar) + tips, sEarn = tot - (bEarn - tips), settle = cash - bEarn;
    $("dTotal").innerText = tot.toLocaleString(); $("dTrans").innerText = trans.toLocaleString(); $("dCash").innerText = cash.toLocaleString();
    $("dBarber").innerText = Math.floor(bEarn).toLocaleString(); $("dShop").innerText = Math.floor(sEarn).toLocaleString(); $("dCounts").innerText = `à¸¥à¸¹à¸à¸„à¹‰à¸²: ${today.length} à¸„à¸™`;
    let sH = `<div style="display:flex; flex-wrap:wrap; gap:5px; justify-content:center; margin-bottom:10px;">`;
    ["à¸•à¸±à¸”à¸œà¸¡", "à¹€à¸”à¹‡à¸"].forEach(k => { if (stats[k]) sH += `<span style="background:#4338ca;color:#fff;padding:5px 12px;border-radius:8px;font-size:11px;font-weight:800;">${k}: ${stats[k]}</span>`; });
    for (let s in stats) { if (!["à¸•à¸±à¸”à¸œà¸¡", "à¹€à¸”à¹‡à¸"].includes(s)) sH += `<span style="background:#64748b;color:#fff;padding:5px 12px;border-radius:8px;font-size:11px;font-weight:800;">${s}: ${stats[s]}</span>`; }
    $("dServiceStats").innerHTML = sH + `</div>`;
    $("dailyList").innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; margin:10px 0; padding:0 5px;"><b style="font-size:16px;">ğŸ“‹ à¸£à¸²à¸¢à¸‡à¸²à¸™à¸§à¸±à¸™à¸™à¸µà¹‰:</b><i class="fab fa-line" style="color:#22c55e;font-size:32px;cursor:pointer" onclick="shareLine()"></i></div>` + (listHtml || "<center style='padding:40px; opacity:0.3;'>à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</center>");
    let txt = "", bg = ""; if (tot === 0) { txt = "ğŸŸ¦ à¸£à¹‰à¸²à¸™à¸ˆà¹ˆà¸²à¸¢à¸›à¸£à¸°à¸à¸±à¸™"; bg = "#e0f2fe"; } else if (settle > 0) { txt = `ğŸŸ¥ à¸Šà¹ˆà¸²à¸‡à¸„à¸·à¸™à¸£à¹‰à¸²à¸™ à¸¿${Math.floor(Math.abs(settle)).toLocaleString()}`; bg = "#fee2e2"; } else if (settle < 0) { txt = `ğŸŸ¦ à¸£à¹‰à¸²à¸™à¸„à¸·à¸™à¸Šà¹ˆà¸²à¸‡ à¸¿${Math.floor(Math.abs(settle)).toLocaleString()}`; bg = "#e0e7ff"; } else { txt = "âœ… à¸¢à¸­à¸”à¸à¸­à¸”à¸µ"; bg = "#dcfce7"; }
    const container = $("settleBar").parentElement; container.style.cssText = "display:flex; gap:10px; margin-top:10px;";
    container.innerHTML = `<div id="settleBar" style="flex:8; height:55px; background:${bg}; display:flex; align-items:center; justify-content:center; border-radius:15px; font-weight:900; font-size:15px; color:#1e293b; border:1px solid rgba(0,0,0,0.05);">${txt}</div><button onclick="saveAndGo('${dInp}', ${tot}, ${sEarn}, ${bEarn})" style="flex:2; height:55px; background:#f97316; color:#fff; border-radius:15px; border:none; font-size:22px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"><i class="fas fa-paper-plane"></i></button>`;
}
    // --- 4. à¸«à¸™à¹‰à¸²à¸šà¸±à¸à¸Šà¸µà¸ªà¸°à¸ªà¸¡ (à¸«à¸™à¹‰à¸² 3) ---
    function loadAccountStatus() {
        const dInp = $("dateInp").value, today = db.filter(r => r.date === dInp);
        const tot = today.reduce((a,b)=>a+b.price, 0), tips = today.reduce((a,b)=>a+b.tip, 0);
        const cash = today.filter(r=>r.pay==='Cash').reduce((a,b)=>a+b.price, 0);
        const todaySettle = cash - (Math.max(tot * (conf.perc / 100), conf.guar) + tips);
        const net = (account.balance || 0) + todaySettle;

        $("accOldVal").innerText = "à¸¿" + (account.balance || 0).toLocaleString();
        $("accTodayVal").innerText = "à¸¿" + todaySettle.toLocaleString();
        $("accNet").innerText = Math.abs(net).toLocaleString();
        
        let status = net > 0 ? "ğŸš© à¸Šà¹ˆà¸²à¸‡à¸„à¸·à¸™à¸£à¹‰à¸²à¸™" : net < 0 ? "ğŸš© à¸£à¹‰à¸²à¸™à¸„à¸·à¸™à¸Šà¹ˆà¸²à¸‡" : "âœ… à¸à¸­à¸”à¸µ";
        $("accStatus").innerText = `${status}: à¸¿${Math.abs(net).toLocaleString()}`;
        $("accLight").style.background = net > 0 ? "#dc2626" : net < 0 ? "#1e3a8a" : "#16a34a";
    }

    function clearAccount() {
        if(!confirm("à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œà¸¢à¸­à¸”à¸ªà¸°à¸ªà¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”?")) return;
        const currentSettle = parseFloat($("accTodayVal").innerText.replace('à¸¿','').replace(/,/g,'')) || 0;
        const totalNet = (account.balance || 0) + currentSettle;
        account.logs.unshift({ date: $("accDate").value, amount: totalNet, note: $("accNote").value || "à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œà¸¢à¸­à¸”à¸ªà¸°à¸ªà¸¡" });
        account.balance = -currentSettle; 
        saveAcc(); speak("à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œà¹€à¸‡à¸´à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢"); loadAccountStatus();
    }

    // --- 5. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¹ˆà¸‡à¹„à¸¥à¸™à¹Œ (à¹‚à¸›à¸£à¹ˆà¸‡à¹ƒà¸ª à¸—à¸´à¸›à¹„à¸¡à¹ˆà¸«à¸²à¸¢) ---
    function shareLine() {
        const dInp = $("dateInp").value, today = db.filter(r => r.date === dInp);
        if(!today.length) return alert("à¹„à¸¡à¹ˆà¸¡à¸µà¸‡à¸²à¸™à¹ƒà¸«à¹‰à¹à¸Šà¸£à¹Œà¹€à¸–à¹‰à¸²à¹à¸à¹ˆ!");
        
        let tot = today.reduce((a,b) => a + b.price, 0);
        let tips = today.reduce((a,b) => a + b.tip, 0);
        let bShare = Math.max(tot * (conf.perc / 100), conf.guar);
        let bTotal = bShare + tips;
        let sTotal = tot - bShare;

        let msg = `ğŸ’ˆ ${conf.shop}\nğŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆ: ${dInp}\n----------------\n`;
        today.forEach((r,i) => msg += `${i+1}. [${r.time}] ${r.hair||'à¸•à¸±à¸”à¸œà¸¡'} = ${r.price}${r.tip?` (+à¸—à¸´à¸› ${r.tip})`:''} ${r.pay==='Cash'?'ğŸ’µ':'ğŸ“±'}\n`);
        
        msg += `----------------\nğŸ’° à¸¢à¸­à¸”à¸•à¸±à¸”à¸œà¸¡: ${tot}\nğŸ§§ à¸—à¸´à¸›à¸£à¸§à¸¡: ${tips}\nğŸ¤µ à¸Šà¹ˆà¸²à¸‡à¹„à¸”à¹‰: ${Math.floor(bTotal)}\nğŸ  à¸£à¹‰à¸²à¸™à¹„à¸”à¹‰: ${Math.floor(sTotal)}\n----------------\n`;
        
        let cash = today.filter(r => r.pay === 'Cash').reduce((a,b) => a + b.price, 0);
        let settle = cash - bTotal;
        msg += settle > 0 ? `âš ï¸ à¸Šà¹ˆà¸²à¸‡à¸„à¸·à¸™à¸£à¹‰à¸²à¸™: ${Math.floor(settle)}` : settle < 0 ? `ğŸŸ¦ à¸£à¹‰à¸²à¸™à¸„à¸·à¸™à¸Šà¹ˆà¸²à¸‡: ${Math.floor(Math.abs(settle))}` : `âœ… à¸¢à¸­à¸”à¸à¸­à¸”à¸µ`;

        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(msg)}`);
    }

    // --- 6. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹€à¸ªà¸£à¸´à¸¡à¸­à¸·à¹ˆà¸™à¹† ---
    function saveSettings() {
        conf = { ...conf, shop: $("setShop").value, perc: parseInt($("setPerc").value), guar: parseInt($("setGuar").value), theme: $("setTheme").value, sound: $("setSound").value, voice: $("setVoice").value };
        localStorage.setItem("barber_conf", JSON.stringify(conf));
        location.reload();
    }
    function applyTheme(t) { document.body.className = "theme-" + t; }
    function delRec(id) { if(confirm("à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸™à¸µà¹‰?")) { db=db.filter(r=>r.id!==id); saveDB(); renderDay(); } }
    function addMinutes(t, m) { let [h, min] = t.split(":").map(Number); let d = new Date(); d.setHours(h, min+m); return d.toTimeString().slice(0,5); }
    function updateDateDisplay(v) { renderDay(); }
    function selectPay(m) { payMethod = m; $("btnCash").className=`btn-pay ${m==='Cash'?'active-cash':''}`; $("btnTrans").className=`btn-pay ${m==='Trans'?'active-trans':''}`; }
</script>
</body>
</html>
