<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LA-MOON CUT</title>
    
    <link rel="apple-touch-icon" href="https://i.ibb.co/ycCG3DGk/LA-MOON.png">
    <link rel="icon" type="image/png" href="https://i.ibb.co/ycCG3DGk/LA-MOON.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="LA-MOON">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        *{font-family:'Kanit',sans-serif;-webkit-tap-highlight-color:transparent}
        body{background:#f8fafc;font-size:16px;padding-bottom:100px;margin:0}
        header{background:#1e293b;color:white;padding:25px 0;text-align:center}
        .report-mode header{display:none}
        
        .card{background:white;border-radius:12px;border:1px solid #e2e8f0;padding:10px 14px;margin-bottom:8px;box-shadow: 0 2px 4px rgba(0,0,0,0.02)}
        input,select{width:100%;font-size:17px!important;font-weight:600;color:#1e293b;outline:none;border:none;background:transparent}
        
        .pay-btn{border-radius:10px;padding:12px;text-align:center;border:2px solid #e2e8f0;background:white;cursor:pointer;font-size:16px; transition: all 0.2s;}
        .pay-btn.active{background:#1e293b;color:white;border-color:#1e293b}
        
        #btn-save{background:#1e293b;color:white;width:100%;padding:16px;border-radius:15px;font-size:20px!important;font-weight:700}
        #btn-save.success{background:#10b981}
        
        .summary-dark{background:#1e293b;border-radius:20px;padding:18px;color:white}
        .history-card{background:white;border-radius:12px;padding:12px;display:flex;align-items:center;border-left:6px solid #1e293b;margin-bottom:8px}
        
        .idx-box {
            min-width: 30px; height: 30px; background: #1e293b; color: white !important; 
            border-radius: 6px; display: flex; align-items: center; justify-content: center; 
            font-weight: bold; margin-right: 10px; font-size: 14px;
        }

        /* Fixed Navigation Z-Index Fix */
        .nav-bar{position:fixed;bottom:0;left:0;right:0;height:75px;background:white;border-top:1px solid #e2e8f0;display:flex;z-index:999}
        .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#94a3b8;font-size:14px;cursor:pointer}
        .nav-item.active{color:#1e293b;font-weight:700;border-top:4px solid #1e293b}
        .hidden{display:none!important}
    </style>
</head>
<body id="main-body">
    <header id="main-header"><div class="text-2xl font-bold tracking-widest uppercase">LA-MOON CUT</div></header>
    
    <main class="p-3 max-w-md mx-auto">
        <div id="page-rec">
            <div class="card"><label class="text-[11px] text-gray-400 uppercase tracking-wider">วันที่</label><input type="date" id="work-date"></div>
            
            <div class="flex gap-2">
                <div class="card flex-1"><label class="text-[11px] text-gray-400 uppercase tracking-wider">เวลาเริ่ม</label><input type="time" id="t-start"></div>
                <div class="card flex-1"><label class="text-[11px] text-gray-400 uppercase tracking-wider">เวลาเสร็จ</label><input type="time" id="t-end"></div>
            </div>
            
            <div id="svc-list">
                <div class="card border-l-[6px] border-blue-500 flex svc-row relative">
                    <div class="flex-1">
                        <label class="text-[11px] text-gray-400 uppercase tracking-wider">เลือกบริการ</label>
                        <select class="svc-name">
                            <option>ตัดผม</option><option>ย้อมผม</option><option>สระผม</option>
                            <option>แก้ผม</option><option>กันหน้า</option><option>โกนหนวด</option>
                            <option>ดัดผม</option><option>อื่นๆ</option>
                        </select>
                    </div>
                    <div class="w-24 text-right border-l pl-3">
                        <label class="text-[11px] text-gray-400 uppercase tracking-wider">ราคา</label>
                        <input type="number" class="svc-price text-blue-600 text-right font-bold" placeholder="0">
                    </div>
                </div>
            </div>
            
            <button onclick="addSvc()" class="w-full border-2 border-dashed py-2 rounded-xl text-gray-400 font-bold mb-3 text-xs">+ เพิ่มบริการ</button>
            
            <div class="card">
                <label class="text-[11px] text-gray-400 uppercase tracking-wider">ทรงผม</label>
                <select id="h-style">
                    <option>รองทรง</option><option>เปิดข้าง / วินเทจ</option><option>แฟชั่น / ทูบล็อค</option>
                    <option>สกินเฟด</option><option>ทรงอเมริกัน</option><option>ตำรวจ / ทหาร</option><option>นักเรียน</option>
                </select>
            </div>
            
            <div class="grid grid-cols-2 gap-2 mb-4">
                <div onclick="setPay('cash')" id="p-cash" class="pay-btn active"><i class="fa-solid fa-money-bill mr-1"></i>เงินสด</div>
                <div onclick="setPay('transfer')" id="p-trans" class="pay-btn"><i class="fa-solid fa-qrcode mr-1"></i>โอนเงิน</div>
            </div>
            
            <button id="btn-save" onclick="saveData()">Save Record</button>
        </div>

        <div id="page-rep" class="hidden">
            <div id="display-date-rep" class="font-bold mb-2 text-gray-500 text-lg"></div>
            <div class="summary-dark mb-4 shadow-lg">
                <div class="flex justify-between items-center mb-3 border-b border-white/10 pb-2">
                    <div>จำนวนลูกค้า<br><span id="r-count" class="text-3xl font-bold">0</span></div>
                    <div class="text-right text-yellow-400">ยอดเงินรวม<br>฿<span id="r-total" class="text-3xl font-bold">0</span></div>
                </div>
                <div class="grid grid-cols-3 text-center text-xs">
                    <div>เงินสด<br><span id="r-cash" class="text-green-400 font-bold text-lg">0</span></div>
                    <div>เงินโอน<br><span id="r-transfer" class="text-blue-400 font-bold text-lg">0</span></div>
                    <div>เคลียร์ยอด<br><span id="r-settle" class="text-white font-bold text-lg">0</span></div>
                </div>
            </div>
            <div id="status-box" class="card text-center font-bold hidden py-4 border-2 text-lg"></div>
            
            <div id="hist-list" class="space-y-2 mb-6"></div>
            
            <div class="text-center pt-2">
                <button onclick="clearDB()" class="text-red-400 text-xs underline block w-full mb-3 font-bold">ลบประวัติทั้งหมด</button>
                <a href="https://docs.google.com/spreadsheets/d/1B6DkU8E0UuS0fX6C8z_7Oq9iLqYf7D0_7W2h3M5M/edit" 
                   target="_blank" class="inline-block bg-gray-200 px-4 py-2 rounded-lg text-sm font-bold">
                   <i class="fa-solid fa-file-excel mr-1"></i> เปิดดู Google Sheet
                </a>
            </div>
        </div>
    </main>

    <nav class="nav-bar">
        <div onclick="nav('rec')" id="n-rec" class="nav-item active"><i class="fa-solid fa-edit text-xl mb-1"></i>บันทึก</div>
        <div onclick="nav('rep')" id="n-rep" class="nav-item"><i class="fa-solid fa-chart-pie text-xl mb-1"></i>รายงาน</div>
    </nav>

    <script>
        const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwNFKCDFWna8t42rSYRrdsMCsd2symtnM9C7N_wNPJ_R713F_5J0s02A4AnBWPzIVAq/exec";
        let db=JSON.parse(localStorage.getItem('lamoon_db_vfinal'))||[], payType='cash';
        const monthsThai=["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."];

        function init(){
            const n=new Date(); 
            document.getElementById('work-date').valueAsDate=n;
            updateDateLabel(n);
            document.getElementById('t-start').value=n.toTimeString().slice(0,5);
            document.getElementById('t-end').value=new Date(n.getTime()+30*60000).toTimeString().slice(0,5);
        }

        function updateDateLabel(d) {
            document.getElementById('display-date-rep').innerText=`${d.getDate()} ${monthsThai[d.getMonth()]} ${d.getFullYear()+543}`;
        }

        function addSvc(){
            const div=document.createElement('div'); div.className="card border-l-[6px] border-blue-500 flex svc-row relative mt-1";
            div.innerHTML=document.querySelector('.svc-row').innerHTML+`<button onclick="this.parentElement.remove()" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px]">✕</button>`;
            document.getElementById('svc-list').appendChild(div);
        }

        function setPay(t){
            payType=t;
            document.getElementById('p-cash').classList.toggle('active', t=='cash');
            document.getElementById('p-trans').classList.toggle('active', t=='transfer');
        }

        async function saveData(){
            let total=0, svcs=[]; 
            document.querySelectorAll('.svc-row').forEach(r=>{
                const p=Number(r.querySelector('.svc-price').value);
                if(p){total+=p;svcs.push(r.querySelector('.svc-name').value)}
            });
            if(!total) return alert("กรุณาใส่ราคา");
            const btn=document.getElementById('btn-save'); 
            btn.innerText="กำลังบันทึก..."; btn.disabled=true;
            
            const rec = {
                date: document.getElementById('work-date').value,
                services: svcs.join(','),
                hairstyle: document.getElementById('h-style').value,
                total: total,
                t_start: document.getElementById('t-start').value,
                t_end: document.getElementById('t-end').value,
                pay_transfer: payType === 'transfer' ? total : 0, 
                pay_cash: payType === 'cash' ? total : 0          
            };

            try {
                await fetch(SCRIPT_URL, {method:"POST", mode:"no-cors", body:JSON.stringify(rec)});
                rec.id=Date.now(); 
                rec.payment=payType=='cash'?'เงินสด':'โอนเงิน';
                db.push(rec); 
                localStorage.setItem('lamoon_db_vfinal',JSON.stringify(db));
                btn.innerText="สำเร็จ!"; btn.classList.add('success');
                setTimeout(()=>location.reload(), 800);
            } catch(e) { 
                alert("ล้มเหลว"); 
                btn.disabled=false; 
                btn.innerText="Save Record"; 
            }
        }

        function nav(p){
            if(p=='rec'){
                document.getElementById('page-rec').classList.remove('hidden');
                document.getElementById('page-rep').classList.add('hidden');
                document.getElementById('n-rec').classList.add('active');
                document.getElementById('n-rep').classList.remove('active');
                document.body.classList.remove('report-mode');
            } else {
                document.getElementById('page-rec').classList.add('hidden');
                document.getElementById('page-rep').classList.remove('hidden');
                document.getElementById('n-rec').classList.remove('active');
                document.getElementById('n-rep').classList.add('active');
                document.body.classList.add('report-mode');
                renderReport();
            }
        }

        function renderReport(){
            let t=0,c=0,tr=0; 
            const list=document.getElementById('hist-list'); 
            list.innerHTML='';
            
            db.slice().reverse().forEach((r,i)=>{
                const val = Number(r.total) || 0;
                t+=val; 
                if(r.payment=='เงินสด') c+=val; else tr+=val;
                
                const displayIdx = db.length - i;
                list.innerHTML+=`<div class="history-card">
                    <div class="idx-box">${displayIdx}</div>
                    <div class="flex-1 font-bold text-sm">${r.services}<div class="text-[11px] text-gray-400 font-normal">${r.t_start}-${r.t_end} | ${r.hairstyle}</div></div>
                    <div class="text-right"><div class="font-bold text-lg">฿${val}</div><div class="text-[10px] ${r.payment=='เงินสด'?'text-green-500':'text-blue-500'} font-bold">${r.payment}</div></div>
                    <button onclick="delItem(${r.id})" class="ml-2 text-red-300"><i class="fa-solid fa-trash text-sm"></i></button>
                </div>`;
            });

            document.getElementById('r-count').innerText=db.length;
            document.getElementById('r-total').innerText=t.toLocaleString();
            document.getElementById('r-cash').innerText=c.toLocaleString();
            document.getElementById('r-transfer').innerText=tr.toLocaleString();
            
            let s=t>=400 ? (c - (t/2)) : (c - 200);
            document.getElementById('r-settle').innerText=Math.abs(s).toLocaleString();
            
            const b=document.getElementById('status-box'); 
            b.classList.remove('hidden');
            b.innerText=s>=0 ? `ช่างคืนร้าน ฿${s.toLocaleString()}` : `ร้านคืนช่าง ฿${Math.abs(s).toLocaleString()}`;
            b.className=`card text-center font-bold py-4 ${s>=0?'bg-orange-50 text-orange-600 border-orange-200':'bg-blue-50 text-blue-600 border-blue-200'} text-lg`;
        }

        function delItem(id){ if(confirm('ลบรายการนี้?')){db=db.filter(i=>i.id!=id);localStorage.setItem('lamoon_db_vfinal',JSON.stringify(db));renderReport();}}
        function clearDB(){ if(confirm('ลบข้อมูลทั้งหมด?')){localStorage.removeItem('lamoon_db_vfinal');db=[];renderReport();}}        
        window.onload = init;
    </script>
</body>
</html>
