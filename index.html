<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BarberNote">
    <link rel="apple-touch-icon" href="https://i.ibb.co/kVrdspsT/Barber-note-pro.jpg">
    <title>Barber Note Pro </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å $ ‡πÄ‡∏õ‡πá‡∏ô getEl ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
const getEl = id => document.getElementById(id);
async function openComparisonSelector() {
    if (typeof Swal === 'undefined') {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï");
        return;
    }
    const { value: v } = await Swal.fire({
        title: 'üìä ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        confirmButtonText: '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        confirmButtonColor: '#38bdf8',
        html: `
            <div style="text-align: left; font-family: 'Kanit', sans-serif; font-size: 14px; color: #1e293b;">
                <p style="margin: 0 0 5px 0; color: #64748b;">üìÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1 </p>
                <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                    <input id="s1" type="date" class="swal2-input" style="flex:1; margin:0; height:45px; font-size:14px; border-radius:12px; border: 1px solid #cbd5e1;">
                    <input id="e1" type="date" class="swal2-input" style="flex:1; margin:0; height:45px; font-size:14px; border-radius:12px; border: 1px solid #cbd5e1;">
                </div>
                <p style="margin: 0 0 5px 0; color: #64748b;">üìÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2 </p>
                <div style="display: flex; gap: 8px;">
                    <input id="s2" type="date" class="swal2-input" style="flex:1; margin:0; height:45px; font-size:14px; border-radius:12px; border: 1px solid #cbd5e1;">
                    <input id="e2" type="date" class="swal2-input" style="flex:1; margin:0; height:45px; font-size:14px; border-radius:12px; border: 1px solid #cbd5e1;">
                </div>
            </div>
        `,
        preConfirm: () => ({ 
            s1: getEl('s1').value, e1: getEl('e1').value, 
            s2: getEl('s2').value, e2: getEl('e2').value 
        })
    });

    if (v && v.s1 && v.e1 && v.s2 && v.e2) renderComparisonReport(v);
}
function renderComparisonReport(v) {
    const formatThaiDate = (dateStr) => {
        const days = ['‡∏≠‡∏≤.', '‡∏à.', '‡∏≠.', '‡∏û.', '‡∏û‡∏§.', '‡∏®.', '‡∏™.'];
        const dt = new Date(dateStr);
        const dayName = days[dt.getDay()];
        const [y, m, d] = dateStr.split('-');
        return `${dayName} ${d}/${m}/${(parseInt(y) + 543).toString().slice(-2)}`;
    };

    const fetchStats = (start, end) => {
        let list = [];
        let currentDate = new Date(start);
        const stopDate = new Date(end);

        while (currentDate <= stopDate) {
            const dateStr = currentDate.toISOString().split('T')[0];
            if (typeof archives !== 'undefined') {
                const dayData = archives.find(a => a.date === dateStr);
               if (dayData) {
                    let realCustomerCount = 0;
                    
                    if (dayData.details && Array.isArray(dayData.details)) {
                        realCustomerCount = dayData.details.filter(d => {
                            // 1. ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô "üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô")
                            const itemName = Array.isArray(d.svcs) ? d.svcs.join("") : String(d.svcs || "");
                            // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏õ‡πá‡∏ô GUARANTEE_CLAIM ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô" ‡πÑ‡∏´‡∏°
                            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ false ‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö" ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                            const isInsurance = d.type === "GUARANTEE_CLAIM" || itemName.includes("‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô");
                            
                            return !isInsurance; 
                        }).length;
                    }

                    list.push({
                        date: formatThaiDate(dateStr),
                        count: realCustomerCount,
                        barber: dayData.barber || 0
                    });
                }
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
        const sumC = list.reduce((a, b) => a + Number(b.count || 0), 0);
        const sumE = list.reduce((a, b) => a + Number(b.barber || 0), 0);
        
        const rowList = list.length > 0 ? list.map(d => `
            <div style="display:flex; justify-content:space-between; padding:10px 8px; border-bottom:1px solid rgba(0,0,0,0.05); font-size:13px; color:#334155;">
                <span style="flex:1.5; font-weight:500;">${d.date}</span>
                <span style="flex:1; text-align:center; color:#1d4ed8; font-weight:700;">üë§ ${d.count}</span>
                <span style="flex:1.2; text-align:right; color:#059669; font-weight:700;">‡∏ø${Number(d.barber).toLocaleString()}</span>
            </div>`).join("") : `<div style="padding:15px; text-align:center; color:#94a3b8;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
        
        return { sumC, sumE, rowList, range: `${formatThaiDate(start)} - ${formatThaiDate(end)}` };
    };

    const d1 = fetchStats(v.s1, v.e1);
    const d2 = fetchStats(v.s2, v.e2);

    // ... ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (reportHtml ‡πÅ‡∏•‡∏∞ openReportModal) ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ...
    const reportHtml = `
        <div style="font-family:'Kanit', sans-serif; text-align:left; background:#ffffff; margin:-20px; padding:20px; color:#1e293b;">
            <div style="background:#f0f9ff; border:1px solid #bae6fd; border-radius:24px; padding:18px; margin-bottom:15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                <div style="color:#0369a1; font-weight:700; font-size:13px; margin-bottom:10px; display:flex; align-items:center; gap:5px;">üìÖ ${d1.range}</div>
                <div style="display:flex; justify-content:space-between; align-items:center; background:#ffffff; padding:12px; border-radius:16px; border:1px solid #e0f2fe; margin-bottom:10px;">
                    <span style="flex:1.5; font-weight:800; color:#1e293b; font-size:14px;">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°</span>
                    <span style="flex:1; text-align:center; color:#1d4ed8; font-weight:800; font-size:18px;">üë§ ${d1.sumC}</span>
                    <span style="flex:1.2; text-align:right; color:#059669; font-weight:800; font-size:18px;">‡∏ø${d1.sumE.toLocaleString()}</span>
                </div>
                <div style="max-height:160px; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:0 5px;">
                    ${d1.rowList}
                </div>
            </div>

            <div style="text-align:center; color:#cbd5e1; font-weight:900; margin:10px 0; font-size:12px;">VS</div>

            <div style="background:#f0fdf4; border:1px solid #bbf7d0; border-radius: 24px; padding: 18px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                <div style="color:#15803d; font-weight:700; font-size:13px; margin-bottom:10px; display:flex; align-items:center; gap:5px;">üìÖ ${d2.range}</div>
                <div style="display:flex; justify-content:space-between; align-items:center; background:#ffffff; padding:12px; border-radius:16px; border:1px solid #dcfce7; margin-bottom:10px;">
                    <span style="flex:1.5; font-weight:800; color:#1e293b; font-size:14px;">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°</span>
                    <span style="flex:1; text-align:center; color:#1d4ed8; font-weight:800; font-size:18px;">üë§ ${d2.sumC}</span>
                    <span style="flex:1.2; text-align:right; color:#059669; font-weight:800; font-size:18px;">‡∏ø${d2.sumE.toLocaleString()}</span>
                </div>
                <div style="max-height:160px; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:0 5px;">
                    ${d2.rowList}
                </div>
            </div>
            <div style="text-align:center; font-size:11px; color:#94a3b8; margin-top:15px;">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á</div>
        </div>`;

    openReportModal("‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", reportHtml);
}
function openReportModal(title, htmlContent) {
    const modal = getEl('reportModal');
    const modalTitle = getEl('reportTitle');
    const modalContent = getEl('reportContent');
    
    if (!modal || !modalTitle || !modalContent) {
        console.error("‚ùå ‡∏´‡∏≤ ID Modal ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠!");
        return;
    }
    // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    modalTitle.innerText = title;
    modalContent.innerHTML = htmlContent;
    // ‡∏à‡∏±‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå modalInner (‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß)
    const inner = modalContent.parentElement;
    inner.style.width = "95%";            // ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
    inner.style.maxWidth = "650px";       // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏°
    inner.style.maxHeight = "85vh";       // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡πÄ‡∏•‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    inner.style.overflowY = "auto";       // ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏î‡∏π‡πÑ‡∏î‡πâ
    inner.style.background = "#ffffff";   // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏ß‡∏™‡∏∞‡∏≠‡∏≤‡∏î
    inner.style.borderRadius = "24px";    // ‡∏Ç‡∏≠‡∏ö‡∏°‡∏ô‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
    inner.style.padding = "20px";
    inner.style.margin = "auto";
    
    // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πÑ‡∏ñ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ö‡∏ô iPhone ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏•
    inner.style.webkitOverflowScrolling = "touch";
    // ‡∏™‡∏±‡πà‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Modal
    modal.style.display = "flex";
    modal.style.alignItems = "center";
    modal.style.justifyContent = "center";
}
</script>
</head>
<style>
    /* 1. ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å */
    :root { 
        --primary: #6366f1; --accent: #0ea5e9; --danger: #ef4444; --success: #22c55e; 
        --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --border: #e2e8f0;
    }
    /* 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ò‡∏µ‡∏° (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£) */
    body.navy { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --accent: #38bdf8; }
    body.dark { --bg: #121212; --card: #1a1a1a; --text: #fbbf24; --accent: #fbbf24; }

    /* 3. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
    * { box-sizing: border-box; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
    body { 
        margin: 0; background: var(--bg); color: var(--text); 
        padding-bottom: 90px; overflow-x: hidden; transition: all 0.3s ease; 
    }
   /* 4. ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏¢‡πå‡πÄ‡∏≠‡∏≤‡∏ï‡πå (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á) */
.container { 
    padding: 15px; 
    max-width: 500px; 
    margin: auto; 
    position: relative; 
    z-index: 1; 
}
/* 4. ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏¢‡πå‡πÄ‡∏≠‡∏≤‡∏ï‡πå  */
.page { 
    display: none; 
    background: #f8fafc; 
    opacity: 1; 
    border-radius: 25px;
    padding: 20px;
    
    /* üî¥ ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡πâ‡∏ô‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π */
    margin: 10px 10px 100px 10px; 
    
    border: 1px solid var(--border);
    
    /* üü¢ ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏•‡∏á‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡∏ö */
    min-height: calc(100vh - 200px); 
    
    box-sizing: border-box;
    overflow-y: auto;
}

.page.active { 
    display: block !important; 
    animation: slideUp 0.4s ease-out;
}
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 8px; }
/* 5. ‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏≤‡∏£‡πå (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ò‡∏µ‡∏°) */
nav {
    position: fixed; bottom: 0; left: 0; right: 0;
    /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å #ffffff !important ‡πÄ‡∏õ‡πá‡∏ô var(--card) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏ò‡∏µ‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
    background: var(--card) !important; 
    display: flex; justify-content: space-around; 
    height: 75px; align-items: center;
    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ò‡∏µ‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏°‡∏∑‡∏î */
    box-shadow: 0 -5px 20px rgba(0,0,0,0.15); 
    z-index: 99999; 
    /* ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏ò‡∏µ‡∏° */
    border-top: 1px solid var(--border); 
    padding-bottom: env(safe-area-inset-bottom);
    transition: background 0.3s ease; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡∏à‡∏∞‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏î‡∏π‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•‡∏Ñ‡∏£‡∏±‡∏ö */
}
.nav-item { 
    flex: 1; text-align: center; 
    /* ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏ò‡∏µ‡∏° ‡πÅ‡∏ï‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏à‡∏≤‡∏á‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
    color: var(--text);
    opacity: 0.6; 
    cursor: pointer; transition: 0.2s; 
    display: flex; flex-direction: column; align-items: center;
}
.nav-item.active { 
    /* ‡∏™‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏µ Accent ‡∏Ç‡∏≠‡∏á‡∏ò‡∏µ‡∏°‡∏ô‡∏±‡πâ‡∏ô‡πÜ (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á) */
    color: var(--accent) !important; 
    opacity: 1; 
}
.nav-item i { font-size: 22px; display: block; margin-bottom: 2px; }
.nav-item span { font-size: 11px; font-weight: 700; }
    /* 6. ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï */
    .icon-card, input, select { background: var(--card); color: var(--text); }
    .icon-card { 
        border-radius: 15px; padding: 10px 2px; display: flex; flex-direction: column; 
        align-items: center; justify-content: center; gap: 4px; cursor: pointer; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); height: 75px; font-size: 14px; transition: 0.2s;
    }
    .icon-card:active { transform: scale(0.95); }
    input, select { 
        width: 100%; height: 75px; border-radius: 20px; font-size: 20px; font-weight: 700; 
        text-align: center; border: none; outline: none; box-shadow: 0 4px 10px rgba(0,0,0,0.03); 
        appearance: none; -webkit-appearance: none;
    }     
      /* 7. ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (‡∏Ç‡∏ô‡∏≤‡∏î‡∏ô‡∏¥‡πà‡∏á‡∏™‡∏ô‡∏¥‡∏ó) */
    /* ‡∏™‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏° */
    #btnCash { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    #btnTrans { background: linear-gradient(135deg, #6366f1, #4338ca); color: white; }
    #btnMix   { background: linear-gradient(135deg, #81d4fa, #01579b); color: white; }
/* üîµ ‡∏õ‡∏∏‡πà‡∏°‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏Å */
.btn-pay { 
    height: 75px; 
    font-size: 18px; 
    width: 100%; 
    border-radius: 18px;
    border: 3px solid transparent;
    /* ‡πÉ‡∏ä‡πâ transition ‡πÅ‡∏Ñ‡πà‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏≤‡∏û‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà all ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢ */
    transition: background 0.2s, opacity 0.2s, border 0.2s;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    
    /* üîí ‡∏•‡πá‡∏≠‡∏Ñ‡∏ï‡∏±‡∏ß‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î */
    transform: none !important; 
    
    /* ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏™‡∏µ Gradient ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á */
    background: linear-gradient(135deg, #190da8, #0b1e59); 
    color: #ffffff;
}

/* üü¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Active) - ‡∏•‡πá‡∏≠‡∏Ñ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡πâ‡∏ô‡∏¥‡πà‡∏á‡∏™‡∏ô‡∏¥‡∏ó */
.btn-pay.active-cash, 
.btn-pay.active-trans, 
.btn-pay.active-mix {
    border: 3px solid #ffffff !important; /* ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏≤‡∏ß‡πÄ‡∏ô‡πâ‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
    box-shadow: 0 0 15px rgba(255,255,255,0.3);   
    /* üîí ‡∏•‡πá‡∏≠‡∏Ñ‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î */
    transform: scale(1) !important; 
    opacity: 1 !important;
}
/* üîí ‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ */
.btn-pay.active-cash i, 
.btn-pay.active-trans i, 
.btn-pay.active-mix i {
    transform: scale(1) !important;
    display: inline-block !important;
}
/* ‚ö™ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
.btn-pay.is-inactive {
    opacity: 0.4;
    filter: grayscale(0.5);
    transform: none !important; /* ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢ */
}
/* üîí ‡∏•‡πá‡∏≠‡∏Ñ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô (‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏Å) */
.btn-pay i {
    transform: none !important;      /* ‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢/‡∏î‡∏µ‡∏î */
    display: inline-block !important; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Block ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ margin ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
    margin-bottom: 8px;              /* üëà ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 4 ‡πÄ‡∏õ‡πá‡∏ô 8) */
    font-size: 24px;                 /* ‡∏Ñ‡∏∏‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà */
    transition: none !important;     /* ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡∏ô‡∏¥‡πà‡∏á‡∏™‡∏ô‡∏¥‡∏ó‡∏ó‡∏±‡∏ô‡∏ó‡∏µ */
} 
   /* 8. ‡πÇ‡∏°‡∏î‡∏≠‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà */
    .modal { 
        position: fixed; 
        inset: 0; 
        background: rgba(0, 0, 0, 0.7); /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏≥‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á */
        display: none; 
        z-index: 1000000; 
        align-items: center; 
        justify-content: center;
        padding-bottom: 80px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏û‡πâ‡∏ô‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏≤‡∏£‡πå */
    }
    .modal-content { 
        background: var(--card); 
        color: var(--text); 
        width: 90%; 
        max-width: 400px; 
        border-radius: 25px; 
        padding: 25px; 
        max-height: 75vh; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î‡∏à‡∏≤‡∏Å 85 ‡πÄ‡∏õ‡πá‡∏ô 75 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
        overflow-y: auto; 
        box-shadow: 0 20px 50px rgba(0,0,0,0.3); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥ */
        position: relative;
    }
    .status-bar { padding: 12px; border-radius: 12px; text-align: center; font-weight: 800; font-size: 14px; margin-bottom: 10px; }
    .acc-main-card { background: var(--card); padding: 20px; border-radius: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 15px; }
    #accHistory { font-size: 12px; max-height: 150px; overflow-y: auto; }
    @keyframes slideUp {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
        </style>
    </head>
<body>
            <div class="container">
            <div id="p1" class="page active" style="padding: 15px; background: #f8fafc;">
                <h2 id="shopNameDisp" style="text-align:center; color:#1e293b; font-weight:900; margin: 10px 0 20px 0; letter-spacing: 1px; text-transform: uppercase;">BARBER SHOP</h2>
                
                <div class="grid-3" style="gap: 12px; margin-bottom: 20px;">
                    <div class="icon-card" style="background:#fff; border:none; box-shadow:0 8px 15px rgba(0,0,0,0.05); border-radius:20px; height:90px; display:flex; flex-direction:column; align-items:center; justify-content:center;" onclick="handleInsurance()">
                        <div style="background:linear-gradient(135deg, #fbbf24, #f59e0b); width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:8px; color:#fff; font-size:18px;">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <span style="color:#1e293b; font-weight:800; font-size:14px;">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</span>
                    </div>
                    
                    <div class="icon-card" style="background:#fff; border:none; box-shadow:0 8px 15px rgba(0,0,0,0.05); border-radius:20px; height:90px; display:flex; flex-direction:column; align-items:center; justify-content:center;" onclick="handleHoliday()">
                        <div style="background:linear-gradient(135deg, #f87171, #ef4444); width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:8px; color:#fff; font-size:18px;">
                            <i class="fas fa-umbrella-beach"></i>
                        </div>
                        <span style="color:#1e293b; font-weight:800; font-size:14px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span>
                    </div>
            
                    <div class="icon-card" style="background:#fff; border:none; box-shadow:0 8px 15px rgba(0,0,0,0.05); border-radius:20px; height:90px; display:flex; flex-direction:column; align-items:center; justify-content:center;" onclick="openSettings()">
                        <div style="background:linear-gradient(135deg, #94a3b8, #475569); width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:8px; color:#fff; font-size:18px;">
                            <i class="fas fa-cog"></i>
                        </div>
                        <span style="color:#1e293b; font-weight:800; font-size:14px;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
                    </div>
                </div>
            
              <div class="grid-3" style="gap:10px; margin-bottom:15px;">
    <div style="background:#fff; border-radius:18px; border:none; height:75px; position:relative; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
        
        <span id="dateDisplay" style="font-weight:800; color:#475569; font-size:18px;">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
        
        <input type="date" id="dateInp" 
               onchange="if(window.updateDateDisplay) updateDateDisplay(this.value);" 
               style="position:absolute; opacity:0; width:100%; height:100%; cursor:pointer; z-index:2;">
    </div>

    <input type="time" id="tStart" style="height:75px; border-radius:22px; border:none; text-align:center; font-weight:700; background:#fff; color:#1e293b; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
    <input type="time" id="tEnd" style="height:75px; border-radius:22px; border:none; text-align:center; font-weight:700; background:#fff; color:#1e293b; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
</div>
            <div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <select id="hairStyle" style="height:70px; border-radius:14px; border:none; font-weight:700; background:#fff; color:#1e293b; box-shadow:0 4px 10px rgba(0,0,0,0.03); padding:0 10px;">
                    <option value="">‚úÇÔ∏è ‡∏ó‡∏£‡∏á‡∏ú‡∏°</option>
                    <option>‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô</option><option>‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î</option><option>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á</option><option>‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á</option>
                    <option>‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£</option><option>‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option><option>‡πÅ‡∏Å‡πâ‡∏ú‡∏°</option><option>‡πÇ‡∏Å‡∏ô‡∏ú‡∏°</option>
                </select>
                <select id="extra1" style="height:70px; border-radius:14px; border:none; font-weight:700; background:#fff; color:#64748b; box-shadow:0 4px 10px rgba(0,0,0,0.03); padding:0 8px;">
                    <option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£1</option>
                    <option value="‡πÄ‡∏î‡πá‡∏Å"> ‡πÄ‡∏î‡πá‡∏Å</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option><option>‡∏î‡∏±‡∏î‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô</option>
                </select>
                <select id="extra2" style="height:70px; border-radius:14px; border:none; font-weight:700; background:#fff; color:#64748b; box-shadow:0 4px 10px rgba(0,0,0,0.03); padding:0 8px;">
                    <option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£2</option>
                    <option value="‡πÄ‡∏î‡πá‡∏Å"> ‡πÄ‡∏î‡πá‡∏Å</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option><option>‡∏î‡∏±‡∏î‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô</option>
                </select>
            </div>
            
            <div style="display: grid; grid-template-columns: 1.4fr 1fr; gap: 8px; margin: 10px 0;">
                <div style="position: relative; background: #ffffff; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05);">
                    <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 24px; color: #6366f1; font-weight: 900;">‡∏ø</span>
                    <input type="number" id="priceInp" placeholder="0" inputmode="numeric" 
                        style="width: 100%; height: 85px !important; background: transparent !important; font-size: 45px !important; font-weight: 900 !important; color: #1e293b !important; padding-left: 40px !important; border: none !important;">
                </div>
            
                <input type="number" id="tipInp" placeholder="‡∏ó‡∏¥‡∏õ" inputmode="numeric" 
                    style="width: 100%; height: 85px !important; background: #e1f5fe !important; border-radius: 20px !important; font-size: 32px !important; font-weight: 900 !important; color: #ad2c18 !important; border: none !important;">
            </div>
            
           <div class="grid-3" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; margin-bottom:15px;">
    <button id="btnCash" onclick="setPaymentType('Cash')" style="height:70px; border-radius:18px; border:none; background:linear-gradient(135deg, #10b981, #059669); color:#fff; font-weight:700; font-size:18px; box-shadow:0 4px 10px rgba(16,185,129,0.2);">
        <i class="fas fa-money-bill-wave"></i><br>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
    </button>
    <button id="btnTrans" onclick="setPaymentType('Trans')" style="height:70px; border-radius:18px; border:none; background:linear-gradient(135deg, #6366f1, #4338ca); color:#fff; font-weight:700; font-size:18px; box-shadow:0 4px 10px rgba(99,102,241,0.2);">
        <i class="fas fa-qrcode"></i><br>‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢
    </button>
    <button id="btnMix" onclick="setPaymentType('Mix')" style="height:70px; border-radius:18px; border:none; background:linear-gradient(135deg, #81d4fa, #01579b); color:#fff; font-weight:700; font-size:18px; box-shadow:0 4px 10px rgba(245,158,11,0.2);">
        <i class="fas fa-wallet"></i><br>‡∏à‡πà‡∏≤‡∏¢‡∏ú‡∏™‡∏°
    </button>
</div>

<div id="mixPanel" style="display:none; background:#f8fafc; padding:15px; border-radius:20px; border:2px dashed #cbd5e1; margin-bottom:20px;">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div>
            <label style="font-size:18px; color:#64748b;">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î:</label>
            <input type="number" id="mixCash" style="width:100%; height:45px; border-radius:12px; border:1px solid #ddd; text-align:center; font-size:30px;" placeholder="0">
        </div>
        <div>
            <label style="font-size:18px; color:#64748b;">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô:</label>
            <input type="number" id="mixTrans" style="width:100%; height:45px; border-radius:12px; border:1px solid #ddd; text-align:center; font-size:30px;" placeholder="0">
        </div>
    </div>
</div>
<button class="btn-main" onclick="handleSave(event)" 
    style="width:100%; height:90px; border-radius:28px; 
    background: linear-gradient(135deg, #190da8, #0b1e59); /* üîµ ‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
    color:#fff; border:none; 
    box-shadow: 0 15px 35px rgba(11, 30, 89, 0.4); 
    display:flex; align-items:center; justify-content:center; gap:15px;">
    
    <i class="fas fa-save" style="font-size: 38px;"></i>
    <span style="font-size: 32px; font-weight: 900; letter-spacing:1px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
</button>
</div>
            <div id="p2" class="page" style="max-width:480px; margin:0 auto; padding: 15px; padding-bottom: 100px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                    <div style="background: #3b50ce; padding:18px 15px; border-radius:20px; text-align:center; box-shadow:0 10px 15px -3px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);">
                        <small style="font-weight:800; color:#cbd5e1; text-transform: uppercase; letter-spacing: 0.5px;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
                        <div id="dTotal" style="font-size:36px; font-weight:900; color:#cbd5e1; margin: 5px 0;">0</div>
                        <div id="dCounts" style="font-size:16px; font-weight:700; color:#cbd5e1; background:rgba(255,255,255,0.15); display:inline-block; padding:2px 10px; border-radius:10px;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 0 ‡∏Ñ‡∏ô</div>
                    </div>
            
                   <div style="background:#3b50ce; padding:15px; border-radius:20px; box-shadow:0 10px 15px -3px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); display:flex; flex-direction:column; justify-content:center; gap:8px;">
                
                <div style="display:flex; justify-content:space-between; align-items:center; font-size:15px; font-weight:700;">
                    <span style="color:#cbd5e1; display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-mobile-alt" style="width:18px; color:#60a5fa;"></i> ‡πÇ‡∏≠‡∏ô:
                    </span> 
                    <b id="dTrans" style="color:#ffffff;">0</b>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; font-size:15px; font-weight:700;">
                    <span style="color:#cbd5e1; display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-money-bill-wave" style="width:18px; color:#4ade80;"></i> ‡∏™‡∏î:
                    </span> 
                    <b id="dCash" style="color:#ffffff;">0</b>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; font-size:15px; font-weight:700;">
                    <span style="color:#cbd5e1; display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-cut" style="width:18px; color:#fbbf24;"></i> ‡∏ä‡πà‡∏≤‡∏á:
                    </span> 
                    <b id="dBarber" style="color:#ffffff;">0</b>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; font-size:15px; font-weight:800; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 8px; margin-top: 2px;">
                    <span style="color:#cbd5e1; display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-store" style="width:18px; color:#f472b6;"></i> ‡∏£‡πâ‡∏≤‡∏ô:
                    </span> 
                    <b id="dShop" style="color:#ffffff;">0</b>
                </div>
            </div>
            </div>
                <div id="settleBarContainer" style="margin-bottom:18px;"><div id="settleBar"></div> </div>
                <div id="dServiceStats"></div>
                <hr style="border:0; border-top:1px solid #e2e8f0; margin-top:15px;">
                <div id="dailyList"></div>
            </div>
            
               <div id="p3" class="page" style="max-width:480px; margin:0 auto; padding: 12px; padding-bottom: 100px; background: #f8fafc;">
    
    <div class="card" style="background:#fff; border-radius:25px; padding:20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border:1px solid #fff; margin-bottom: 15px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <b style="font-size:22px; color:#92400e;"><i class="fas fa-wallet"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</b>
            <div id="accLight" style="background:#22c55e; width:10px; height:10px; border-radius:50%; box-shadow:0 0 8px #22c55e;"></div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div style="background:#fff; border-radius:18px; padding:12px; text-align:center; border: 1px solid #f1f5f9; box-shadow: 0 4px 12px rgba(0,0,0,0.03);">
                <small style="font-size:12px; color:#64748b; font-weight:700;">‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°</small>
                <b style="font-size:18px; color:#1e293b; display:block;" id="accOldVal">‡∏ø0</b>
            </div>
            <div style="background:#fff; border-radius:18px; padding:12px; text-align:center; border: 1px solid #f1f5f9; box-shadow: 0 4px 12px rgba(0,0,0,0.03);">
                <small id="accDateLabel" style="font-size:12px; color:#64748b; font-weight:700;">00/00/0000</small>
                <b style="font-size:18px; color:#1e293b; display:block;" id="accTodayVal">‡∏ø0</b>
            </div>
        </div>

        <div style="background:#fff; border-radius:22px; padding:20px; text-align:center; margin-bottom:15px; border: 1px solid #f1f5f9;">
            <div id="statusBadge" style="display:inline-block; padding:4px 12px; border-radius:10px; font-size:12px; font-weight:700; margin-bottom:8px;">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...
            </div>
            <div style="font-size:32px; font-weight:900; color:#1e293b;" id="accTotalVal">‡∏ø0</div>
        </div>

        <div style="margin-bottom:15px;">
            <div style="display:flex; align-items:center; background:#f1f5f9; border-radius:15px; padding:0 15px; margin-bottom:8px; height:50px;">
                <i class="fas fa-calendar-alt" style="color:#6366f1;"></i>
                <input type="date" id="accDate" style="flex:1; border:none; background:none; font-size:16px; font-weight:600; padding-left:10px; outline:none;">
            </div>
            <div style="display:flex; align-items:center; background:#f1f5f9; border-radius:15px; padding:0 15px; height:50px;">
                <i class="fas fa-pen-nib" style="color:#94a3b8;"></i>
                <input type="text" id="accNote" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..." style="flex:1; border:none; background:none; font-size:15px; padding-left:10px; outline:none;">
            </div>
        </div>

       <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
    <button onclick="clearAccount()" style="background:#22c55e; color:#fff; border:none; border-radius:18px; padding:15px 5px; font-size:14px; font-weight:800; cursor:pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
        <i class="fas fa-check-double"></i> ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô
    </button>

    <button onclick="openHistoryModal()" style="background:#f59e0b; color:#fff; border:none; border-radius:18px; padding:15px 5px; font-size:14px; font-weight:800; cursor:pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
        <i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô
    </button>
</div>
   <div onclick="document.getElementById('histMonth').showPicker()" 
     style="background:linear-gradient(135deg, #1e40af, #4338ca); border-radius:25px; padding:15px 10px; text-align:center; color:#fff; position:relative; box-shadow:0 8px 20px rgba(67, 56, 202, 0.3); cursor:pointer; margin-top: 15px; margin-bottom: 12px; transition: 0.3s;">
    
    <i class="fas fa-calendar-check" style="font-size:26px; margin-bottom:8px; display:block; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));"></i>
    <b style="font-size:18px; letter-spacing: 0.5px;">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</b>
    
    <input type="month" id="histMonth" onchange="loadHistMonth()" 
           style="position:absolute; inset:0; opacity:0; width:100%; height:100%; cursor:pointer;">
</div>
    <div onclick="openComparisonSelector()" style="background: linear-gradient(135deg, #38bdf8, #1d4ed8); border-radius: 25px; padding: 15px; text-align: center; color: #fff; cursor: pointer; box-shadow: 0 8px 15px rgba(56,189,248,0.2); display: flex; align-items: center; justify-content: center; gap: 10px;">       
    <i class="fas fa-chart-line" style="font-size: 24px;"></i>
    <b style="font-size: 16px;">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</b>
</div>
     </div> 
  </div>                   
    <div id="modalSet" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(15px); -webkit-backdrop-filter:blur(15px); z-index:9999; display:flex; align-items:center; justify-content:center; padding:15px;">
  <div style="background:#ffffff; width:95%; max-width:420px; border-radius:35px; display:flex; flex-direction:column; overflow:hidden; animation: slideUp 0.3s ease-out; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
    
    <div style="padding: 20px 20px 5px; text-align: center;">
        <h3 style="margin: 0; font-size: 22px; color: #1e3a8a; font-weight: 900;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
    </div>

    <div style="padding: 5px 20px 25px;"> <input type="text" id="setShop" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô" 
               style="width: 100%; height: 52px; border-radius: 16px; border: 1px solid #e2e8f0; background: #f1f5f9; text-align: center; font-size: 18px; font-weight: 700; color: #1e3a8a; margin-bottom: 10px; outline: none;">

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
            <input type="number" id="setPerc" placeholder="% ‡∏ä‡πà‡∏≤‡∏á" style="width:100%; height:52px; border-radius:16px; border:1px solid #e2e8f0; background:#f1f5f9; text-align:center; font-size:18px; font-weight:700; outline:none;">
            <input type="number" id="setGuar" placeholder="‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô" style="width:100%; height:52px; border-radius:16px; border:1px solid #e2e8f0; background:#f1f5f9; text-align:center; font-size:18px; font-weight:700; outline:none;">
        </div>

        <div style="margin-bottom:10px;">
            <select id="setTheme" style="width:100%; height:52px; border-radius:16px; border:1px solid #e2e8f0; background:#f1f5f9; text-align:center; font-size:16px; font-weight:700; color:#475569; outline:none;">
                <option value="light">üå§ ‡∏ò‡∏µ‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á</option>
                <option value="navy">üåå ‡∏ò‡∏µ‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô</option>
                <option value="dark">üåë ‡∏ò‡∏µ‡∏°‡∏î‡∏≥-‡∏ó‡∏≠‡∏á</option>
            </select>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
            <div style="position: relative; display: flex; align-items: center;">
                <select id="setSound" style="width:100%; height:52px; border-radius:16px; border:1px solid #cbd5e1; background:#f1f5f9; text-align:center; font-size:15px; font-weight:700; outline:none; appearance:none; -webkit-appearance:none; padding-left: 35px;">
                    <option value="on">‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</option>
                    <option value="off">‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</option>
                </select>
                <i class="fas fa-volume-up" style="position: absolute; left: 12px; color: #475569; pointer-events: none; font-size: 14px;"></i>
            </div>

            <div style="position: relative; display: flex; align-items: center;">
                <select id="setVoice" style="width:100%; height:52px; border-radius:16px; border:1px solid #cbd5e1; background:#f1f5f9; text-align:center; font-size:15px; font-weight:700; outline:none; appearance:none; -webkit-appearance:none; padding-left: 35px;">
                    <option value="female">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏´‡∏ç‡∏¥‡∏á</option>
                    <option value="male">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ä‡∏≤‡∏¢</option>
                </select>
                <i class="fas fa-user-friends" style="position: absolute; left: 12px; color: #475569; pointer-events: none; font-size: 14px;"></i>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-bottom:20px;">
            <button onclick="exportBackup()" style="height:48px; background:#ffffff; border:1px solid #cbd5e1; border-radius:12px; font-size:12px; font-weight:800; color:#1e293b; display:flex; align-items:center; justify-content:center; gap:5px; cursor:pointer;">
                <i class="fas fa-file-download"></i> <span>‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
            </button>
            
            <input type="file" id="fileInput" style="display:none;" onchange="importBackup(this)">

            <button onclick="$('fileInput').click()" style="height:48px; background:#ffffff; border:1px solid #cbd5e1; border-radius:12px; font-size:12px; font-weight:800; color:#1e293b; display:flex; align-items:center; justify-content:center; gap:5px; cursor:pointer;">
                <i class="fas fa-file-upload"></i> <span>‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤</span>
            </button>
            
            <button onclick="clearData()" style="height:48px; background:#fff1f2; border:1px solid #fecaca; border-radius:12px; font-size:12px; font-weight:800; color:#e11d48; display:flex; align-items:center; justify-content:center; gap:5px; cursor:pointer;">
                <i class="fas fa-trash-alt"></i> <span>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
            </button>
        </div>

        <div style="display:grid; grid-template-columns: 2fr 1.2fr; gap:12px; margin-bottom: 10px;">
            <button onclick="saveSettings()" style="background:#1e3a8a; color:#fff; height:60px; border-radius:20px; border:none; font-weight:800; font-size:18px; box-shadow: 0 8px 20px rgba(30,58,138,0.2);">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button onclick="$('modalSet').style.display='none'" style="background:#f1f5f9; color:#64748b; height:60px; border-radius:20px; border:none; font-weight:800; font-size:16px;">‡∏õ‡∏¥‡∏î</button>
        </div>

        <div style="text-align:center; line-height: 1.4;">
            <div style="font-size:10px; color:#94a3b8; font-weight:600; letter-spacing: 0.5px;">V.<span id="display-version">1.0.7</span></div>
            <div style="font-size:9px; color:#cbd5e1; font-weight:400;">Update: <span id="display-date">22/02/2026</span></div>
        </div>
    </div>
</div>
</div>
    <div id="reportModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="reportTitle" style="margin:0; color:#1a237e;">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
            <button onclick="closeReportModal()" style="background:#fee2e2; color:#dc2626; border:none; width:35px; height:35px; border-radius:50%; font-size:18px; cursor:pointer;">‚úï</button>
        </div>
        <div id="reportContent" style="max-height:400px; overflow-y:auto;"></div>
    </div>
</div>
<div id="historyModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; color:#1a237e;">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô</h3>
            <button onclick="closeHistoryModal()" style="background:#fee2e2; color:#dc2626; border:none; width:35px; height:35px; border-radius:50%; font-size:18px; cursor:pointer;">‚úï</button>
        </div>
        <div id="accHistory" style="max-height:400px; overflow-y:auto;"></div>
    </div>
</div>
<div id="linePreview" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center; padding:20px;">
    <div style="background:#fff; width:100%; max-width:450px; padding:20px; border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
        <h3 style="margin:0 0 15px 0; color:#1e293b; font-size:18px; display:flex; align-items:center; gap:8px;">üìù ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
        <textarea id="msgEdit" style="width:100%; height:300px; padding:12px; border:1px solid #cbd5e1; border-radius:10px; font-family:sans-serif; font-size:14px; line-height:1.5; outline:none; resize:none;"></textarea>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="document.getElementById('linePreview').style.display='none'" style="flex:1; padding:12px; background:#f1f5f9; color:#475569; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button onclick="sendToLineFinal()" style="flex:1; padding:12px; background:#22c55e; color:#fff; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ LINE ‚úÖ</button>
        </div>
    </div>
</div>
    <nav>
    <div onclick="go(1)" class="nav-item active"><i class="fas fa-edit"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span></div>
    <div onclick="go(2)" class="nav-item"><i class="fas fa-history"></i><span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span></div>
    <div onclick="go(3)" class="nav-item"><i class="fas fa-wallet"></i><span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span></div>
</nav>
 <script>
 /* ==========================================================
   SECTION 1: INITIALIZATION & GLOBAL VARIABLES
   (‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å)
   ========================================================== */
const $ = (id) => document.getElementById(id);
// 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
const APP_VERSION = "1.0.7"; 
const LAST_UPDATED = "22/02/2026"; 
// 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå)
(function autoUpdate() {
    const currentStoredVersion = localStorage.getItem("app_v");
    if (currentStoredVersion !== APP_VERSION) {
        localStorage.setItem("app_v", APP_VERSION);
        if ('caches' in window) {
            caches.keys().then(names => {
                for (let name of names) caches.delete(name);
            });
        }
        // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà
        window.location.reload(true);
    }
})();
// 3. ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö
let db = JSON.parse(localStorage.getItem("barber_db")) || [];
let archives = JSON.parse(localStorage.getItem("barber_archives")) || [];
let account = JSON.parse(localStorage.getItem("barber_account")) || { balance: 0, logs: [] };
let conf = JSON.parse(localStorage.getItem("barber_conf")) || { shop: "Barber Shop", perc: 50, guar: 0 };
let payMethod = "";
// 4. ‡∏™‡∏±‡πà‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏•‡∏Ç‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
document.addEventListener("DOMContentLoaded", () => {
    if ($("display-version")) $("display-version").innerText = APP_VERSION;
    if ($("display-date")) $("display-date").innerText = LAST_UPDATED;
});
function go(p) {
    // 1. ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á‡∏î‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö)
    document.querySelectorAll('.page').forEach(pg => {
        pg.classList.remove('active');
        pg.style.display = 'none'; 
    });
    
    const targetPage = document.getElementById('p' + p);
    if (targetPage) {
        targetPage.classList.add('active');
        targetPage.style.display = 'block';
    }
    // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π Active
    document.querySelectorAll('.nav-item').forEach((btn, i) => {
        btn.classList.toggle('active', (i + 1) === p);
    });
    // --- ‚ú® ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏¢) ---
    const savedShopName = localStorage.getItem("shopName") || "BARBER SHOP";
    const shopTitleEl = document.querySelector('h2'); 
    if (shopTitleEl) shopTitleEl.innerText = savedShopName;

    // 3. ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏©
    const dateInpValue = $("dateInp")?.value || new Date().toISOString().split('T')[0];

    if (p === 2) {
        if (typeof renderDay === 'function') renderDay(dateInpValue);
        if ($("displayDateThai")) {
            const [y, m, d] = dateInpValue.split('-');
            $("displayDateThai").innerText = `${d}/${m}/${parseInt(y) + 543}`;
        }
    }

    if (p === 3) { 
        // ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏´‡∏° ‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î (‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å)
        if ($("accDate") && $("dateInp")) {
            $("accDate").value = $("dateInp").value;
        }
        if (typeof loadAccountStatus === 'function') {
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            loadAccountStatus(); 
        }
    }

    window.scrollTo({ top: 0, behavior: 'smooth' });
}
function updateDateDisplay(v) {
    if (!v) return;
    // 1. ‡πÅ‡∏¢‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (v ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö 2026-02-13)
    const [y, m, d] = v.split('-');
    // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å (2026 + 543 = 2569 -> ‡∏ï‡∏±‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 69)
    const thaiYearFull = parseInt(y) + 543;
    const thaiYearShort = thaiYearFull.toString().slice(-2); 
    // 3. ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏¢‡πà‡∏≠
    const months = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
    // 4. ‚ú® ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: "13 ‡∏Å.‡∏û. 69"
    const formattedDate = `${parseInt(d)} ${months[parseInt(m)-1]} ${thaiYearShort}`;
    // 5. ‡∏ô‡∏≥‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ
    const el = document.getElementById("dateDisplay");
    if (el) el.innerText = formattedDate;
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏´‡∏ô‡πâ‡∏≤ 2) ‡∏Å‡πá‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
    const el2 = document.getElementById("displayDateThai");
    if (el2) el2.innerText = formattedDate;
    // ‡∏™‡∏±‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    if (typeof renderDay === "function") renderDay(v);
}
/* ==========================================================
   SECTION 2: CORE DATA & BACKUP SYSTEM
   (‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á/‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô)
   ========================================================== */
function saveDB() {
    try {
        localStorage.setItem("barber_db", JSON.stringify(db));
        localStorage.setItem("barber_archives", JSON.stringify(archives));
        localStorage.setItem("barber_account", JSON.stringify(account));
        localStorage.setItem("barber_conf", JSON.stringify(conf));
        console.log("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");
    } catch (e) {
        console.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ:", e);
    }
}
// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup)
function exportBackup() {
    try {
        const data = {
            db: JSON.parse(localStorage.getItem("barber_db") || "[]"),
            archives: JSON.parse(localStorage.getItem("barber_archives") || "[]"),
            account: account, // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
            settings: JSON.parse(localStorage.getItem("barber_settings") || "{}")
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `full-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        alert("‚úÖ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    } catch (e) { alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ"); }
}
// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå (Import)
function importBackup(input) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if(confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")) {
                localStorage.clear(); // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                localStorage.setItem("barber_db", JSON.stringify(data.db || []));
                localStorage.setItem("barber_archives", JSON.stringify(data.archives || []));
                localStorage.setItem("barber_account", JSON.stringify(data.account || { balance: 0, logs: [] }));
                localStorage.setItem("barber_settings", JSON.stringify(data.settings || {}));
                alert("‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö");
                location.reload();
            }
        } catch(err) { alert("‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
    };
    if (input.files && input.files[0]) reader.readAsText(input.files[0]);
}
// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Restore ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ï‡∏£‡∏á‡πÜ)
function restoreData(jsonData) {
    try {
        const data = JSON.parse(jsonData);
        // 1. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
        account = data.account || { balance: 0, logs: [] };
        archives = data.archives || []; 
        // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Storage ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ Key ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
        localStorage.setItem("barber_account", JSON.stringify(account));
        localStorage.setItem("barber_archives", JSON.stringify(archives));
        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô save() ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ
        if (typeof save === "function") save();
        alert("‚úÖ ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");
        // 3. ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
        location.reload(); 
        
    } catch (e) {
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    }
}
// 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏õ (Hard Reset)
function clearData() {
        const confirmDelete = confirm("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î");
                if (confirmDelete) {
                    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
                    localStorage.clear(); 
                    alert("‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                    location.reload(); // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô 0
                }
            }

function clearAllData(){if(confirm("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")){localStorage.clear();location.reload()}}            
/* ==========================================================
   SECTION 3: DAILY WORK INPUT & FORM HANDLING
   (‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)
   ========================================================== */
function addRecord() {
    const dInp = $("dateInp").value;
    const timeInp = $("timeInp").value;
    const price = parseFloat($("priceInp").value) || 0;
    const tip = parseFloat($("tipInp").value) || 0;
    const total = price + tip; 
    
    const currentPay = payMethod; 
    if (price === 0 && currentPay !== 'Holiday' && currentPay !== 'Guarantee') {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏Ñ‡∏≤");
        return;
    }

    let finalCash = 0;
    let finalTrans = 0;
    if (currentPay === 'Mix') {
        finalCash = parseFloat($("mixCash").value) || 0;
        finalTrans = parseFloat($("mixTrans").value) || 0;
    } else if (currentPay === 'Cash' || currentPay === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') {
        finalCash = total;
        finalTrans = 0;
    } else if (currentPay === 'Trans' || currentPay === '‡πÇ‡∏≠‡∏ô') {
        finalCash = 0;
        finalTrans = total;
    }

    const newRec = {
        id: Date.now(),
        date: dInp,
        time: timeInp,
        price: price,
        tip: tip,
        pay: currentPay, 
        svcs: selectedServices,
        payCash: finalCash,
        payTrans: finalTrans
    };

    db.push(newRec);
    localStorage.setItem("barber_db", JSON.stringify(db));

    if (typeof calculateMoney === "function") {
        const result = calculateMoney(); 
        const idx = archives.findIndex(a => a.date === dInp);
        const archiveData = {
            date: dInp,
            settle: result.settle, 
            type: (currentPay === 'Holiday') ? 'HOLIDAY' : 'WORK'
        };

        if (idx > -1) {
            archives[idx].settle = result.settle; 
        } else {
            archives.push(archiveData); 
        }
        localStorage.setItem("barber_archives", JSON.stringify(archives));
    }

    // --- üõ°Ô∏è ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà ---
   const btn = document.getElementById("btnSubmitSend");
const icon = document.getElementById("btnIcon");
if (btn) {
    btn.disabled = false; // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å
    btn.style.background = "#ff6f00"; // ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏™‡πâ‡∏°
    if (icon) icon.className = "fas fa-paper-plane"; // ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏à‡∏£‡∏ß‡∏î
    btn.style.cursor = "pointer";
}
    // -------------------------------------------------------
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");

    if (typeof resetForm === 'function') resetForm();
    if (typeof renderDay === 'function') renderDay();
    
    // üéØ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (typeof loadAccountStatus === 'function') loadAccountStatus();
} // <--- üü¢ ‡∏õ‡∏¥‡∏î‡∏õ‡∏µ‡∏Å‡∏Å‡∏≤‡∏ï‡∏±‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÅ‡∏Ñ‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏û‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≤‡∏á
 // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
function resetForm() {
    // 1. ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if ($("priceInp")) $("priceInp").value = "";
    if ($("tipInp")) $("tipInp").value = "";
    if ($("mixCash")) $("mixCash").value = "";
    if ($("mixTrans")) $("mixTrans").value = ""; // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö
    // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô
    if ($("mixPanel")) $("mixPanel").style.display = "none"; 
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î" ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    payMethod = "Cash"; 
    if (typeof setPaymentType === "function") {
        setPaymentType('Cash'); 
    }
    // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Services)
    selectedServices = []; 
    // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
    const serviceButtons = document.querySelectorAll('.service-btn');
    serviceButtons.forEach(btn => btn.classList.remove('selected', 'active', 'bg-blue-500')); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≤‡∏á‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î
    // 4. ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    const n = new Date();
    const t = n.getHours().toString().padStart(2, '0') + ':' + n.getMinutes().toString().padStart(2, '0'); 
    if ($("timeInp")) $("timeInp").value = t;
    console.log("üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î mixPanel ‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
function togglePayType() {
    const payType = $("payTypeInp").value;
    const panel = $("mixPanel");
    
    if (payType === 'Mix') {
        panel.style.display = "block";
        // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏≠‡∏ô = ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const total = (parseFloat($("priceInp").value) || 0) + (parseFloat($("tipInp").value) || 0);
        $("mixCash").value = "";
        $("mixTrans").value = total;
    } else {
        panel.style.display = "none";
    }
}
// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î" ‡πÉ‡∏´‡πâ "‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô" ‡∏•‡∏î‡∏•‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
$("mixCash").addEventListener("input", function() {
    const total = (parseFloat($("priceInp").value) || 0) + (parseFloat($("tipInp").value) || 0);
    const cash = parseFloat(this.value) || 0;
    const remain = total - cash;
    $("mixTrans").value = remain > 0 ? remain : 0;
});    
 function addMinutes(time, mins) {
                if (!time) return "";
                const [h, m] = time.split(":").map(Number);
                const d = new Date();
                d.setHours(h, m + mins, 0, 0);
                return d.toTimeString().slice(0, 5);
            }

function speak(txt) {
    // üü¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏π‡∏î
    if (typeof conf !== 'undefined' && conf.sound === "off") {
        console.log("‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö");
        return; 
    }

    if ('speechSynthesis' in window) {
        // 1. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏π‡∏î‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        window.speechSynthesis.cancel();

        const msg = new SpeechSynthesisUtterance(txt);
        // 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
        msg.lang = 'th-TH'; 
        
        // 3. ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        msg.pitch = 0.8;  
        msg.rate = 1.0;   
        msg.volume = 1;   

        // 4. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        const voices = window.speechSynthesis.getVoices();
        const maleVoice = voices.find(v => v.lang === 'th-TH' && (v.name.includes('Male') || v.name.includes('‡∏ä‡∏≤‡∏¢')));
        if (maleVoice) {
            msg.voice = maleVoice;
        }
        
        window.speechSynthesis.speak(msg);
    } else {
        console.warn("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î‡∏Ñ‡∏£‡∏±‡∏ö");
    }
}
// ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
 function delRec(id) { if (confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) { db = db.filter(r => r.id !== id); saveDB(); renderDay(); } }
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
function editTime(id) {
    const rec = db.find(r => r.id === id);
    if (!rec) return;
    
    const newStart = prompt("‚è±Ô∏è ‡πÅ‡∏Å‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° (HH:MM)", rec.time);
    if (!newStart) return;
    
    const newEnd = prompt("‚è±Ô∏è ‡πÅ‡∏Å‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à (HH:MM)", rec.endTime || "");
    
    rec.time = newStart;
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏ö‡∏ß‡∏Å‡πÑ‡∏õ 30 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    rec.endTime = newEnd || (typeof addMinutes === 'function' ? addMinutes(newStart, 30) : "");
    
    saveDB();
    renderDay();
}
function setPaymentType(m) {
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (Toggle Off)
    if (typeof payMethod !== 'undefined' && payMethod === m) {
        payMethod = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô
        // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥
        ['btnCash', 'btnTrans', 'btnMix'].forEach(id => {
            const el = $(id);
            if (el) el.className = 'btn btn-pay'; 
        });

        if ($("mixPanel")) $("mixPanel").style.display = 'none';
        return;
    }
    // 2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏´‡∏°‡πà (Toggle On)
    payMethod = m;

    const btns = {
        'Cash': { id: 'btnCash', active: 'active-cash' },
        'Trans': { id: 'btnTrans', active: 'active-trans' },
        'Mix': { id: 'btnMix', active: 'active-mix' }
    };
    // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    Object.keys(btns).forEach(key => {
        const target = $(btns[key].id);
        if (target) {
            if (m === key) {
                // ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡πÉ‡∏™‡πà‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢
                target.className = `btn btn-pay ${btns[key].active}`;
            } else {
                // ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏à‡∏≤‡∏á‡∏•‡∏á
                target.className = `btn btn-pay is-inactive`;
            }
        }
    });
    // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏° (Mix Panel)
    const mixPanel = $("mixPanel");
    if (mixPanel) {
        if (m === 'Mix') {
            mixPanel.style.display = 'block';
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Mix ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            const price = parseFloat($("priceInp")?.value) || 0;
            const tip = parseFloat($("tipInp")?.value) || 0;
            const total = price + tip;
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ MixTrans ‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞ MixCash ‡πÄ‡∏õ‡πá‡∏ô 0 (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏≠‡∏á)
            if ($("mixCash")) $("mixCash").value = ""; 
            if ($("mixTrans")) $("mixTrans").value = total > 0 ? total : "";   
            // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏á Mix ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏á‡πà‡∏≤‡∏¢
            mixPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            mixPanel.style.display = 'none';
        }
    }
}
function togglePayType() {
    const payType = $("payTypeInp") ? $("payTypeInp").value : payMethod;
    const panel = $("mixPanel");
    
    if (!panel) return;

    if (payType === 'Mix') {
        panel.style.display = "block";
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        const total = (parseFloat($("priceInp").value) || 0) + (parseFloat($("tipInp").value) || 0);
        // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡πÇ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°
        if ($("mixCash")) $("mixCash").value = "";
        if ($("mixTrans")) $("mixTrans").value = total > 0 ? total : "";
    } else {
        panel.style.display = "none";
    }
}
// --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Event Listeners) ---
// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î" ‡πÉ‡∏´‡πâ "‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô" ‡∏•‡∏î‡∏•‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
if ($("mixCash")) {
    $("mixCash").addEventListener("input", function() {
        const price = parseFloat($("priceInp").value) || 0;
        const tip = parseFloat($("tipInp").value) || 0;
        const total = price + tip;
        
        const cash = parseFloat(this.value) || 0;
        const remain = total - cash;
        
        // ‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏•‡∏ö)
        if ($("mixTrans")) {
            $("mixTrans").value = remain >= 0 ? remain : 0;
        }
    });
}
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å "‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô" ‡πÉ‡∏´‡πâ "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î" ‡∏•‡∏î‡∏•‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏•‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á)
if ($("mixTrans")) {
    $("mixTrans").addEventListener("input", function() {
        const total = (parseFloat($("priceInp").value) || 0) + (parseFloat($("tipInp").value) || 0);
        const trans = parseFloat(this.value) || 0;
        const remain = total - trans;
        
        if ($("mixCash")) {
            $("mixCash").value = remain >= 0 ? remain : 0;
        }
    });
}
function updateMixValues() {
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏ó‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    const price = parseFloat($("priceInp")?.value) || 0;
    const tip = parseFloat($("tipInp")?.value) || 0;
    const total = price + tip;
    // ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å
    const cash = parseFloat($("mixCash")?.value) || 0;
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏•‡∏ö)
    const trans = total - cash;
    
    if ($("mixTrans")) {
        $("mixTrans").value = trans > 0 ? trans.toFixed(2).replace(/\.00$/, '') : 0;
    }
}
/* ==========================================================
   SECTION 4: CALCULATION & CLOSING DAILY REPORT
   (‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ö‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)
   ========================================================== */
async function saveAndGo(date, total) {
    if (typeof db === 'undefined' || typeof archives === 'undefined') return;

    const btn = document.getElementById("btnSubmitSend");
    const icon = document.getElementById("btnIcon");

    // üéØ 1. ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥: ‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏à‡∏£‡∏ß‡∏î
    const alreadySent = archives.some(a => a.date === date);
    if (alreadySent) {
        alert(`‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${date} ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß`);
        if (btn) {
            btn.disabled = true; 
            btn.style.background = "#94a3b8"; // üîò ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤
            if (icon) icon.className = "fas fa-paper-plane"; // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏à‡∏£‡∏ß‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            btn.style.cursor = "default";
        }
        return;
    }

    // üéØ 2. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${date} ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`)) return;

    // üéØ 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á: ‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
    if (btn) {
        if (btn.disabled) return; 
        btn.disabled = true;             
        btn.style.background = "#22c55e"; // üü¢ ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á)
        if (icon) icon.className = "fas fa-spinner fa-spin"; 
    }

    // ... [Logic ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á] ...
    const allToday = db.filter(r => r.date === date);
    const todayData = allToday.filter(r => r.type === 'SERVICE');
    const isHoliday = allToday.some(r => r.type === 'HOLIDAY');
    let cash = 0, tips = 0;
    todayData.forEach(r => {
        const p = Number(r.price) || 0;
        const t = Number(r.tip) || 0;
        tips += t;
        if (r.pay === "Cash" || r.pay === "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î") { cash += (p + t); }
        else if (r.pay === "Mix") { cash += Number(r.payCash) || 0; }
    });
    const commission = total * (Number(conf.perc) / 100);
    const baseEarn = Math.max(commission, Number(conf.guar) || 0); 
    const bEarn = isHoliday ? 0 : baseEarn + tips;
    const settle = isHoliday ? 0 : cash - bEarn;
    const data = { date, total, cash, barber: Math.floor(bEarn), settle: settle, type: isHoliday ? "HOLIDAY" : "WORK", details: allToday };
    const idx = archives.findIndex(a => a.date === date);
    if (idx > -1) { archives[idx] = data; } else { archives.push(data); }
    if (!isHoliday) { account.balance = -settle; }
    db = db.filter(r => r.date !== date);

    try {
        if (typeof saveDB === "function") { await saveDB(); } else { await save(); }
        
        // üéØ 4. ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ ‡πÅ‡∏ï‡πà‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏à‡∏£‡∏ß‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        if (btn) {
            btn.style.background = "#94a3b8"; // üîò ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ (‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)
            if (icon) icon.className = "fas fa-paper-plane"; // ‚úàÔ∏è ‡∏à‡∏£‡∏ß‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            btn.disabled = true;             
            btn.style.cursor = "default";
        }

        if (typeof loadAccountStatus === 'function') loadAccountStatus();
        
        setTimeout(() => {
            alert(`‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
        }, 500);

    } catch (e) {
        if (btn) {
            btn.disabled = false;
            btn.style.background = "#ff6f00"; // üü† ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏™‡πâ‡∏°
            if (icon) icon.className = "fas fa-paper-plane";
        }
        alert("‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e);
    }
}
// --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ---
function handleInsurance() {
    const d = $("dateInp")?.value || new Date().toISOString().split('T')[0];
    const g = parseInt(conf.guar) || 0;
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    if (g <= 0) {
        if (typeof speak === "function") speak("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô");
        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÉ‡∏ô '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö' ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
        return;
    }
    // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    const isClaimed = db.find(r => r.date === d && r.type === "GUARANTEE_CLAIM");
    if (isClaimed) {
        if (typeof speak === "function") speak("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
        alert("üõ°Ô∏è ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        return;
    }
    // 3. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô
    if (confirm(`üõ°Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ' (${g} ‡∏ö‡∏≤‡∏ó)?\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏¢‡∏≠‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏´‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á`)) {
        db.push({ 
            id: Date.now(), 
            date: d, 
            time: "00:00", 
            svcs: ["üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô"], 
            price: 0, 
            pay: "N/A", 
            type: "GUARANTEE_CLAIM" 
        });

        saveDB(); 
        if (typeof speak === "function") speak(`‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô ${g} ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
        alert(`‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (${g}.-) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
        renderDay(d);
    }
}
// --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ---
function handleHoliday() {
    const d = $("dateInp")?.value;
    if (!d) return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î");
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const isHoliday = db.find(r => r.date === d && r.type === "HOLIDAY");
    if (isHoliday) return alert("üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");

    if (confirm(`üèñÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d} ‡πÄ‡∏õ‡πá‡∏ô "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"?\n(‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)`)) {
        db.push({
            id: Date.now(),
            date: d, 
            time: "00:00",
            svcs: ["üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"],
            price: 0, 
            pay: "N/A",
            type: "HOLIDAY",
            off: true  
        });

        saveDB();
        if (typeof speak === "function") speak("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        alert("üèñÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        renderDay(d);
    }
}
function renderDay(selectedDate){
    let dInp = selectedDate || ($("dateInp") ? $("dateInp").value : new Date().toISOString().split('T')[0]);
    if ($("dateInp")) $("dateInp").value = dInp;
    let allRec = db.filter(r => r.date === dInp);
    
    if (allRec.length === 0 && typeof archives !== 'undefined') {
        const archivedDay = archives.find(a => a.date === dInp);
        if (archivedDay && archivedDay.details) {
            allRec = archivedDay.details;
        }
    }
    const isHoliday = allRec.some(r => r.type && r.type.toUpperCase() === 'HOLIDAY');
    const stats = {};
    const extraSvcs = ["‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î", "‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤", "‡∏™‡∏£‡∏∞‡∏ú‡∏°"];
    let tot = 0, trans = 0, cash = 0, tips = 0;
    let listHtml = "";
    let realCustomerCount = 0;
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
    allRec
    .slice()
    .sort((a,b) => a.time.localeCompare(b.time))
    .forEach((r, i) => {
        const p = parseFloat(r.price) || 0; 
        const t = parseFloat(r.tip) || 0;
        const rType = r.type ? String(r.type).toUpperCase().trim() : '';
        const currentSvcs = Array.isArray(r.svcs) ? r.svcs : [];
 // ‚úÖ 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å DB)
        tot += p;
        tips += t;
        if (r.pay === 'Mix') {
            // ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            const pCash = parseFloat(r.payCash) || 0;
            const pTrans = parseFloat(r.payTrans) || 0; 
            trans += pTrans;
            // cash ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡∏´‡∏±‡∏Å‡∏ó‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
            // ‡∏ñ‡πâ‡∏≤ r.payCash ‡∏£‡∏ß‡∏°‡∏ó‡∏¥‡∏õ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ pCash - t
            cash += (pCash - t); 
        } else if (r.pay === 'Trans' || r.pay === '‡πÇ‡∏≠‡∏ô') {
            // ‡∏ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ + ‡∏ó‡∏¥‡∏õ ‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô trans
            trans += (p + t);
        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Cash): ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ cash ‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô (‡∏ó‡∏¥‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏ß‡∏Å)
            cash += p;
        }
      // üö® 2. ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
    if (rType === 'HOLIDAY' || rType === 'GUARANTEE' || p === 0) {
        // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö (‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/‡∏Å‡∏≤‡∏£‡∏±‡∏ô‡∏ï‡∏µ/‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡πá‡∏ô 0)
    } else {
    // üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ô‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 1 ‡∏Ñ‡∏ô‡πÄ‡∏™‡∏°‡∏≠‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ï‡∏±‡∏î‡∏ú‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°)
    if (currentSvcs.length > 0) {
        realCustomerCount++; 
    }
    // ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏ï‡∏±‡∏î‡∏ú‡∏°‡∏ö‡πâ‡∏≤‡∏á)
    const cleanExtras = extraSvcs.map(s => s.trim().toLowerCase());
    const hasRealHaircut = currentSvcs.some(s => {
        if (!s) return false;
        const cleanS = s.trim().toLowerCase();
        return !cleanExtras.includes(cleanS);
    });
    if (hasRealHaircut) {
        stats["‡∏ï‡∏±‡∏î‡∏ú‡∏°"] = (stats["‡∏ï‡∏±‡∏î‡∏ú‡∏°"] || 0) + 1;
    }
    // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
    currentSvcs.forEach(s => {
        if (s) stats[s] = (stats[s] || 0) + 1;
    });
}
        // ‚úÖ 3. ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á HTML (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô Mix)
        const timeShow = r.endTime ? `${r.time}-${r.endTime}` : r.time;
        
        let payIcon = r.pay === 'Trans' ? 'üì±' : 'üíµ';
        let mixText = "";
        if (r.pay === 'Mix') {
            payIcon = 'üåì'; // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡πà‡∏≤‡∏¢‡∏ú‡∏™‡∏°
            mixText = `<br><small style="color:#64748b; font-size:10px; font-weight:normal;">(‡∏™‡∏î:${r.payCash}/‡πÇ‡∏≠‡∏ô:${r.payTrans})</small>`;
        } 
        listHtml += `
        <div class="history-row" style="padding:15px; border-bottom:1px solid #f1f5f9; background:#fff;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="width:28px; height:28px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:800; color:#64748b; flex-shrink:0;">
                        ${i+1}
                    </div>
                    <div style="display:flex; flex-direction:column;">
                        <div style="font-weight:800; font-size:14px; color:#1e293b; margin-bottom:2px;">
                            <span style="color:#64748b; font-weight:500;">[${timeShow}]</span> ${currentSvcs.join(' + ')}
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            ${t ? `<small style="color:#be185d; font-weight:700; font-size:11px;">üîπ ‡∏ó‡∏¥‡∏õ: ‡∏ø${t}</small>` : '<small style="color:#94a3b8; font-size:11px;">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏¥‡∏õ)</small>'}
                        </div>
                    </div>
                </div>
                <div style="text-align:right;">
                    <b style="font-size:16px; display:block; color:#1e293b; line-height:1.2;">
                        <span style="font-size:14px;">${payIcon}</span> ‡∏ø${p}${t ? ` <span style="color:#be185d;">(+${t})</span>` : ''}
                        ${mixText}
                    </b>
                    <span style="font-size:11px; font-weight:700; color:#ef4444; cursor:pointer;" onclick="delRec(${r.id})">‡∏•‡∏ö</span>
                </div>
            </div>
        </div>`;
    });

    const bEarn = isHoliday ? 0 : Math.max(tot * (conf.perc / 100), conf.guar) + tips;
    const sEarn = isHoliday ? 0 : tot - (bEarn - tips);
    const settle = isHoliday ? 0 : cash - bEarn;

    if ($("dTotal")) $("dTotal").innerText = tot.toLocaleString();
    if ($("dTrans")) $("dTrans").innerText = trans.toLocaleString();
    if ($("dCash")) $("dCash").innerText = cash.toLocaleString();
    if ($("dBarber")) $("dBarber").innerText = Math.floor(bEarn).toLocaleString();
    if ($("dShop")) $("dShop").innerText = Math.floor(sEarn).toLocaleString();

    if ($("dCounts")) {
        if (isHoliday) {
            $("dCounts").innerText = "üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î";
        } else if (realCustomerCount === 0 && allRec.length > 0) {
            $("dCounts").innerText = "üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ";
        } else if (allRec.length === 0 && allRec.length > 0) {
            $("dCounts").innerText = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        } else {
            $("dCounts").innerText = `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${realCustomerCount} ‡∏Ñ‡∏ô`;
        }
    }

    let sH = `<div style="display:flex; flex-wrap:wrap; gap:5px; justify-content:center; margin-bottom:10px;">`;
    const priority = ["‡∏ï‡∏±‡∏î‡∏ú‡∏°", "‡πÄ‡∏î‡πá‡∏Å"];
    priority.forEach(k => { if (stats[k]) sH += `<span style="background:#4338ca;color:#fff;padding:5px 12px;border-radius:8px;font-size:11px;font-weight:800;">${k}: ${stats[k]}</span>`; });
    for (let s in stats) { if (!priority.includes(s)) sH += `<span style="background:#64748b;color:#fff;padding:5px 12px;border-radius:8px;font-size:11px;font-weight:800;">${s}: ${stats[s]}</span>`; }
    if ($("dServiceStats")) $("dServiceStats").innerHTML = sH + `</div>`;

    let txt = "", statusColor = "", icon = "";
    if (isHoliday) {
        txt = "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"; statusColor = "#1e40af"; icon = "üèñÔ∏è";
    } else if (allRec.length === 0) {
        txt = "‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."; statusColor = "#64748b"; icon = "üìù";
    } else if (tot === 0) {
        txt = "‡∏£‡πâ‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô"; statusColor = "#0369a1"; icon = "üõ°Ô∏è";
    } else if (settle > 0) {
        txt = `‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${Math.floor(settle).toLocaleString()}`; statusColor = "#b91c1c"; icon = "üë®‚Äçüé®";
    } else if (settle < 0) {
        txt = `‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ‡∏ø${Math.floor(Math.abs(settle)).toLocaleString()}`; statusColor = "#4338ca"; icon = "üè†";
    } else {
        txt = "‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ"; statusColor = "#15803d"; icon = "‚úÖ";
    }

    const actionBox = $("settleBarContainer");
    if (actionBox) {
        actionBox.style.display = "flex";
        actionBox.style.gap = "10px";
        actionBox.innerHTML = `
            <div id="settleBar" style="flex:8; height:55px; background:#f1f5f9; display:flex; align-items:center; justify-content:center; border-radius:18px; font-weight:800; font-size:14px; color:${statusColor}; border:1px solid #e2e8f0;">
                <span style="margin-right:8px; font-size:18px;">${icon}</span> ${txt}
            </div>
          <button id="btnSubmitSend" onclick="saveAndGo('${dInp}', ${tot})" 
        style="flex:2.2; height:55px; background:#ff6f00; color:#fff; border-radius:18px; border:none; font-size:22px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition: background 0.3s;">
    <i id="btnIcon" class="fas fa-paper-plane"></i>
</button>`;
    }
const dList = $("dailyList");
if (dList) {
    const dateParts = dInp.split('-'); 
    let displayDateBE = dInp;

    if (dateParts.length === 3) {
        const d = dateParts[2];
        const m = dateParts[1];
        const yBE = parseInt(dateParts[0]) + 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
        displayDateBE = `${d}/${m}/${yBE}`;
    }
    dList.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; background: #ffffff; padding: 8px 12px; border-radius: 12px; border-bottom: 2px solid #f1f5f9; margin-bottom: 10px;">           
            <div style="display: flex; align-items: center; gap: 10px;">
                <b style="font-size: 16px; color: #1e293b;">üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</b>              
            <div style="position: relative; background: #f1f5f9; padding: 5px 12px; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; align-items: center; cursor: pointer; width: 180px;"> 
                <span style="font-size: 14px; font-weight: 700; color: #6366f1; width: 100%; text-align: center;">${displayDateBE}</span>                
            <input type="date" id="reportDateSelector" value="${dInp}" 
                   onchange="renderDay(this.value)" 
                   style="position: absolute; opacity: 0; left: 0; top: 0; width: 100%; height: 100%; cursor: pointer;">
        </div>
    </div>
            <i class="fab fa-line" style="color: #22c55e; font-size: 32px; cursor: pointer;" onclick="shareLine()"></i>
        </div>
        <div style="padding: 0 5px;">
            ${isHoliday ? `<center style='padding:30px; color:#64748b;'>üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (${displayDateBE})</center>` : (listHtml || "<center style='padding:30px; color:#94a3b8;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</center>")}
        </div>
    `;
}
}             
/* ==========================================================
   SECTION 5: ACCOUNTING & FINANCIAL STATUS
   (‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)
   ========================================================== */
function loadAccountStatus() {
    const getEl = (id) => document.getElementById(id);
    
    // üéØ ‡πÅ‡∏Å‡πâ‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ: ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Input "accDate" ‡∏ï‡∏£‡∏á‡πÜ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ISO (YYYY-MM-DD) ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö
    let todayKey = getEl("accDate")?.value;
    
    if (!todayKey) {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        todayKey = `${y}-${m}-${d}`; // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö 2026-02-14
    }

    if (typeof archives === "undefined") return;

    // üéØ 1. ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î "‡∏Ñ‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ"
    const todayData = archives.find(a => a.date === todayKey);
    let todaySettle = todayData ? -todayData.settle : 0;

    // üéØ 2. ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î "‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°" (‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
    let oldSettle = archives.reduce((sum, day) => {
        // ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ 
        // ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå" (‡∏ñ‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏≠‡∏î‡∏à‡∏∞‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô 0)
        if (day.date !== todayKey && day.settle !== 0) {
            return sum + (Number(-day.settle) || 0);
        }
        return sum;
    }, 0);

    // üéØ 3. ‡∏´‡∏±‡∏Å‡∏•‡∏ö‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏¢‡∏≠‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå"
    let totalBalance = oldSettle + todaySettle;
    if (typeof account !== "undefined") {
        account.balance = totalBalance;
    }

    // üìä ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    if (getEl("accTodayVal")) getEl("accTodayVal").innerText = `‡∏ø${todaySettle.toLocaleString()}`;
    if (getEl("accOldVal"))   getEl("accOldVal").innerText = `‡∏ø${oldSettle.toLocaleString()}`;
    
    if (getEl("accTotalVal")) {
        getEl("accTotalVal").innerText = `‡∏ø${Math.abs(totalBalance).toLocaleString()}`;
    }

    // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏±‡∏ß (‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°)
    if (getEl("accDateLabel")) {
        getEl("accDateLabel").innerText = new Date(todayKey).toLocaleDateString('th-TH', { 
            day: 'numeric', month: 'short', year: 'numeric' 
        });
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡πâ‡∏≤‡∏¢
    const badge = getEl("statusBadge");
    if (badge) {
        if (totalBalance < 0) {
            badge.innerText = "üë®‚Äçüé® ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô";
            badge.style.backgroundColor = "#fee2e2"; badge.style.color = "#991b1b";
        } else if (totalBalance > 0) {
            badge.innerText = "üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á";
            badge.style.backgroundColor = "#dcfce7"; badge.style.color = "#166534";
        } else {
            badge.innerText = "‚úÖ ‡∏¢‡∏≠‡∏î‡∏•‡∏á‡∏ï‡∏±‡∏ß";
            badge.style.backgroundColor = "#f1f5f9"; badge.style.color = "#64748b";
        }
    }

    if (typeof updateStatusUI === 'function') updateStatusUI(totalBalance);
}
function updateStatusUI(net) {
    const getEl = (id) => document.getElementById(id);
    const badge = getEl("statusBadge");
    const light = getEl("accLight"); 

    // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏™‡∏µ: ‡∏•‡∏ö=‡πÅ‡∏î‡∏á (‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô) | ‡∏ö‡∏ß‡∏Å=‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á)
    let color = net < 0 ? "#dc2626" : (net > 0 ? "#1e3a8a" : "#16a34a");
    let txt = net < 0 ? "üë®‚Äçüé® ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô" : (net > 0 ? "üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á" : "‚úÖ ‡∏¢‡∏≠‡∏î‡∏•‡∏á‡∏ï‡∏±‡∏ß");

    if (badge) {
        badge.innerText = txt;
        badge.style.background = net < 0 ? "#fef2f2" : (net > 0 ? "#eff6ff" : "#f0fdf4");
        badge.style.color = color;
    }
    if (light) {
        light.style.background = color;
        light.style.boxShadow = `0 0 12px ${color}`;
    }
}
function clearAccount() {
    const net = Number(account.balance) || 0;
    if (net === 0) return alert("üíé ‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");

    const accNoteEl = document.getElementById("accNote");
    const d = document.getElementById("accDate")?.value || new Date().toLocaleDateString('th-TH');

    // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÅ‡∏ü‡πâ‡∏° (logs) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
    account.logs.push({
        date: d,
        amount: -net, 
        note: (accNoteEl && accNoteEl.value) || "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á"
    });

    // üéØ 2. ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ú‡∏°‡∏™‡∏∞‡πÄ‡∏û‡∏£‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ: "‡∏•‡πâ‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡πÉ‡∏ô Archives ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0"
    // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ö‡∏ß‡∏Å‡∏ó‡∏ö‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏µ‡∏Å
    if (typeof archives !== "undefined") {
        archives.forEach(day => {
            day.settle = 0; 
        });
        // ‡πÄ‡∏ã‡∏ü‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î
        localStorage.setItem("barber_archives", JSON.stringify(archives));
    }

    // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    if (typeof save === "function") save();
    if (typeof loadAccountHistory === 'function') loadAccountHistory();
    
    loadAccountStatus(); // ‡∏û‡∏≠‡∏¢‡∏≠‡∏î‡πÉ‡∏ô archives ‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏à‡∏∞‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    alert("‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
}
// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
function deleteAccountLog(index) {
    if (confirm("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà")) {
        // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Array
        account.logs.splice(index, 1);
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á LocalStorage (‡πÉ‡∏ä‡πâ saveDB ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°)
        if (typeof saveDB === "function") saveDB(); else if (typeof save === "function") save();
        
        alert("‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ)
        if (typeof loadAccountHistory === "function") loadAccountHistory();
        else if (typeof renderHistoryList === "function") renderHistoryList();
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡∏°‡πà
        if (typeof loadAccountStatus === "function") loadAccountStatus();
    }
}
// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
function editAccountLog(index) {
    let log = account.logs[index];
    if (!log) return;

    const newNote = prompt("üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:", log.note);
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö absolute (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏•‡∏ö) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡πà‡∏≤‡∏¢
    const newAmount = prompt("üí∞ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:", Math.abs(log.amount));
    
    if (newNote !== null && newAmount !== null) {
        // ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ (‡∏ö‡∏ß‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏£‡∏±‡∏ö/‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô, ‡∏•‡∏ö‡∏Ñ‡∏∑‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á)
        const isNegative = log.amount < 0;
        const val = parseFloat(newAmount.replace(/,/g, '')) || 0;
        
        account.logs[index].note = newNote;
        account.logs[index].amount = isNegative ? -val : val;
        
        if (typeof saveDB === "function") saveDB(); else if (typeof save === "function") save();
        
        alert("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        
        if (typeof loadAccountHistory === "function") loadAccountHistory();
        else if (typeof renderHistoryList === "function") renderHistoryList();
        
        if (typeof loadAccountStatus === "function") loadAccountStatus();
    }
}
function loadAccountHistory() {
    const historyContainer = $("accHistory");
    if (!historyContainer) return;

    if (!account.logs || account.logs.length === 0) {
        historyContainer.innerHTML = '<center style="padding:40px; color:#94a3b8;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</center>';
        return;
    }

    const historyHtml = account.logs.slice().reverse().map((l, originalIndex) => {
        const realIdx = account.logs.length - 1 - originalIndex;
        
        // üéØ ‡πÅ‡∏Å‡πâ‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö -settle:
        // ‡∏•‡∏ö (-) = ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô (‡∏™‡∏µ‡πÅ‡∏î‡∏á)
        // ‡∏ö‡∏ß‡∏Å (+) = ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á (‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô)
        const isBarberDebt = l.amount < 0; 
        const color = isBarberDebt ? '#dc2626' : '#1e3a8a';
        const sign = l.amount > 0 ? '+' : (l.amount < 0 ? '-' : '');

        return `
        <div class="log-item" style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center; background:#fff;">
            <div style="flex:1;">
                <b style="font-size:13px; color:#64748b;">${l.date}</b><br>
                <span style="font-size:14px; font-weight:700; color:#1e293b;">${l.note}</span>
            </div>
            <div style="text-align:right; flex-shrink:0;">
                <b style="font-size:15px; color:${color}; display:block; margin-bottom:5px;">
                    ${sign}‡∏ø${Math.abs(l.amount).toLocaleString()}
                </b>
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <small style="color:#6366f1; font-weight:700; cursor:pointer;" onclick="editAccountLog(${realIdx})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</small>
                    <small style="color:#ef4444; font-weight:700; cursor:pointer;" onclick="deleteAccountLog(${realIdx})">‡∏•‡∏ö</small>
                </div>
            </div>
        </div>`;
    }).join('');

    historyContainer.innerHTML = historyHtml;
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
function toggleAccHistory() {
    const wrapper = $("accHistoryWrapper");
    if (!wrapper) return;

    if (wrapper.style.display === "none" || wrapper.style.display === "") {
        wrapper.style.display = "block";
        loadAccountHistory(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î
        
        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏•‡∏á‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        wrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        wrapper.style.display = "none";
    }
}
/* ==========================================================
   SECTION 6: MODALS & USER INTERFACE RENDER
   (‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Pop-up ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)
   ========================================================== */
function openHistoryModal() { 
    const modal = $("historyModal");
    if (!modal) return alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á historyModal ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
    // ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡πÅ‡∏ö‡∏ö Flex
    modal.style.display = "flex"; 
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
    if (typeof renderHistoryList === "function") {
        renderHistoryList(); 
    } else { 
        console.warn("‚ö†Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderHistoryList ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á");
    }
}
function closeHistoryModal() { 
    const modal = $("historyModal");
    if (modal) modal.style.display = "none"; 
}
function closeReportModal() {
    const modal = $("reportModal"); 
    
    if (modal) {
        modal.style.display = "none";
        document.body.style.overflow = "auto";
    }

    // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ UI ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
    setTimeout(() => {
        if (typeof go === 'function') {
            console.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");
            go(2); 
        }
    }, 100); 
} // ‡∏õ‡∏¥‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Ñ‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏û‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≤‡∏á (‡∏õ‡∏µ‡∏Å‡∏Å‡∏≤‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
function closeAndGoHome() {
    const m = $("modalSet");
    if (m) m.style.display = 'none';

    if (typeof go === 'function') {
        go(1); 
    } else {
        location.reload();
    }
}              
function renderHistoryList() {
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!account.logs || account.logs.length === 0) {
        $("accHistory").innerHTML = `
            <div style="padding:50px; text-align:center; color:#94a3b8;">
                <span style="font-size:40px;">üìÇ</span><br>
                <p style="font-size:15px; margin-top:10px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î</p>
            </div>`;
        return;
    }

    // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Grouping by Month/Year)
    const groups = {};
    account.logs.forEach((log, index) => {
        // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á 2026-02-13 ‡πÅ‡∏•‡∏∞ 13/02/2026
        const dateParts = log.date.includes('-') ? log.date.split('-') : log.date.split('/');
        
        // ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏µ: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®. (4 ‡∏´‡∏•‡∏±‡∏Å) ‡πÉ‡∏´‡πâ +543 ‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
        let m = dateParts[1];
        let y = dateParts[0].length === 4 ? parseInt(dateParts[0]) + 543 : dateParts[2];
        const monthYear = `${m}/${y}`;

        if (!groups[monthYear]) groups[monthYear] = [];
        groups[monthYear].push({ ...log, originalIndex: index });
    });

    // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Sorting)
    const sortedMonths = Object.keys(groups).sort((a, b) => {
        return b.split('/').reverse().join().localeCompare(a.split('/').reverse().join());
    });

    // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏î‡πâ‡∏ß‡∏¢ Tag <details> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
    let finalHtml = "";
    sortedMonths.forEach(my => {
        const monthLogs = groups[my];
        const monthSum = monthLogs.reduce((s, l) => s + (parseFloat(l.amount) || 0), 0);

        finalHtml += `
            <details style="margin-bottom:12px; border:1px solid #e2e8f0; border-radius:18px; overflow:hidden; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.02);" open>
                <summary style="padding:15px; background:#f8fafc; cursor:pointer; display:flex; justify-content:space-between; align-items:center; list-style:none; border-bottom:1px solid #f1f5f9;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:18px;">üìÇ</span>
                        <b style="font-size:15px; color:#1e293b;">‡πÅ‡∏ü‡πâ‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${my}</b>
                    </div>
                    <b style="color:${monthSum >= 0 ? '#16a34a' : '#dc2626'}; font-size:15px;">
                        ‡∏ø${Math.abs(monthSum).toLocaleString()}
                    </b>
                </summary>
                <div style="padding:5px;">
                    ${monthLogs.slice().reverse().map(l => `
                        <div style="padding:12px 10px; border-bottom:1px solid #f8fafc; display:flex; justify-content:space-between; align-items:center;">
                            <div style="flex:1;">
                                <div style="font-size:11px; color:#94a3b8; margin-bottom:2px;">üìÖ ${l.date}</div>
                                <div style="font-weight:600; color:#334155; font-size:14px;">${l.note || '‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á'}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="color:${l.amount >= 0 ? '#16a34a' : '#dc2626'}; font-weight:800; font-size:16px; margin-bottom:5px;">
                                    ${l.amount >= 0 ? '+' : '-'}‡∏ø${Math.abs(l.amount).toLocaleString()}
                                </div>
                                <div style="display:flex; gap:5px; justify-content:flex-end;">
                                    <button onclick="editAccountLog(${l.originalIndex})" style="background:#fffbeb; color:#92400e; border:none; border-radius:8px; padding:6px 10px; font-size:12px; font-weight:700; cursor:pointer;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                    <button onclick="deleteAccountLog(${l.originalIndex})" style="background:#fff1f2; color:#be123c; border:none; border-radius:8px; padding:6px 10px; font-size:12px; font-weight:700; cursor:pointer;">‡∏•‡∏ö</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </details>
        `;
    });

    $("accHistory").innerHTML = finalHtml;
}
/* ==========================================================
   SECTION 7: ANALYTICS, REPORTS & SHARING
   (‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ LINE)
   ========================================================== */
 function loadHistDaily() {
    const d = $("histDate").value;
    if (!d) return;
    const f = archives.find(a => a.date === d);
    if (!f) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ");
    let cashTotal = f.cash || 0;
    let transTotal = f.trans || 0;
    let totalRevenue = cashTotal + transTotal;
    let customerCount = f.count || (f.details ? f.details.length : 0);
    const barberEarn = Math.floor(f.barber || 0);
    const shopEarn = Math.floor(f.shop || 0);
    const svcCounts = {};
    (f.details || []).forEach(r => {
        const services = Array.isArray(r.svcs) ? r.svcs : [r.svcs];
        services.forEach(s => {
            if(s) svcCounts[s] = (svcCounts[s] || 0) + 1;
        });
    });

    const svcHTML = Object.entries(svcCounts).map(([name, count]) => `
        <div style="background:rgba(203, 213, 225, 0.1); padding:6px 12px; border-radius:10px; font-size:12px; color:#cbd5e1; font-weight:600; display:inline-block; margin:3px; border:1px solid rgba(255, 255, 255, 0.1);">
            ${name} <span style="opacity:0.7; margin-left:4px;">x${count}</span>
        </div>
    `).join("");

    let settleHTML = "";
    if (cashTotal > barberEarn) {
        const toShop = cashTotal - barberEarn;
        settleHTML = `<div style="background:rgba(251,146,60,0.1); padding:16px; border-radius:16px; margin-bottom:20px; text-align:center; border:1px solid rgba(251,146,60,0.3);">
            <div style="font-size:16px; color:#fdba74; font-weight:600; margin-bottom:4px;">üë®‚Äçüé® ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô</div>
            <div style="font-size:24px; color:#fb923c; font-weight:800;">‡∏ø${toShop.toLocaleString()}</div>
        </div>`;
    } else if (barberEarn > cashTotal) {
        const toBarber = barberEarn - cashTotal;
        settleHTML = `<div style="background:rgba(56,189,248,0.1); padding:16px; border-radius:16px; margin-bottom:20px; text-align:center; border:1px solid rgba(56,189,248,0.3);">
            <div style="font-size:16px; color:#7dd3fc; font-weight:600; margin-bottom:4px;">üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á</div>
            <div style="font-size:24px; color:#38bdf8; font-weight:800;">‡∏ø${toBarber.toLocaleString()}</div>
        </div>`;
    }
    const rows = (f.details || [])
        .slice()
        .sort((a, b) => (a.time || "").localeCompare(b.time || ""))
        .map((r, index) => {
            const p = Number(r.price) || 0;
            const t = Number(r.tip) || 0;
            const fullTime = (r.time && r.endTime) ? `${r.time}-${r.endTime}` : (r.time || "--:--");
            let payText = "";
            if (r.pay === 'Mix') {
                payText = `üåì ‡∏ú‡∏™‡∏° (‡∏™‡∏î:${(r.payCash||0)}/‡πÇ‡∏≠‡∏ô:${(r.payTrans||0)})`;
            } else {
                payText = r.pay === 'Trans' ? 'üì± ‡πÇ‡∏≠‡∏ô' : 'üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î';
            }
            return `
            <div style="padding:14px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:16px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="width:28px; height:28px; background:rgba(255,255,255,0.08); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:700; color:#94a3b8;">${index + 1}</div>
                    <div>
                        <div style="font-weight:700; font-size:14px; color:#f8fafc;">${Array.isArray(r.svcs) ? r.svcs.join(' + ') : r.svcs}</div>
                        <div style="font-size:13px; color:#94a3b8; font-weight:500; margin-top:2px;">‚è± ${fullTime} ‚Ä¢ ${payText}</div>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:16px; font-weight:800; color:#f8fafc;">‡∏ø${p.toLocaleString()}</div>
                    ${t > 0 ? `<div style="font-size:12px; font-weight:600; color:#f472b6;">+ Tip ‡∏ø${t.toLocaleString()}</div>` : ''}
                </div>
            </div>`;
        }).join("");

    openReportModal(`‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ${d}`, `
        <div style="font-family:'Inter', system-ui, sans-serif; background:#0f172a; margin:-16px; padding:24px; color:#f1f5f9; min-height:100vh;">
            <div style="text-align:center; padding:20px 0 30px 0;">
                <div style="font-size:16px; color:#94a3b8; font-weight:600; text-transform:uppercase; letter-spacing:1px;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</div>
                <div style="font-size:48px; font-weight:900; color:#ffffff; margin-top:5px;">‡∏ø${totalRevenue.toLocaleString()}</div>
            </div>

            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-bottom:24px;">
                <div style="background:#14532d; padding:14px 8px; border-radius:18px; text-align:center; color:#ffffff;">
                    <div style="font-size:13px; opacity:0.8; font-weight:600; margin-bottom:4px;">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</div>
                    <div style="font-size:16px; font-weight:800;">‡∏ø${cashTotal.toLocaleString()}</div>
                </div>
                <div style="background:#1e3a8a; padding:14px 8px; border-radius:18px; text-align:center; color:#ffffff;">
                    <div style="font-size:13px; opacity:0.8; font-weight:600; margin-bottom:4px;">üì± ‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô</div>
                    <div style="font-size:16px; font-weight:800;">‡∏ø${transTotal.toLocaleString()}</div>
                </div>
                <div style="background:#78350f; padding:14px 8px; border-radius:18px; text-align:center; color:#ffffff;">
                    <div style="font-size:13px; opacity:0.8; font-weight:600; margin-bottom:4px;">üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                    <div style="font-size:16px; font-weight:800;">${customerCount}</div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
                <div style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); padding:16px; border-radius:20px; text-align:center;">
                    <div style="font-size:14px; color:#94a3b8; font-weight:600; margin-bottom:4px;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ä‡πà‡∏≤‡∏á</div>
                    <div style="font-size:20px; font-weight:800; color:#f8fafc;">‡∏ø${barberEarn.toLocaleString()}</div>
                </div>
                <div style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); padding:16px; border-radius:20px; text-align:center;">
                    <div style="font-size:14px; color:#94a3b8; font-weight:600; margin-bottom:4px;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡πâ‡∏≤‡∏ô</div>
                    <div style="font-size:20px; font-weight:800; color:#f8fafc;">‡∏ø${shopEarn.toLocaleString()}</div>
                </div>
            </div>

            ${settleHTML}

            <div style="margin-bottom:30px;">
                <div style="font-size:14px; color:#94a3b8; font-weight:700; text-transform:uppercase; margin-bottom:12px; text-align:center;">‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</div>
                <div style="text-align:center;">${svcHTML}</div>
            </div>

            <div style="font-weight:800; font-size:16px; color:#f8fafc; margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                <div style="width:4px; height:18px; background:#cbd5e1; border-radius:2px;"></div>
                ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô
            </div>
            <div style="max-height:400px; overflow-y:auto;">
                ${rows}
            </div>
            </div>
    `);
}
function loadHistMonth() {
    const $ = (id) => document.getElementById(id);
    const m = $("histMonth").value;
    if (!m) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

    if (typeof archives === 'undefined') return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (archives)");

    const filtered = archives.filter(a => a.date && a.date.startsWith(m));
    if (!filtered.length) {
        return openReportModal("üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", `<div style='text-align:center;padding:50px;color:#94a3b8;'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${m}</div>`);
    }

    // üü¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö monthGuarDays (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ)
    let monthTotal = 0, monthBarber = 0, monthCount = 0, monthGuarDays = 0; 
    let hairStats = {}, serviceStats = {};
    let offDays = 0, workDays = 0;
    let weeklyData = {};

    const haircutList = ["‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô","‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î","‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á","‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á","‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£","‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡πÅ‡∏Å‡πâ‡∏ú‡∏°","‡πÇ‡∏Å‡∏ô‡∏ú‡∏°","‡πÄ‡∏î‡πá‡∏Å"];
    const dayNames = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", "‡∏û‡∏∏‡∏ò", "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ", "‡∏®‡∏∏‡∏Å‡∏£‡πå", "‡πÄ‡∏™‡∏≤‡∏£‡πå"];

    filtered.forEach(day => {
        const dObj = new Date(day.date);
        let wIdx = Math.ceil(dObj.getDate() / 7);
        const wKey = `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà ${wIdx}`;

        if (!weeklyData[wKey]) {
            weeklyData[wKey] = { 
                customers: 0, workDays: 0, offDays: 0, 
                zeroDays: 0, guarDays: 0, dailyCounts: [], // ‡πÄ‡∏û‡∏¥‡πà‡∏° guarDays ‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏î‡πâ‡∏ß‡∏¢
                popularHair: {}, 
                popularService: {}, 
                income: 0 
            };
        }

        if (day.off === true || day.type === "HOLIDAY") {
            offDays++;
            weeklyData[wKey].offDays++;
            return;
        }

        workDays++;
        weeklyData[wKey].workDays++;
        
        // üõ°Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "GUARANTEE_CLAIM" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const hasInsurance = day.details && day.details.some(d => d.type === "GUARANTEE_CLAIM");
        if (hasInsurance) {
            monthGuarDays++;
            weeklyData[wKey].guarDays++;
        }

        const dailyIncome = Number(day.total) || 0;
        const dailyBarber = Number(day.barber) || 0; 
        
        monthTotal += dailyIncome;
        monthBarber += dailyBarber;
        weeklyData[wKey].income += dailyIncome;

        let dayCustomerCount = 0;
        if (day.details && Array.isArray(day.details)) {
            day.details.forEach(d => {
                // üë§ ‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ SERVICE ‡∏à‡∏£‡∏¥‡∏á‡πÜ (‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö GUARANTEE_CLAIM ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)
                if (d.type === "SERVICE") {
                    monthCount++;
                    dayCustomerCount++;
                    weeklyData[wKey].customers++;

                    const svcs = Array.isArray(d.svcs) ? d.svcs : [d.svcs];
                    svcs.forEach(s => {
                        if (!s) return;
                        const cleanS = s.trim();
                        if (haircutList.includes(cleanS)) {
                            hairStats[cleanS] = (hairStats[cleanS] || 0) + 1;
                            weeklyData[wKey].popularHair[cleanS] = (weeklyData[wKey].popularHair[cleanS] || 0) + 1;
                        } else {
                            serviceStats[cleanS] = (serviceStats[cleanS] || 0) + 1;
                            weeklyData[wKey].popularService[cleanS] = (weeklyData[wKey].popularService[cleanS] || 0) + 1;
                        }
                    });
                }
            });
        }
        if (dayCustomerCount === 0) weeklyData[wKey].zeroDays++;
        
        weeklyData[wKey].dailyCounts.push({ 
            dayName: dayNames[dObj.getDay()], 
            count: dayCustomerCount, 
            income: dailyIncome,
            barberEarn: dailyBarber 
        });
    });

    const avgCustomerPerDay = workDays > 0 ? (monthCount / workDays) : 0;
    
    // üéØ ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ monthGuarDays ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢
    generateMonthlyReport(m, monthTotal, monthBarber, monthCount, workDays, offDays, avgCustomerPerDay, weeklyData, hairStats, serviceStats, monthGuarDays);
}
function generateMonthlyReport(m, monthTotal, monthBarber, monthCount, workDays, offDays, avgCustomerPerDay, weeklyData, hairStats, serviceStats, monthGuarDays) {
    // --- 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Logic) ---
    const weekEntries = Object.entries(weeklyData);
    const dayStats = {};
    let dailyTimeline = []; 

    const haircutList = ["‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô","‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î","‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á","‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á","‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£","‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡πÅ‡∏Å‡πâ‡∏ú‡∏°","‡πÇ‡∏Å‡∏ô‡∏ú‡∏°","‡πÄ‡∏î‡πá‡∏Å"];
    const allHaircuts = ["‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô","‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î","‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á","‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á","‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£","‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡πÅ‡∏Å‡πâ‡∏ú‡∏°","‡πÇ‡∏Å‡∏ô‡∏ú‡∏°","‡πÄ‡∏î‡πá‡∏Å"];
    const allServices = ["‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î", "‡∏™‡∏£‡∏∞‡∏ú‡∏°", "‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°", "‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤", "‡∏î‡∏±‡∏î‡∏ú‡∏°", "‡∏¢‡πâ‡∏≠‡∏°‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô"]; 

    const topHair = Object.entries(hairStats).sort((a, b) => b[1] - a[1])[0];
    const topService = Object.entries(serviceStats).sort((a, b) => b[1] - a[1])[0];

    weekEntries.forEach(([wk, data]) => {
        if (data.dailyCounts) {
            data.dailyCounts.forEach(d => {
                dailyTimeline.push(d); 
                const dayName = d.dayName.split(' ')[0]; 
                if (!dayStats[dayName]) dayStats[dayName] = { total: 0, count: 0 };
                if (d.count > 0) {
                    dayStats[dayName].total += d.count;
                    dayStats[dayName].count += 1;
                }
            });
        }
    });

    const topIncomeWeek = weekEntries.length > 0 ? weekEntries.reduce((prev, curr) => (curr[1].income > prev[1].income ? curr : prev)) : null;
    const topCountWeek = weekEntries.length > 0 ? weekEntries.reduce((prev, curr) => (curr[1].customers > prev[1].customers ? curr : prev)) : null;

    const dayAverages = Object.entries(dayStats)
        .filter(([name, data]) => data.count > 0)
        .map(([name, data]) => ({ name, avg: data.total / data.count }));

    const busiestDay = dayAverages.sort((a, b) => b.avg - a.avg)[0];
    const quietestDay = dayAverages.sort((a, b) => a.avg - b.avg)[0];

    const renderStats = (statsObj, color) => {
        const entries = Object.entries(statsObj).sort((a,b) => b[1]-a[1]);
        if (entries.length === 0) return `<div style="color:#64748b; font-size:12px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>`;
        const maxVal = entries[0][1];
        return entries.map(([name, count]) => {
            const width = (count / maxVal) * 100;
            return `
            <div style="margin-bottom:10px;">
                <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
                    <span style="color:#f8fafc;">${name}</span>
                    <span style="color:${color}; font-weight:700;">${count}</span>
                </div>
                <div style="width:100%; height:6px; background:rgba(255,255,255,0.05); border-radius:10px; overflow:hidden;">
                    <div style="width:${width}%; height:100%; background:${color}; border-radius:10px;"></div>
                </div>
            </div>`;
        }).join("");
    };

    const maxWeekCount = topCountWeek ? topCountWeek[1].customers : 0;
    const maxIncomeAmount = topIncomeWeek ? (topIncomeWeek[1].income || 0) : 0;

    // üéØ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ ? ‡πÄ‡∏Å‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Insights
    const insights = [
        `‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <b>${workDays} ‡∏ß‡∏±‡∏ô</b> (‡∏´‡∏¢‡∏∏‡∏î ${offDays} ‡∏ß‡∏±‡∏ô)`,
        `‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <b>${monthGuarDays || 0} ‡∏ß‡∏±‡∏ô</b>`,
        (topIncomeWeek && maxIncomeAmount > 0) ? `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ <b>${topIncomeWeek[0]}</b>` : `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ <b>-</b>`,
        (topCountWeek && maxWeekCount > 0) ? `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ <b>${topCountWeek[0]}</b>` : `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ <b>-</b>`,
        (busiestDay && busiestDay.avg > 0) ? (() => {
            if (!quietestDay || busiestDay.avg === quietestDay.avg) return `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡πÉ‡∏ô <b>‡∏ß‡∏±‡∏ô${busiestDay.name}</b>`;
            return `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡πÉ‡∏ô <b>‡∏ß‡∏±‡∏ô${busiestDay.name}</b> ‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏ô <b>‡∏ß‡∏±‡∏ô${quietestDay.name}</b>`;
        })() : `‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: -`,
        `‡∏ó‡∏£‡∏á‡∏ú‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°: <b>${topHair ? topHair[0] : '-'}</b> | ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°: <b>${topService ? topService[0] : '-'}</b>`
    ];

    const weeklyHtml = weekEntries.map(([wk, data]) => {
        const weeklyTotalIncome = data.income || 0;
        let sumBarber = 0;
        if (data.dailyCounts) {
            data.dailyCounts.forEach(day => { sumBarber += Number(day.barberEarn || 0); });
        }
        const wBarber = sumBarber;
        const wShop = weeklyTotalIncome - wBarber;
        const avg = data.workDays > 0 ? (data.customers / data.workDays).toFixed(1) : 0;
        
        const sortedDays = data.dailyCounts ? [...data.dailyCounts].sort((a,b) => b.count - a.count) : [];
        const maxCount = sortedDays.length > 0 ? sortedDays[0].count : 0;
        const minCount = sortedDays.length > 0 ? sortedDays[sortedDays.length - 1].count : 0;

        const bestDay = (maxCount > 0) ? `${sortedDays[0].dayName} (${maxCount})` : "-";
        let worstDay = (sortedDays.length > 1 && maxCount !== minCount) ? `${sortedDays[sortedDays.length - 1].dayName} (${minCount})` : "-";

        const unusedHair = allHaircuts.filter(h => !data.popularHair[h]);
        const unusedService = allServices.filter(s => !data.popularService[s]);

        const popHair = Object.entries(data.popularHair || {}).sort((a,b) => b[1] - a[1]).slice(0, 2).map(([name, count]) => `
            <span style="background:rgba(190,242,100,0.1); color:#bef264; padding:2px 8px; border-radius:8px; font-size:10px; border:1px solid rgba(190,242,100,0.2); margin-right:4px;">‚úÇÔ∏è ${name} ${count}</span>
        `).join("");

        const popService = Object.entries(data.popularService || {}).sort((a,b) => b[1] - a[1]).slice(0, 2).map(([name, count]) => `
            <span style="background:rgba(56,189,248,0.1); color:#38bdf8; padding:2px 8px; border-radius:8px; font-size:10px; border:1px solid rgba(56,189,248,0.2); margin-right:4px;">üß¥ ${name} ${count}</span>
        `).join("");

        return `
        <div style="background:#020617; border:1px solid rgba(255,255,255,0.08); padding:16px; border-radius:22px; margin-bottom:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div style="font-size:15px; font-weight:800; color:#f8fafc;">üìÖ ${wk}</div>
                <div style="font-size:10px; color:#94a3b8;">‡πÄ‡∏õ‡∏¥‡∏î ${data.workDays} | ‡∏´‡∏¢‡∏∏‡∏î ${data.offDays}</div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:6px; margin-bottom:10px;">
                <div style="background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.1); padding:6px 4px; border-radius:12px; text-align:center;">
                    <div style="font-size:9px; color:#94a3b8; margin-bottom:2px;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</div>
                    <div style="font-size:13px; font-weight:800; color:#ffffff;">‡∏ø${weeklyTotalIncome.toLocaleString()}</div>
                </div>
                <div style="background:rgba(190,242,100,0.05); border:1px solid rgba(190,242,100,0.2); padding:6px 4px; border-radius:12px; text-align:center;">
                    <div style="font-size:9px; color:#bef264; margin-bottom:2px;">‡∏ä‡πà‡∏≤‡∏á</div>
                    <div style="font-size:13px; font-weight:800; color:#bef264;">‡∏ø${Math.floor(wBarber).toLocaleString()}</div>
                </div>
                <div style="background:rgba(56,189,248,0.05); border:1px solid rgba(56,189,248,0.2); padding:6px 4px; border-radius:12px; text-align:center;">
                    <div style="font-size:9px; color:#38bdf8; margin-bottom:2px;">‡∏£‡πâ‡∏≤‡∏ô</div>
                    <div style="font-size:13px; font-weight:800; color:#38bdf8;">‡∏ø${Math.floor(wShop).toLocaleString()}</div>
                </div>
            </div>
            <div style="display:flex; gap:6px; margin-bottom:10px;">
                <div style="flex:1; background:rgba(255,255,255,0.02); padding:4px 10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:10px; color:#64748b;">üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
                    <span style="font-size:11px; font-weight:700; color:#38bdf8;">${data.customers}</span>
                </div>
                <div style="flex:1; background:rgba(250,204,21,0.05); border:1px solid rgba(250,204,21,0.1); padding:4px 10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:10px; color:#facc15;">üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</span>
                    <span style="font-size:11px; font-weight:700; color:#facc15;">${data.guarDays || 0}</span>
                </div>
                <div style="flex:1; background:rgba(255,255,255,0.02); padding:4px 10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:10px; color:#64748b;">üìä ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</span>
                    <span style="font-size:11px; font-weight:700; color:#ffffff;">${avg}</span>
                </div>
            </div>
            <div style="font-size:11px; color:#64748b; line-height:1.6; padding:0 4px 10px 4px; border-bottom:1px solid rgba(255,255,255,0.05); margin-bottom:10px;">
                <div>üìà ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: <span style="color:#f1f5f9; font-weight:600;">${bestDay}</span></div>
                <div>üìâ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: <span style="color:#f1f5f9; font-weight:600;">${worstDay}</span></div>
            </div>
            <div style="display:flex; flex-wrap:wrap; gap:4px; margin-top: 8px;">
                ${popHair} ${popService}
            </div>
        </div>`;
    }).join("");

    openReportModal(
        `‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${m}`,
        `<div style="background:#0f172a; padding:24px; color:#f1f5f9; border-radius:20px; font-family: sans-serif; margin-bottom:50px;">
            <div style="text-align:center; padding:10px 0 20px 0;">
                <div style="font-size:16px; color:#94a3b8; font-weight:700; margin-bottom:5px;">‚úÇÔ∏è ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                <div style="font-size:48px; font-weight:900; color:#ffffff;">‡∏ø${monthTotal.toLocaleString()}</div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
                <div style="background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.1); padding:15px; border-radius:20px; text-align:center;">
                    <div style="font-size:11px; color:#94a3b8;">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ä‡πà‡∏≤‡∏á</div>
                    <div style="font-size:20px; font-weight:800; color:#f8fafc;">‡∏ø${Math.floor(monthBarber).toLocaleString()}</div>
                </div>
                <div style="background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.1); padding:15px; border-radius:20px; text-align:center;">
                    <div style="font-size:11px; color:#94a3b8;">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡πâ‡∏≤‡∏ô</div>
                    <div style="font-size:20px; font-weight:800; color:#f8fafc;">‡∏ø${Math.floor(monthTotal - monthBarber).toLocaleString()}</div>
                </div>
            </div>
            <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:8px; margin-bottom:25px;">
                <div style="background:rgba(56,189,248,0.15); padding:6px 14px; border-radius:12px; font-size:13px; font-weight:600; color:#38bdf8;">üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${monthCount} ‡∏Ñ‡∏ô</div>
                <div style="background:rgba(255,255,255,0.08); padding:6px 14px; border-radius:12px; font-size:13px; font-weight:600; color:#f8fafc;">üìÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô ${workDays} ‡∏ß‡∏±‡∏ô</div>
                <div style="background:rgba(250,204,21,0.15); padding:6px 14px; border-radius:12px; font-size:13px; font-weight:600; color:#facc15;">üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô ${monthGuarDays || 0} ‡∏ß‡∏±‡∏ô</div>
                <div style="background:rgba(244,63,94,0.15); padding:6px 14px; border-radius:12px; font-size:13px; font-weight:600; color:#fb7185;">üõë ‡∏´‡∏¢‡∏∏‡∏î ${offDays} ‡∏ß‡∏±‡∏ô</div>
                <div style="background:rgba(147, 51, 234, 0.15); padding:6px 14px; border-radius:12px; font-size:13px; font-weight:600; color:#a855f7;">üìä ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${avgCustomerPerDay.toFixed(2)}</div>
            </div>
            <div style="margin-bottom:25px;">
                <div style="font-size:14px; font-weight:800; color:#facc15; margin-bottom:12px;">üìÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
                ${weeklyHtml}
            </div>
            <div style="background:rgba(250,204,21,0.08); border:1px solid rgba(250,204,21,0.25); padding:18px; border-radius:20px; margin-bottom:30px;">
                <div style="font-size:14px; font-weight:800; color:#facc15; margin-bottom:10px;">üí° ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</div>
                ${insights.map(i => `<div style="font-size:13px; color:#f8fafc; margin-bottom:6px;">‚Ä¢ ${i}</div>`).join("")}
            </div>
            <div style="margin-bottom:25px;">
                <div style="font-size:15px; font-weight:800; color:#bef264; margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                    <div style="width:4px; height:16px; background:#bef264; border-radius:2px;"></div> ‡∏ó‡∏£‡∏á‡∏ú‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°
                </div>
                ${renderStats(hairStats, "#bef264")}
            </div>
            <div style="padding-bottom:20px;">
                <div style="font-size:15px; font-weight:800; color:#38bdf8; margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                    <div style="width:4px; height:16px; background:#38bdf8; border-radius:2px;"></div> ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°
                </div>
                ${renderStats(serviceStats, "#38bdf8")}
            </div>
        </div>`
    );
}  
function renderStats(obj, accentColor) {
    const entries = Object.entries(obj).sort((a, b) => b[1] - a[1]);
    if (!entries.length) return "<div style='color:rgba(255,255,255,0.2); padding:10px; font-size:13px;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>";
    
    return entries.map(([k, v]) => `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:16px; margin-bottom:8px;">
            <div style="font-weight:600; color:#f1f5f9; font-size:14px;">${k}</div>
            <div style="font-weight:800; color:${accentColor}; font-size:16px;">${v} <span style="font-size:11px; opacity:0.5; color:#fff;">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
        </div>`).join("");
}
function shareLine() {
    const dInp = $("dateInp").value;
    const today = db.filter(r => r.date === dInp);
    
    if (!today.length) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");
        return;
    }
    // --- üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô 13 ‡∏Å.‡∏û. 69) ---
    const [y, m, d] = dInp.split('-');
    const months = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
    const fDate = `${parseInt(d)} ${months[parseInt(m)-1]} ${(parseInt(y) + 543).toString().slice(-2)}`;
    
    // --- üü¢ ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Config ---
    const shopName = conf.shop || "Barber Shop";

    let tot = 0, cash = 0, trans = 0, tips = 0;
    let stats = {}, realCustomerCount = 0;

    // 1. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    const clientList = today
        .sort((a, b) => a.time.localeCompare(b.time))
        .map((r, i) => {
            const p = Number(r.price) || 0;
            const t = Number(r.tip) || 0;
            const rType = r.type ? String(r.type).toUpperCase().trim() : '';
            
            tot += p;
            tips += t;

            if (r.pay === 'Trans') {
                trans += (p + t);
            } else {
                cash += p;
            }

            const isService = !['GUARANTEE', 'HOLIDAY'].includes(rType) && p > 0;
            if (isService) {
                realCustomerCount++;
                if (r.hair && r.hair.includes("‡πÄ‡∏î‡πá‡∏Å")) stats["‡πÄ‡∏î‡πá‡∏Å"] = (stats["‡πÄ‡∏î‡πá‡∏Å"] || 0) + 1;
                (r.svcs || []).forEach(s => { if (s) stats[s] = (stats[s] || 0) + 1; });
            }

            const tShow = r.endTime ? `${r.time}-${r.endTime}` : r.time;
            const icon = rType === 'GUARANTEE' ? 'üõ°Ô∏è' : (rType === 'HOLIDAY' ? 'üèñÔ∏è' : '');
            const payIcon = r.pay === 'Trans' ? 'üì±' : 'üíµ';

            return `${i + 1}. [${tShow}] ${icon} ${(r.svcs || []).join('+')} = ${p}${t ? ` (+‡∏ó‡∏¥‡∏õ ${t})` : ''} ${payIcon}`;
        }).join('\n');

    // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    const allowed = ["‡πÄ‡∏î‡πá‡∏Å", "‡∏™‡∏£‡∏∞‡∏ú‡∏°", "‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î", "‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°", "‡∏¢‡πâ‡∏≠‡∏°‡∏™‡∏µ"];
    const icons = { "‡πÄ‡∏î‡πá‡∏Å": "üßí", "‡∏™‡∏£‡∏∞": "üßº", "‡πÇ‡∏Å‡∏ô": "ü™í", "‡∏¢‡πâ‡∏≠‡∏°": "üé®" };
    
    let statText = Object.entries(stats)
        .filter(([k]) => allowed.some(a => k.includes(a)))
        .map(([k, v]) => {
            const iconKey = Object.keys(icons).find(i => k.includes(i));
            return `${icons[iconKey] || 'üîπ'} ${k}: ${v}`;
        }).join('\n');

    // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    let bEarn = Math.max(tot * (conf.perc / 100), conf.guar) + tips;
    let bEarnNoTip = bEarn - tips; 
    let shopEarn = tot - bEarnNoTip;
    
    let settle = cash - bEarn;
    let settleMsg = settle > 0 
        ? `‚ö†Ô∏è ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô: ${Math.floor(Math.abs(settle)).toLocaleString()} ‡∏ö‡∏≤‡∏ó` 
        : `üü¶ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á: ${Math.floor(Math.abs(settle)).toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

    // 4. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Template)
    let msg = `üíà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô: ${shopName}\n`; // üü¢ ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÅ‡∏•‡πâ‡∏ß
    msg += `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${fDate}\n`;            // üü¢ ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß
    msg += `-------------------------\n`;
    msg += `üìù ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (${realCustomerCount} ‡∏Ñ‡∏ô):\n${clientList}\n`;
    msg += `-------------------------\n`;
    msg += `üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô:\n${statText || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)'}\n`;
    msg += `-------------------------\n`;
    msg += `üí∞ ‡∏¢‡∏≠‡∏î: ${tot.toLocaleString()} | üßß ‡∏ó‡∏¥‡∏õ: ${tips}\n`;
    msg += `üì± ‡πÇ‡∏≠‡∏ô: ${trans.toLocaleString()} | üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î: ${cash.toLocaleString()}\n`;
    msg += `ü§µ ‡∏ä‡πà‡∏≤‡∏á: ${Math.floor(bEarn).toLocaleString()}\n`;
    msg += `üè† ‡∏£‡πâ‡∏≤‡∏ô: ${Math.floor(shopEarn).toLocaleString()}\n`;
    msg += `-------------------------\n`;
    msg += `${settleMsg}`;

    // 5. ‡πÅ‡∏™‡∏î‡∏á Preview (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
    const msgEdit = $("msgEdit"); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô $ ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ
    const previewArea = $("linePreview");
    
    if (msgEdit && previewArea) {
        msgEdit.value = msg;
        previewArea.style.display = "flex"; // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Preview
        console.log("‚úÖ Preview Generated");
    } else {
        console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Element ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á Preview");
        alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ID ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");
    }
}
function sendToLineFinal() {
    const msgEdit = document.getElementById("msgEdit");
    const previewArea = document.getElementById("linePreview");
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!msgEdit || !msgEdit.value.trim()) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏ö");
        return;
    }
    const finalMsg = msgEdit.value;
    // 2. ‡πÉ‡∏ä‡πâ LINE URL Scheme ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ LINE ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    // encodeURIComponent ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(finalMsg)}`;
    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    window.open(lineUrl, '_blank');
    // 3. ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Preview ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á Timeout ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥)
    if (previewArea) {
        previewArea.style.display = "none";
    }
}
/* ==========================================================
   SECTION 8: SETTINGS & APPEARANCE
   (‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏õ‡πÅ‡∏•‡∏∞‡∏ò‡∏µ‡∏°)
   ========================================================== */
function openSettings() {
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• configuration ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
    const config = conf || {};
    // 2. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ mapping ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á ID ‡∏Ç‡∏≠‡∏á Element ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô conf
    // ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô if ‡∏ã‡πâ‡∏≥‡πÜ ‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
    const fields = {
        "setShop":  config.shop  || "",
        "setTheme": config.theme || "light",
        "setVoice": config.voice || "female",
        "setSound": config.sound || "on",
        "setPerc":  config.perc  || 50,
        "setGuar":  config.guar  || 0
    };
    // 3. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ Input (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏µ Element ‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á)
    Object.entries(fields).forEach(([id, value]) => {
        const el = $(id);
        if (el) el.value = value;
    });
    // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Modal
    const modal = $("modalSet");
    if (modal) {
        modal.style.display = "flex";
    } else {
        console.error("‡πÑ‡∏°‡πà‡∏û‡∏ö Element: modalSet");
    }
}
function saveSettings() {
    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° (‡πÄ‡∏û‡∏¥‡πà‡∏° sound ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö)
    const settings = {
        shop:  $("setShop")?.value || "",
        perc:  parseFloat($("setPerc")?.value) || 0,
        guar:  parseFloat($("setGuar")?.value) || 0,
        theme: $("setTheme")?.value || "light",
        voice: $("setVoice")?.value || "default.mp3",
        sound: $("setSound")?.value || "on"  // üü¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
    };

    // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Å‡∏•‡∏≤‡∏á (conf) ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ 
    Object.assign(conf, settings);

    // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á LocalStorage (‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß JSON)
    localStorage.setItem('barber_conf', JSON.stringify(conf));

    // üü¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏¢‡∏Å Key (‡πÄ‡∏û‡∏¥‡πà‡∏° shopSound ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö)
    localStorage.setItem('shopName',  settings.shop);
    localStorage.setItem('shopPerc',  settings.perc);
    localStorage.setItem('shopGuar',  settings.guar);
    localStorage.setItem('shopTheme', settings.theme);
    localStorage.setItem('shopVoice', settings.voice);
    localStorage.setItem('shopSound', settings.sound); // üü¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö

    // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if ($("shopNameDisp")) {
        $("shopNameDisp").innerText = settings.shop.toUpperCase();
    } 

    if (document.getElementById("shopNameDisplay")) {
        document.getElementById("shopNameDisplay").innerText = settings.shop;
    }

    // 5. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
    if (typeof applyTheme === "function")        applyTheme(settings.theme);
    if (typeof calculateMoney === "function")    calculateMoney(); 
    if (typeof renderDay === "function")         renderDay(); 

    // üü¢ ‡∏ñ‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
    // if (typeof updateSoundStatus === "function") updateSoundStatus(settings.sound);

    // 6. ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    if ($("modalSet")) $("modalSet").style.display = 'none';
    
    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
}
function handleSave(event) {
    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    const price = parseInt($("priceInp")?.value) || 0;
    const tip = parseInt($("tipInp")?.value) || 0;
    const dateVal = $("dateInp")?.value;

    if (!price || !payMethod) {
        // üîä ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
        speak("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô");
        return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô!");
    }

    // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ End Time ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï)
    const startTime = $("tStart")?.value || new Date().toTimeString().slice(0, 5);
    const endTime = $("tEnd")?.value; 

    // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏î / ‡πÇ‡∏≠‡∏ô / ‡∏ú‡∏™‡∏°)
    let cashAmt = 0, transAmt = 0;
    if (payMethod === 'Mix') {
        cashAmt = parseInt($("mixCash")?.value) || 0;
        transAmt = parseInt($("mixTrans")?.value) || 0;
        if (cashAmt + transAmt !== price + tip) {
            const isConfirmed = confirm(`‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ö‡∏¥‡∏• (‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á ${cashAmt + transAmt} / ‡∏ö‡∏¥‡∏• ${price + tip})\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÑ‡∏´‡∏°?`);
            if (!isConfirmed) return;
        }
    } else {
        payMethod === 'Cash' ? cashAmt = price + tip : transAmt = price + tip;
    }
    // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡πá‡∏≠‡∏ö‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Record Object)
    const rec = {
        id: Date.now(), 
        date: dateVal, 
        time: startTime, 
        endTime: endTime || (typeof addMinutes === 'function' ? addMinutes(startTime, 30) : startTime),
        svcs: [$("hairStyle")?.value, $("extra1")?.value, $("extra2")?.value].filter(Boolean),
        price: price, 
        tip: tip, 
        pay: payMethod, 
        payCash: cashAmt, 
        payTrans: transAmt, 
        type: "SERVICE"
    };

    // 5. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏ö‡∏ö
    db.push(rec); 
    saveDB(); 

    // üîä --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô ---
    const total = price + tip;
    const payText = payMethod === 'Cash' ? "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î" : (payMethod === 'Trans' ? "‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô" : "‡∏¢‡∏≠‡∏î‡∏ú‡∏™‡∏°");
    speak(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${payText} ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ${total} ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    // ---------------------------------------

    if (typeof renderDay === 'function') renderDay(); 
    if (typeof loadAccountStatus === 'function') loadAccountStatus();

    // 6. Animation ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Feedback UI)
    const btnSave = event.currentTarget || document.querySelector(".btn-main");
    if (btnSave) {
        const originalContent = btnSave.innerHTML;
        const originalBg = btnSave.style.background;
        
        btnSave.style.setProperty("background", "linear-gradient(135deg, #10b981, #059669)", "important");
        btnSave.innerHTML = `<i class="fas fa-check-circle" style="font-size:38px;"></i> <span style="font-size:32px; font-weight:900;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`;
        
        setTimeout(() => {
            btnSave.style.background = originalBg;
            btnSave.innerHTML = originalContent;
        }, 1200);
    }

    // 7. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
    if ($("tStart") && endTime) {
        $("tStart").value = endTime;
    }
    const inputsToClear = ["priceInp", "tipInp", "mixCash", "mixTrans", "tEnd"];
    inputsToClear.forEach(id => { if($(id)) $(id).value = ""; });

    const selectsToReset = ["hairStyle", "extra1", "extra2"];
    selectsToReset.forEach(id => { if($(id)) $(id).selectedIndex = 0; });

    payMethod = ""; 
    const payButtons = ["btnCash", "btnTrans", "btnMix"];
    payButtons.forEach(id => { if($(id)) $(id).className = "icon-card"; });
    
    if($("mixPanel")) $("mixPanel").style.display = 'none';

    if ($("tEnd")) {$("tEnd").focus();
    }
}
function applyTheme(t) {
    // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Class ‡πÅ‡∏•‡∏∞‡∏•‡∏ö Style ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
    document.body.className = t;
    const oldStyle = document.getElementById("navyStyle");
    if (oldStyle) oldStyle.remove();

    const s = document.documentElement.style;
    // 2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (Default: Light Theme)
    // ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥‡πÉ‡∏ô else
    let bodyBg = '#f3f4f6';
    s.setProperty('--card', '#ffffff');
    s.setProperty('--text', '#1a237e');
    s.setProperty('--modal-bg', '#f3f4f6');
    // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ò‡∏µ‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ
    if (t === 'dark') {
        // --- üåë ‡∏ò‡∏µ‡∏°‡∏°‡∏∑‡∏î-‡∏ó‡∏≠‡∏á ---
        bodyBg = '#171717';
        s.setProperty('--card', '#262626');
        s.setProperty('--text', '#fbbf24');
        s.setProperty('--modal-bg', '#171717');
    } 
    else if (t === 'navy') {
        // --- üåå ‡∏ò‡∏µ‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô ---
        bodyBg = '#1a237e';
        s.setProperty('--card', '#ffffff');
        s.setProperty('--text', '#1a237e');
        s.setProperty('--modal-bg', '#1a237e');
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Style ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ò‡∏µ‡∏° Navy
        const st = document.createElement("style");
        st.id = "navyStyle";
        st.innerHTML = `
            body.navy { background: #1a237e !important; color: #ffffff !important; }
            .navy .card b, .navy .card span { color: #1e293b !important; }
            .navy #dTotal, .navy #accNet { color: #1a237e !important; }
            .navy .nav-item { color: #ffffff !important; opacity: 0.7; }
            .navy .nav-item.active { color: #facc15 !important; opacity: 1; font-weight: bold; }
        `;
        document.head.appendChild(st);
    }
    // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á Body
    document.body.style.background = bodyBg;
}
/* ==========================================================
   SECTION 9: SYSTEM STARTUP & EVENT LISTENERS
   (‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå)
   ========================================================== */
// 1. ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î Modal (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)
window.onclick = function(e) {
    const modals = [
        { id: "reportModal", close: typeof closeReportModal === "function" ? closeReportModal : null },
        { id: "historyModal", close: typeof closeHistoryModal === "function" ? closeHistoryModal : null },
        { id: "modalSet", close: typeof closeAndGoHome === "function" ? closeAndGoHome : null },
        { id: "configModal", close: typeof closeConfigModal === "function" ? closeConfigModal : null } 
    ]; 
    modals.forEach(m => {
        const modalEl = document.getElementById(m.id);
        if (modalEl && e.target === modalEl && m.close) m.close();
    });
};

// 2. ‡∏£‡∏∞‡∏ö‡∏ö Pull-to-Refresh (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡∏ì‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô)
let touchStart = 0;
window.addEventListener('touchstart', (e) => {
    touchStart = e.targetTouches[0].pageY;
}, {passive: true});

window.addEventListener('touchmove', (e) => {
    let touchMove = e.targetTouches[0].pageY;
    let swipeDistance = touchMove - touchStart;
    // üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ: 
    // 1. ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÜ (window.scrollY === 0)
    // 2. ‡∏£‡∏∞‡∏¢‡∏∞‡∏•‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å 180 ‡πÄ‡∏õ‡πá‡∏ô 250px) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡∏±‡πà‡∏ô‡∏á‡πà‡∏≤‡∏¢
    // 3. ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Scroll ‡∏≠‡∏¢‡∏π‡πà
    if (window.scrollY === 0 && swipeDistance > 250) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ô‡∏¥‡πâ‡∏ß‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≤‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô Element ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô)
        if (e.target.closest('.scrollable-table') || e.target.closest('#reportModal')) {
            return; // ‡∏ñ‡πâ‡∏≤‡∏•‡∏≤‡∏Å‡∏ö‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
        }
        
        document.body.style.opacity = "0.5";
        location.reload(); 
    }
}, {passive: true});

// 3. ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)
window.addEventListener('load', () => {
    console.log("üöÄ Barber App System Started...");

    // --- üü¢ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÅ‡∏´‡∏•‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ---
    const savedName = localStorage.getItem("shopName") || "BARBER SHOP";
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô
    const shopElements = [
        document.querySelector('h2'), 
        document.getElementById("shopNameDisplay"),
        document.getElementById("shopNameDisp")
    ];
    
    shopElements.forEach(el => {
        if (el) el.innerText = savedName;
    });

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (Modal) ---
    if (document.getElementById("modalSet")) document.getElementById("modalSet").style.display = "none";
    if (document.getElementById("reportModal")) document.getElementById("reportModal").style.display = "none";

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ---
    const today = new Date().toISOString().split('T')[0]; 
    ["dateInp", "accDate", "histDate"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = today;
    });

    // ‚ú® ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (p1) ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏™‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    if (typeof go === 'function') go(1); 
    
    document.body.style.opacity = "1"; 
    document.body.style.overflow = "auto";

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
    if (typeof updateDateDisplay === 'function') updateDateDisplay(today);
    if (typeof loadAccountStatus === 'function') loadAccountStatus();

    console.log("‚ö° ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏≠ " + savedName);
});
 </script>
            </body>
            </html>
