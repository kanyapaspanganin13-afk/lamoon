<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BarberNote">
    <link rel="apple-touch-icon" href="https://i.ibb.co/kVrdspsT/Barber-note-pro.jpg">
    <title>Barber Note Pro V.1 </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./service-worker.js")
                    .then(reg => console.log("‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!"))
                    .catch(err => console.error("‚ùå SW error:", err));
            });
        }
    </script>
</head>
<style>
/* =====================================================
   1Ô∏è‚É£ ROOT VARIABLES (‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö)
===================================================== */
:root {
    /* Brand */
    --primary: #6366f1;
    --accent: #0ea5e9;
    --danger: #ef4444;
    --success: #22c55e;

    /* Base Colors */
    --bg: #f8fafc;
    --card: #ffffff;
    --text: #1e293b;
    --border: #e2e8f0;

    /* Radius */
    --radius-lg: 25px;
    --radius-md: 18px;
    --radius-sm: 12px;

    /* Shadow */
    --shadow-sm: 0 2px 6px rgba(0,0,0,0.05);
    --shadow-md: 0 8px 20px rgba(0,0,0,0.08);

    /* Transition */
    --transition: 0.25s ease;
}
/* =====================================================
   2Ô∏è‚É£ THEME SYSTEM
===================================================== */
body.dark {
    --bg: #121212;
    --card: #1a1a1a;
    --text: #fbbf24;
    --accent: #fbbf24;
}
body.navy {
    --bg: #0f172a;
    --card: #1e293b;
    --text: #f1f5f9;
    --accent: #38bdf8;
}
/* =====================================================
   3Ô∏è‚É£ RESET & BASE
===================================================== */
* {
    box-sizing: border-box;
    font-family: 'Kanit', sans-serif;
    -webkit-tap-highlight-color: transparent;
}

body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    transition: background var(--transition), color var(--transition);
}
/* =====================================================
   4Ô∏è‚É£ LAYOUT SYSTEM
===================================================== */
.container {
    max-width: 500px;
    margin: auto;
    padding: 15px;
}
.page {
    display: none;
    background: var(--card);
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid var(--border);
    min-height: 75vh;
}

.page.active {
    display: block;
    animation: fadeSlide 0.35s ease;
}

@keyframes fadeSlide {
    from { opacity: 0; transform: translateY(15px); }
    to   { opacity: 1; transform: translateY(0); }
}

/* =====================================================
   5Ô∏è‚É£ NAVIGATION
===================================================== */

nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 75px;
    background: var(--card);
    display: flex;
    justify-content: space-around;
    align-items: center;
    border-top: 1px solid var(--border);
    box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
}

.nav-item {
    flex: 1;
    text-align: center;
    color: var(--text);
    opacity: 0.6;
    cursor: pointer;
    transition: var(--transition);
}

.nav-item.active {
    color: var(--accent);
    opacity: 1;
}


/* =====================================================
   6Ô∏è‚É£ FORM & INPUT
===================================================== */

input, select {
    width: 100%;
    height: 70px;
    border-radius: var(--radius-md);
    border: none;
    text-align: center;
    font-size: 20px;
    font-weight: bold;
    background: var(--card);
    color: var(--text);
    box-shadow: var(--shadow-sm);
}


/* =====================================================
   7Ô∏è‚É£ BUTTON SYSTEM
===================================================== */

.btn {
    height: 70px;
    border-radius: var(--radius-md);
    border: none;
    cursor: pointer;
    font-weight: bold;
    transition: var(--transition);
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-danger {
    background: var(--danger);
    color: white;
}


/* =====================================================
   8Ô∏è‚É£ CARD SYSTEM
===================================================== */

.card {
    background: var(--card);
    border-radius: var(--radius-lg);
    padding: 20px;
    box-shadow: var(--shadow-sm);
}
.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: rgba(0,0,0,0.04);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    margin-bottom: 8px;
}
.stat-label {
    font-weight: 600;
    font-size: 14px;
}
.stat-value {
    font-weight: 800;
    font-size: 16px;
}
.stat-unit {
    font-size: 11px;
    opacity: 0.6;
}

/* =====================================================
   9Ô∏è‚É£ MODAL SYSTEM
===================================================== */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    visibility: hidden;
    transition: var(--transition);
}
.modal.active {
    opacity: 1;
    visibility: visible;
}
.modal-content {
    background: var(--card);
    border-radius: var(--radius-lg);
    padding: 25px;
    width: 90%;
    max-width: 600px;
    max-height: 85vh;
    overflow-y: auto;
}
/* =====================================================
   üîü UTILITIES
===================================================== */
.text-center { text-align: center; }
.mt-10 { margin-top: 10px; }
.mb-10 { margin-bottom: 10px; }
.hidden { display: none !important; }

</style>
    </head>
<body>
   <div class="container">
    <div id="p1" class="page active main-page">
        <h2 id="shopNameDisp" class="shop-title">
            BARBER SHOP
        </h2>
        <div class="grid-3 main-grid">
              <div class="icon-card gold" onclick="handleInsurance()">
                <div class="icon-box">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <span>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</span>
            </div>
            <div class="icon-card red" onclick="handleHoliday()">
                <div class="icon-box">
                    <i class="fas fa-umbrella-beach"></i>
                </div>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span>
            </div>
            <div class="icon-card gray" onclick="openSettings()">
                <div class="icon-box">
                    <i class="fas fa-cog"></i>
                </div>
                <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
            </div>
        </div>
<div class="form-wrapper">
    <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà + ‡πÄ‡∏ß‡∏•‡∏≤ -->
    <div class="grid-3 top-row">
        <div class="date-box">
            <span id="dateDisplay">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
            <input type="date" id="dateInp">
        </div>
        <input type="time" id="tStart" class="input-large">
        <input type="time" id="tEnd" class="input-large">
    </div>
    <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ -->
    <div class="grid-service">
        <select id="hairStyle" class="select-main">
            <option value="">‚úÇÔ∏è ‡∏ó‡∏£‡∏á‡∏ú‡∏°</option>
            <option>‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô</option>
            <option>‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î</option>
            <option>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á</option>
            <option>‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á</option>
            <option>‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£</option>
            <option>‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            <option>‡πÅ‡∏Å‡πâ‡∏ú‡∏°</option>
            <option>‡πÇ‡∏Å‡∏ô‡∏ú‡∏°</option>
        </select>
        <select id="extra1" class="select-sub">
            <option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£1</option>
            <option value="‡πÄ‡∏î‡πá‡∏Å">‡πÄ‡∏î‡πá‡∏Å</option>
            <option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option>
            <option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option>
            <option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option>
            <option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option>
        </select>
        <select id="extra2" class="select-sub">
            <option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£2</option>
            <option value="‡πÄ‡∏î‡πá‡∏Å">‡πÄ‡∏î‡πá‡∏Å</option>
            <option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option>
            <option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option>
            <option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option>
            <option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option>
        </select>
    </div>
    <!-- ‡∏£‡∏≤‡∏Ñ‡∏≤ -->
    <div class="price-row">
        <div class="price-box">
            <span class="baht">‡∏ø</span>
            <input type="number" id="priceInp" placeholder="0">
        </div>
        <input type="number" id="tipInp" placeholder="‡∏ó‡∏¥‡∏õ" class="tip-box">
    </div>
    <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢ -->
    <div class="grid-3 pay-row">
        <button id="btnCash" class="pay-btn green">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
        <button id="btnTrans" class="pay-btn purple">üì± ‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢</button>
        <button id="btnMix" class="pay-btn blue">üåì ‡∏à‡πà‡∏≤‡∏¢‡∏ú‡∏™‡∏°</button>
    </div>
    <!-- Mix Panel -->
    <div id="mixPanel" class="mix-panel">
        <div class="mix-grid">
            <input type="number" id="mixCash" placeholder="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">
            <input type="number" id="mixTrans" placeholder="‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô">
        </div>
    </div>
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
    <button class="btn-save">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    </button>
</div>
<div id="p2" class="page report-page">
    <!-- Summary Card -->
    <div class="report-grid">
        <div class="summary-card">
            <small>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
            <div id="dTotal" class="big-number">0</div>
            <div id="dCounts" class="count-badge">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 0 ‡∏Ñ‡∏ô</div>
        </div>
        <div class="detail-card">
            <div class="row-line">
                <span><i class="fas fa-mobile-alt blue"></i> ‡πÇ‡∏≠‡∏ô</span>
                <b id="dTrans">0</b>
            </div>
            <div class="row-line">
                <span><i class="fas fa-money-bill-wave green"></i> ‡∏™‡∏î</span>
                <b id="dCash">0</b>
            </div>
            <div class="row-line">
                <span><i class="fas fa-cut yellow"></i> ‡∏ä‡πà‡∏≤‡∏á</span>
                <b id="dBarber">0</b>
            </div>
            <div class="row-line total-line">
                <span><i class="fas fa-store pink"></i> ‡∏£‡πâ‡∏≤‡∏ô</span>
                <b id="dShop">0</b>
            </div>
        </div>
    </div>
    <!-- Settlement -->
    <div id="settleBarContainer" class="settle-container">
        <div id="settleBar"></div>
    </div>
    <!-- Service Stats -->
    <div id="dServiceStats" class="service-stats"></div>
    <hr class="divider">
    <!-- List -->
    <div id="dailyList"></div>
    <!-- Delete Button -->
    <div class="delete-wrapper">
        <button onclick="clearDailyData()" class="btn-delete">
            <i class="fas fa-trash-alt"></i>
            ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        </button>
    </div>
</div>
   <div id="p3" class="page account-page">
    <div class="account-card">
        <!-- Header -->
        <div class="account-header">
            <b><i class="fas fa-wallet"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</b>
            <div id="accLight" class="status-light"></div>
        </div>
        <!-- Old + Today -->
        <div class="account-grid">
            <div class="mini-card">
                <small>‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°</small>
                <b id="accOldVal">‡∏ø0</b>
            </div>
            <div class="mini-card">
                <small id="accDateLabel">00/00/0000</small>
                <b id="accTodayVal">‡∏ø0</b>
            </div>
        </div>
        <!-- Total -->
        <div class="total-card">
            <div id="statusBadge" class="status-badge">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...
            </div>
            <div id="accTotalVal" class="total-number">‡∏ø0</div>
        </div>
        <!-- Inputs -->
        <div class="account-inputs">
            <div class="input-row">
                <i class="fas fa-calendar-alt"></i>
                <input type="date" id="accDate">
            </div>
            <div class="input-row">
                <i class="fas fa-pen-nib"></i>
                <input type="text" id="accNote" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏...">
            </div>
        </div>
        <!-- Buttons -->
        <div class="account-buttons">
            <button onclick="clearAccount()" class="btn-clear">
                <i class="fas fa-check-double"></i> ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô
            </button>
            <button onclick="openHistoryModal()" class="btn-history">
                <i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô
            </button>
        </div>
        <!-- Monthly Summary -->
        <div class="btn-month" onclick="document.getElementById('histMonth').showPicker()">
            <i class="fas fa-calendar-check"></i>
            <b>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</b>
            <input type="month" id="histMonth" onchange="loadHistMonth()">
        </div>
        <!-- Share -->
        <div class="btn-line" onclick="confirmShareLine()">
            <i class="fab fa-line"></i>
            <b>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</b>
        </div>
    </div>
</div>       
<div id="modalSet" class="modal">
    <div class="modal-box">
        <div class="modal-header">
            <h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
        </div>
        <div class="modal-body">
            <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô -->
            <input type="text" id="setShop" class="input-main" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô">
            <!-- % ‡∏ä‡πà‡∏≤‡∏á + ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô -->
            <div class="grid-2">
                <input type="number" id="setPerc" class="input-main" placeholder="% ‡∏ä‡πà‡∏≤‡∏á">
                <input type="number" id="setGuar" class="input-main" placeholder="‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô">
            </div>
            <!-- ‡∏ò‡∏µ‡∏° -->
            <select id="setTheme" class="input-main">
                <option value="light">üå§ ‡∏ò‡∏µ‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á</option>
                <option value="navy">üåå ‡∏ò‡∏µ‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô</option>
                <option value="dark">üåë ‡∏ò‡∏µ‡∏°‡∏î‡∏≥-‡∏ó‡∏≠‡∏á</option>
            </select>
            <!-- ‡πÄ‡∏™‡∏µ‡∏¢‡∏á -->
            <div class="grid-2">
                <div class="select-icon">
                    <i class="fas fa-volume-up"></i>
                    <select id="setSound">
                        <option value="on">‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</option>
                        <option value="off">‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</option>
                    </select>
                </div>
                <div class="select-icon">
                    <i class="fas fa-user-friends"></i>
                    <select id="setVoice">
                        <option value="female">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏´‡∏ç‡∏¥‡∏á</option>
                        <option value="male">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ä‡∏≤‡∏¢</option>
                    </select>
                </div>
            </div>
            <!-- Backup -->
            <div class="grid-3">
                <button onclick="exportBackup()" class="btn-outline">
                    <i class="fas fa-file-download"></i> ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
                <input type="file" id="fileInput" hidden onchange="importBackup(this)">
                <button onclick="document.getElementById('fileInput').click()" class="btn-outline">
                    <i class="fas fa-file-upload"></i> ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤
                </button>
                <button onclick="clearData()" class="btn-danger">
                    <i class="fas fa-trash-alt"></i> ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πà‡∏≤‡∏á -->
            <div class="grid-bottom">
                <button onclick="saveSettings()" class="btn-primary">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
                <button onclick="closeSettings()" class="btn-secondary">
                    ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
                </button>
            </div>
        </div>
    </div>
</div>
<!-- REPORT MODAL -->
<div id="reportModal" class="modal">
    <div class="modal-box">
        <div class="modal-header">
            <h3 id="reportTitle">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
            <button class="modal-close" onclick="closeReportModal()">‚úï</button>
        </div>
        <div id="reportContent" class="modal-body scroll-y"></div>
    </div>
</div>
<!-- HISTORY MODAL -->
<div id="historyModal" class="modal">
    <div class="modal-box">
        <div class="modal-header">
            <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô</h3>
            <button class="modal-close" onclick="closeHistoryModal()">‚úï</button>
        </div>
        <div id="accHistory" class="modal-body scroll-y"></div>
    </div>
</div>
<!-- LINE PREVIEW -->
<div id="linePreview" class="modal">
    <div class="modal-box small">
        <div class="modal-header">
            <h3>üìù ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
        </div>
        <div class="modal-body">
            <textarea id="msgEdit" class="textarea-main"></textarea>
            <div class="grid-2 mt-15">
                <button class="btn-secondary"
                        onclick="closeLinePreview()">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button class="btn-line"
                        onclick="sendToLineFinal()">
                    ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ LINE ‚úÖ
                </button>
            </div>
        </div>
    </div>
</div>
<!-- NAVIGATION -->
<nav class="bottom-nav">
    <div onclick="go(1)" class="nav-item active">
        <i class="fas fa-edit"></i>
        <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
    </div>
    <div onclick="go(2)" class="nav-item">
        <i class="fas fa-history"></i>
        <span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span>
    </div>
    <div onclick="go(3)" class="nav-item">
        <i class="fas fa-wallet"></i>
        <span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span>
    </div>
</nav>
 <script>
// =====================================================
// 1Ô∏è‚É£ GLOBAL STATE / LOCAL STORAGE
// =====================================================
const $ = (id) => document.getElementById(id);

let db = JSON.parse(localStorage.getItem("barber_db")) || [];
let archives = JSON.parse(localStorage.getItem("barber_archives")) || [];
let account = JSON.parse(localStorage.getItem("barber_account")) || { balance: 0, logs: [] };
let conf = JSON.parse(localStorage.getItem("barber_conf")) || { shop: "Barber Shop", perc: 50, guar: 0 };

let payMethod = "";
// =====================================================
// 2Ô∏è‚É£ CORE SYSTEM (‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á)
// =====================================================
function save() {
    try {
        localStorage.setItem("barber_db", JSON.stringify(db || []));
        localStorage.setItem("barber_archives", JSON.stringify(archives || []));
        localStorage.setItem("barber_account", JSON.stringify(account || {}));
        localStorage.setItem("barber_conf", JSON.stringify(conf || {}));
    } 
    catch (err) {
        console.error("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
}
window.addEventListener("load", function () {
    const today = new Date().toLocaleDateString("sv-SE");

    if ($("dateInp")) $("dateInp").value = today;
    if ($("accDate")) $("accDate").value = today;
    if ($("histDate")) $("histDate").value = today;

    if (conf?.shop && $("shopNameDisp")) {
        $("shopNameDisp").innerText = conf.shop;
    }
    if (conf?.theme) {
        applyTheme(conf.theme);
    } else {
        applyTheme("light");
    }
    renderDay(today);
    loadAccountStatus();

});
function addRecord() {
    if (!Array.isArray(db)) db = [];

    const dInp = $("dateInp")?.value;
    const timeInp = $("timeInp")?.value;

    if (!dInp || !timeInp) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤");
        return;
    }
    const price = Number($("priceInp")?.value) || 0;
    const tip = Number($("tipInp")?.value) || 0;
    const total = price + tip;

    const currentPay = payMethod;
    if (price === 0 && currentPay !== "Holiday" && currentPay !== "Guarantee") {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
        return;
    }
    let finalCash = 0;
    let finalTrans = 0;

    if (currentPay === "Mix") {
        finalCash = Number($("mixCash")?.value) || 0;
        finalTrans = Number($("mixTrans")?.value) || 0;

        if (finalCash + finalTrans !== total) {
            alert("‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î + ‡πÇ‡∏≠‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°");
            return;
        }
    } 
    else if (currentPay === "Cash" || currentPay === "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î") {
        finalCash = total;
    } 
    else if (currentPay === "Trans" || currentPay === "‡πÇ‡∏≠‡∏ô") {
        finalTrans = total;
    }
    const newRec = {
        id: Date.now(),
        date: dInp,
        time: timeInp,
        price,
        tip,
        pay: currentPay,
        svcs: Array.isArray(selectedServices) ? [...selectedServices] : [],
        payCash: finalCash,
        payTrans: finalTrans
    };
    db.push(newRec);
    saveDB();
    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    if (typeof resetForm === "function") resetForm();
    renderDay(dInp);
}
function delRec(id) {
    if (!Array.isArray(db)) return;
    const record = db.find(r => r.id === id);
    if (!record) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö");
        return;
    }
    const isConfirm = confirm("‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");
    if (!isConfirm) return;

    db = db.filter(r => r.id !== id);
    saveDB();
    renderDay(record.date);
}
function editTime(id) {
    const rec = (db || []).find(r => r.id === id);
    if (!rec) return;

    const newStart = prompt("‡πÅ‡∏Å‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° (HH:MM)", rec.time);
    if (!newStart) return;

    const cleanStart = newStart.trim();
    if (!isValidTime(cleanStart)) {
        alert("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 09:30)");
        return;
    }
    const newEnd = prompt("‡πÅ‡∏Å‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à (HH:MM)", rec.endTime || "");
    let cleanEnd = newEnd ? newEnd.trim() : "";
    if (cleanEnd && !isValidTime(cleanEnd)) {
        alert("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        return;
    }
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à ‚Üí ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì +30 ‡∏ô‡∏≤‡∏ó‡∏µ
    if (!cleanEnd) {
        try {
            cleanEnd = addMinutes(cleanStart, 30);
        } catch {
            cleanEnd = cleanStart;
        }
    }
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°
    if (timeToMinutes(cleanEnd) < timeToMinutes(cleanStart)) {
        alert("‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°");
        return;
    }
    rec.time = cleanStart;
    rec.endTime = cleanEnd;

    saveDB();
    renderDay(rec.date); // render ‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
}

function editDailyData() {
    const targetDate = $("accDate")?.value;
    if (!targetDate) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");
        return;
    }

    if (!Array.isArray(archives)) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á");
        return;
    }
    const archivedDay = archives.find(a => a.date === targetDate);
    if (!archivedDay || !Array.isArray(archivedDay.details)) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");
        return;
    }
    const isConfirm = confirm(
        `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${targetDate} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n` +
        "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà"
    );
    if (!isConfirm) return;
    try {
        // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å db ‡∏Å‡πà‡∏≠‡∏ô
        db = (db || []).filter(r => r.date !== targetDate);
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å archive ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ db
        const restored = JSON.parse(JSON.stringify(archivedDay.details));
        db = db.concat(restored);

        saveDB();
        renderDay(targetDate);
        alert(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${targetDate} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ`);

    } 
    catch (err) {
        console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
}

function confirmDeleteDaily(dateStr) {
    if (!dateStr) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö");
        return;
    }
    const isConfirm = confirm(
        `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n\n` +
        `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n` +
        `(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ)`
    );
    if (!isConfirm) return;
    try {
        if (!Array.isArray(archives)) {
            console.warn("archives ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            return;
        }
        const beforeCount = archives.length;
        archives = archives.filter(r => r.date !== dateStr);
        if (archives.length === beforeCount) {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ");
            return;
        }
        saveData(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
        alert(`‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);

        if (typeof closeReportModal === "function") {
            closeReportModal();
        }
        if (typeof renderHistory === "function") {
            renderHistory();
        }

    } 
    catch (err) {
        console.error("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
}

function clearDailyData() {
    const dateInp = $("dateInp")?.value 
        || new Date().toLocaleDateString("sv-SE");
    const confirmDelete = confirm(
        `‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateInp} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ`
    );
    if (!confirmDelete) return;
    try {
        // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö
        db = (db || []).filter(r => r.date !== dateInp);
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà
        localStorage.setItem("barber_db", JSON.stringify(db));

        alert("‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        renderDay(dateInp);
    }
    catch (err) {
        console.error("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
}

function clearAllData() {
    if (!confirm("‚ö†Ô∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
    try {
        localStorage.removeItem("barber_db");
        localStorage.removeItem("barber_conf");
        localStorage.removeItem("barber_archives");

        alert("‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        location.reload();
    } 
    catch (err) {
        console.error("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
}

function clearData() {
    const confirmDelete = confirm(
        "‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
    );
    if (!confirmDelete) return;
    try {
        // ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ
        localStorage.removeItem("barber_db");
        localStorage.removeItem("barber_conf");
        localStorage.removeItem("barber_archives"); // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ

        alert("‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        location.reload();
    }
    catch (err) {
        console.error("‚ùå ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
}

function saveDB() {
    try {
        if (!Array.isArray(db)) {
            console.warn("db is not an array");
            return;
        }
        localStorage.setItem("barber_db", JSON.stringify(db));
        localStorage.setItem("barber_conf", JSON.stringify(conf || {}));

        console.log("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    } 
    catch (err) {
        console.error("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);

        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Storage ‡∏≠‡∏≤‡∏à‡πÄ‡∏ï‡πá‡∏°)");
    }
}
// =====================================================
// 3Ô∏è‚É£ INITIAL LOAD / RENDER SYSTEM
// =====================================================
function renderDay(selectedDate) {
    // =============================
    // 1Ô∏è‚É£ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Local Safe)
    // =============================
    const inputEl = $("dateInp");
    const today = new Date().toLocaleDateString("sv-SE");
    const dInp = selectedDate || inputEl?.value || today;

    if (inputEl) inputEl.value = dInp;

    // =============================
    // 2Ô∏è‚É£ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
    // =============================
    let records = (db || []).filter(r => r.date === dInp);

    if (records.length === 0 && Array.isArray(archives)) {
        const archived = archives.find(a => a.date === dInp);
        if (archived?.details) records = archived.details;
    }

    const isHoliday = records.some(r =>
        String(r.type || "").toUpperCase() === "HOLIDAY"
    );

    // =============================
    // 3Ô∏è‚É£ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    // =============================
    const extraSvcs = ["‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î", "‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤", "‡∏™‡∏£‡∏∞‡∏ú‡∏°"].map(s => s.toLowerCase());
    const stats = {};

    let tot = 0;
    let cash = 0;
    let trans = 0;
    let tips = 0;
    let realCustomerCount = 0;

    // =============================
    // 4Ô∏è‚É£ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    // =============================
    records
        .slice()
        .sort((a, b) => (a.time || "").localeCompare(b.time || ""))
        .forEach(r => {

            const price = Number(r.price) || 0;
            const tip = Number(r.tip) || 0;
            const type = String(r.type || "").toUpperCase();
            const svcs = Array.isArray(r.svcs) ? r.svcs : [];

            tot += price;
            tips += tip;

            // -------- Payment --------
            if (r.pay === "Mix") {
                const pCash = Number(r.payCash) || 0;
                const pTrans = Number(r.payTrans) || 0;

                trans += pTrans;
                cash += (pCash - tip); // ‡∏£‡πâ‡∏≤‡∏ô‡∏ñ‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏á‡∏≤‡∏ô
            }
            else if (r.pay === "Trans" || r.pay === "‡πÇ‡∏≠‡∏ô") {
                trans += (price + tip);
            }
            else {
                cash += price;
            }

            // -------- ‡∏ô‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --------
            if (!["HOLIDAY", "GUARANTEE"].includes(type) && price > 0) {

                if (svcs.length > 0) realCustomerCount++;

                const hasHaircut = svcs.some(s =>
                    !extraSvcs.includes(String(s).toLowerCase().trim())
                );

                if (hasHaircut) {
                    stats["‡∏ï‡∏±‡∏î‡∏ú‡∏°"] = (stats["‡∏ï‡∏±‡∏î‡∏ú‡∏°"] || 0) + 1;
                }

                svcs.forEach(s => {
                    if (!s) return;
                    stats[s] = (stats[s] || 0) + 1;
                });
            }
        });

    // =============================
    // 5Ô∏è‚É£ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
    // =============================
    const perc = Number(conf?.perc) || 0;
    const guar = Number(conf?.guar) || 0;

    const barberEarn = isHoliday
        ? 0
        : Math.max(tot * (perc / 100), guar) + tips;

    const shopEarn = isHoliday
        ? 0
        : tot - (barberEarn - tips);

    const settle = isHoliday
        ? 0
        : cash - barberEarn;
    // =============================
    // 6Ô∏è‚É£ ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    // =============================
    setText("dTotal", tot);
    setText("dCash", cash);
    setText("dTrans", trans);
    setText("dBarber", Math.floor(barberEarn));
    setText("dShop", Math.floor(shopEarn));
    // =============================
    // 7Ô∏è‚É£ ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    // =============================
    const countEl = $("dCounts");
    if (countEl) {
        if (isHoliday) {
            countEl.innerText = "üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î";
        }
        else if (records.length === 0) {
            countEl.innerText = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        }
        else if (tot === 0) {
            countEl.innerText = "üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ";
        }
        else {
            countEl.innerText = `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${realCustomerCount} ‡∏Ñ‡∏ô`;
        }
    }
    // =============================
    // 8Ô∏è‚É£ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Settlement
    // =============================
    updateSettleBar(settle, isHoliday, records.length, tot);
    // =============================
    // 9Ô∏è‚É£ ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    // =============================
    renderDailyList(records, dInp, isHoliday);
}
// =================================
// Helper Functions
// =================================
function setText(id, val) {
    const el = $(id);
    if (el) el.innerText = Number(val).toLocaleString();
}

function updateSettleBar(settle, isHoliday, recCount, tot) {
    const box = $("settleBarContainer");
    if (!box) return;

    let txt = "", color = "", icon = "";

    if (isHoliday) {
        txt = "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"; color = "#1e40af"; icon = "üèñÔ∏è";
    }
    else if (recCount === 0) {
        txt = "‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."; color = "#64748b"; icon = "üìù";
    }
    else if (tot === 0) {
        txt = "‡∏£‡πâ‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô"; color = "#0369a1"; icon = "üõ°Ô∏è";
    }
    else if (settle > 0) {
        txt = `‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${Math.floor(settle).toLocaleString()}`;
        color = "#b91c1c"; icon = "üë®‚Äçüé®";
    }
    else if (settle < 0) {
        txt = `‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ‡∏ø${Math.floor(Math.abs(settle)).toLocaleString()}`;
        color = "#4338ca"; icon = "üè†";
    }
    else {
        txt = "‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ"; color = "#15803d"; icon = "‚úÖ";
    }
    box.innerHTML = `
        <div style="flex:8;height:55px;background:#f1f5f9;
            display:flex;align-items:center;justify-content:center;
            border-radius:18px;font-weight:800;font-size:14px;
            color:${color};border:1px solid #e2e8f0;">
            <span style="margin-right:8px;font-size:18px;">${icon}</span>
            ${txt}
        </div>
    `;
}
     
function renderDailyList(records, dInp, isHoliday) {
    const dList = $("dailyList");
    if (!dList) return;

    const dateParts = dInp.split("-");
    const displayDateBE =
        dateParts.length === 3
            ? `${dateParts[2]}/${dateParts[1]}/${Number(dateParts[0]) + 543}`
            : dInp;
    let listHtml = records.map((r, i) => {
        const price = Number(r.price) || 0;
        const tip = Number(r.tip) || 0;
        const timeShow = r.endTime
            ? `${r.time}-${r.endTime}`
            : r.time;
        return `
        <div class="history-row">
            <b>${i + 1}. [${timeShow}] ${ (r.svcs || []).join(" + ") }</b>
            <div>
                ‡∏ø${price.toLocaleString()}
                ${tip ? `<span style="color:#be185d">(+${tip})</span>` : ""}
            </div>
        </div>`;
    }).join("");

    dList.innerHTML = `
        <div style="padding:10px;">
            <b>üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (${displayDateBE})</b>
        </div>
        <div>
            ${isHoliday
                ? `<center style="padding:30px;">üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</center>`
                : (listHtml || "<center style='padding:30px;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</center>")
            }
        </div>
    `;
}

function loadAccountStatus() {
    const now = new Date();
    // =========================
    // 1) ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÉ‡∏ä‡πâ Local Time ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤ ISO)
    // =========================
    const dateLabel = now.toLocaleDateString('th-TH', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
    const today = now.toLocaleDateString('sv-SE'); // YYYY-MM-DD (local time)

    if ($("accDateLabel")) {
        $("accDateLabel").innerText = dateLabel;
    }
    // =========================
    // 2) ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°
    // =========================
    const oldBalance = Number(account?.balance) || 0;

    if ($("accOldVal")) {
        $("accOldVal").innerText = formatMoney(oldBalance);
    }
    // =========================
    // 3) ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    // =========================
    const todayEntries = (db || []).filter(r =>
        r.date === today &&
        (r.type === "SERVICE" || r.type === "GUARANTEE")
    );

    let totalService = 0;
    let totalTips = 0;
    let totalCash = 0;

    todayEntries.forEach(r => {
        const price = Number(r.price) || 0;
        const tip = Number(r.tip) || 0;

        totalService += price;
        totalTips += tip;

        if (r.pay === "Cash") {
            totalCash += price + tip;
        }
    });
    // =========================
    // 4) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Settlement ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    // =========================
    let settleToday = 0;
    if (todayEntries.length > 0) {
        const perc = Number(conf?.perc) || 0;
        const guar = Number(conf?.guar) || 0;

        const commissionEarn = totalService * (perc / 100);
        const baseEarn = Math.max(commissionEarn, guar);

        const barberEarn = baseEarn + totalTips;
        // ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏ñ‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà - ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á
        settleToday = totalCash - barberEarn;
    }
    if ($("accTodayVal")) {
        $("accTodayVal").innerText = formatMoney(settleToday);
    }
    // =========================
    // 5) ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
    // =========================
    const net = oldBalance + settleToday;
    if ($("accTotalVal")) {
        $("accTotalVal").innerText = formatMoney(net);
    }
    // =========================
    // 6) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    // =========================
    updateStatusUI(net);
}
// =========================
// UI STATUS
// =========================
function updateStatusUI(net) {
    const badge = $("statusBadge");
    const light = $("accLight");

    let color, text, bg;

    if (net > 0) {
        color = "#dc2626";
        bg = "#fef2f2";
        text = "üë®‚Äçüé® ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô";
    } 
    else if (net < 0) {
        color = "#1e3a8a";
        bg = "#eff6ff";
        text = "üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á";
    } 
    else {
        color = "#16a34a";
        bg = "#f0fdf4";
        text = "‚öñÔ∏è ‡∏¢‡∏≠‡∏î‡∏•‡∏á‡∏ï‡∏±‡∏ß";
    }

    if (badge) {
        badge.innerText = text;
        badge.style.background = bg;
        badge.style.color = color;
    }
    if (light) {
        light.style.background = color;
        light.style.boxShadow = `0 0 12px ${color}`;
    }
}
// =========================
// Utility: Format ‡πÄ‡∏á‡∏¥‡∏ô
// =========================
function formatMoney(num) {
    return `‡∏ø${Number(num).toLocaleString()}`;
}
  
function loadAccountHistory() {
    const container = $("accHistory");
    if (!container) return;

    const logs = account.logs || [];

    if (logs.length === 0) {
        container.innerHTML = `
            <div style="padding:40px; text-align:center; color:#94a3b8;">
                ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå
            </div>
        `;
        return;
    }

    const html = logs.map(log => {
        const isPositive = log.amount >= 0;
        const amountColor = isPositive ? "#16a34a" : "#dc2626";
        const sign = isPositive ? "+" : "";
        const formattedAmount = Math.abs(log.amount).toLocaleString();

        return `
            <div style="
                padding:15px;
                border-bottom:1px solid #f1f5f9;
                display:flex;
                justify-content:space-between;
                align-items:center;
            ">
                <div>
                    <b style="font-size:14px; color:#1e293b;">
                        ${log.date}
                    </b><br>
                    <small style="color:#64748b;">
                        ${log.note || "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á"}
                    </small>
                </div>

                <b style="color:${amountColor};">
                    ${sign}‡∏ø${formattedAmount}
                </b>
            </div>
        `;
    }).join("");

    container.innerHTML = html;
}

function renderHistoryList() {
    const container = $("accHistory");
    const logs = account.logs || [];

    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (logs.length === 0) {
        container.innerHTML = `
            <div style="padding:50px; text-align:center; color:#94a3b8; font-size:15px;">
                ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡∏£‡∏±‡∏ö
            </div>
        `;
        return;
    }
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    const sortedLogs = [...logs].reverse();
    const html = sortedLogs.map((log, index) => {
        const realIndex = logs.length - 1 - index;
        const isPositive = log.amount >= 0;
        const amountColor = isPositive ? "#16a34a" : "#dc2626";
        const formattedAmount = Math.abs(log.amount).toLocaleString();

        return `
            <div style="
                padding:20px 15px;
                margin-bottom:10px;
                background:#ffffff;
                border:1px solid #e2e8f0;
                border-radius:15px;
                box-shadow:0 2px 5px rgba(0,0,0,0.05);
                display:flex;
                justify-content:space-between;
                align-items:center;
            ">
                <div style="flex:1;">
                    <b style="display:block; font-size:17px; color:#0f172a; margin-bottom:5px;">
                        üìÖ ${log.date}
                    </b>
                    <span style="font-size:15px; color:#475569; font-weight:500;">
                        üìå ${log.note || "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á"}
                    </span>
                </div>

                <div style="text-align:right; min-width:120px;">
                    <b style="
                        display:block;
                        font-size:20px;
                        margin-bottom:10px;
                        color:${amountColor};
                    ">
                        ‡∏ø${formattedAmount}
                    </b>

                    <button 
                        onclick="editAccountLog(${realIndex})"
                        style="
                            width:100%;
                            padding:10px 20px;
                            font-size:14px;
                            font-weight:800;
                            cursor:pointer;
                            border-radius:10px;
                            border:1px solid #fcd34d;
                            background:#fef3c7;
                            color:#92400e;
                        "
                    >
                        <i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                </div>
            </div>
        `;
    }).join("");

    container.innerHTML = html;
}

function loadHistDaily() {
    if (typeof archives === "undefined") {
        return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å");
    }
    const d = $("histDate")?.value;
    if (!d) return;
    const f = archives.find(a => a.date === d);
    if (!f) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ");
    const cashTotal = Number(f.cash) || 0;
    const transTotal = Number(f.trans) || 0;
    const totalRevenue = cashTotal + transTotal;
    const barberEarn = Math.floor(Number(f.barber) || 0);
    const shopEarn = Math.floor(Number(f.shop) || 0);
    const settle = Number(f.settle) || 0;
    // ‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ SERVICE ‡∏à‡∏£‡∏¥‡∏á
    const serviceDetails = (f.details || []).filter(r => r.type === "SERVICE");
    const customerCount = f.count || serviceDetails.length;

    // --------- ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô ----------
    const svcCounts = {};
    serviceDetails.forEach(r => {
        const services = Array.isArray(r.svcs) ? r.svcs : [r.svcs];
        services.forEach(s => {
            if (s) svcCounts[s] = (svcCounts[s] || 0) + 1;
        });
    });
    const svcHTML = Object.keys(svcCounts).length > 0
        ? Object.entries(svcCounts).map(([name, count]) => `
            <div style="background:rgba(203,213,225,0.1); padding:6px 12px; border-radius:10px; font-size:12px; color:#cbd5e1; font-weight:600; display:inline-block; margin:3px; border:1px solid rgba(255,255,255,0.1);">
                ${name} <span style="opacity:0.7; margin-left:4px;">x${count}</span>
            </div>
        `).join("")
        : `<div style="color:#64748b;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>`;

    // --------- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ----------
    let settleHTML = "";
    if (settle > 0) {
        settleHTML = `
        <div style="background:rgba(251,146,60,0.1); padding:16px; border-radius:16px; margin-bottom:20px; text-align:center; border:1px solid rgba(251,146,60,0.3);">
            <div style="font-size:16px; color:#fdba74; font-weight:600;">üë®‚Äçüé® ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô</div>
            <div style="font-size:24px; color:#fb923c; font-weight:800;">‡∏ø${settle.toLocaleString()}</div>
        </div>`;
    } else if (settle < 0) {
        settleHTML = `
        <div style="background:rgba(56,189,248,0.1); padding:16px; border-radius:16px; margin-bottom:20px; text-align:center; border:1px solid rgba(56,189,248,0.3);">
            <div style="font-size:16px; color:#7dd3fc; font-weight:600;">üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á</div>
            <div style="font-size:24px; color:#38bdf8; font-weight:800;">‡∏ø${Math.abs(settle).toLocaleString()}</div>
        </div>`;
    }
    // --------- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô ----------
    const rows = serviceDetails
        .slice()
        .sort((a, b) => (a.time || "").localeCompare(b.time || ""))
        .map((r, index) => {
            const p = Number(r.price) || 0;
            const t = Number(r.tip) || 0;
            const fullTime = r.time && r.endTime
                ? `${r.time}-${r.endTime}`
                : (r.time || "--:--");
            let payText = "";
            if (r.pay === "Mix") {
                payText = `üåì ‡∏ú‡∏™‡∏° (‡∏™‡∏î:${r.payCash || 0}/‡πÇ‡∏≠‡∏ô:${r.payTrans || 0})`;
            } else {
                payText = r.pay === "Trans" ? "üì± ‡πÇ‡∏≠‡∏ô" : "üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î";
            }
            return `
            <div style="padding:14px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:16px; margin-bottom:10px; display:flex; justify-content:space-between;">
                <div>
                    <div style="font-weight:700; font-size:14px; color:#f8fafc;">
                        ${index + 1}. ${Array.isArray(r.svcs) ? r.svcs.join(" + ") : r.svcs}
                    </div>
                    <div style="font-size:13px; color:#94a3b8;">
                        ‚è± ${fullTime} ‚Ä¢ ${payText}
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:16px; font-weight:800; color:#f8fafc;">
                        ‡∏ø${p.toLocaleString()}
                    </div>
                    ${t > 0 ? `<div style="font-size:12px; color:#f472b6;">+ Tip ‡∏ø${t.toLocaleString()}</div>` : ""}
                </div>
            </div>`;
        }).join("");

    // --------- ‡πÄ‡∏õ‡∏¥‡∏î Modal ----------
    openReportModal(`‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ${d}`, `
        <div style="background:#0f172a; padding:24px; color:#f1f5f9; border-radius:20px;">
            <div style="text-align:center; margin-bottom:25px;">
                <div style="font-size:14px; color:#94a3b8;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</div>
                <div style="font-size:44px; font-weight:900;">‡∏ø${totalRevenue.toLocaleString()}</div>
            </div>

            <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:20px;">
                <div style="background:#14532d; padding:10px; border-radius:12px; text-align:center;">üíµ ‡∏ø${cashTotal.toLocaleString()}</div>
                <div style="background:#1e3a8a; padding:10px; border-radius:12px; text-align:center;">üì± ‡∏ø${transTotal.toLocaleString()}</div>
                <div style="background:#78350f; padding:10px; border-radius:12px; text-align:center;">üë• ${customerCount}</div>
            </div>

            ${settleHTML}

            <div style="margin-bottom:20px;">
                <div style="font-weight:700; margin-bottom:8px;">‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</div>
                ${svcHTML}
            </div>

            <div style="font-weight:700; margin-bottom:10px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</div>
            <div style="max-height:400px; overflow-y:auto;">
                ${rows || `<div style="color:#64748b;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>`}
            </div>
        </div>
    `);
}

function loadHistMonth() {
    const $ = (id) => document.getElementById(id);
    const m = $("histMonth").value;
    if (!m) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

    if (typeof archives === "undefined") {
        return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (archives)");
    }
    const filtered = archives.filter(a => a.date && a.date.startsWith(m));
    if (!filtered.length) {
        return openReportModal(
            "üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô",
            "<div style='text-align:center;padding:50px;color:#94a3b8;'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>"
        );
    }

    let monthTotal = 0;
    let monthBarber = 0;
    let monthCount = 0;
    let workDays = 0;
    let offDays = 0;

    let hairStats = {};
    let serviceStats = {};
    let weeklyData = {};

    const haircutList = ["‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô","‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î","‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á","‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á","‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£","‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡πÅ‡∏Å‡πâ‡∏ú‡∏°","‡πÇ‡∏Å‡∏ô‡∏ú‡∏°","‡πÄ‡∏î‡πá‡∏Å"];
    const dayNames = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå"];

    filtered.forEach(day => {

        const dObj = new Date(day.date);

        // ‚úÖ ‡πÅ‡∏ö‡πà‡∏á‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ï‡∏≤‡∏°‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á
        const firstDay = new Date(dObj.getFullYear(), dObj.getMonth(), 1).getDay();
        const wIdx = Math.ceil((dObj.getDate() + firstDay) / 7);
        const wKey = `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà ${wIdx}`;

        if (!weeklyData[wKey]) {
            weeklyData[wKey] = {
                customers: 0,
                workDays: 0,
                offDays: 0,
                income: 0,
                dailyCounts: [],
                popularHair: {},
                popularService: {}
            };
        }

        // ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
        if (day.off === true || day.type === "HOLIDAY") {
            offDays++;
            weeklyData[wKey].offDays++;
            return;
        }
        workDays++;
        weeklyData[wKey].workDays++;
        
        const dailyIncome = Number(day.total) || 0;
        const barberIncome = Number(day.barber) || 0;
        
        monthTotal += dailyIncome;
        monthBarber += barberIncome;
        weeklyData[wKey].income += dailyIncome;
        
        let dayCustomerCount = 0;
        if (Array.isArray(day.details)) {
            day.details.forEach(d => {
                if (d.type === "SERVICE") {
                    const svcs = Array.isArray(d.svcs) ? d.svcs : [d.svcs];
                    let isHaircut = false;
                    svcs.forEach(s => {
                        if (!s) return;
                        const clean = s.trim();
                        if (haircutList.includes(clean)) {
                            hairStats[clean] = (hairStats[clean] || 0) + 1;
                            weeklyData[wKey].popularHair[clean] =
                                (weeklyData[wKey].popularHair[clean] || 0) + 1;
                            isHaircut = true;
                        } else {
                            serviceStats[clean] = (serviceStats[clean] || 0) + 1;
                            weeklyData[wKey].popularService[clean] =
                                (weeklyData[wKey].popularService[clean] || 0) + 1;
                        }
                    });

                    if (isHaircut) {
                        monthCount++;
                        dayCustomerCount++;
                        weeklyData[wKey].customers++;
                    }
                }
            });
        }

        // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö date ‡∏î‡πâ‡∏ß‡∏¢ (‡πÅ‡∏Å‡πâ Insight ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)
        weeklyData[wKey].dailyCounts.push({
            date: day.date,
            dayName: dayNames[dObj.getDay()],
            count: dayCustomerCount,
            income: dailyIncome
        });
    });
    const avgCustomerPerDay = workDays > 0 ? (monthCount / workDays) : 0;
    generateMonthlyReport(
        m,
        monthTotal,
        monthBarber,
        monthCount,
        workDays,
        offDays,
        avgCustomerPerDay,
        weeklyData,
        hairStats,
        serviceStats
    );
}
// =====================================================
// 4Ô∏è‚É£ FORM & INPUT CONTROL
// =====================================================
function handleSave(event) {
    const dateVal = $("dateInp")?.value;
    const price = parseFloat($("priceInp")?.value) || 0;
    const tip = parseFloat($("tipInp")?.value) || 0;
    if (!dateVal) {
        return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô!");
    }
    if (price <= 0) {
        return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");
    }
    if (!payMethod) {
        return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô!");
    }
    const start = $("tStart")?.value || new Date().toTimeString().slice(0, 5);
    const end = $("tEnd")?.value || (typeof addMinutes === 'function' ? addMinutes(start, 30) : start);

    let cashAmt = 0;
    let transAmt = 0;
    const totalBill = price + tip;
    // --------- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô ----------
    if (payMethod === 'Mix') {

        cashAmt = parseFloat($("mixCash")?.value) || 0;
        transAmt = parseFloat($("mixTrans")?.value) || 0;

        if (cashAmt < 0 || transAmt < 0) {
            return alert("‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö");
        }
        if ((cashAmt + transAmt) !== totalBill) {
            const confirmMsg = 
                `‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ö‡∏¥‡∏•\n` +
                `‡∏£‡∏ß‡∏°‡∏£‡∏±‡∏ö: ${cashAmt + transAmt}\n` +
                `‡∏¢‡∏≠‡∏î‡∏ö‡∏¥‡∏•: ${totalBill}\n\n` +
                `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`;

            if (!confirm(confirmMsg)) return;
        }

    } else {
        if (payMethod === 'Cash') {
            cashAmt = totalBill;
        } else {
            transAmt = totalBill;
        }
    }
    // --------- ‡∏™‡∏£‡πâ‡∏≤‡∏á record ----------
    const rec = {
        id: Date.now(),
        date: dateVal,
        time: start,
        endTime: end,
        svcs: [
            $("hairStyle")?.value,
            $("extra1")?.value,
            $("extra2")?.value
        ].filter(Boolean),
        price: price,
        tip: tip,
        pay: payMethod,
        payCash: cashAmt,
        payTrans: transAmt,
        type: "SERVICE"
    };
    db.push(rec);
    if (typeof saveDB === "function") saveDB();
    if (typeof renderDay === "function") renderDay(dateVal);
    if (typeof loadAccountStatus === "function") loadAccountStatus();

    // --------- ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ----------
    const btnSave = event?.currentTarget;
    if (btnSave) {
        const oldHTML = btnSave.innerHTML;
        btnSave.style.background = "linear-gradient(135deg, #10b981, #059669)";
        btnSave.innerHTML = `
            <i class="fas fa-check-circle" style="font-size:32px;"></i>
            <span style="font-size:26px; font-weight:900;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
        `;
        setTimeout(() => {
            btnSave.removeAttribute("style");
            btnSave.innerHTML = oldHTML;
        }, 1200);
    }
    // --------- Reset ‡∏ü‡∏≠‡∏£‡πå‡∏° ----------
    ["priceInp", "tipInp", "mixCash", "mixTrans"].forEach(id => {
        if ($(id)) $(id).value = "";
    });
    payMethod = "";
    ["btnCash", "btnTrans", "btnMix"].forEach(id => {
        const el = $(id);
        if (el) el.className = "btn btn-pay";
    });
    if ($("mixPanel")) $("mixPanel").style.display = "none";
}

function handleInsurance() {
    const d = $("dateInp")?.value || new Date().toISOString().split('T')[0];
    const g = parseInt(conf?.guar) || 0;

    const speakTH = (text) => {
        try {
            if ('speechSynthesis' in window) {
                const msg = new SpeechSynthesisUtterance(text);
                msg.lang = 'th-TH';
                window.speechSynthesis.speak(msg);
            }
        } catch(e) {}
    };
    // üîí 1. ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    if (g <= 0) {
        speakTH("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô");
        return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÉ‡∏ô '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö' ‡∏Å‡πà‡∏≠‡∏ô");
    }
    // üèñÔ∏è 2. ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô
    const isHoliday = db.some(r => r.date === d && r.type === "HOLIDAY");
    if (isHoliday) {
        speakTH("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î");
        return alert("üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ");
    }
    // üõ°Ô∏è 3. ‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡πâ‡∏≥
    const alreadyOpened = db.some(r => r.date === d && r.type === "GUARANTEE_CLAIM");
    if (alreadyOpened) {
        speakTH("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
        return alert("üõ°Ô∏è ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
    }
    // ‚úÖ 4. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    if (!confirm(`üõ°Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ${g} ‡∏ö‡∏≤‡∏ó" ?`)) return;
    db.push({
        id: Date.now(),
        date: d,
        time: "00:00",
        svcs: ["üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô"],
        price: 0,
        tip: 0,
        pay: "N/A",
        type: "GUARANTEE_CLAIM",
        isGuarantee: true
    });
    if (typeof saveDB === "function") saveDB();
    speakTH(`‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô ${g} ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    alert("‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");

    if (typeof renderDay === "function") {
        renderDay(d);
    }
}

function handleHoliday() {
    const d = $("dateInp")?.value;
    if (!d) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");
    // üîç ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const hasData = db.some(r => r.date === d && r.type !== "HOLIDAY");
    const hasHoliday = db.some(r => r.date === d && r.type === "HOLIDAY");

    if (hasHoliday) {
        return alert("‚ö†Ô∏è ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß");
    }
    if (hasData) {
        if (!confirm("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
            return;
        }
        // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
        db = db.filter(r => r.date !== d);
    }
    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d} ‡πÄ‡∏õ‡πá‡∏ô "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"?`)) return;
    db.push({
        id: Date.now(),
        date: d,
        time: "00:00",
        svcs: ["üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"],
        price: 0,
        tip: 0,
        pay: "N/A",
        type: "HOLIDAY",
        off: true
    });
    if (typeof saveDB === "function") saveDB();
    // üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î
    try {
        const msg = new SpeechSynthesisUtterance("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        msg.lang = "th-TH";
        window.speechSynthesis.speak(msg);
    } catch(e) {}
    alert("üèñÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    if (typeof renderDay === "function") {
        renderDay(d);
    }
}

function saveAndGo(date, total) {
    const allToday = db.filter(r => r.date === date);
    const todayData = allToday.filter(r =>
        r.type === "SERVICE" || r.type === "GUARANTEE"
    );
    const isHoliday = allToday.some(r => r.type === "HOLIDAY");
    let cash = 0,
        trans = 0,
        tips = 0,
        count = 0,
        stats = {};
    const extraSvcs = ["‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î", "‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤", "‡∏™‡∏£‡∏∞‡∏ú‡∏°"];
    todayData.forEach(r => {
        const p = Number(r.price) || 0;
        const t = Number(r.tip) || 0;
        tips += t;

        // üí≥ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Cash / Trans / Mix
        if (r.pay === "Cash") {
            cash += p;
        } else if (r.pay === "Trans") {
            trans += p + t;
        } else if (r.pay === "Mix") {
            cash += Number(r.mixCash) || 0;
            trans += Number(r.mixTrans) || 0;
        }
        const svcs = Array.isArray(r.svcs) ? r.svcs : [r.svcs];
        if (r.type !== "GUARANTEE") {
            const isRealCut = svcs.some(
                s => s && !extraSvcs.includes(s)
            );
            if (isRealCut) count++;
            svcs.forEach(s => {
                if (s) stats[s] = (stats[s] || 0) + 1;
            });
        }
    });

    // üí∞ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
    const bEarn = isHoliday
        ? 0
        : Math.max(total * (conf.perc / 100), conf.guar) + tips;
    const settle = isHoliday ? 0 : cash - bEarn;
    const idx = archives.findIndex(a => a.date === date);
    const data = {
        date,
        total: Number(total),
        cash,
        trans,
        tips,
        barber: Math.floor(bEarn),
        shop: isHoliday ? 0 : total - (bEarn - tips),
        settle,
        count,
        stats,
        details: allToday,
        off: isHoliday,
        type: isHoliday ? "HOLIDAY" : "WORK"
    };
    // üîÑ ‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏° (Balance)
    if (idx > -1) {
        const oldSettle = archives[idx].settle || 0;
        account.balance =
            (Number(account.balance) || 0) + (settle - oldSettle);
        archives[idx] = data;
    } else {
        account.balance =
            (Number(account.balance) || 0) + settle;
        archives.push(data);
    }
    // üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
    db = db.filter(r => r.date !== date);

    save();

    if (typeof loadAccountStatus === "function") {
        loadAccountStatus();
    }
    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
    go(3);
}

function setPaymentType(m) {
    const $ = (id) => document.getElementById(id);

    if (typeof payMethod === "undefined") {
        window.payMethod = "";
    }
    // üîÅ ‡∏Å‡∏î‡∏ã‡πâ‡∏≥ = ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    if (payMethod === m) {
        payMethod = "";

        ["btnCash", "btnTrans", "btnMix"].forEach(id => {
            const el = $(id);
            if (el) {
                el.classList.remove("active-cash", "active-trans", "active-mix", "is-inactive");
            }
        });

        $("mixPanel")?.style && ($("mixPanel").style.display = "none");
        return;
    }

    payMethod = m;

    const btnConfig = {
        Cash: { id: "btnCash", active: "active-cash" },
        Trans: { id: "btnTrans", active: "active-trans" },
        Mix: { id: "btnMix", active: "active-mix" }
    };
    Object.keys(btnConfig).forEach(key => {
        const btn = $(btnConfig[key].id);
        if (!btn) return;

        btn.classList.remove("active-cash", "active-trans", "active-mix", "is-inactive");
        if (key === m) {
            btn.classList.add(btnConfig[key].active);
        } else {
            btn.classList.add("is-inactive");
        }
    });
    // üí≥ Mix Panel
    const mixPanel = $("mixPanel");
    if (!mixPanel) return;

    if (m === "Mix") {
        mixPanel.style.display = "block";

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
        if ($("mixCash")) $("mixCash").value = "";
        if (typeof updateMixValues === "function") {
            updateMixValues();
        }
    } else {
        mixPanel.style.display = "none";
    }
}

function togglePayType() {
    const $ = (id) => document.getElementById(id);

    const payType = $("payTypeInp")?.value;
    const panel = $("mixPanel");

    if (!panel) return;

    if (payType === "Mix") {
        panel.style.display = "block";

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        $("mixCash").value = "";
        updateMixValues(); // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡πà‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å
    } else {
        panel.style.display = "none";
    }
}

function updateMixValues() {
    const $ = (id) => document.getElementById(id);
    const price = parseFloat($("priceInp")?.value.replace(/,/g, "")) || 0;
    const tip   = parseFloat($("tipInp")?.value.replace(/,/g, "")) || 0;
    const total = price + tip;

    let cash = parseFloat($("mixCash")?.value.replace(/,/g, "")) || 0;
    // ‚ùó ‡∏ñ‡πâ‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏Å‡∏¥‡∏ô‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ‡πÉ‡∏´‡πâ‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
    if (cash > total) {
        cash = total;
        $("mixCash").value = total.toFixed(2);
    }
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô
    let trans = total - cash;
    // ‚ùó ‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏•‡∏ö
    if (trans < 0) trans = 0;
    if ($("mixTrans")) {
        $("mixTrans").value = trans.toFixed(2);
    }
}

function resetForm() {
    const $ = (id) => document.getElementById(id);
    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏á‡∏¥‡∏ô
    if ($("priceInp")) $("priceInp").value = "";
    if ($("tipInp")) $("tipInp").value = "";
    if ($("mixCash")) $("mixCash").value = "";
    if ($("mixTrans")) $("mixTrans").value = "";
    // ‡∏ã‡πà‡∏≠‡∏ô panel ‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡∏™‡∏°
    if ($("mixPanel")) $("mixPanel").style.display = "none";
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    if (typeof selectedServices !== "undefined") {
        selectedServices = [];
    }
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï checkbox ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï radio button (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    document.querySelectorAll('input[type="radio"]').forEach(rb => {
        rb.checked = false;
    });
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ element ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    if ($("selectedList")) $("selectedList").innerHTML = "";
    // ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤
    if ($("priceInp")) $("priceInp").focus();
}

// =====================================================
// 5Ô∏è‚É£ ACCOUNT SYSTEM
// =====================================================
function toggleAccHistory() {
    const $ = (id) => document.getElementById(id);

    const wrapper = $("accHistoryWrapper");
    const container = $("accHistory");

    if (!wrapper || !container) return;
    const isHidden = wrapper.style.display === "none" || wrapper.style.display === "";
    wrapper.style.display = isHidden ? "block" : "none";
    // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á render ‡πÉ‡∏´‡∏°‡πà
    if (!isHidden) return;

    if (!account || !Array.isArray(account.logs) || account.logs.length === 0) {
        container.innerHTML = "<div style='padding:10px;color:#94a3b8;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>";
        return;
    }
    container.innerHTML = account.logs.map((l, i) => {
        const isNegative = l.amount < 0;
        const color = isNegative ? "#ef4444" : "#22c55e";
        const sign = isNegative ? "-" : "+";

        return `
        <div style="padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.08); display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div style="font-size:12px; color:#94a3b8;">${l.date}</div>
                <div style="font-size:13px; color:#f1f5f9;">${escapeHTML(l.note || "-")}</div>
            </div>
            <div style="font-weight:700; color:${color};">
                ${sign}‡∏ø${Math.abs(l.amount).toLocaleString()}
            </div>
        </div>
        `;
    }).join("");
}
// ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô HTML injection
function escapeHTML(str) {
    return str.replace(/[&<>"']/g, function(m) {
        return ({
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#039;"
        })[m];
    });
}
    
function editAccountLog(index) {
    const $ = (id) => document.getElementById(id);

    if (!account || !Array.isArray(account.logs)) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ");
        return;
    }
    const log = account.logs[index];
    if (!log) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç");
        return;
    }
    // üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
    const newNote = prompt("üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:", log.note || "");
    if (newNote === null) return; // ‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    // üí∞ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
    const newAmountInput = prompt("üí∞ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:", Math.abs(log.amount).toLocaleString());
    if (newAmountInput === null) return; // ‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å

    const cleanValue = newAmountInput.replace(/,/g, "").trim();
    const val = parseFloat(cleanValue);

    if (isNaN(val) || val < 0) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        return;
    }
    // ‚úÖ ‡∏Ñ‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ
    const isNegative = log.amount < 0;
    account.logs[index] = {
        ...log,
        note: newNote.trim(),
        amount: isNegative ? -val : val,
        updatedAt: new Date().toISOString()
    };

    if (typeof save === "function") save();
    alert("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");

    if (typeof renderHistoryList === "function") renderHistoryList();
    if (typeof loadAccountStatus === "function") loadAccountStatus();
}

function clearAccount() {
    const $ = (id) => document.getElementById(id);

    if (typeof account === "undefined") {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ");
        return;
    }
    const d = $("accDate")?.value || new Date().toISOString().split("T")[0];
    const net = Number(account.balance) || 0;
    // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
    if (net === 0) {
        alert("üíé ‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå");
        return;
    }
    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    const confirmMsg = net > 0
        ? `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏≤‡∏á "‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" ‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${net.toLocaleString()} ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`
        : `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≤‡∏ô "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô" ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≤‡∏á ‡∏ø${Math.abs(net).toLocaleString()} ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`;

    if (!confirm(confirmMsg)) return;

    // ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô logs ‡πÄ‡∏õ‡πá‡∏ô undefined
    if (!Array.isArray(account.logs)) {
        account.logs = [];
    }
    // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log (‡πÉ‡∏ä‡πâ type ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)
    account.logs.unshift({
        date: d,
        amount: net,
        type: net > 0 ? "RETURN_TO_SHOP" : "PAY_TO_BARBER",
        note: $("accNote")?.value?.trim() || "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á"
    });
    // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏¢‡∏≠‡∏î
    account.balance = 0;
    // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (typeof save === "function") {
        save();
    }
    // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á note
    if ($("accNote")) {
        $("accNote").value = "";
    }
    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà
    if (typeof lo

// =====================================================
// 6Ô∏è‚É£ REPORT SYSTEM
// =====================================================
function generateMonthlyReport(
    m,
    monthTotal,
    monthBarber,
    monthCount,
    workDays,
    offDays,
    avgCustomerPerDay,
    weeklyData,
    hairStats,
    serviceStats
) {
    const weekEntries = Object.entries(weeklyData);

    let dailyTimeline = [];
    let dayStats = {};

    weekEntries.forEach(([wk, data]) => {
        data.dailyCounts.forEach(d => {
            dailyTimeline.push(d);
            if (!dayStats[d.dayName]) {
                dayStats[d.dayName] = { total: 0, count: 0 };
            }
            if (d.count > 0) {
                dayStats[d.dayName].total += d.count;
                dayStats[d.dayName].count++;
            }
        });
    });
    // üî• ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ß‡∏±‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
    const dayAverages = Object.entries(dayStats)
        .filter(([_, v]) => v.count > 0)
        .map(([name, v]) => ({ name, avg: v.total / v.count }));

    const sortedDesc = [...dayAverages].sort((a,b)=>b.avg-a.avg);
    const sortedAsc  = [...dayAverages].sort((a,b)=>a.avg-b.avg);

    const busiestDay = sortedDesc[0];
    const quietestDay = sortedAsc[0];
    // üî• ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    const dates = dailyTimeline.map(d => d.date).sort();
    const startDate = dates[0];
    const endDate = dates[dates.length-1];

    const fmt = (d) => {
        if (!d) return "";
        const p = d.split("-");
        return `${p[2]}/${p[1]}`;
    };
    const periodLabel = startDate && endDate
        ? `‡∏ä‡πà‡∏ß‡∏á ${fmt(startDate)} - ${fmt(endDate)}`
        : "‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ";
    const maxDaily = dailyTimeline.length
        ? Math.max(...dailyTimeline.map(d=>d.count))
        : 0;
    const behavior = (maxDaily > avgCustomerPerDay * 1.5)
        ? `${periodLabel} ‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡∏°‡∏≤‡∏Å`
        : `${periodLabel} ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠`;
    const topIncomeWeek = weekEntries.length
        ? weekEntries.reduce((a,b)=>b[1].income>a[1].income?b:a)
        : null;
    const topCustomerWeek = weekEntries.length
        ? weekEntries.reduce((a,b)=>b[1].customers>a[1].customers?b:a)
        : null;

    const topHair = Object.entries(hairStats).sort((a,b)=>b[1]-a[1])[0];
    const topService = Object.entries(serviceStats).sort((a,b)=>b[1]-a[1])[0];

    const insights = `
        ‚Ä¢ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ${workDays} ‡∏ß‡∏±‡∏ô (‡∏´‡∏¢‡∏∏‡∏î ${offDays} ‡∏ß‡∏±‡∏ô)<br>
        ‚Ä¢ ${behavior}<br>
        ‚Ä¢ ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${topIncomeWeek ? topIncomeWeek[0] : "-"}<br>
        ‚Ä¢ ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î: ${topCustomerWeek ? topCustomerWeek[0] : "-"}<br>
        ‚Ä¢ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡∏ß‡∏±‡∏ô${busiestDay?.name || "-"}<br>
        ‚Ä¢ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏ß‡∏±‡∏ô${quietestDay?.name || "-"}<br>
        ‚Ä¢ ‡∏ó‡∏£‡∏á‡∏ú‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°: ${topHair?.[0] || "-"}<br>
        ‚Ä¢ ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°: ${topService?.[0] || "-"}
    `;

    openReportModal(
        `üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${m}`,
        `
        <div style="padding:25px;">
            <h2 style="margin-bottom:10px;">üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° ‡∏ø${monthTotal.toLocaleString()}</h2>
            <div>üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${monthCount} ‡∏Ñ‡∏ô</div>
            <div>üìä ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${avgCustomerPerDay.toFixed(2)} ‡∏Ñ‡∏ô/‡∏ß‡∏±‡∏ô</div>
            <hr style="margin:15px 0;">
            <div>${insights}</div>
        </div>
        `
    );
}

function renderStats(obj = {}, accentColor = "var(--accent)") {
    if (typeof obj !== "object" || obj === null) {
        return `<div class="text-center mt-10 mb-10" style="opacity:.5;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>`;
    }
    const entries = Object.entries(obj)
        .filter(([_, v]) => Number(v) > 0)
        .sort((a, b) => Number(b[1]) - Number(a[1]));

    if (!entries.length) {
        return `<div class="text-center mt-10 mb-10" style="opacity:.5;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>`;
    }
    return entries.map(([key, value]) => `
        <div class="stat-item">
            <div class="stat-label">${escapeHTML(key)}</div>
            <div class="stat-value" style="color:${accentColor}">
                ${value}
                <span class="stat-unit">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
            </div>
        </div>
    `).join("");
}

function topN(obj = {}, n = 5) {
    if (typeof obj !== "object" || obj === null) return [];
    const limit = Number(n) > 0 ? Number(n) : 5;
    return Object.entries(obj)
        .filter(([_, value]) => {
            const num = Number(value);
            return !isNaN(num) && num > 0;
        })
        .sort((a, b) => Number(b[1]) - Number(a[1]))
        .slice(0, limit);
}

function buildMonthlyComments(data = {}) {
    const {
        weekly = {},
        monthHair = {},
        monthSvc = {},
        avgPerDay = 0,
        workDays = 0,
        monthKey = ""
    } = data;

    const comments = [];
    if (!monthKey) return ["‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå"];

    /* ===============================
       üìÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
    =============================== */
    const [year, month] = monthKey.split('-').map(Number);
    const daysInMonth = new Date(year, month, 0).getDate();
    const offDaysCount = Math.max(daysInMonth - workDays, 0);

    const dayNames = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå"];
    const workedWeekdays = new Set();

    Object.values(weekly).forEach(w => {
        (w.days || []).forEach(dateStr => {
            workedWeekdays.add(new Date(dateStr).getDay());
        });
    });
    const regularOffDays = dayNames.filter((_, index) => !workedWeekdays.has(index));
    let holidayMsg = `‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏ß‡∏° ${offDaysCount} ‡∏ß‡∏±‡∏ô`;
    if (regularOffDays.length && offDaysCount > 0) {
        holidayMsg += ` (‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô${regularOffDays.join("/")})`;
    }
    comments.push(holidayMsg);

    /* ===============================
       üë• ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    =============================== */
    let maxDaily = 0;

    Object.values(weekly).forEach(w => {
        Object.values(w.daily || {}).forEach(count => {
            if (count > max

// =====================================================
// 7Ô∏è‚É£ SHARE / LINE SYSTEM
// =====================================================

function confirmShareLine() {
    const monthInput = $("histMonth");
    if (!monthInput) {
        console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö element #histMonth");
        return;
    }
    const month = monthInput.value;
    if (!month) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô");
        return;
    }
    const isConfirmed = confirm(
        `üì§ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô\n\n‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${month} ‡πÄ‡∏Ç‡πâ‡∏≤ LINE ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`
    );
    if (!isConfirmed) return;
    if (typeof shareLineMonth === "function") {
        shareLineMonth();
    } else {

function shareLine() {
    const dateInput = $("dateInp");
    if (!dateInput) return;
    const selectedDate = dateInput.value;
    if (!selectedDate) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");
    if (!Array.isArray(db) || db.length === 0) {
        return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }
    const todayRecords = db
        .filter(r => r?.date === selectedDate)
        .sort((a,b) => (a.time || "").localeCompare(b.time || ""));
    if (todayRecords.length === 0) {
        return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ");
    }
    const [y,m,d] = selectedDate.split("-");
    const formattedDate = `${d}/${m}/${y}`;
    const shopName = conf?.shop || "Barber Shop";

    let total = 0;
    let cash = 0;
    let trans = 0;
    let tips = 0;
    let stats = {};
    let realCustomerCount = 0;

    // =========================
    // LOOP DATA
    // =========================

    const clientList = todayRecords.map((r,i) => {
        const price = Number(r.price) || 0;
        const tip = Number(r.tip) || 0;
        const type = (r.type || "").toUpperCase().trim();

        total += price;
        tips += tip;

        if (r.pay === "Trans") {
            trans += (price + tip);
        } else {
            cash += price;
        }
        // ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô / ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î / ‡∏£‡∏≤‡∏Ñ‡∏≤ 0
        if (type !== "GUARANTEE" && type !== "HOLIDAY" && price > 0) {
            realCustomerCount++;

            if (r.hair?.includes("‡πÄ‡∏î‡πá‡∏Å")) {
                stats["‡πÄ‡∏î‡πá‡∏Å"] = (stats["‡πÄ‡∏î‡πá‡∏Å"] || 0) + 1;
            }
            (r.svcs || []).forEach(s => {
                if (s) stats[s] = (stats[s] || 0) + 1;
            });
        }
        const timeShow = r.endTime
            ? `${r.time}-${r.endTime}`
            : r.time || "-";
        const icon =
            type === "GUARANTEE" ? "üõ°Ô∏è" :
            type === "HOLIDAY"   ? "üèñÔ∏è" :
            "";
        return `${i+1}. [${timeShow}] ${icon} ${(r.svcs || []).join("+")} = ${price}${tip ? ` (+‡∏ó‡∏¥‡∏õ ${tip})` : ""} ${r.pay === "Trans" ? "üì±" : "üíµ"}`;
    }).join("\n");

    // =========================
    // ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    // =========================
    const allowed = ["‡πÄ‡∏î‡πá‡∏Å","‡∏™‡∏£‡∏∞‡∏ú‡∏°","‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î","‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°",];
    const icons = {
        "‡πÄ‡∏î‡πá‡∏Å":"üßí",
        "‡∏™‡∏£‡∏∞":"üßº",
        "‡πÇ‡∏Å‡∏ô":"ü™í",
        "‡∏¢‡πâ‡∏≠‡∏°":"üé®"
    };
    const statText = Object.entries(stats)
        .filter(([k]) => allowed.some(a => k.includes(a)))
        .map(([k,v]) => {
            const iconKey = Object.keys(icons).find(i => k.includes(i));
            return `${icons[iconKey] || "üîπ"} ${k}: ${v}`;
        })
        .join("\n");
    // =========================
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
    // =========================
    const barberEarnBase =
        Math.max(total * (conf.perc / 100), conf.guar);

    const barberEarn = barberEarnBase + tips;
    const shopEarn = total - barberEarnBase;

    const settle = cash - barberEarn;
    const settleMsg =
        settle > 0
            ? `‚ö†Ô∏è ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ${Math.floor(Math.abs(settle))}`
            : `üü¶ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ${Math.floor(Math.abs(settle))}`;

    // =========================
    // BUILD MESSAGE
    // =========================
    let msg = `
üíà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô: ${shopName}
üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formattedDate}
-------------------------
üìù ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (${realCustomerCount} ‡∏Ñ‡∏ô):
${clientList}
-------------------------
üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô:
${statText || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô)"}
-------------------------
üí∞ ‡∏¢‡∏≠‡∏î: ${total}
üßß ‡∏ó‡∏¥‡∏õ: ${tips}
üì± ‡πÇ‡∏≠‡∏ô: ${trans}
üíµ ‡∏™‡∏î: ${cash}
ü§µ ‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ: ${Math.floor(barberEarn)}
üè† ‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ${Math.floor(shopEarn)}
-------------------------
${settleMsg}
`.trim();

    const msgEdit = $("msgEdit");
    const preview = $("linePreview");

    if (msgEdit) msgEdit.value = msg;
    if (preview) preview.style.display = "flex";
}

function shareLineMonth() {
    const monthInput = $("histMonth");
    if (!monthInput) return;

    const monthKey = monthInput.value;
    if (!monthKey) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô");
        return;
    }
    if (!Array.isArray(archives) || archives.length === 0) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        return;
    }
    const records = archives.filter(r => 
        r?.date && r.date.startsWith(monthKey)
    );

    if (records.length === 0) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ");
        return;
    }
    const shopName = $("setShop")?.value || conf?.shop || "Barber Shop";

    let total = 0;
    let barberEarn = 0;
    let clientCount = 0;

    const weekly = {};
    const monthHair = {};
    const monthSvc = {};

    const haircutList = [
        "‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô","‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î","‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á","‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á",
        "‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£","‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡πÅ‡∏Å‡πâ‡∏ú‡∏°","‡πÇ‡∏Å‡∏ô‡∏ú‡∏°","‡πÄ‡∏î‡πá‡∏Å"
    ];
    const weekOfMonth = date =>
        Math.ceil(new Date(date).getDate() / 7);
    const weekdayTH = date =>
        ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå"]
        [new Date(date).getDay()];
    // ==========================
    // LOOP DATA
    // ==========================
    records.forEach(r => {
        const dayCustomers = r.details?.length || 1;
        const week = weekOfMonth(r.date);
        const dayName = weekdayTH(r.date);

        total += Number(r.total) || 0;
        barberEarn += Number(r.barber) || 0;
        clientCount += dayCustomers;

        if (!weekly[week]) {
            weekly[week] = {
                customers: 0,
                days: new Set(),
                daily: {}
            };
        }
        weekly[week].customers += dayCustomers;
        weekly[week].days.add(r.date);
        weekly[week].daily[dayName] =
            (weekly[week].daily[dayName] || 0) + dayCustomers;
        (r.details || []).forEach(d => {
            (d.svcs || []).forEach(s => {
                if (!s) return;
                const name = s.trim();

                if (haircutList.includes(name)) {
                    monthHair[name] = (monthHair[name] || 0) + 1;
                } else {
                    monthSvc[name] = (monthSvc[name] || 0) + 1;
                }
            });
        });
    });
    // ==========================
    // SUMMARY
    // ==========================
    const shopEarn = total - barberEarn;
    const workDays = records.length;

    const [year, month] = monthKey.split("-");
    const totalDaysInMonth =
        new Date(year, month, 0).getDate();
    const holidayCount = totalDaysInMonth - workDays;
    const avgPerDay =
        workDays > 0 ? clientCount / workDays : 0;
    const aiComments = typeof buildMonthlyComments === "function"
        ? buildMonthlyComments({
            weekly,
            monthHair,
            monthSvc,
            avgPerDay,
            workDays,
            monthKey
        })
        : [];
    // ==========================
    // BUILD MESSAGE
    // ==========================
    const topServices = Object.entries(monthSvc)
        .sort((a,b) => b[1] - a[1])
        .slice(0,3)
        .map(([k,v]) => `‚Ä¢ ${k} (${v} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`)
        .join("\n") || "-";

    const message = `
üíà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${shopName}
üìÖ ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${monthKey}

üí∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
‚úÇÔ∏è ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ‡∏ø${total.toLocaleString()}
ü§µ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ä‡πà‡∏≤‡∏á: ‡∏ø${Math.floor(barberEarn).toLocaleString()}
üè† ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡πâ‡∏≤‡∏ô: ‡∏ø${Math.floor(shopEarn).toLocaleString()}

üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${clientCount} ‡∏Ñ‡∏ô
üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ${workDays} ‡∏ß‡∏±‡∏ô
üò¥ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î: ${holidayCount} ‡∏ß‡∏±‡∏ô
üìà ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${avgPerDay.toFixed(2)} ‡∏Ñ‡∏ô/‡∏ß‡∏±‡∏ô

üìù ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
${aiComments.map(c => `‚Ä¢ ${c}`).join("\n") || "-"}

üèÜ ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°
${topServices}

üí° ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô Barber
`.trim();

    const lineURL =
        `https://line.me/R/msg/text/?${encodeURIComponent(message)}`;

    window.open(lineURL, "_blank");
}

function sendToLineFinal() {
    const msgInput = $("msgEdit");
    const previewModal = $("linePreview");
    if (!msgInput) return;
    const finalMsg = msgInput.value.trim();

    if (!finalMsg) {
        alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á");
        return;
    }
    const lineURL = `https://line.me/R/msg/text/?${encodeURIComponent(finalMsg)}`;
    window.open(lineURL, "_blank");
    // ‡∏õ‡∏¥‡∏î modal ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
    if (previewModal) {
        previewModal.classList.remove("active");
    }
}
// =====================================================
// 8Ô∏è‚É£ UI NAVIGATION / PAGE CONTROLLER
// =====================================================
function go(p) {
    // 1Ô∏è‚É£ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    document.querySelectorAll('.page').forEach(pg => {
        pg.classList.remove('active');
    });
    const targetPage = document.getElementById('p' + p);
    if (targetPage) {
        targetPage.classList.add('active');
    }
    // 2Ô∏è‚É£ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏ô‡∏π
    document.querySelectorAll('.nav-item').forEach((btn, i) => {
        btn.classList.toggle('active', (i + 1) === p);
    });
    // 3Ô∏è‚É£ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤
    switch (p) {
        case 2:
            const targetDate =
                $("dateInp")?.value ||
                new Date().toISOString().split('T')[0];
            if (typeof renderDay === 'function') {
                renderDay(targetDate);
            }
            break;
        case 3:
            if ($("accDate") && $("dateInp")) {
                $("accDate").value = $("dateInp").value;
            }
            if (typeof loadAccountStatus === 'function') {
                loadAccountStatus();
            }
            break;
    }
    // 4Ô∏è‚É£ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
function closeAndGoHome() {
    const modal = $("modalSet");
    if (modal) {
        modal.classList.remove("active");
    }
    if (typeof go === "function") {
        go(1);
    } else {
        location.reload();
    }
}
// =====================================================
// 9Ô∏è‚É£ MODAL CONTROL
// =====================================================
function openReportModal(title = "", htmlContent = "") {
    const modal = $("reportModal");
    const modalTitle = $("reportTitle");
    const modalContent = $("reportContent");

    if (!modal || !modalTitle || !modalContent) {
        console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö element ‡∏Ç‡∏≠‡∏á Report Modal");
        return;
    }
    modalTitle.textContent = title;
    modalContent.innerHTML = htmlContent;
    modal.classList.add("active");
}
function closeReportModal() {
    const modal = $("reportModal");
    if (modal) modal.classList.remove("active");
}
function closeHistoryModal() {
    const modal = $("historyModal");
    if (modal) modal.classList.remove("active");
}
function openSettings() {
    const fields = {
        setShop:  conf.shop  ?? "",
        setTheme: conf.theme ?? "light",
        setVoice: conf.voice ?? "female",
        setSound: conf.sound ?? "on",
        setPerc:  conf.perc  ?? 50,
        setGuar:  conf.guar  ?? 0
    };
    Object.keys(fields).forEach(id => {
        const el = $(id);
        if (el) el.value = fields[id];
    });

    const modal = $("modalSet");
    if (modal) modal.style.display = "flex";
}
// =====================================================
// üîü SETTINGS / THEME
// =====================================================
function applyTheme(theme = "light") {
    const root = document.documentElement;
    const body = document.body;
    // ‡∏•‡πâ‡∏≤‡∏á class theme ‡πÄ‡∏Å‡πà‡∏≤
    body.classList.remove("light", "dark", "navy");
    // ‡πÉ‡∏™‡πà class ‡πÉ‡∏´‡∏°‡πà
    body.classList.add(theme);
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ theme ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ö‡∏ö
    const themes = {
        light: {
            "--card": "#ffffff",
            "--text": "#1a237e",
            "--modal-bg": "#f3f4f6",
            "--bg": "#f3f4f6"
        },
        dark: {
            "--card": "#262626",
            "--text": "#fbbf24",
            "--modal-bg": "#171717",
            "--bg": "#171717"
        },
        navy: {
            "--card": "#ffffff",
            "--text": "#1a237e",
            "--modal-bg": "#1a237e",
            "--bg": "#1a237e"
        }
    };
    const selected = themes[theme] || themes.light;
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CSS Variables
    Object.keys(selected).forEach(key => {
        root.style.setProperty(key, selected[key]);
    });

    body.style.background = selected["--bg"];

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å theme
    localStorage.setItem("barber_theme", theme);
}
function saveSettings() {
    const shopName  = $("setShop")?.value.trim() || "Barber Shop";
    const shopPerc  = parseFloat($("setPerc")?.value) || 0;
    const shopGuar  = parseFloat($("setGuar")?.value) || 0;
    const shopTheme = $("setTheme")?.value || "light";
    const shopVoice = $("setVoice")?.value || "default.mp3";
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï object ‡∏Å‡∏•‡∏≤‡∏á
    conf = {
        ...conf,
        shop: shopName,
        perc: shopPerc,
        guar: shopGuar,
        theme: shopTheme,
        voice: shopVoice
    };
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
    localStorage.setItem("barber_conf", JSON.stringify(conf));
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    if ($("shopNameDisp")) {
        $("shopNameDisp").innerText = shopName.toUpperCase();
    }
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°
    if (typeof applyTheme === "function") {
        applyTheme(shopTheme);
    }
    // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    if (typeof playSuccessSound === "function") {
        playSuccessSound(shopVoice);
    }
    // ‡∏£‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì + ‡∏£‡∏µ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå
    if (typeof calculateMoney === "function") {
        calculateMoney();
    }
    if (typeof renderDay === "function") {
        renderDay();
    }
    // ‡∏õ‡∏¥‡∏î modal
    if ($("modalSet")) {
        $("modalSet").style.display = "none";
    }
    alert("‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
}
// =====================================================
// 1Ô∏è‚É£1Ô∏è‚É£ BACKUP SYSTEM
// =====================================================
function exportBackup() {
    try {
        const backupData = {
            barber_db: JSON.parse(localStorage.getItem("barber_db") || "[]"),
            barber_archives: JSON.parse(localStorage.getItem("barber_archives") || "[]"),
            barber_account: JSON.parse(localStorage.getItem("barber_account") || "{}"),
            barber_conf: JSON.parse(localStorage.getItem("barber_conf") || "{}"),
            exportDate: new Date().toISOString()
        };

        const blob = new Blob(
            [JSON.stringify(backupData, null, 2)],
            { type: "application/json" }
        );

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");

        const today = new Date().toISOString().split("T")[0];
        a.href = url;
        a.download = `barber-backup-${today}.json`;

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        URL.revokeObjectURL(url);

        alert("‚úÖ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    } catch (err) {
        console.error("Export error:", err);
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
    }
}
function importBackup(input) {
    if (!input.files || !input.files[0]) return;

    const reader = new FileReader();

    reader.onload = function (e) {
        try {
            const data = JSON.parse(e.target.result);

            const confirmImport = confirm(
                "‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\n‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?"
            );
            if (!confirmImport) return;
            // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ key ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á
            if (data.barber_db)
                localStorage.setItem("barber_db", JSON.stringify(data.barber_db));
            if (data.barber_archives)
                localStorage.setItem("barber_archives", JSON.stringify(data.barber_archives));
            if (data.barber_account)
                localStorage.setItem("barber_account", JSON.stringify(data.barber_account));
            if (data.barber_conf)
                localStorage.setItem("barber_conf", JSON.stringify(data.barber_conf));

            alert("‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà");
            location.reload();
        } catch (err) {
            console.error("Import error:", err);
            alert("‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢");
        }
        input.value = "";
    };
    reader.readAsText(input.files[0]);
}
if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
        try {
            await navigator.serviceWorker.register("./service-worker.js");
            console.log("‚úÖ Service Worker registered");
        } catch (err) {
            console.error("‚ùå Service Worker registration failed:", err);
        }
    });
}
// =====================================================
// 1Ô∏è‚É£2Ô∏è‚É£ UTILITIES (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢)
// =====================================================
 function speak(text = "") {
    if (!("speechSynthesis" in window)) return;
    if (!text.trim()) return;
    // ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≠‡∏ô)
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "th-TH";
    utterance.rate = 1;     // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß (0.1 - 10)
    utterance.pitch = 1;    // ‡πÇ‡∏ó‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (0 - 2)
    utterance.volume = 1;   // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á (0 - 1)
    window.speechSynthesis.speak(utterance);
}
function addMinutes(time, mins = 0) {
    if (!time || !time.includes(":")) return "";
    const [hours, minutes] = time.split(":").map(Number);
    if (isNaN(hours) || isNaN(minutes) || isNaN(mins)) return "";
    let totalMinutes = hours * 60 + minutes + mins;
    totalMinutes = ((totalMinutes % 1440) + 1440) % 1440;
    const newHours = Math.floor(totalMinutes / 60);
    const newMinutes = totalMinutes % 60;
    return `${String(newHours).padStart(2, "0")}:${String(newMinutes).padStart(2, "0")}`;
}
// ==========================
// 1Ô∏è‚É£3Ô∏è‚É£ Global Event Listeners
// ==========================
window.addEventListener("click", function (e) {
    const modals = [
        { id: "reportModal", close: closeReportModal },
        { id: "historyModal", close: closeHistoryModal },
        { id: "configModal", close: closeConfigModal }
    ];
    modals.forEach(m => {
        const modalEl = $(m.id);
        if (modalEl && e.target === modalEl && typeof m.close === "function") {
            m.close();
        }
    });

});
 window.addEventListener("load", function () {
    const now = new Date();
    const timeNow =
        now.getHours().toString().padStart(2, "0") +
        ":" +
        now.getMinutes().toString().padStart(2, "0");
    const tStart = document.getElementById("tStart");
    const tEnd = document.getElementById("tEnd");

    if (tStart) tStart.value = timeNow;
    if (tEnd) tEnd.value = timeNow;
    // =============================
    // ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô
    // =============================
    const savedName = localStorage.getItem("shopName");
    if (savedName) {
        const shopDisp = document.getElementById("shopNameDisp");
        const setShop = document.getElementById("setShop");

        if (shopDisp) shopDisp.innerText = savedName.toUpperCase();
        if (setShop) setShop.value = savedName;
    }
    // =============================
    // ‡πÇ‡∏´‡∏•‡∏î‡∏ò‡∏µ‡∏°
    // =============================
    const savedTheme = localStorage.getItem("shopTheme");
    if (savedTheme) {
        const setTheme = document.getElementById("setTheme");
        if (setTheme) setTheme.value = savedTheme;
        applyTheme(savedTheme);
    }
});       
 </script>
    </body>
    </html>
