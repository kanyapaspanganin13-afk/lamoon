<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BarberNote">
    <link rel="apple-touch-icon" href="https://i.ibb.co/kVrdspsT/Barber-note-pro.jpg">
    <title>Barber Note Pro v.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./service-worker.js")
                    .then(reg => console.log("‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!"))
                    .catch(err => console.error("‚ùå SW error:", err));
            });
        }
    </script>
</head>
<style>
    /* 1. ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å */
    :root { 
        --primary: #6366f1; --accent: #0ea5e9; --danger: #ef4444; --success: #22c55e; 
        --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --border: #e2e8f0;
    }

    /* 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ò‡∏µ‡∏° (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£) */
    body.navy { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --accent: #38bdf8; }
    body.dark { --bg: #121212; --card: #1a1a1a; --text: #fbbf24; --accent: #fbbf24; }

    /* 3. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
    * { box-sizing: border-box; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
    
    body { 
        margin: 0; background: var(--bg); color: var(--text); 
        padding-bottom: 90px; overflow-x: hidden; transition: all 0.3s ease; 
    }

    /* 4. ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏¢‡πå‡πÄ‡∏≠‡∏≤‡∏ï‡πå (Layout & Page) */
    .container { padding: 15px; max-width: 500px; margin: auto; position: relative; z-index: 1; }
    .page { display: none; } 
    .page.active { display: block; }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 8px; }

    /* 5. ‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏≤‡∏£‡πå (‡πÅ‡∏Å‡πâ‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) */
    nav {
        position: fixed; bottom: 0; left: 0; right: 0;
        background: #1a237e !important; /* ‡∏™‡∏µ‡∏Å‡∏£‡∏°‡∏ó‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
        display: flex; justify-content: space-around; 
        height: 75px; align-items: center;
        box-shadow: 0 -10px 30px rgba(0,0,0,0.4); 
        z-index: 99999; border-top: 1px solid rgba(255,255,255,0.1);
        padding-bottom: env(safe-area-inset-bottom);
    }

    .nav-item { 
        flex: 1; text-align: center; color: rgba(255,255,255,0.5); 
        cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center;
    }

    .nav-item.active { color: #ffffff !important; opacity: 1; }
    
    .nav-item i { font-size: 22px; display: block; margin-bottom: 2px; }
    .nav-item span { font-size: 11px; font-weight: 700; }

    /* 6. ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï */
    .icon-card, input, select { background: var(--card); color: var(--text); }

    .icon-card { 
        border-radius: 15px; padding: 10px 2px; display: flex; flex-direction: column; 
        align-items: center; justify-content: center; gap: 4px; cursor: pointer; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); height: 75px; font-size: 14px; transition: 0.2s;
    }
    .icon-card:active { transform: scale(0.95); }

    input, select { 
        width: 100%; height: 75px; border-radius: 20px; font-size: 20px; font-weight: 700; 
        text-align: center; border: none; outline: none; box-shadow: 0 4px 10px rgba(0,0,0,0.03); 
        appearance: none; -webkit-appearance: none;
    }

    /* 7. ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ */
    .btn { 
        border: none; padding: 12px; border-radius: 15px; cursor: pointer; 
        display: flex; align-items: center; justify-content: center; font-weight: 700; transition: 0.2s; 
    }
    .btn-save { background: var(--success); color: white; width: 100%; font-size: 16px; margin-top: 10px; }
    
    .btn-pay { background: #e2e8f0; color: #64748b; border: 2px solid transparent; height: 70px; font-size: 18px; width: 100%; }
    .btn-pay.active-cash { background: #dcfce7; color: #15803d; border-color: #22c55e; }
    .btn-pay.active-trans { background: #e0f2fe; color: #0369a1; border-color: #0ea5e9; }

    /* 8. ‡πÇ‡∏°‡∏î‡∏≠‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô */
    .modal { 
        position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); 
        display: none; z-index: 1000000; align-items: center; justify-content: center; 
    }
    .modal-content { 
        background: var(--card); color: var(--text); width: 90%; max-width: 400px; 
        border-radius: 25px; padding: 25px; max-height: 85vh; overflow-y: auto; 
    }

    .status-bar { padding: 12px; border-radius: 12px; text-align: center; font-weight: 800; font-size: 14px; margin-bottom: 10px; }
    .acc-main-card { background: var(--card); padding: 20px; border-radius: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 15px; }
    #accHistory { font-size: 12px; max-height: 150px; overflow-y: auto; }
</style>
</head>
<body>
<div class="container">
<div id="p1" class="page active" style="padding: 15px; background: #f8fafc;">
    <h2 id="shopNameDisp" style="text-align:center; color:#1e293b; font-weight:900; margin: 10px 0 20px 0; letter-spacing: 1px; text-transform: uppercase;">BARBER SHOP</h2>
    
    <div class="grid-3" style="gap: 12px; margin-bottom: 20px;">
        <div class="icon-card" style="background:#fff; border:none; box-shadow:0 8px 15px rgba(0,0,0,0.05); border-radius:20px; height:90px; display:flex; flex-direction:column; align-items:center; justify-content:center;" onclick="handleInsurance()">
            <div style="background:linear-gradient(135deg, #fbbf24, #f59e0b); width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:8px; color:#fff; font-size:18px;">
                <i class="fas fa-shield-alt"></i>
            </div>
            <span style="color:#1e293b; font-weight:800; font-size:11px;">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</span>
        </div>
        
        <div class="icon-card" style="background:#fff; border:none; box-shadow:0 8px 15px rgba(0,0,0,0.05); border-radius:20px; height:90px; display:flex; flex-direction:column; align-items:center; justify-content:center;" onclick="handleHoliday()">
            <div style="background:linear-gradient(135deg, #f87171, #ef4444); width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:8px; color:#fff; font-size:18px;">
                <i class="fas fa-umbrella-beach"></i>
            </div>
            <span style="color:#1e293b; font-weight:800; font-size:11px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span>
        </div>

        <div class="icon-card" style="background:#fff; border:none; box-shadow:0 8px 15px rgba(0,0,0,0.05); border-radius:20px; height:90px; display:flex; flex-direction:column; align-items:center; justify-content:center;" onclick="openSettings()">
            <div style="background:linear-gradient(135deg, #94a3b8, #475569); width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:8px; color:#fff; font-size:18px;">
                <i class="fas fa-cog"></i>
            </div>
            <span style="color:#1e293b; font-weight:800; font-size:11px;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
        </div>
    </div>

   <div class="grid-3" style="gap:10px; margin-bottom:15px;">
        <div style="background:#fff; border-radius:18px; border:none; height:75px; position:relative; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
            <span id="dateDisplay" style="font-weight:800; color:#475569; font-size:18px;">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
           <input type="date" id="dateInp" onchange="document.getElementById('dateDisplay').innerText = this.value; if(window.updateDateDisplay) updateDateDisplay(this.value); renderDay();" style="position:absolute; opacity:0; width:100%; height:100%; cursor:pointer; z-index:2;">
        </div>
        <input type="time" id="tStart" style="height:60px; border-radius:22px; border:none; text-align:center; font-weight:700; background:#fff; color:#1e293b; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
        <input type="time" id="tEnd" style="height:60px; border-radius:22px; border:none; text-align:center; font-weight:700; background:#fff; color:#1e293b; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
    </div>
<div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
    <select id="hairStyle" style="height:70px; border-radius:14px; border:none; font-weight:700; background:#fff; color:#1e293b; box-shadow:0 4px 10px rgba(0,0,0,0.03); padding:0 10px;">
        <option value="">‚úÇÔ∏è ‡∏ó‡∏£‡∏á‡∏ú‡∏°</option>
        <option>‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô</option><option>‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î</option><option>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á</option><option>‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á</option>
        <option>‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£</option><option>‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option><option>‡πÅ‡∏Å‡πâ‡∏ú‡∏°</option><option>‡πÇ‡∏Å‡∏ô‡∏ú‡∏°</option>
    </select>
    <select id="extra1" style="height:70px; border-radius:14px; border:none; font-weight:700; background:#fff; color:#64748b; box-shadow:0 4px 10px rgba(0,0,0,0.03); padding:0 8px;">
        <option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£1</option>
        <option value="‡πÄ‡∏î‡πá‡∏Å"> ‡πÄ‡∏î‡πá‡∏Å</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option>
    </select>
    <select id="extra2" style="height:70px; border-radius:14px; border:none; font-weight:700; background:#fff; color:#64748b; box-shadow:0 4px 10px rgba(0,0,0,0.03); padding:0 8px;">
        <option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£2</option>
        <option value="‡πÄ‡∏î‡πá‡∏Å"> ‡πÄ‡∏î‡πá‡∏Å</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option>
    </select>
</div>

<div style="display: grid; grid-template-columns: 1.4fr 1fr; gap: 8px; margin: 10px 0;">
    <div style="position: relative; background: #ffffff; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05);">
        <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 24px; color: #6366f1; font-weight: 900;">‡∏ø</span>
        <input type="number" id="priceInp" placeholder="0" inputmode="numeric" 
            style="width: 100%; height: 85px !important; background: transparent !important; font-size: 45px !important; font-weight: 900 !important; color: #1e293b !important; padding-left: 40px !important; border: none !important;">
    </div>

    <input type="number" id="tipInp" placeholder="‡∏ó‡∏¥‡∏õ" inputmode="numeric" 
        style="width: 100%; height: 85px !important; background: #ccfbf1 !important; border-radius: 20px !important; font-size: 32px !important; font-weight: 900 !important; color: #0f766e !important; border: none !important;">
</div>

<div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:20px;">
    <button id="btnCash" onclick="selectPay('Cash')" style="height:75px; border-radius:22px; border:none; background:linear-gradient(135deg, #10b981, #059669); color:#fff; font-weight:900; font-size:22px; box-shadow:0 8px 20px rgba(16,185,129,0.3); display:flex; align-items:center; justify-content:center; gap:10px;">
        <i class="fas fa-money-bill-wave"></i> ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
    </button>
    <button id="btnTrans" onclick="selectPay('Trans')" style="height:75px; border-radius:22px; border:none; background:linear-gradient(135deg, #6366f1, #4338ca); color:#fff; font-weight:900; font-size:22px; box-shadow:0 8px 20px rgba(99,102,241,0.3); display:flex; align-items:center; justify-content:center; gap:10px;">
        <i class="fas fa-qrcode"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢
    </button>
</div>
<button class="btn-main" onclick="handleSave(event)" style="width:100%; height:90px; border-radius:28px; background:linear-gradient(135deg, #4338ca, #3730a3); color:#fff; border:none; box-shadow:0 15px 35px rgba(67,56,202,0.4); display:flex; align-items:center; justify-content:center; gap:15px;">
    <i class="fas fa-save" style="font-size: 38px;"></i>
    <span style="font-size: 32px; font-weight: 900; letter-spacing:1px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
</button>  
</div>
 <div id="p2" class="page" style="max-width:480px; margin:0 auto; padding: 15px; padding-bottom: 100px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
        <div style="background: white; padding:18px 15px; border-radius:20px; text-align:center; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;">
            <small style="font-weight:800; color:#64748b; text-transform: uppercase;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
            <div id="dTotal" style="font-size:36px; font-weight:900; color:#4338ca; margin: 5px 0;">0</div>
            <div id="dCounts" style="font-size:16px; font-weight:700; color:#1e293b; background:#e0e7ff; display:inline-block; padding:2px 10px; border-radius:10px;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 0 ‡∏Ñ‡∏ô</div>
        </div>

        <div style="background:white; padding:15px; border-radius:20px; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; display:flex; flex-direction:column; justify-content:center; gap:8px;">
            <div style="display:flex; justify-content:space-between; font-size:16px; font-weight:700;"><span style="color:#0ea5e9;">üì± ‡πÇ‡∏≠‡∏ô:</span> <b id="dTrans">0</b></div>
            <div style="display:flex; justify-content:space-between; font-size:16px; font-weight:700;"><span style="color:#f59e0b;">üíµ ‡∏™‡∏î:</span> <b id="dCash">0</b></div>
            <div style="display:flex; justify-content:space-between; font-size:16px; font-weight:700;"><span style="color:#6366f1;">üë®‚Äçüé® ‡∏ä‡πà‡∏≤‡∏á:</span> <b id="dBarber">0</b></div>
            <div style="display:flex; justify-content:space-between; font-size:16px; font-weight:800;"><span style="color:#64748b;">üè† ‡∏£‡πâ‡∏≤‡∏ô:</span> <b id="dShop">0</b></div>
        </div>
    </div>
    <div id="settleBarContainer" style="margin-bottom:18px;"><div id="settleBar"></div> </div>
    <div id="dServiceStats"></div>
    <hr style="border:0; border-top:1px solid #e2e8f0; margin-top:15px;">
    <div id="dailyList"></div>
</div>
<div id="p3" class="page" style="max-width:480px; margin:0 auto; padding: 12px; padding-bottom: 100px; background: #f8fafc;">
    <div class="card" style="background:#fff; border-radius:25px; padding:20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border:1px solid #fff; margin-bottom: 15px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <b style="font-size:22px; color:#92400e;"><i class="fas fa-wallet"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</b>
            <div id="accLight" style="background:#22c55e; width:10px; height:10px; border-radius:50%; box-shadow:0 0 8px #22c55e;"></div>
        </div>

        <div style="display:flex; gap:12px; margin-bottom:25px;">
            <div style="flex:1; background:#fff; border-radius:22px; padding:18px 10px; text-align:center; box-shadow: 0 8px 20px rgba(0,0,0,0.04); border: 1px solid #f1f5f9;">
                <small style="font-size:16px; color:#64748b; font-weight:700; text-transform:uppercase;">‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°</small>
                <b style="font-size:22px; color:#1e293b; font-weight:900; display:block;" id="accOldVal">‡∏ø0</b>
            </div>
            <div style="flex:1; background:#fff; border-radius:22px; padding:18px 10px; text-align:center; box-shadow: 0 8px 20px rgba(0,0,0,0.04); border: 1px solid #f1f5f9;">
                <small style="font-size:16px; color:#64748b; font-weight:700; text-transform:uppercase;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
                <b style="font-size:22px; color:#1e293b; font-weight:900; display:block;" id="accTodayVal">‡∏ø0</b>
            </div>
        </div>
            <div style="text-align:center; margin-bottom:20px;">
    <div style="font-size:48px; font-weight:900; color:#1a237e; letter-spacing:-1px;">‡∏ø<span id="accNet">0</span></div>
    <div id="statusBadge" style="display:inline-block; padding:6px 16px; border-radius:20px; font-size:14px; font-weight:bold; margin-top:8px;">
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...
    </div>
     </div>
        <div style="margin-bottom:15px;">
            <div style="display:flex; align-items:center; background:#f1f5f9; border-radius:15px; padding:0 15px; margin-bottom:8px; height:50px;">
                <i class="fas fa-calendar-alt" style="color:#6366f1;"></i>
                <input type="date" id="accDate" style="flex:1; border:none; background:none; font-size:16px; font-weight:600; padding-left:10px; outline:none;">
            </div>
            <div style="display:flex; align-items:center; background:#f1f5f9; border-radius:15px; padding:0 15px; height:50px;">
                <i class="fas fa-pen-nib" style="color:#94a3b8;"></i>
                <input type="text" id="accNote" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..." style="flex:1; border:none; background:none; font-size:15px; padding-left:10px; outline:none;">
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button onclick="clearAccount()" style="background:linear-gradient(135deg, #10b981, #059669); color:#fff; border:none; border-radius:18px; padding:15px 5px; font-size:14px; font-weight:800;">
                <i class="fas fa-check-double"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô
            </button>
            <button onclick="openHistoryModal()" style="background:#fff; color:#3b82f6; border:2px solid #3b82f6; border-radius:18px; padding:15px 5px; font-size:14px; font-weight:800;">
                <i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô
            </button>
        </div>
    </div>
 <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div onclick="$('histDate').showPicker()" style="background:linear-gradient(135deg, #f59e0b, #d97706); border-radius:25px; padding:20px 10px; text-align:center; color:#fff; position:relative; box-shadow:0 8px 15px rgba(245,158,11,0.2);">
            <i class="fas fa-search-dollar" style="font-size:28px; margin-bottom:5px; display:block;"></i>
            <b style="font-size:16px;">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</b>
            <input type="date" id="histDate" onchange="loadHistDaily()" style="position:absolute; inset:0; opacity:0;">
        </div>
        <div onclick="$('histMonth').showPicker()" style="background:linear-gradient(135deg, #6366f1, #4338ca); border-radius:25px; padding:20px 10px; text-align:center; color:#fff; position:relative; box-shadow:0 8px 15px rgba(99,102,241,0.2);">
            <i class="fas fa-calendar-check" style="font-size:28px; margin-bottom:5px; display:block;"></i>
            <b style="font-size:16px;">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</b>
            <input type="month" id="histMonth" onchange="loadHistMonth()" style="position:absolute; inset:0; opacity:0;">
        </div>
    </div>
</div>
<div id="modalSet" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); z-index:9999; align-items:flex-end; justify-content:center;">
    
    <div style="background:#ffffff; width:92%; max-width:400px; border-radius:35px; margin-bottom:110px; box-shadow:0 20px 60px rgba(0,0,0,0.15); display:flex; flex-direction:column; overflow:hidden;">
        
        <div style="padding:15px 0 0; text-align:center;">
            <div style="width:40px; height:5px; background:#f1f5f9; border-radius:10px; margin:0 auto;"></div>
        </div>

        <div style="padding:10px 25px 30px;">
            <h3 style="margin:0 0 20px; font-size:20px; color:#1a237e; font-weight:800; text-align:center;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>

            <div style="margin-bottom:18px;">
                <label style="display:block; font-size:11px; font-weight:800; color:#94a3b8; margin-bottom:8px;">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label>
                <input type="text" id="setShop" style="width:100%; height:55px; border-radius:18px; border:none; background:#f8fafc; text-align:center; font-size:16px; font-weight:700; outline:none;">
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <input type="number" id="setPerc" placeholder="% ‡∏ä‡πà‡∏≤‡∏á" style="width:100%; height:55px; border-radius:18px; border:none; background:#f8fafc; text-align:center; font-weight:700; outline:none;">
                <input type="number" id="setGuar" placeholder="‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô" style="width:100%; height:55px; border-radius:18px; border:none; background:#f8fafc; text-align:center; font-weight:700; outline:none;">
            </div>

            <div style="margin-top:18px;">
                <select id="setTheme" style="width:100%; height:55px; border-radius:18px; border:none; background:#f8fafc; padding:0 15px; font-weight:700; outline:none; appearance:none;">
                    <option value="light">üå§ ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á</option> 
                    <option value="navy">üåå ‡πÇ‡∏´‡∏°‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô</option>
                    <option value="dark">üåë ‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏≥-‡∏ó‡∏≠‡∏á</option> 
                </select> 
            </div>
            
           <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:12px; margin-top:18px;">
    <select id="setSound" style="width:100%; height:55px; border-radius:18px; border:none; background:#f8fafc; padding:0 10px; font-weight:700; outline:none; appearance:none; font-size: 10px;">
        <option value="on">üîä ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</option>
        <option value="off">üîá ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</option>
    </select>    
    
    <select id="setVoice" style="width:100%; height:55px; border-radius:18px; border:none; background:#f8fafc; padding:0 10px; font-weight:700; outline:none; appearance:none; font-size: 10px;">
        <option value="female">üë∏ ‡∏´‡∏ç‡∏¥‡∏á </option>
        <option value="male">ü§µ ‡∏ä‡∏≤‡∏¢ </option>
    </select> 
</div>

            <div style="margin-top:20px; padding:15px; background:#f8fafc; border-radius:24px;">
                <p style="font-size:11px; font-weight:800; color:#94a3b8; margin-bottom:10px; text-align:center;">üíæ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button onclick="exportBackup()" style="padding:12px; background:#22c55e; color:white; border-radius:15px; border:none; font-weight:700; font-size:13px; cursor:pointer;">Backup</button>
                    <button onclick="document.getElementById('importFile').click()" style="padding:12px; background:#3b82f6; color:white; border-radius:15px; border:none; font-weight:700; font-size:13px; cursor:pointer;">Restore</button>
                </div>
                <input type="file" id="importFile" onchange="importBackup(this)" style="display:none;">
            </div>

            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px; margin-top:25px;">
                <button onclick="saveSettings()" style="background:#1e3a8a; color:#fff; height:65px; border-radius:22px; border:none; font-weight:800; font-size:18px; cursor:pointer;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button onclick="document.getElementById('modalSet').style.display='none'" style="background:#fff5f5; color:#e11d48; height:65px; border-radius:22px; border:none; font-size:32px; display:flex; align-items:center; justify-content:center; cursor:pointer;">‚èª</button>
            </div>

            <button onclick="clearAllData()" style="width:100%; margin-top:20px; background:none; border:none; color:#fca5a5; font-size:13px; font-weight:700; text-decoration:underline; cursor:pointer;">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
    </div>
</div>
    <div id="reportModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="reportTitle" style="margin:0; color:#1a237e;">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
            <button onclick="closeReportModal()" style="background:#fee2e2; color:#dc2626; border:none; width:35px; height:35px; border-radius:50%; font-size:18px; cursor:pointer;">‚úï</button>
        </div>
        <div id="reportContent" style="max-height:400px; overflow-y:auto;"></div>
    </div>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; color:#1a237e;">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</h3>
            <button onclick="closeHistoryModal()" style="background:#fee2e2; color:#dc2626; border:none; width:35px; height:35px; border-radius:50%; font-size:18px; cursor:pointer;">‚úï</button>
        </div>
        <div id="accHistory" style="max-height:400px; overflow-y:auto;"></div>
    </div>
</div>
 <nav>
    <div onclick="go(1)" class="nav-item active"><i class="fas fa-edit"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span></div>
    <div onclick="go(2)" class="nav-item"><i class="fas fa-history"></i><span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span></div>
    <div onclick="go(3)" class="nav-item"><i class="fas fa-wallet"></i><span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span></div>
</nav>
 <script>
const $ = (id) => document.getElementById(id);
let db = JSON.parse(localStorage.getItem("barber_db")) || [];
let archives = JSON.parse(localStorage.getItem("barber_archives")) || [];
let account = JSON.parse(localStorage.getItem("barber_account")) || { balance: 0, logs: [] };
let conf = JSON.parse(localStorage.getItem("barber_conf")) || { shop: "Barber Shop", perc: 50, guar: 0 };
let payMethod = "";
function save() {
    localStorage.setItem("barber_db", JSON.stringify(db));
    localStorage.setItem("barber_archives", JSON.stringify(archives));
    localStorage.setItem("barber_account", JSON.stringify(account));
    localStorage.setItem("barber_conf", JSON.stringify(conf));
}
window.onload = () => {
    const today = new Date().toISOString().split('T')[0];

    if ($("dateInp")) $("dateInp").value = today;
    if ($("accDate")) $("accDate").value = today;
    if ($("histDate")) $("histDate").value = today;
    if (conf.shop) $("shopNameDisp").innerText = conf.shop;
    if (conf.theme) applyTheme(conf.theme);

    renderDay();
    loadAccountStatus();
};

    function addMinutes(time, mins) {
    if (!time) return "";
    const [h, m] = time.split(":").map(Number);
    const d = new Date();
    d.setHours(h, m + mins, 0, 0);
    return d.toTimeString().slice(0, 5);
}
function openReportModal(title, htmlContent) {
    const modal = $("reportModal");
    const modalTitle = $("reportTitle");     
    const modalContent = $("reportContent"); 
    const modalInner = modalContent.parentElement; 

    if (!modal || !modalTitle || !modalContent) {
        console.error("‚ùå ‡∏´‡∏≤ ID Modal ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÄ‡∏ä‡πá‡∏Ñ HTML ‡∏î‡πà‡∏ß‡∏ô!");
        return;
    }
    modalTitle.innerText = title;
    modalContent.innerHTML = htmlContent;
    modalInner.style.width = "95%";            
    modalInner.style.maxWidth = "650px";       
    modalInner.style.maxHeight = "85vh";       
    modalInner.style.overflowY = "auto";       
    modalInner.style.borderRadius = "24px";    
    modalInner.style.padding = "20px";
    modalInner.style.margin = "auto";
    modal.style.display = "flex";
    modal.style.alignItems = "center";
    modal.style.justifyContent = "center";
}
function closeReportModal() {
    $("reportModal").style.display = "none";
}
  function openHistoryModal() { 
    $("historyModal").style.display = "flex"; 
    if (typeof renderHistoryList === "function") {
        renderHistoryList(); 
    } else {
        console.error("‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderHistoryList ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÇ‡∏ß‡πâ‡∏¢!");
    }
}

function closeHistoryModal() { 
    $("historyModal").style.display = "none"; 
}
  function handleSave() {
    const p = parseInt($("priceInp").value), t = parseInt($("tipInp").value) || 0;
    if (!p || !payMethod) return alert("‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô!");
    const start = $("tStart").value || new Date().toTimeString().slice(0, 5);
    const rec = {
        id: Date.now(), date: $("dateInp").value, time: start, endTime: $("tEnd").value || addMinutes(start, 30),
        svcs: [$("hairStyle").value, $("extra1").value, $("extra2").value].filter(Boolean),
        hair: $("hairStyle").value, price: p, tip: t, pay: payMethod, type: "SERVICE"
    };
    db.push(rec); saveDB(); renderDay(); 
    ["priceInp", "tipInp", "tStart", "tEnd"].forEach(id => $(id).value = ""); 
}
function handleInsurance() {
    const d = $("dateInp").value || new Date().toISOString().split('T')[0], g = parseInt(conf.guar) || 0;
    const speak = (t) => { const m = new SpeechSynthesisUtterance(t); m.lang = 'th-TH'; window.speechSynthesis.speak(m); };
    if (g <= 0) return (speak("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô"), alert("‚ö†Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÉ‡∏ô '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö' ‡∏Å‡πà‡∏≠‡∏ô"));
    if (db.find(r => r.date === d && r.type === "GUARANTEE_CLAIM")) return (speak("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞"), alert("üõ°Ô∏è ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß"));
    if (confirm(`üõ°Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ'?`)) {
        db.push({ id: Date.now(), date: d, time: "00:00", svcs: ["üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô"], price: 0, pay: "N/A", type: "GUARANTEE_CLAIM" });
        saveDB(); speak(`‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô ${g} ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`); alert("‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); renderDay();
    }
}
 function handleHoliday(){const d=$("dateInp").value;if(!d)return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d} ‡πÄ‡∏õ‡πá‡∏ô "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"?`)){db.push({id:Date.now(),date:d,time:"00:00",svcs:["üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"],price:0,pay:"N/A",type:"HOLIDAY"});saveDB();const m=new SpeechSynthesisUtterance("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");m.lang='th-TH';if(conf.voice==='male'){const v=window.speechSynthesis.getVoices().find(x=>x.name.includes('Male')||x.name.includes('Google'));if(v)m.voice=v}window.speechSynthesis.speak(m);alert("üèñÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");renderDay()}}   
function openSettings() {
    if ($("setShop"))  $("setShop").value  = conf.shop || "";
    if ($("setTheme")) $("setTheme").value = conf.theme || "light";
    if ($("setVoice")) $("setVoice").value = conf.voice || "female";
    if ($("setSound")) $("setSound").value = conf.sound || "on";
    if ($("setPerc"))  $("setPerc").value  = conf.perc || 50;
    if ($("setGuar"))  $("setGuar").value  = conf.guar || 0;

    $("modalSet").style.display = "flex";
}

 function applyTheme(t) {document.body.className = t;const oldStyle = document.getElementById("navyStyle");if (oldStyle) oldStyle.remove();
    const s = document.documentElement.style;s.setProperty('--card', '#ffffff');s.setProperty('--text', '#1a237e');document.body.style.background = '#f3f4f6'; 
    if (t === 'dark') {s.setProperty('--card', '#262626');s.setProperty('--text', '#fbbf24');document.body.style.background = '#171717';}
    else if (t === 'navy') {s.setProperty('--card', '#ffffff'); s.setProperty('--text', '#1a237e');document.body.style.background = '#1a237e';
    const st = document.createElement("style");st.id = "navyStyle"; st.innerHTML = ` body.navy { background: #1a237e !important; color: #ffffff !important; }.navy .card b, .navy .card span { color: #1e293b !important; }.navy #dTotal, .navy #accNet { color: #1a237e !important; }.nav-item { color: #ffffff !important; opacity: 0.7; }.nav-item.active { color: #facc15 !important; opacity: 1; font-weight: bold; } `;document.head.appendChild(st);}}
            
function saveSettings() {
    
    conf = {
        ...conf, 
        shop: document.getElementById("setShop").value || "",
        perc: parseInt(document.getElementById("setPerc").value) || 0,
        guar: parseInt(document.getElementById("setGuar").value) || 0,

    };
    localStorage.setItem("barber_conf", JSON.stringify(conf));
    renderDay(); 
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
}    
 function closeAndGoHome(){const m=document.getElementById("modalSet");if(m)m.style.display='none';if(typeof go==='function')go(1);else location.reload()}
 function speak(txt) {if ('speechSynthesis' in window) {const msg = new SpeechSynthesisUtterance(txt); msg.lang = 'th-TH'; window.speechSynthesis.speak(msg);}}       
 function clearAllData(){if(confirm("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")){localStorage.clear();location.reload()}}
 function updateDateDisplay(v){if(!v)return;const d=new Date(v);const el=$("dateDisplay");if(el)el.innerText=d.toLocaleDateString('th-TH',{day:'numeric',month:'short',year:'2-digit'});if(typeof renderDay==="function")renderDay()}window.addEventListener('DOMContentLoaded',()=>{const i=$("dateInp"),t=new Date().toISOString().split('T')[0];if(i){i.value=t;updateDateDisplay(t)}});
 function selectPay(m) {payMethod = m; $("btnCash").className = `btn btn-pay ${m === 'Cash' ? 'active-cash' : ''}`;$("btnTrans").className = `btn btn-pay ${m === 'Trans' ? 'active-trans' : ''}`;}
       
 function renderDay() {
    const dInp = $("dateInp").value;
    const allRec = db.filter(r => r.date === dInp);
    const today = allRec.filter(r => r.type !== 'HOLIDAY');
    const isHoliday = allRec.some(r => r.type === 'HOLIDAY');
    const stats = {};
    const extraSvcs = ["‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î", "‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤", "‡∏™‡∏£‡∏∞‡∏ú‡∏°"];
    let tot = 0, trans = 0, cash = 0, tips = 0;
    let listHtml = "";
    today
    .slice()
    .sort((a,b) => a.time.localeCompare(b.time))
    .forEach((r, i) => {
        const p = Number(r.price) || 0;
        const t = Number(r.tip) || 0;
        tot += p;
        tips += t;
        (r.pay === 'Trans') ? trans += (p + t) : cash += p;
        const currentSvcs = Array.isArray(r.svcs) ? r.svcs : [];
        const hasRealHaircut = currentSvcs.some(s => s && !extraSvcs.includes(s));
        currentSvcs.forEach(s => {
            if (!s) return;
            stats[s] = (stats[s] || 0) + 1;
        });

        if (hasRealHaircut) {
            stats["‡∏ï‡∏±‡∏î‡∏ú‡∏°"] = (stats["‡∏ï‡∏±‡∏î‡∏ú‡∏°"] || 0) + 1;
        }
       const timeShow = r.endTime ? `${r.time}-${r.endTime}` : r.time;
        const payIcon = r.pay === 'Trans' ? 'üì±' : 'üíµ';

        listHtml += `
        <div class="history-row" style="padding:15px; border-bottom:1px solid #f1f5f9; background:#fff;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="width:28px; height:28px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:800; color:#64748b; flex-shrink:0;">
                        ${i+1}
                    </div>
                    <div style="display:flex; flex-direction:column;">
                        <div style="font-weight:800; font-size:14px; color:#1e293b; margin-bottom:2px;">
                            <span style="color:#64748b; font-weight:500;">[${timeShow}]</span> ${currentSvcs.join(' + ')}
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            ${t ? `<small style="color:#be185d; font-weight:700; font-size:11px;">üîπ ‡∏ó‡∏¥‡∏õ: ‡∏ø${t}</small>` : '<small style="color:#94a3b8; font-size:11px;">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏¥‡∏õ)</small>'}
                        </div>
                    </div>
                </div>
                <div style="text-align:right;">
                    <b style="font-size:16px; display:block; color:#1e293b;">
                        <span style="font-size:14px;">${payIcon}</span> ‡∏ø${p}${t ? ` <span style="color:#be185d;">(+${t})</span>` : ''}
                    </b>
                    <span style="font-size:11px; font-weight:700; color:#ef4444; cursor:pointer;" onclick="delRec(${r.id})">
                        ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <i class="fas fa-trash-alt"></i>
                    </span>
                </div>
            </div>
        </div>`;
    });

    const bEarn = isHoliday ? 0 : Math.max(tot * (conf.perc / 100), conf.guar) + tips;
    const sEarn = isHoliday ? 0 : tot - (bEarn - tips);
    const settle = isHoliday ? 0 : cash - bEarn;

    $("dTotal").innerText  = tot.toLocaleString();
    $("dTrans").innerText  = trans.toLocaleString();
    $("dCash").innerText   = cash.toLocaleString();
    $("dBarber").innerText = Math.floor(bEarn).toLocaleString();
    $("dShop").innerText   = Math.floor(sEarn).toLocaleString();
    $("dCounts").innerText = isHoliday ? "üè™ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î" : `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${today.length} ‡∏Ñ‡∏ô`;

    let sH = `<div style="display:flex; flex-wrap:wrap; gap:5px; justify-content:center; margin-bottom:10px;">`;
    const priority = ["‡∏ï‡∏±‡∏î‡∏ú‡∏°", "‡πÄ‡∏î‡πá‡∏Å"];
    priority.forEach(k => { if (stats[k]) sH += `<span style="background:#4338ca;color:#fff;padding:5px 12px;border-radius:8px;font-size:11px;font-weight:800;">${k}: ${stats[k]}</span>`; });
    for (let s in stats) { if (!priority.includes(s)) sH += `<span style="background:#64748b;color:#fff;padding:5px 12px;border-radius:8px;font-size:11px;font-weight:800;">${s}: ${stats[s]}</span>`; }
    $("dServiceStats").innerHTML = sH + `</div>`;

    let txt = "", bg = "";
    if (isHoliday) { txt = "üèñÔ∏è ‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"; bg = "#f1f5f9"; }
    else if (tot === 0) { txt = "üõ°Ô∏è ‡∏£‡πâ‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô"; bg = "#e0f2fe"; }
    else if (settle > 0) { txt = `üë®‚Äçüé® ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${Math.floor(settle).toLocaleString()}`; bg = "#fee2e2"; }
    else if (settle < 0) { txt = `üíà ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ‡∏ø${Math.floor(Math.abs(settle)).toLocaleString()}`; bg = "#e0e7ff"; }
    else { txt = "‚úÖ ‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ"; bg = "#dcfce7"; }

    $("dailyList").innerHTML =
        `<div style="display:flex; justify-content:space-between; align-items:center; margin:10px 0; padding:0 5px;">
            <b style="font-size:16px;">üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</b>
            <i class="fab fa-line" style="color:#22c55e;font-size:32px;cursor:pointer" onclick="shareLine()"></i>
        </div>` +
        (isHoliday
            ? `<div style="text-align:center; padding:40px; color:#64748b; font-weight:800;">üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏£‡πâ‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) <i class="fas fa-trash-alt" style="color:#ef4444; cursor:pointer;" onclick="delRec(${allRec.find(x=>x.type==='HOLIDAY')?.id})"></i></div>`
            : (listHtml || "<center style='padding:40px; opacity:0.3;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</center>")
        );

    const container = $("settleBar").parentElement;
    container.style.cssText = "display:flex; gap:10px; margin-top:10px;";
    container.innerHTML = `
        <div id="settleBar" style="flex:8; height:55px; background:${bg}; display:flex; align-items:center; justify-content:center; border-radius:15px; font-weight:900; font-size:15px; color:#1e293b; border:1px solid rgba(0,0,0,0.05);">${txt}</div>
        <button onclick="saveAndGo('${dInp}', ${tot})" style="flex:2; height:55px; background:#f97316; color:#fff; border-radius:15px; border:none; font-size:22px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 6px rgba(0,0,0,0.1);"><i class="fas fa-paper-plane"></i></button>`;
}
function saveAndGo(date, total) {
    const todayData = db.filter(r => r.date === date && r.type === 'SERVICE');
    const isHoliday = db.some(r => r.date === date && r.type === 'HOLIDAY');
    let cash = 0, trans = 0, tips = 0, count = 0, stats = {};
    const extraSvcs = ["‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î", "‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤", "‡∏™‡∏£‡∏∞‡∏ú‡∏°"];
    todayData.forEach(r => {
        const p = Number(r.price) || 0, t = Number(r.tip) || 0;
        tips += t;
        r.pay === "Cash" ? cash += p : trans += (p + t);
        const svcs = Array.isArray(r.svcs) ? r.svcs : [r.svcs];
        const isRealCut = svcs.some(s => s && !extraSvcs.includes(s));
        if (isRealCut) count++;
        svcs.forEach(s => { if(s) stats[s] = (stats[s] || 0) + 1; });
    });
    const bEarn = isHoliday ? 0 : Math.max(total * (conf.perc / 100), conf.guar) + tips;
    const settle = isHoliday ? 0 : cash - bEarn;
    const idx = archives.findIndex(a => a.date === date);
    const data = {date,total: Number(total),cash,trans,tips,barber: Math.floor(bEarn),shop: total - (bEarn - tips),settle,count,stats,details: todayData };    
    if (idx > -1) {account.balance = (Number(account.balance) || 0) + (settle - (archives[idx].settle || 0));archives[idx] = data;
    } else {account.balance = (Number(account.balance) || 0) + settle;archives.push(data);}
    db = db.filter(r => r.date !== date);save();alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");go(3);}

    function toggleAccHistory() {const w = $("accHistoryWrapper"); w.style.display = w.style.display === "none" ? "block" : "none";$("accHistory").innerHTML = account.logs.map(l => `<div style="padding:5px; border-bottom:1px solid #eee;">${l.date}: ‡∏ø${l.amount} (${l.note})</div>`).join('') || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥";}    
    function loadAccountHistory() {let h = account.logs.map(l => `<div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;"><div><b style="font-size:14px; color:#1e293b;">${l.date}</b><br><small style="color:#64748b;">${l.note}</small></div><b style="color:${l.amount >= 0 ? '#16a34a' : '#dc2626'};">${l.amount >= 0 ? '+' : ''}‡∏ø${Math.abs(l.amount).toLocaleString()}</b></div> `).join('');if($("accHistory")) {$("accHistory").innerHTML = h || '<center style="padding:40px; color:#94a3b8;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</center>';}}     
    function loadAccountStatus() {
    const net = Number(account.balance) || 0;
   
    if ($("accOldVal")) $("accOldVal").innerText = `‡∏ø${net.toLocaleString()}`;
    if ($("accTodayVal")) $("accTodayVal").innerText = `‡∏ø0`; 
    if ($("accNet")) $("accNet").innerText = Math.abs(net).toLocaleString();

    const badge = $("statusBadge"); 
    let bgColor = "#f8fafc"; 
    let textColor = "#64748b";
    let statusTxt = "‚öñÔ∏è ‡∏¢‡∏≠‡∏î‡∏•‡∏á‡∏ï‡∏±‡∏ß";

    if (net > 0) {
        bgColor = "#fef2f2"; 
        textColor = "#dc2626"; 
        statusTxt = "üë®‚Äçüé® ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô";
    } else if (net < 0) {
        bgColor = "#eff6ff"; 
        textColor = "#1e3a8a"; 
        statusTxt = "üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á";
    }
    if (badge) {
        badge.innerText = statusTxt;
        badge.style.background = bgColor;
        badge.style.color = textColor;
    }
    if ($("accLight")) {
        const lightColor = net > 0 ? "#dc2626" : (net < 0 ? "#1e3a8a" : "#16a34a");
        $("accLight").style.background = lightColor;
        $("accLight").style.boxShadow = `0 0 12px ${lightColor}`;
    }
}
function clearAccount() {
    const d = $("accDate").value || new Date().toISOString().split('T')[0];
    
    const net = Number(account.balance) || 0;

    if (net === 0) {
        alert("üíé ‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå");
        return;
    }

    const confirmMsg = net > 0 
        ? `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏≤‡∏á "‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" ‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${net.toLocaleString()} ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`
        : `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏£‡πâ‡∏≤‡∏ô "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô" ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≤‡∏á ‡∏ø${Math.abs(net).toLocaleString()} ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`;

    if (!confirm(confirmMsg)) return;
    if (!account.logs) account.logs = [];
    account.logs.unshift({
        date: d,
        amount: net,
        note: $("accNote")?.value || "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á"
    });
    account.balance = 0;
    save(); 
    alert("‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
    
    if ($("accNote")) $("accNote").value = "";
    loadAccountHistory(); 
    loadAccountStatus();  
}
function renderHistoryList() {
    let h = account.logs.map(l => `
        <div style="padding:12px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <b style="font-size:14px; color:#1e293b;">${l.date}</b><br>
                <small style="color:#64748b;">${l.note}</small>
            </div>
            <b style="color:#16a34a;">‡∏ø${Math.abs(l.amount).toLocaleString()}</b>
        </div>
    `).join('');
    
    $("accHistory").innerHTML = h || '<center style="padding:40px; color:#94a3b8;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</center>';
}
function loadHistDaily() {
    const d = $("histDate").value;
    if (!d) return;

    const f = archives.find(a => a.date === d);
    if (!f) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ");

    let cashTotal = f.cash || 0;
    let transTotal = f.trans || 0;
    let totalRevenue = cashTotal + transTotal;
    let customerCount = f.count || (f.details ? f.details.length : 0);
    const barberEarn = Math.floor(f.barber || 0);
    const shopEarn = Math.floor(f.shop || 0);
    const svcCounts = {};
    (f.details || []).forEach(r => {
        const services = Array.isArray(r.svcs) ? r.svcs : [r.svcs];
        services.forEach(s => {
            svcCounts[s] = (svcCounts[s] || 0) + 1;
        });
    });

    const svcHTML = Object.entries(svcCounts).map(([name, count]) => `
        <div style="background:rgba(255,255,255,0.1); padding:8px 14px; border-radius:14px; font-size:12px; color:#bef264; font-weight:700; display:inline-block; margin:4px 2px;">
            ${name} x${count}
        </div>
    `).join("");

    let settleHTML = "";
    if (cashTotal > barberEarn) {
        const toShop = cashTotal - barberEarn;
        settleHTML = `<div style="background:rgba(251,146,60,0.15); padding:18px; border-radius:24px; margin-bottom:20px; text-align:center;">
            <div style="font-size:16px; color:#fb923c; font-weight:800; text-transform:uppercase;">üë®‚Äçüé® ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô</div>
            <div style="font-size:26px; color:#fb923c; font-weight:900;">‡∏ø${toShop.toLocaleString()}</div>
        </div>`;
    } else if (barberEarn > cashTotal) {
        const toBarber = barberEarn - cashTotal;
        settleHTML = `<div style="background:rgba(56,189,248,0.15); padding:18px; border-radius:24px; margin-bottom:20px; text-align:center;">
            <div style="font-size:16px; color:#38bdf8; font-weight:800; text-transform:uppercase;">üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á</div>
            <div style="font-size:26px; color:#0284c7; font-weight:900;">‡∏ø${toBarber.toLocaleString()}</div>
        </div>`;
    }
    const rows = (f.details || []).map((r, index) => {
        const p = Number(r.price) || 0;
        const t = Number(r.tip) || 0;
        const fullTime = (r.time && r.endTime) ? `${r.time}-${r.endTime}` : (r.time || "--:--");
        
        return `
        <div style="padding:16px; background:rgba(255,255,255,0.06); border-radius:20px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap:12px;">
                <div style="width:32px; height:32px; background:rgba(255,255,255,0.1); border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:900; color:#fff;">${index + 1}</div>
                <div>
                    <div style="font-weight:800; font-size:15px; color:#fff;">${Array.isArray(r.svcs) ? r.svcs.join('+') : r.svcs}</div>
                    <div style="font-size:14px; color:rgba(255,255,255,0.4); font-weight:600;">‚è± ${fullTime} ‚Ä¢ ${r.pay === 'Trans' ? '‡πÇ‡∏≠‡∏ô' : '‡∏™‡∏î'}</div>
                </div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:18px; font-weight:900; color:#bef264;">‡∏ø${p.toLocaleString()}</div>
                ${t > 0 ? `<div style="font-size:14px; font-weight:800; color:#f472b6;">+ Tip ‡∏ø${t.toLocaleString()}</div>` : ''}
            </div>
        </div>`;
    }).join("");

    openReportModal(`‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ${d}`, `
        <div style="font-family: 'Inter', sans-serif; background:#0f172a; margin:-16px; padding:24px; color:#fff; min-height:100vh;">
            
            <div style="text-align:center; padding:10px 0 30px 0;">
                <div style="font-size:18px; color:rgba(255,255,255,0.5); font-weight:700; text-transform:uppercase; letter-spacing:2px; margin-bottom:5px;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</div>
                <div style="font-size:45px; font-weight:900; color:#bef264; letter-spacing:-2px; text-shadow: 0 0 20px rgba(190, 242, 100, 0.3);">‡∏ø${totalRevenue.toLocaleString()}</div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:25px;">
                <div style="background:#22c55e; padding:15px 5px; border-radius:20px; text-align:center;">
                    <div style="font-size:16px; color:rgba(255,255,255,0.8); font-weight:800;">üíµ ‡∏™‡∏î</div>
                    <div style="font-size:16px; font-weight:900;">‡∏ø${cashTotal.toLocaleString()}</div>
                </div>
                <div style="background:#3b82f6; padding:15px 5px; border-radius:20px; text-align:center;">
                    <div style="font-size:16px; color:rgba(255,255,255,0.8); font-weight:800;">üì± ‡πÇ‡∏≠‡∏ô</div>
                    <div style="font-size:16px; font-weight:900;">‡∏ø${transTotal.toLocaleString()}</div>
                </div>
                <div style="background:#f59e0b; padding:15px 5px; border-radius:20px; text-align:center;">
                    <div style="font-size:16px; color:rgba(255,255,255,0.8); font-weight:800;">üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                    <div style="font-size:16px; font-weight:900;">${customerCount}</div>
                </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:25px;">
                <div style="background:rgba(255,255,255,0.05); padding:16px; border-radius:24px; text-align:center;">
                    <div style="font-size:16px; color:rgba(255,255,255,0.5); font-weight:700;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ä‡πà‡∏≤‡∏á</div>
                    <div style="font-size:22px; font-weight:900; color:#fff;">‡∏ø${barberEarn.toLocaleString()}</div>
                </div>
                <div style="background:rgba(255,255,255,0.05); padding:16px; border-radius:24px; text-align:center;">
                    <div style="font-size:16px; color:rgba(255,255,255,0.5); font-weight:700;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡πâ‡∏≤‡∏ô</div>
                    <div style="font-size:22px; font-weight:900; color:#fff;">‡∏ø${shopEarn.toLocaleString()}</div>
                </div>
            ${settleHTML}
             
            </div>
            <div style="margin-bottom:25px; text-align:center;">
                <div style="font-size:11px; color:rgba(255,255,255,0.4); font-weight:800; text-transform:uppercase; margin-bottom:10px; letter-spacing:1px;">Service Summary</div>
                ${svcHTML}
            </div>
            <div style="font-weight:900; font-size:16px; color:rgba(255,255,255,0.9); margin-bottom:15px; letter-spacing:1px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            <div style="max-height:350px; overflow-y:auto; padding-bottom:30px;">
                ${rows}
            </div>
        </div>
    `);
}
function loadHistMonth() {
    const m = $("histMonth").value;
    if (!m) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô");

    const filtered = archives.filter(a => a.date && a.date.startsWith(m));
    if (!filtered.length) {
        return openReportModal(
            "üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô",
            "<div style='padding:80px 20px; text-align:center; color:#94a3b8; background:#0f172a; height:100vh;'><i class='fas fa-folder-open' style='font-size:40px;margin-bottom:10px;opacity:0.3;'></i><br>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>"
        );
    }

    const haircutList = ["‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô","‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î","‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á","‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á","‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£","‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡πÅ‡∏Å‡πâ‡∏ú‡∏°","‡πÇ‡∏Å‡∏ô‡∏ú‡∏°","‡πÄ‡∏î‡πá‡∏Å"];
    const serviceList = ["‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î","‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤","‡∏™‡∏£‡∏∞‡∏ú‡∏°","‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°"];

    let monthTotal = 0, monthBarber = 0, monthCount = 0;
    let hairStats = {}, serviceStats = {};

    filtered.forEach(day => {
        monthTotal += Number(day.total) || 0;
        monthBarber += Number(day.barber) || 0;
        (day.details || []).forEach(d => {
            const svcs = Array.isArray(d.svcs) ? d.svcs : [];
            let countedHair = false;
            svcs.forEach(s => {
                if (!s) return;
                s = s.trim();
                if (haircutList.includes(s)) {
                    hairStats[s] = (hairStats[s] || 0) + 1;
                    if (!countedHair) { monthCount++; countedHair = true; }
                } else if (serviceList.includes(s)) {
                    serviceStats[s] = (serviceStats[s] || 0) + 1;
                }
            });
        });
    });

    const monthShop = monthTotal - monthBarber;
    const renderStats = (obj, accentColor, icon) => {
        const entries = Object.entries(obj).sort((a,b)=>b[1]-a[1]);
        if (!entries.length) return "<div style='font-size:12px;color:rgba(255,255,255,0.2);padding:10px;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>";
        return entries.map(([k,v]) => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 18px; background:rgba(255,255,255,0.05); border-radius:18px; margin-bottom:10px; border-left:4px solid ${accentColor};">
                <div style="display:flex; align-items:center; gap:12px;">
                    <span style="color:#fff; font-size:14px; font-weight:700;">${k}</span>
                </div>
                <div style="font-weight:900; color:${accentColor}; font-size:16px;">${v} <span style="font-size:11px; font-weight:400; opacity:0.6; color:#fff;">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
            </div>`
        ).join("");
    };

    openReportModal(
        `‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${m}`,
        `
        <div style="background:#0f172a; margin:-16px; padding:24px; font-family:'Inter', sans-serif; color:#fff; min-height:100vh;">
            
            <div style="text-align:center; padding:20px 0 40px 0;">
                <div style="font-size:18px; color:rgba(255,255,255,0.5); font-weight:800; text-transform:uppercase; letter-spacing:2px; margin-bottom:8px;">‚úÇÔ∏è ‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                <div style="font-size:52px; font-weight:900; color:#bef264; letter-spacing:-2px; text-shadow: 0 0 25px rgba(190, 242, 100, 0.4);">‡∏ø${monthTotal.toLocaleString()}</div>
                
                <div style="display:flex; justify-content:center; gap:12px; margin-top:20px;">
                    <div style="background:rgba(255,255,255,0.1); padding:8px 16px; border-radius:12px; font-size:13px; font-weight:700;">
                        üë§ ${monthCount} <span style="opacity:0.5; font-weight:400;">‡∏Ñ‡∏ô</span>
                    </div>
                    <div style="background:rgba(255,255,255,0.1); padding:8px 16px; border-radius:12px; font-size:13px; font-weight:700;">
                        üìÖ ${filtered.length} <span style="opacity:0.5; font-weight:400;">‡∏ß‡∏±‡∏ô</span>
                    </div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:35px;">
                <div style="background:rgba(34, 197, 94, 0.1); border:1px solid rgba(34, 197, 94, 0.2); padding:20px; border-radius:28px; text-align:center;">
                    <div style="font-size:12px; color:#4ade80; margin-bottom:8px; font-weight:800; text-transform:uppercase;">‡∏¢‡∏≠‡∏î‡∏ä‡πà‡∏≤‡∏á</div>
                    <div style="font-size:20px; font-weight:900; color:#fff;">‡∏ø${Math.floor(monthBarber).toLocaleString()}</div>
                </div>
                <div style="background:rgba(59, 130, 246, 0.1); border:1px solid rgba(59, 130, 246, 0.2); padding:20px; border-radius:28px; text-align:center;">
                    <div style="font-size:12px; color:#60a5fa; margin-bottom:8px; font-weight:800; text-transform:uppercase;">‡∏¢‡∏≠‡∏î‡∏£‡πâ‡∏≤‡∏ô</div>
                    <div style="font-size:20px; font-weight:900; color:#fff;">‡∏ø${Math.floor(monthShop).toLocaleString()}</div>
                </div>
            </div>

            <div style="margin-bottom:30px;">
                <div style="font-size:15px; font-weight:900; color:rgba(255,255,255,0.9); margin-bottom:18px; letter-spacing:1px; display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-cut" style="color:#bef264;"></i> ‡∏ó‡∏£‡∏á‡∏ú‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°
                </div>
                ${renderStats(hairStats, "#bef264", "fa-cut")}
            </div>

            <div style="padding-bottom:40px;">
                <div style="font-size:15px; font-weight:900; color:rgba(255,255,255,0.9); margin-bottom:18px; letter-spacing:1px; display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-star" style="color:#38bdf8;"></i> ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°
                </div>
                ${renderStats(serviceStats, "#38bdf8", "fa-magic")}
            </div>
            
        </div>
        `
    );
}
  function shareLine() {
    const dInp = $("dateInp").value, today = db.filter(r => r.date === dInp); if (!today.length) return;
    const dp = dInp.split('-'), fDate = `${dp[2]}/${dp[1]}/${dp[0]}`;
    let tot=0, cash=0, trans=0, tips=0, stats={};
    let clientList = today.sort((a,b)=>a.time.localeCompare(b.time)).map((r,i)=>{
        const p = Number(r.price)||0, t = Number(r.tip)||0; tot+=p; tips+=t;
        r.pay==='Trans' ? trans+=p : cash+=p;
        if(r.hair&&r.hair.includes("‡πÄ‡∏î‡πá‡∏Å")) stats["‡πÄ‡∏î‡πá‡∏Å"]=(stats["‡πÄ‡∏î‡πá‡∏Å"]||0)+1;
        (r.svcs||[]).forEach(s=>{ if(s) stats[s]=(stats[s]||0)+1; });
        const tShow = r.endTime ? `${r.time}-${r.endTime}` : r.time;
        return `${i+1}. [${tShow}] ${(r.svcs||[]).join('+')} = ${p}${t?` (+‡∏ó‡∏¥‡∏õ ${t})`:''} ${r.pay==='Trans'?'üì±':'üíµ'}`;
    }).join('\n');
    const allowed = ["‡πÄ‡∏î‡πá‡∏Å","‡∏™‡∏£‡∏∞‡∏ú‡∏°","‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î","‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°","‡∏¢‡πâ‡∏≠‡∏°‡∏™‡∏µ"], icons = {"‡πÄ‡∏î‡πá‡∏Å":"üßí","‡∏™‡∏£‡∏∞":"üßº","‡πÇ‡∏Å‡∏ô":"ü™í","‡∏¢‡πâ‡∏≠‡∏°":"üé®"};
    let statText = Object.entries(stats).filter(([k])=>allowed.some(a=>k.includes(a))).map(([k,v])=>`${icons[Object.keys(icons).find(i=>k.includes(i))]||'üîπ'} ${k}: ${v}`).join('\n');
    let bEarn = Math.max(tot*(conf.perc/100), conf.guar) + tips; // ‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ = ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ö‡πà‡∏á + ‡∏ó‡∏¥‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    let settle = cash - bEarn, settleMsg = settle > 0 ? `‚ö†Ô∏è ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ${Math.floor(Math.abs(settle))}` : `üü¶ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ${Math.floor(Math.abs(settle))}`;
    let msg = `üíà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô: Barber Shop\nüìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${fDate}\n-------------------------\nüìù ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (${today.length} ‡∏Ñ‡∏ô):\n${clientList}\n-------------------------\nüìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô:\n${statText}\n-------------------------\nüí∞ ‡∏¢‡∏≠‡∏î: ${tot} | üßß ‡∏ó‡∏¥‡∏õ: ${tips}\nüì± ‡πÇ‡∏≠‡∏ô: ${trans} | üíµ ‡∏™‡∏î: ${cash}\nü§µ ‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ: ${Math.floor(bEarn)}\nüè† ‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ${Math.floor(tot-(bEarn-tips))}\n-------------------------\n${settleMsg}`;
    window.open(`https://line.me/R/msg/text/?${encodeURIComponent(msg)}`);
}
function go(p) {
    document.querySelectorAll('.page').forEach(pg => {
        pg.classList.remove('active');
        pg.style.display = 'none'; 
    });
    const targetPage = document.getElementById('p' + p);
    if (targetPage) {
        targetPage.classList.add('active');
        targetPage.style.display = 'block';
    }
    document.querySelectorAll('.nav-item').forEach((btn, i) => {
        btn.classList.toggle('active', (i + 1) === p);
    });
    if (p === 3) { 
        // 1. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏Å‡πà‡∏≠‡∏ô
        if($("accDate") && $("dateInp")) $("accDate").value = $("dateInp").value;
        // 2. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        loadAccountStatus(); 
    }
}
    function saveDB() {localStorage.setItem("barber_db", JSON.stringify(db));localStorage.setItem("barber_conf", JSON.stringify(conf));}
    function delRec(id) { if (confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) { db = db.filter(r => r.id !== id); saveDB(); renderDay(); } }
    function editTime(id) {const rec = db.find(r => r.id === id);if (!rec) return;const newStart = prompt("‡πÅ‡∏Å‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° (HH:MM)", rec.time);if (!newStart) return;const newEnd = prompt("‡πÅ‡∏Å‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à (HH:MM)", rec.endTime || "");rec.time = newStart;rec.endTime = newEnd || addMinutes(newStart, 30);saveDB();renderDay();}
    
    window.onclick = function(e) {const modals = [{ id: "reportModal", close: closeReportModal },{ id: "historyModal", close: closeHistoryModal },{ id: "configModal", close: closeConfigModal } ]; 
    modals.forEach(m => {const modalEl = $(m.id);if (modalEl && e.target === modalEl && typeof m.close === "function") {m.close();}});};
    window.addEventListener('load', () => { const n = new Date(), t = n.getHours().toString().padStart(2, '0') + ':' + n.getMinutes().toString().padStart(2, '0'); if(document.getElementById('tStart')) document.getElementById('tStart').value = t; if(document.getElementById('tEnd')) document.getElementById('tEnd').value = t; });
        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        function exportBackup() {
            const data = {
                db: JSON.parse(localStorage.getItem("barber_db") || "[]"),
                archives: JSON.parse(localStorage.getItem("barber_archives") || "[]")
            };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `backup-barber-${new Date().toLocaleDateString()}.json`;
            a.click();
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        function importBackup(input) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(confirm("‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) {
                        localStorage.setItem("barber_db", JSON.stringify(data.db || []));
                        localStorage.setItem("barber_archives", JSON.stringify(data.archives || []));
                        alert("‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                        location.reload();
                    }
                } catch(err) {
                    alert("‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
            };
            if (input.files[0]) {
                reader.readAsText(input.files[0]);
            }
        }

        // 3. ‡∏ï‡∏±‡∏ß‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Service Worker (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏î‡πâ)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker ‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'))
                    .catch(err => console.log('‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', err));
            });
        }
        
</script>
</body>
</html>
